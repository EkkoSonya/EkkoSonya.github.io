"use strict";(self.webpackChunklearn_data=self.webpackChunklearn_data||[]).push([[5732],{83671:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}},82315:(n,s,a)=>{n.exports=a.p+"assets/img/10.d6cedd60.png"},43656:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>v,data:()=>m});var t=a(7847);const p=a.p+"assets/img/26.93fd15f8.png",e=a.p+"assets/img/27.94425150.png",o=a.p+"assets/img/28.4ca1b931.png",c=a.p+"assets/img/29.183d6f16.png",l=a.p+"assets/img/30.324eb9e8.png",i=a.p+"assets/img/31.e2de4720.png",u=a.p+"assets/img/32.9e6de9cb.png",k=a.p+"assets/img/33.86fde050.png",r=[(0,t.Fv)('<h2 id="菜品管理模块2" tabindex="-1"><a class="header-anchor" href="#菜品管理模块2"><span>菜品管理模块2</span></a></h2><h3 id="实现功能" tabindex="-1"><a class="header-anchor" href="#实现功能"><span>实现功能</span></a></h3><ul><li>公共字段自动填充</li><li>新增菜品</li><li>菜品分页查询</li><li>删除菜品</li><li>修改菜品</li></ul><h3 id="_3-菜品分页查询" tabindex="-1"><a class="header-anchor" href="#_3-菜品分页查询"><span>3. 菜品分页查询</span></a></h3><h4 id="产品原型" tabindex="-1"><a class="header-anchor" href="#产品原型"><span>产品原型</span></a></h4><figure><img src="'+p+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>在菜品列表展示时，除了菜品的基本信息(名称、售价、售卖状态、最后操作时间)外，还有两个字段略微特殊，第一个是图片字段，我们从数据库查询出来的仅仅是图片的名字，图片要想在表格中回显展示出来，就需要下载这个图片。</p><p>第二个是菜品分类，这里展示的是分类名称，而不是分类ID，此时我们就需要根据菜品的分类ID，去分类表中查询分类信息，然后在页面展示。</p><p><strong>业务规则：</strong></p><ul><li>根据页码展示菜品信息</li><li>每页展示10条数据</li><li>分页查询时可以根据需要输入菜品名称、菜品分类、菜品状态进行查询</li></ul><h4 id="接口设计" tabindex="-1"><a class="header-anchor" href="#接口设计"><span>接口设计</span></a></h4><figure><img src="'+e+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="代码开发" tabindex="-1"><a class="header-anchor" href="#代码开发"><span>代码开发</span></a></h4><h5 id="_1-对应dto设计" tabindex="-1"><a class="header-anchor" href="#_1-对应dto设计"><span>1. 对应DTO设计</span></a></h5><p>查询Query对应的DTO: <code>DishPageQueryDTO</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>\n<span class="token annotation punctuation">@Data</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DishPageQueryDTO</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> page<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">Integer</span> categoryId<span class="token punctuation">;</span> <span class="token comment">//分类id</span>\n    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span> <span class="token comment">//状态 0表示禁用 1表示启用</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-对应vo设计" tabindex="-1"><a class="header-anchor" href="#_2-对应vo设计"><span>2. 对应VO设计</span></a></h5><p>返回结果<code>records</code>, 设计对应的VO: <code>DishVO</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">DishFlavor</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>\n\n<span class="token annotation punctuation">@Data</span>\n<span class="token annotation punctuation">@Builder</span>\n<span class="token annotation punctuation">@NoArgsConstructor</span>\n<span class="token annotation punctuation">@AllArgsConstructor</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DishVO</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>\n    <span class="token comment">//菜品名称</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n    <span class="token comment">//菜品分类id</span>\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> categoryId<span class="token punctuation">;</span>\n    <span class="token comment">//菜品价格</span>\n    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>\n    <span class="token comment">//图片</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span>\n    <span class="token comment">//描述信息</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>\n    <span class="token comment">//0 停售 1 起售</span>\n    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>\n    <span class="token comment">//更新时间</span>\n    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> updateTime<span class="token punctuation">;</span>\n    <span class="token comment">//分类名称</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> categoryName<span class="token punctuation">;</span>\n    <span class="token comment">//菜品关联的口味</span>\n    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishFlavor</span><span class="token punctuation">&gt;</span></span> flavors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-controller层" tabindex="-1"><a class="header-anchor" href="#_3-controller层"><span>3. <code>Controller</code>层</span></a></h5><p>根据接口定义创建DishController的page分页查询方法</p><p>根据之前设计的 <code>PageResult</code>来设计</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>  <span class="token doc-comment comment">/**\n     * 菜品分页查询\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">dishPageQueryDTO</span>\n     * <span class="token keyword">@return</span>\n     */</span>\n    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/page&quot;</span><span class="token punctuation">)</span>\n    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;菜品分页查询&quot;</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token class-name">DishPageQueryDTO</span> dishPageQueryDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;菜品分页查询:{}&quot;</span><span class="token punctuation">,</span> dishPageQueryDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> dishService<span class="token punctuation">.</span><span class="token function">pageQuery</span><span class="token punctuation">(</span>dishPageQueryDTO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后绪步骤定义</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-service层接口" tabindex="-1"><a class="header-anchor" href="#_4-service层接口"><span>4. <code>Service</code>层接口</span></a></h5><p><strong>在 DishService 中扩展分页查询方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n  * 菜品分页查询\n  *\n  * <span class="token keyword">@param</span> <span class="token parameter">dishPageQueryDTO</span>\n  * <span class="token keyword">@return</span>\n  */</span>\n<span class="token class-name">PageResult</span> <span class="token function">pageQuery</span><span class="token punctuation">(</span><span class="token class-name">DishPageQueryDTO</span> dishPageQueryDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-service层实现类" tabindex="-1"><a class="header-anchor" href="#_4-service层实现类"><span>4. <code>Service</code>层实现类</span></a></h5><p><strong>在 DishServiceImpl 中实现分页查询方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n* 菜品分页查询\n*\n* <span class="token keyword">@param</span> <span class="token parameter">dishPageQueryDTO</span>\n* <span class="token keyword">@return</span>\n*/</span>\n<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">pageQuery</span><span class="token punctuation">(</span><span class="token class-name">DishPageQueryDTO</span> dishPageQueryDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>dishPageQueryDTO<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dishPageQueryDTO<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> dishMapper<span class="token punctuation">.</span><span class="token function">pageQuery</span><span class="token punctuation">(</span>dishPageQueryDTO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后绪步骤实现</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-mapper层" tabindex="-1"><a class="header-anchor" href="#_5-mapper层"><span>5. <code>Mapper</code>层</span></a></h5><p>在 DishMapper 接口中声明 pageQuery 方法：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n  * 菜品分页查询\n  *\n  * <span class="token keyword">@param</span> <span class="token parameter">dishPageQueryDTO</span>\n  * <span class="token keyword">@return</span>\n  */</span>\n<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">pageQuery</span><span class="token punctuation">(</span><span class="token class-name">DishPageQueryDTO</span> dishPageQueryDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在 DishMapper.xml 中编写SQL：</strong></p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pageQuery<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.sky.vo.DishVO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n  select d.* , c.name as categoryName from dish d left outer join category c on d.category_id = c.id\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n          and d.name like concat(&#39;%&#39;,#{name},&#39;%&#39;)\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>categoryId != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n          and d.category_id = #{categoryId}\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n          and d.status = #{status}\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">&gt;</span></span>\n  order by d.create_time desc\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的SQL设计可以先去测试下，感觉需要了解下，并没有系统仔细学过SQL语句</p><h3 id="_4-删除菜品" tabindex="-1"><a class="header-anchor" href="#_4-删除菜品"><span>4. 删除菜品</span></a></h3><p>在菜品列表页面，每个菜品后面对应的操作分别为<strong>修改</strong>、<strong>删除</strong>、<strong>停售</strong>，可通过删除功能完成对菜品及相关的数据进行删除。</p><h4 id="产品原型-1" tabindex="-1"><a class="header-anchor" href="#产品原型-1"><span>产品原型</span></a></h4><figure><img src="'+o+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p><strong>业务规则：</strong></p><ul><li>可以一次删除一个菜品，也可以批量删除菜品</li><li>起售中的菜品不能删除</li><li>被套餐关联的菜品不能删除</li><li>删除菜品后，关联的口味数据也需要删除掉</li></ul><h4 id="接口设计-delete" tabindex="-1"><a class="header-anchor" href="#接口设计-delete"><span>接口设计 <code>DELETE</code></span></a></h4><figure><img src="'+c+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="数据库设计" tabindex="-1"><a class="header-anchor" href="#数据库设计"><span>数据库设计</span></a></h4><ol><li>删除的菜品需要看是否被套餐关联 (setmeal_dish)</li><li>菜品删除对应的口味也要删除 (dish_flavor)</li></ol><figure><img src="'+l+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="代码开发-1" tabindex="-1"><a class="header-anchor" href="#代码开发-1"><span>代码开发</span></a></h4><h5 id="_1-controller层" tabindex="-1"><a class="header-anchor" href="#_1-controller层"><span>1. Controller层</span></a></h5><p><strong>根据删除菜品的接口定义在DishController中创建方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 菜品批量删除\n *\n * <span class="token keyword">@param</span> <span class="token parameter">ids</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token annotation punctuation">@DeleteMapping</span>\n<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;菜品批量删除&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;菜品批量删除：{}&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    dishService<span class="token punctuation">.</span><span class="token function">deleteBatch</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后绪步骤实现</span>\n    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-service层接口" tabindex="-1"><a class="header-anchor" href="#_2-service层接口"><span>2. <code>Service</code>层接口</span></a></h5><p><strong>在DishService接口中声明deleteBatch方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 菜品批量删除\n *\n * <span class="token keyword">@param</span> <span class="token parameter">ids</span>\n */</span>\n<span class="token keyword">void</span> <span class="token function">deleteBatch</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-service层实现类" tabindex="-1"><a class="header-anchor" href="#_2-service层实现类"><span>2. <code>Service</code>层实现类</span></a></h5><p><strong>在DishServiceImpl中实现deleteBatch方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>\n<span class="token keyword">private</span> <span class="token class-name">SetmealDishMapper</span> setMealDishMapper<span class="token punctuation">;</span>\n<span class="token doc-comment comment">/**\n * 菜品删除\n * <span class="token keyword">@param</span> <span class="token parameter">ids</span>\n */</span>\n<span class="token annotation punctuation">@Override</span>\n<span class="token annotation punctuation">@Transactional</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteBatch</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//判断当前菜品是否能够删除---是否存在起售中的菜品</span>\n  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id <span class="token operator">:</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Dish</span> dish <span class="token operator">=</span> dishMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StatusConstant</span><span class="token punctuation">.</span><span class="token constant">ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DeletionNotAllowedException</span><span class="token punctuation">(</span><span class="token class-name">MessageConstant</span><span class="token punctuation">.</span><span class="token constant">DISH_ON_SALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">//判断当前菜品是否能够删除---是否被套餐关联了</span>\n  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> setMealIds <span class="token operator">=</span> setMealDishMapper<span class="token punctuation">.</span><span class="token function">getSetMealIdsByDishIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span><span class="token punctuation">(</span>setMealIds <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setMealIds<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DeletionNotAllowedException</span><span class="token punctuation">(</span><span class="token class-name">MessageConstant</span><span class="token punctuation">.</span><span class="token constant">DISH_BE_RELATED_BY_SETMEAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">//删除菜品表中的菜品数据</span>\n  dishMapper<span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dishFlavorMapper<span class="token punctuation">.</span><span class="token function">deleteByDishIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-mapper层" tabindex="-1"><a class="header-anchor" href="#_3-mapper层"><span>3. <code>Mapper</code>层</span></a></h5><ol><li><code>dishMapper.getById</code></li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据主键查询菜品\n  *\n  * <span class="token keyword">@param</span> <span class="token parameter">id</span>\n  * <span class="token keyword">@return</span>\n  */</span>\n<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from dish where id = #{id}&quot;</span><span class="token punctuation">)</span>\n<span class="token class-name">Dish</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><code>setMealDishMapper</code> + <code>setMealDishMapper.getSetMealIdsByDishIds</code></li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>\n<span class="token annotation punctuation">@Mapper</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SetMealDishMapper</span> <span class="token punctuation">{</span>\n    <span class="token comment">// select id from setmeal_dish where dish_id in (x,x,x);</span>\n    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSetMealIdsByDishIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SetmealDishMapper.xml</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>\n<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>\n        <span class="token string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> <span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.sky.mapper.SetMealDishMapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getSetMealIdsByDishIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n        select setmeal_id from setmeal_dish where dish_id in\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ids<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n            #{id}\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p><code>dishMapper.deleteByIds</code></p><p>批量删除</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据菜品id列表批量删除\n * <span class="token keyword">@param</span> <span class="token parameter">ids</span>\n */</span>\n<span class="token keyword">void</span> <span class="token function">deleteByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deleteByIds<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n    delete from dish where id in\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ids<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n        #{id}\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>dishFlavorMapper.deleteByDishIds</code></p><p>批量删除</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">deleteByDishIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> setMealIds<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deleteByDishIds<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n    delete from dish_flavor where dish_id in\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>setMealIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n        #{id}\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_5-修改菜品" tabindex="-1"><a class="header-anchor" href="#_5-修改菜品"><span>5. 修改菜品</span></a></h3><h4 id="产品原型-2" tabindex="-1"><a class="header-anchor" href="#产品原型-2"><span>产品原型</span></a></h4><p>在菜品管理列表页面点击修改按钮，跳转到修改菜品页面，在修改页面回显菜品相关信息并进行修改，最后点击保存按钮完成修改操作。</p><figure><img src="'+i+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="接口设计-1" tabindex="-1"><a class="header-anchor" href="#接口设计-1"><span>接口设计</span></a></h4><p><strong>接口：</strong></p><ul><li>根据id查询菜品</li><li>根据类型查询分类(已实现)</li><li>文件上传(已实现)</li><li>修改菜品</li></ul><p>我们只需要实现<strong>根据id查询菜品</strong>和<strong>修改菜品</strong>两个接口，接下来，我们来重点分析这两个接口</p><h5 id="根据id查询菜品-admin-dish-id-get" tabindex="-1"><a class="header-anchor" href="#根据id查询菜品-admin-dish-id-get"><span>根据id查询菜品 <code>/admin/dish/{id}</code> GET</span></a></h5><figure><img src="'+u+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="修改菜品-admin-dish-put" tabindex="-1"><a class="header-anchor" href="#修改菜品-admin-dish-put"><span>修改菜品 <code>/admin/dish</code> PUT</span></a></h5><figure><img src="'+k+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="代码开发-——-根据id查询菜品" tabindex="-1"><a class="header-anchor" href="#代码开发-——-根据id查询菜品"><span>代码开发 —— 根据id查询菜品</span></a></h4><h5 id="controller层" tabindex="-1"><a class="header-anchor" href="#controller层"><span><code>Controller</code>层</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据id查询菜品\n *\n * <span class="token keyword">@param</span> <span class="token parameter">id</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;根据id查询菜品&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;根据id查询菜品：{}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">DishVO</span> dishVO <span class="token operator">=</span> dishService<span class="token punctuation">.</span><span class="token function">getByIdWithFlavor</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后绪步骤实现</span>\n  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>dishVO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="service层接口" tabindex="-1"><a class="header-anchor" href="#service层接口"><span><code>Service</code>层接口</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据id查询菜品和对应的口味数据\n *\n * <span class="token keyword">@param</span> <span class="token parameter">id</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token class-name">DishVO</span> <span class="token function">getByIdWithFlavor</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="service层实现类" tabindex="-1"><a class="header-anchor" href="#service层实现类"><span><code>Service</code>层实现类</span></a></h5><p><strong>在DishServiceImpl中实现getByIdWithFlavor方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据id查询菜品和对应的口味数据\n *\n * <span class="token keyword">@param</span> <span class="token parameter">id</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token keyword">public</span> <span class="token class-name">DishVO</span> <span class="token function">getByIdWithFlavor</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//根据id查询菜品数据</span>\n  <span class="token class-name">Dish</span> dish <span class="token operator">=</span> dishMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">//根据菜品id查询口味数据</span>\n  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishFlavor</span><span class="token punctuation">&gt;</span></span> dishFlavors <span class="token operator">=</span> dishFlavorMapper<span class="token punctuation">.</span><span class="token function">getByDishId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后绪步骤实现</span>\n\n  <span class="token comment">//将查询到的数据封装到VO</span>\n  <span class="token class-name">DishVO</span> dishVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DishVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>dish<span class="token punctuation">,</span> dishVO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dishVO<span class="token punctuation">.</span><span class="token function">setFlavors</span><span class="token punctuation">(</span>dishFlavors<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> dishVO<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="mapper层" tabindex="-1"><a class="header-anchor" href="#mapper层"><span>Mapper层</span></a></h5><p><strong>在DishFlavorMapper中声明getByDishId方法，并配置SQL：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据菜品id查询对应的口味数据\n * <span class="token keyword">@param</span> <span class="token parameter">dishId</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from dish_flavor where dish_id = #{dishId}&quot;</span><span class="token punctuation">)</span>\n<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishFlavor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getByDishId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> dishId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="代码开发-——-修改菜品" tabindex="-1"><a class="header-anchor" href="#代码开发-——-修改菜品"><span>代码开发 —— 修改菜品</span></a></h4><h5 id="controller层-1" tabindex="-1"><a class="header-anchor" href="#controller层-1"><span><code>Controller</code>层</span></a></h5><p>根据修改菜品的接口定义在DishController中创建方法</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 修改菜品\n * <span class="token keyword">@param</span> <span class="token parameter">dishDTO</span>\n * <span class="token keyword">@return</span>\n */</span>\n<span class="token annotation punctuation">@PutMapping</span>\n<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;修改菜品&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">DishDTO</span> dishDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;修改菜品: {}&quot;</span><span class="token punctuation">,</span> dishDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dishService<span class="token punctuation">.</span><span class="token function">updateWithFlavor</span><span class="token punctuation">(</span>dishDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="service层接口-1" tabindex="-1"><a class="header-anchor" href="#service层接口-1"><span><code>Service</code>层接口</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 修改菜品\n * <span class="token keyword">@param</span> <span class="token parameter">dishDTO</span>\n */</span>\n<span class="token keyword">void</span> <span class="token function">updateWithFlavor</span><span class="token punctuation">(</span><span class="token class-name">DishDTO</span> dishDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="service层实现类-1" tabindex="-1"><a class="header-anchor" href="#service层实现类-1"><span><code>Service</code>层实现类</span></a></h5><p>在DishServiceImpl中实现updateWithFlavor方法：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>\n<span class="token annotation punctuation">@Transactional</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateWithFlavor</span><span class="token punctuation">(</span><span class="token class-name">DishDTO</span> dishDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Dish</span> dish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>dishDTO<span class="token punctuation">,</span> dish<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 修改菜品基本信息</span>\n    dishMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>dish<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 删除原有口味</span>\n    dishFlavorMapper<span class="token punctuation">.</span><span class="token function">deleteByDishIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 重新插入口味数据</span>\n    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishFlavor</span><span class="token punctuation">&gt;</span></span> flavors <span class="token operator">=</span> dishDTO<span class="token punctuation">.</span><span class="token function">getFlavors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>flavors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flavors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        flavors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dishFlavor <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            dishFlavor<span class="token punctuation">.</span><span class="token function">setDishId</span><span class="token punctuation">(</span>dishDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">//向口味表插入n条数据</span>\n        dishFlavorMapper<span class="token punctuation">.</span><span class="token function">insertBatch</span><span class="token punctuation">(</span>flavors<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="mapper层-1" tabindex="-1"><a class="header-anchor" href="#mapper层-1"><span>Mapper层</span></a></h5><p><strong>在DishMapper中，声明update方法：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 根据id动态修改菜品数据\n *\n * <span class="token keyword">@param</span> <span class="token parameter">dish</span>\n */</span>\n<span class="token annotation punctuation">@AutoFill</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">OperationType</span><span class="token punctuation">.</span><span class="token constant">UPDATE</span><span class="token punctuation">)</span>\n<span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Dish</span> dish<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>并在DishMapper.xml文件中编写SQL:</strong></p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n  update dish\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>name = #{name},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>categoryId != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>category_id = #{categoryId},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>price = #{price},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>image = #{image},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>description != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>description = #{description},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>status = #{status},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateTime != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>update_time = #{updateTime},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateUser != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>update_user = #{updateUser},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>\n  where id = #{id}\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',101)],d={},v=(0,a(83671).A)(d,[["render",function(n,s){return(0,t.uX)(),(0,t.CE)("div",null,r)}]]),m=JSON.parse('{"path":"/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article6.html","title":"Javassm - item1-6 (菜品管理模块2)","lang":"zh-CN","frontmatter":{"title":"Javassm - item1-6 (菜品管理模块2)","date":"2025-11-03T00:00:00.000Z","category":["code"],"tag":["java_item"],"order":-0.6,"description":"菜品管理模块2 实现功能 公共字段自动填充 新增菜品 菜品分页查询 删除菜品 修改菜品 3. 菜品分页查询 产品原型 alt textalt text 在菜品列表展示时，除了菜品的基本信息(名称、售价、售卖状态、最后操作时间)外，还有两个字段略微特殊，第一个是图片字段，我们从数据库查询出来的仅仅是图片的名字，图片要想在表格中回显展示出来，就需要下载这个...","head":[["meta",{"property":"og:url","content":"http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article6.html"}],["meta",{"property":"og:site_name","content":"EkkoSonya\'s Blog"}],["meta",{"property":"og:title","content":"Javassm - item1-6 (菜品管理模块2)"}],["meta",{"property":"og:description","content":"菜品管理模块2 实现功能 公共字段自动填充 新增菜品 菜品分页查询 删除菜品 修改菜品 3. 菜品分页查询 产品原型 alt textalt text 在菜品列表展示时，除了菜品的基本信息(名称、售价、售卖状态、最后操作时间)外，还有两个字段略微特殊，第一个是图片字段，我们从数据库查询出来的仅仅是图片的名字，图片要想在表格中回显展示出来，就需要下载这个..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-04T09:56:28.000Z"}],["meta",{"property":"article:author","content":"EkkoSonya"}],["meta",{"property":"article:tag","content":"java_item"}],["meta",{"property":"article:published_time","content":"2025-11-03T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-04T09:56:28.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Javassm - item1-6 (菜品管理模块2)\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-11-03T00:00:00.000Z\\",\\"dateModified\\":\\"2025-11-04T09:56:28.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"EkkoSonya\\",\\"url\\":\\"http://ekkosonya.cn\\"}]}"]]},"headers":[{"level":2,"title":"菜品管理模块2","slug":"菜品管理模块2","link":"#菜品管理模块2","children":[{"level":3,"title":"实现功能","slug":"实现功能","link":"#实现功能","children":[]},{"level":3,"title":"3. 菜品分页查询","slug":"_3-菜品分页查询","link":"#_3-菜品分页查询","children":[{"level":4,"title":"产品原型","slug":"产品原型","link":"#产品原型","children":[]},{"level":4,"title":"接口设计","slug":"接口设计","link":"#接口设计","children":[]},{"level":4,"title":"代码开发","slug":"代码开发","link":"#代码开发","children":[{"level":5,"title":"1. 对应DTO设计","slug":"_1-对应dto设计","link":"#_1-对应dto设计","children":[]},{"level":5,"title":"2. 对应VO设计","slug":"_2-对应vo设计","link":"#_2-对应vo设计","children":[]},{"level":5,"title":"3. Controller层","slug":"_3-controller层","link":"#_3-controller层","children":[]},{"level":5,"title":"4. Service层接口","slug":"_4-service层接口","link":"#_4-service层接口","children":[]},{"level":5,"title":"4. Service层实现类","slug":"_4-service层实现类","link":"#_4-service层实现类","children":[]},{"level":5,"title":"5. Mapper层","slug":"_5-mapper层","link":"#_5-mapper层","children":[]}]}]},{"level":3,"title":"4. 删除菜品","slug":"_4-删除菜品","link":"#_4-删除菜品","children":[{"level":4,"title":"产品原型","slug":"产品原型-1","link":"#产品原型-1","children":[]},{"level":4,"title":"接口设计 DELETE","slug":"接口设计-delete","link":"#接口设计-delete","children":[]},{"level":4,"title":"数据库设计","slug":"数据库设计","link":"#数据库设计","children":[]},{"level":4,"title":"代码开发","slug":"代码开发-1","link":"#代码开发-1","children":[{"level":5,"title":"1. Controller层","slug":"_1-controller层","link":"#_1-controller层","children":[]},{"level":5,"title":"2. Service层接口","slug":"_2-service层接口","link":"#_2-service层接口","children":[]},{"level":5,"title":"2. Service层实现类","slug":"_2-service层实现类","link":"#_2-service层实现类","children":[]},{"level":5,"title":"3. Mapper层","slug":"_3-mapper层","link":"#_3-mapper层","children":[]}]}]},{"level":3,"title":"5. 修改菜品","slug":"_5-修改菜品","link":"#_5-修改菜品","children":[{"level":4,"title":"产品原型","slug":"产品原型-2","link":"#产品原型-2","children":[]},{"level":4,"title":"接口设计","slug":"接口设计-1","link":"#接口设计-1","children":[{"level":5,"title":"根据id查询菜品 /admin/dish/{id} GET","slug":"根据id查询菜品-admin-dish-id-get","link":"#根据id查询菜品-admin-dish-id-get","children":[]},{"level":5,"title":"修改菜品 /admin/dish PUT","slug":"修改菜品-admin-dish-put","link":"#修改菜品-admin-dish-put","children":[]}]},{"level":4,"title":"代码开发 —— 根据id查询菜品","slug":"代码开发-——-根据id查询菜品","link":"#代码开发-——-根据id查询菜品","children":[{"level":5,"title":"Controller层","slug":"controller层","link":"#controller层","children":[]},{"level":5,"title":"Service层接口","slug":"service层接口","link":"#service层接口","children":[]},{"level":5,"title":"Service层实现类","slug":"service层实现类","link":"#service层实现类","children":[]},{"level":5,"title":"Mapper层","slug":"mapper层","link":"#mapper层","children":[]}]},{"level":4,"title":"代码开发 —— 修改菜品","slug":"代码开发-——-修改菜品","link":"#代码开发-——-修改菜品","children":[{"level":5,"title":"Controller层","slug":"controller层-1","link":"#controller层-1","children":[]},{"level":5,"title":"Service层接口","slug":"service层接口-1","link":"#service层接口-1","children":[]},{"level":5,"title":"Service层实现类","slug":"service层实现类-1","link":"#service层实现类-1","children":[]},{"level":5,"title":"Mapper层","slug":"mapper层-1","link":"#mapper层-1","children":[]}]}]}]}],"git":{"createdTime":1762250188000,"updatedTime":1762250188000,"contributors":[{"name":"EkkoSonya","email":"ekkosonya@163.com","commits":1}]},"readingTime":{"minutes":6.76,"words":2027},"filePathRelative":"code/java_item/1-苍穹外卖/article6.md","localizedDate":"2025年11月3日","excerpt":"<h2>菜品管理模块2</h2>\\n<h3>实现功能</h3>\\n<ul>\\n<li>公共字段自动填充</li>\\n<li>新增菜品</li>\\n<li>菜品分页查询</li>\\n<li>删除菜品</li>\\n<li>修改菜品</li>\\n</ul>\\n<h3>3. 菜品分页查询</h3>\\n<h4>产品原型</h4>\\n<figure><figcaption>alt text</figcaption></figure>\\n<p>在菜品列表展示时，除了菜品的基本信息(名称、售价、售卖状态、最后操作时间)外，还有两个字段略微特殊，第一个是图片字段，我们从数据库查询出来的仅仅是图片的名字，图片要想在表格中回显展示出来，就需要下载这个图片。</p>","autoDesc":true}')},74732:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>y,data:()=>w});var t=a(7847);const p=a.p+"assets/img/22.0aa75b80.png",e=a.p+"assets/img/25.decd0806.png",o=a.p+"assets/img/26.5074fdcd.png",c=a.p+"assets/img/23.c3c12e73.png",l=a.p+"assets/img/24.b3a0da42.png",i=a.p+"assets/img/27.72bd716b.png",u=a.p+"assets/img/28.1d813336.png",k=a.p+"assets/img/29.10ee3f04.png",r=a.p+"assets/img/30.5e217244.png",d=a.p+"assets/img/31.a0fffa03.png",v=a.p+"assets/img/32.d25fb04e.png",m=a.p+"assets/img/33.97a0eeea.png",g=a.p+"assets/img/34.9af60d1a.png",b=a.p+"assets/img/35.b1a53bf7.png",h=[(0,t.Fv)('<h2 id="优惠卷秒杀" tabindex="-1"><a class="header-anchor" href="#优惠卷秒杀"><span>优惠卷秒杀</span></a></h2><h3 id="全局唯一id" tabindex="-1"><a class="header-anchor" href="#全局唯一id"><span>全局唯一ID</span></a></h3><p>每个店铺都可以发布优惠券 (也可以理解为商品)，当用户抢购时，就会生成订单并保存到<code>tb_voucher_order</code>这张表中，而订单表如果使用数据库自增ID就存在一些问题：</p><ul><li>id的规律性太明显</li><li>受单表数据量的限制</li></ul><p>场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，卖出了多少单，这明显不合适。</p><p>场景分析二：随着我们商城规模越来越大，mysql的单表的容量不宜超过500W，数据量过大之后，我们要进行拆库拆表，但拆分表了之后，他们从逻辑上讲他们是同一张表，所以他们的id是不能一样的， 于是乎我们需要保证id的唯一性。</p><h4 id="全局id生成器" tabindex="-1"><a class="header-anchor" href="#全局id生成器"><span>全局ID生成器</span></a></h4><p>是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性:</p><ul><li>唯一性</li><li>高性能</li><li>安全性</li><li>递增型</li><li>高可用</li></ul><p>为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：</p><figure><img src="'+p+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>ID的组成部分：符号位：1bit，永远为0</p><p>时间戳：31bit，以秒为单位，可以使用69年</p><p>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID</p><h4 id="全局唯一id生成策略" tabindex="-1"><a class="header-anchor" href="#全局唯一id生成策略"><span>全局唯一ID生成策略</span></a></h4><ul><li>UUID</li><li>Redis自增</li><li>snowflake算法</li><li>数据库自增</li></ul><h4 id="redis自增实现全局唯一id" tabindex="-1"><a class="header-anchor" href="#redis自增实现全局唯一id"><span>Redis自增实现全局唯一Id</span></a></h4><ul><li>每天一个key，方便统计订单量，避免可能的超出范围</li><li>ID构造是 时间戳 + 计数器</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{</span>\n  <span class="token doc-comment comment">/**\n   * 开始时间戳\n   */</span>\n  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">BEGIN_TIMESTAMP</span> <span class="token operator">=</span> <span class="token number">1735689600L</span><span class="token punctuation">;</span>\n\n  <span class="token doc-comment comment">/**\n   * 序列号的位数\n   */</span>\n  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>\n\n  <span class="token keyword">public</span> <span class="token class-name">RedisIdWorker</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 1.生成时间戳</span>\n      <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> <span class="token constant">BEGIN_TIMESTAMP</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 2.生成序列号</span>\n      <span class="token comment">// 2.1.获取当前日期，精确到天</span>\n      <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 2.2.自增长</span>\n      <span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 3.拼接并返回</span>\n      <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">|</span> count<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2025</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="测试-countdownlatch" tabindex="-1"><a class="header-anchor" href="#测试-countdownlatch"><span>测试 <code>CountDownLatch</code></span></a></h5><blockquote><p><code>countdownlatch</code>名为信号枪：主要的作用是同步协调在多线程的等待于唤醒问题</p><p>我们如果没有 <code>CountDownLatch</code>，那么由于程序是异步的，当异步程序没有执行完时，主线程就已经执行完了，然后我们期望的是分线程全部走完之后，主线程再走，所以我们此时需要使用到<code>CountDownLatch</code></p><p><code>CountDownLatch</code> 中有两个最重要的方法</p><p>1、countDown 2、await await 方法 是阻塞方法，我们担心分线程没有执行完时，main线程就先执行，所以使用await可以让main线程阻塞，那么什么时候main线程不再阻塞呢？ 当CountDownLatch 内部维护的变量变为0时，就不再阻塞，直接放行 那么什么时候CountDownLatch维护的变量变为0呢 我们只需要调用一次countDown ，内部变量就减少1，我们让分线程和变量绑定， 执行完一个分线程就减少一个变量，当分线程全部走完，<code>CountDownLatch</code>维护的变量就是0，此时await就不再阻塞，统计出来的时间也就是所有分线程执行完后的时间。</p></blockquote><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>\n<span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>\n<span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> es <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token annotation punctuation">@Test</span>\n<span class="token keyword">void</span> <span class="token function">testIdWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n  <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;id = &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      es<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time = &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-添加优惠卷" tabindex="-1"><a class="header-anchor" href="#_1-添加优惠卷"><span>1. 添加优惠卷</span></a></h3><p>每个店铺都可以发布优惠券，分为平价券和特价券。平价券可以任意购买，而特价券需要秒杀抢购</p><h4 id="数据库设计" tabindex="-1"><a class="header-anchor" href="#数据库设计"><span>数据库设计</span></a></h4><h5 id="tb-voucher" tabindex="-1"><a class="header-anchor" href="#tb-voucher"><span><code>tb_voucher</code></span></a></h5><p>(包含普通卷+秒杀券) 优惠券的基本信息，优惠金额、使用规则等</p><figure><img src="'+e+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="tb-seckill-voucher" tabindex="-1"><a class="header-anchor" href="#tb-seckill-voucher"><span><code>tb_seckill_voucher</code></span></a></h5><p>(秒杀券) 优惠券的库存、开始抢购时间，结束抢购时间。特价优惠券才需要填写这些信息</p><figure><img src="'+o+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>平价卷由于优惠力度并不是很大，所以是可以任意领取</p><p>而代金券由于优惠力度大，所以像第二种卷，就得限制数量，从表结构上也能看出，特价卷除了具有优惠卷的基本信息以外，还具有库存，抢购时间，结束时间等等字段</p><h3 id="_2-实现秒杀下单" tabindex="-1"><a class="header-anchor" href="#_2-实现秒杀下单"><span>2. 实现秒杀下单</span></a></h3><p>下单核心思路：当我们点击抢购时，会触发右侧的请求，我们只需要编写对应的controller即可</p><figure><img src="'+c+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="主要流程" tabindex="-1"><a class="header-anchor" href="#主要流程"><span>主要流程</span></a></h4><p>下单时需要判断两点：</p><ul><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单</li></ul><p>下单核心逻辑分析：</p><p>当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件</p><p>比如时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单到对应数据表 <code>tb_voucher_order</code>中，然后返回订单id，如果有一个条件不满足则直接结束</p><figure><img src="'+l+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="订单数据表-tb-voucher-order" tabindex="-1"><a class="header-anchor" href="#订单数据表-tb-voucher-order"><span>订单数据表 <code>tb_voucher_order</code></span></a></h4><figure><img src="'+i+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="代码实现" tabindex="-1"><a class="header-anchor" href="#代码实现"><span>代码实现</span></a></h4><h5 id="controller层" tabindex="-1"><a class="header-anchor" href="#controller层"><span><code>Controller</code>层</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/voucher-order&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderController</span> <span class="token punctuation">{</span>\n  <span class="token annotation punctuation">@Autowired</span>\n  <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> voucherOrderService<span class="token punctuation">;</span>\n\n  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;seckill/{id}&quot;</span><span class="token punctuation">)</span>\n  <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> voucherOrderService<span class="token punctuation">.</span><span class="token function">seckillVoucher</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="service层" tabindex="-1"><a class="header-anchor" href="#service层"><span><code>Service</code>层</span></a></h5><p>接口层 <code>IVoucherOrderService</code>：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVoucherOrderService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>\n  <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类 <code>VoucherOrderServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>\n  <span class="token annotation punctuation">@Autowired</span>\n  <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>\n\n  <span class="token annotation punctuation">@Autowired</span>\n  <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>\n\n  <span class="token annotation punctuation">@Override</span>\n  <span class="token annotation punctuation">@Transactional</span>\n  <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 查询优惠券</span>\n      <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 判断秒杀是否开始和结束</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀尚未开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已经结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 判断库存是否充足</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 扣减库存</span>\n      <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// voucher.setStock(voucher.getStock() - 1);</span>\n      <span class="token comment">// seckillVoucherService.updateById(voucher);</span>\n\n      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 创建订单</span>\n      <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 返回订单id</span>\n      <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-库存超卖问题分析" tabindex="-1"><a class="header-anchor" href="#_3-库存超卖问题分析"><span>3. 库存超卖问题分析</span></a></h3><p>有关超卖问题分析：在我们原有代码中是这么写的</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 库存不足</span>\n  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">//5，扣减库存</span>\n<span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//扣减库存</span>\n  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假设线程1过来查询库存，判断出来库存大于1，正准备去扣减库存，但是还没有来得及去扣减</p><p>此时线程2过来，线程2也去查询库存，发现这个数量一定也大于1，那么这两个线程都会去扣减库存，最终多个线程相当于一起去扣减库存，此时就会出现库存的超卖问题</p><figure><img src="'+u+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：</p><p>而对于加锁，通常有两种解决方案：</p><figure><img src="'+k+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="悲观锁" tabindex="-1"><a class="header-anchor" href="#悲观锁"><span>悲观锁</span></a></h4><p>悲观锁可以实现对于数据的串行化执行，比如syn，和lock都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等</p><h4 id="乐观锁" tabindex="-1"><a class="header-anchor" href="#乐观锁"><span>乐观锁</span></a></h4><p>乐观锁不是锁</p><h5 id="版本号法" tabindex="-1"><a class="header-anchor" href="#版本号法"><span>版本号法</span></a></h5><p>会有一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1, 如果大1，则进行操作成功</p><p>这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过</p><h5 id="cas-compareandswap" tabindex="-1"><a class="header-anchor" href="#cas-compareandswap"><span>CAS - CompareAndSwap</span></a></h5><p>当然乐观锁还有一些变种的处理方式比如cas</p><p>乐观锁的典型代表就是cas</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">int</span> var5<span class="token punctuation">;</span>\n<span class="token keyword">do</span> <span class="token punctuation">{</span>\n    var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var5 <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">return</span> var5<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>利用cas进行无锁化机制加锁，var5 是操作前读取的内存值，while中的var1+var2 是预估值，如果预估值 == 内存值，则代表中间没有被人修改过，此时就将新值去替换 内存值</p><p>其中do while 是为了在操作失败时，再次进行自旋操作，即把之前的逻辑再操作一次</p><h5 id="实际做法" tabindex="-1"><a class="header-anchor" href="#实际做法"><span>实际做法</span></a></h5><p>课程中的使用方式是没有像cas一样带自旋的操作，也没有对version的版本号+1</p><figure><img src="'+r+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>直接根据 stock 判断来代替 version，判断前后的 stock 是否被修改即可 (最终版本直接判断 stock &gt; 0 更高效)</p><h4 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h4><h5 id="乐观锁解决" tabindex="-1"><a class="header-anchor" href="#乐观锁解决"><span>乐观锁解决</span></a></h5><p>VoucherOrderServiceImpl 在扣减库存时，改为：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>\n      <span class="token comment">//set stock = stock -1</span>\n      <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">//where id = ？ and stock = ?</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上逻辑的核心含义是：只要我扣减库存时的库存和之前我查询到的库存是一样的，就意味着没有人在中间修改过库存，那么此时就是安全的</p><p>但是以上这种方式通过测试发现会有很多失败的情况，失败的原因在于：在使用乐观锁过程中假设<strong>100个线程同时都拿到了100的库存</strong>，然后大家一起去进行扣减，但是<strong>100个人中只有1个人能扣减成功</strong>，其他的人在处理时，他们在扣减时，库存已经被修改过了，所以此时其他线程<strong>都会失败</strong></p><figure><img src="'+d+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="调整乐观锁" tabindex="-1"><a class="header-anchor" href="#调整乐观锁"><span>调整乐观锁</span></a></h5><p>成功的概率太低，所以我们的乐观锁需要变一下，改成stock大于0 即可</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \n    <span class="token comment">//where id = ? and stock &gt; 0</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="'+v+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h4><figure><img src="'+m+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>也可以采用分批加锁(分段锁)，把相应资源分成几份，比如 100 库存分到10张表，每张10库存，提高成功率</p><h3 id="_4-一人一单" tabindex="-1"><a class="header-anchor" href="#_4-一人一单"><span>4. 一人一单</span></a></h3><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p><p><strong>现在的问题在于</strong></p><p>优惠卷是为了引流，但是目前的情况是，一个人可以无限制的抢这个优惠卷，所以我们应当增加一层逻辑，让一个用户只能下一个单，而不是让一个用户下多个单</p><p>具体操作逻辑如下：比如时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单</p><figure><img src="'+g+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="初步代码" tabindex="-1"><a class="header-anchor" href="#初步代码"><span>初步代码</span></a></h4><p><code>VoucherOrderServiceImpl</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 1.查询优惠券</span>\n    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 2.判断秒杀是否开始</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 尚未开始</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀尚未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 3.判断秒杀是否已经结束</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 尚未开始</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已经结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 4.判断库存是否充足</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 库存不足</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 5.一人一单逻辑</span>\n    <span class="token comment">// 5.1.用户id</span>\n    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 5.2.判断是否存在</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 用户已经购买过了</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户已经购买过一次！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">//6，扣减库存</span>\n    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">//扣减库存</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">//7.创建订单</span>\n    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 7.1.订单id</span>\n    <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 7.3.代金券id</span>\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="存在问题" tabindex="-1"><a class="header-anchor" href="#存在问题"><span>存在问题</span></a></h5><p>现在的问题还是和之前一样，并发过来，查询数据库，都不存在订单，所以我们还是需要加锁，但是乐观锁比较适合更新数据，而现在是插入数据，所以我们需要使用悲观锁操作</p><h4 id="悲观锁-synchronized" tabindex="-1"><a class="header-anchor" href="#悲观锁-synchronized"><span>悲观锁 synchronized</span></a></h4><p>首先提取方法后，如果直接方法加锁，意思所有用户都用一把锁，效率慢</p><p>所以采用 <code>userId.toString().intern()</code> 作为锁来解决</p><p>此外由于我们操作需要保证原子性，用到了事务 <code>@Transitional</code>，因此如果是在方法内加锁，当锁放开，数据库才会直接事务方法，此时就有可能另一个线程获得锁来进行操作，还是有并发的风险，所以不能在方法内加锁</p><p>并且，如果直接</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>是不行的，因为你调用的方法，其实是this.的方式调用的，事务想要生效，还得利用代理来生效，所以这个地方，我们需要获得原始的事务对象来操作事务，这样才能保证事务结束时才释放锁</p><p>最终:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 查询优惠券</span>\n    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 判断秒杀是否开始和结束</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀尚未开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已经结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 判断库存是否充足</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span>\n\n<span class="token annotation punctuation">@Transactional</span>\n<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 一人一单</span>\n    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户已购买&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 扣减库存</span>\n    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 创建订单</span>\n    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 返回订单id</span>\n    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="'+b+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="其他设置" tabindex="-1"><a class="header-anchor" href="#其他设置"><span>其他设置</span></a></h5><p>在 <code>pom.xml</code></p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在启动项 <code>HmDianPingApplication</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.hmdp.mapper&quot;</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@SpringBootApplication</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HmDianPingApplication</span> <span class="token punctuation">{</span>\n  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">HmDianPingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',119)],f={},y=(0,a(83671).A)(f,[["render",function(n,s){return(0,t.uX)(),(0,t.CE)("div",null,h)}]]),w=JSON.parse('{"path":"/code/java_item/2-hmdp/article6.html","title":"item2-6 (优惠券秒杀1)","lang":"zh-CN","frontmatter":{"title":"item2-6 (优惠券秒杀1)","category":["code"],"tag":["java_item"],"order":-0.6,"description":"优惠卷秒杀 全局唯一ID 每个店铺都可以发布优惠券 (也可以理解为商品)，当用户抢购时，就会生成订单并保存到tb_voucher_order这张表中，而订单表如果使用数据库自增ID就存在一些问题： id的规律性太明显 受单表数据量的限制 场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，...","head":[["meta",{"property":"og:url","content":"http://ekkosonya.cn/code/java_item/2-hmdp/article6.html"}],["meta",{"property":"og:site_name","content":"EkkoSonya\'s Blog"}],["meta",{"property":"og:title","content":"item2-6 (优惠券秒杀1)"}],["meta",{"property":"og:description","content":"优惠卷秒杀 全局唯一ID 每个店铺都可以发布优惠券 (也可以理解为商品)，当用户抢购时，就会生成订单并保存到tb_voucher_order这张表中，而订单表如果使用数据库自增ID就存在一些问题： id的规律性太明显 受单表数据量的限制 场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-07T17:25:35.000Z"}],["meta",{"property":"article:author","content":"EkkoSonya"}],["meta",{"property":"article:tag","content":"java_item"}],["meta",{"property":"article:modified_time","content":"2025-12-07T17:25:35.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"item2-6 (优惠券秒杀1)\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-12-07T17:25:35.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"EkkoSonya\\",\\"url\\":\\"http://ekkosonya.cn\\"}]}"]]},"headers":[{"level":2,"title":"优惠卷秒杀","slug":"优惠卷秒杀","link":"#优惠卷秒杀","children":[{"level":3,"title":"全局唯一ID","slug":"全局唯一id","link":"#全局唯一id","children":[{"level":4,"title":"全局ID生成器","slug":"全局id生成器","link":"#全局id生成器","children":[]},{"level":4,"title":"全局唯一ID生成策略","slug":"全局唯一id生成策略","link":"#全局唯一id生成策略","children":[]},{"level":4,"title":"Redis自增实现全局唯一Id","slug":"redis自增实现全局唯一id","link":"#redis自增实现全局唯一id","children":[{"level":5,"title":"测试 CountDownLatch","slug":"测试-countdownlatch","link":"#测试-countdownlatch","children":[]}]}]},{"level":3,"title":"1. 添加优惠卷","slug":"_1-添加优惠卷","link":"#_1-添加优惠卷","children":[{"level":4,"title":"数据库设计","slug":"数据库设计","link":"#数据库设计","children":[{"level":5,"title":"tb_voucher","slug":"tb-voucher","link":"#tb-voucher","children":[]},{"level":5,"title":"tb_seckill_voucher","slug":"tb-seckill-voucher","link":"#tb-seckill-voucher","children":[]}]}]},{"level":3,"title":"2. 实现秒杀下单","slug":"_2-实现秒杀下单","link":"#_2-实现秒杀下单","children":[{"level":4,"title":"主要流程","slug":"主要流程","link":"#主要流程","children":[]},{"level":4,"title":"订单数据表 tb_voucher_order","slug":"订单数据表-tb-voucher-order","link":"#订单数据表-tb-voucher-order","children":[]},{"level":4,"title":"代码实现","slug":"代码实现","link":"#代码实现","children":[{"level":5,"title":"Controller层","slug":"controller层","link":"#controller层","children":[]},{"level":5,"title":"Service层","slug":"service层","link":"#service层","children":[]}]}]},{"level":3,"title":"3. 库存超卖问题分析","slug":"_3-库存超卖问题分析","link":"#_3-库存超卖问题分析","children":[{"level":4,"title":"悲观锁","slug":"悲观锁","link":"#悲观锁","children":[]},{"level":4,"title":"乐观锁","slug":"乐观锁","link":"#乐观锁","children":[{"level":5,"title":"版本号法","slug":"版本号法","link":"#版本号法","children":[]},{"level":5,"title":"CAS - CompareAndSwap","slug":"cas-compareandswap","link":"#cas-compareandswap","children":[]},{"level":5,"title":"实际做法","slug":"实际做法","link":"#实际做法","children":[]}]},{"level":4,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[{"level":5,"title":"乐观锁解决","slug":"乐观锁解决","link":"#乐观锁解决","children":[]},{"level":5,"title":"调整乐观锁","slug":"调整乐观锁","link":"#调整乐观锁","children":[]}]},{"level":4,"title":"总结","slug":"总结","link":"#总结","children":[]}]},{"level":3,"title":"4. 一人一单","slug":"_4-一人一单","link":"#_4-一人一单","children":[{"level":4,"title":"初步代码","slug":"初步代码","link":"#初步代码","children":[{"level":5,"title":"存在问题","slug":"存在问题","link":"#存在问题","children":[]}]},{"level":4,"title":"悲观锁 synchronized","slug":"悲观锁-synchronized","link":"#悲观锁-synchronized","children":[{"level":5,"title":"其他设置","slug":"其他设置","link":"#其他设置","children":[]}]}]}]}],"git":{"createdTime":1765127830000,"updatedTime":1765128335000,"contributors":[{"name":"EkkoSonya","email":"ekkosonya@163.com","commits":2}]},"readingTime":{"minutes":11.68,"words":3504},"filePathRelative":"code/java_item/2-hmdp/article6.md","localizedDate":"2025年12月7日","excerpt":"<h2>优惠卷秒杀</h2>\\n<h3>全局唯一ID</h3>\\n<p>每个店铺都可以发布优惠券 (也可以理解为商品)，当用户抢购时，就会生成订单并保存到<code>tb_voucher_order</code>这张表中，而订单表如果使用数据库自增ID就存在一些问题：</p>\\n<ul>\\n<li>id的规律性太明显</li>\\n<li>受单表数据量的限制</li>\\n</ul>\\n<p>场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，卖出了多少单，这明显不合适。</p>\\n<p>场景分析二：随着我们商城规模越来越大，mysql的单表的容量不宜超过500W，数据量过大之后，我们要进行拆库拆表，但拆分表了之后，他们从逻辑上讲他们是同一张表，所以他们的id是不能一样的， 于是乎我们需要保证id的唯一性。</p>","autoDesc":true}')},63607:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>l,data:()=>i});var t=a(7847);const p=a.p+"assets/img/9.dff941ed.png";var e=a(82315);const o=[(0,t.Fv)('<p>实现大文件的分片上传、断点续传、文件合并以及文档解析功能</p><h2 id="目的" tabindex="-1"><a class="header-anchor" href="#目的"><span>目的</span></a></h2><ul><li>通过 Redis 和 MinIO 的结合，确保大文件上传的可靠性</li><li>并通过 Kafka 实现异步处理，进行文件解析等操作</li><li>模块支持多种文档格式（PDF、Word、Excel）的解析，并提取文本内容用于后续向量化处理</li><li>文本向量化通过调用阿里向量化 API 实现，生成的向量数据目前存储在 <code>Elasticsearch</code> 中，未来将同时支持 FAISS 存储</li></ul><h2 id="文件上传" tabindex="-1"><a class="header-anchor" href="#文件上传"><span>文件上传</span></a></h2><p>首先前端对于用户上传的文件，由前端来计算对应的MD5值 (分片读取 + 增量计算)</p><p>然后根据分片策略逻辑 (5MB 为一个 chunk)，基于此开始不断地发送分片上传请求(文件MD5, 分片索引以及分片数据)</p><p>后端不断接受传来的分片，先校验其完整性和合法性</p><p>然后将分片存储到 MinIO 中，对应的在 MinIO 的临时路径 <code>/temp/{fileMd5}/{chunkIndex}</code></p><p>之后在 Redis 上记录目前接受了哪些分片索引</p><p>然后将信息 (分片记录以及上传进度) 更新到 Mysql 的表内(chunk_info file_upload)</p><figure><img src="'+p+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>感觉前端那块处理的东西也有一些</p><h3 id="前端分析" tabindex="-1"><a class="header-anchor" href="#前端分析"><span>前端分析</span></a></h3><p>主要上传逻辑(点击保存按钮后)逻辑块 (在 views/knowledge-base/moudles/upload-dialog.vue 组件里)</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useKnowledgeBaseStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 表单校验 (必填项检查：组织标签、公开性、是否选了文件)</span>\n  <span class="token keyword">await</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 出现上传动画</span>\n  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将数据“扔”给 Pinia Store</span>\n  <span class="token comment">// 注意：这里传进去的 model.value 包含了 fileList (也就是文件本身)</span>\n  <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">enqueueUpload</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 上传成功</span>\n  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的上传逻辑就是在 <code>store.enqueueUpload(model.value)</code></p><p>具体保存在 <code>store/knowledge-base/index.ts</code></p><p>主要逻辑就是对于 <code>upload-dialog</code> 组件存的文件，先计算出 MD5 值，然后创建个上传任务，将文件大小以 5MB 为一个 chunk 进行切割，并限制一次可以并发传输的 chunk 数量来传输</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**\n * 异步函数：将上传请求加入队列\n *\n * 本函数处理上传任务的排队和初始化工作它首先检查是否存在相同的文件， 如果不存在，则创建一个新的上传任务，并将其添加到任务队列中最后启动上传流程\n *\n * <span class="token keyword">@param</span> <span class="token parameter">form</span> 包含上传信息的表单，包括文件列表和是否公开的标签\n * <span class="token keyword">@returns</span> 返回一个上传任务对象，无论是已存在的还是新创建的\n */</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">enqueueUpload</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">form</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>Form</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取文件列表中的第一个文件</span>\n  <span class="token keyword">const</span> file <span class="token operator">=</span> form<span class="token punctuation">.</span>fileList<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>file<span class="token operator">!</span><span class="token punctuation">;</span>\n  <span class="token comment">// 计算文件的MD5值，用于唯一标识文件</span>\n  <span class="token keyword">const</span> md5 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateMD5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 检查是否已存在相同文件</span>\n  <span class="token keyword">const</span> existingTask <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> md5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果存在相同文件，直接返回该上传任务</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>$message<span class="token operator">?.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;文件已存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Pending <span class="token operator">||</span> existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Uploading<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>$message<span class="token operator">?.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;文件正在上传中&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Break<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      existingTask<span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Pending<span class="token punctuation">;</span>\n      <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建新的上传任务对象</span>\n  <span class="token keyword">const</span> <span class="token literal-property property">newTask</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask <span class="token operator">=</span> <span class="token punctuation">{</span>\n    file<span class="token punctuation">,</span>\n    <span class="token literal-property property">chunk</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">chunkIndex</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> md5<span class="token punctuation">,</span>\n    <span class="token literal-property property">fileName</span><span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>\n    <span class="token literal-property property">totalSize</span><span class="token operator">:</span> file<span class="token punctuation">.</span>size<span class="token punctuation">,</span>\n    <span class="token literal-property property">isPublic</span><span class="token operator">:</span> form<span class="token punctuation">.</span>isPublic<span class="token punctuation">,</span>\n    <span class="token literal-property property">uploadedChunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">status</span><span class="token operator">:</span> UploadStatus<span class="token punctuation">.</span>Pending<span class="token punctuation">,</span>\n    <span class="token literal-property property">orgTag</span><span class="token operator">:</span> form<span class="token punctuation">.</span>orgTag\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  newTask<span class="token punctuation">.</span>orgTagName <span class="token operator">=</span> form<span class="token punctuation">.</span>orgTagName <span class="token operator">??</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将新的上传任务添加到任务队列中</span>\n  tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 启动上传流程</span>\n  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 返回新的上传任务</span>\n<span class="token punctuation">}</span>\n\n<span class="token doc-comment comment">/** 启动文件上传的异步函数 该函数负责从待上传队列中启动文件上传任务，并管理并发上传的数量 */</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 限制可同时上传的文件个数</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token comment">// 获取待上传的文件</span>\n  <span class="token keyword">const</span> pendingTasks <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n    <span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Pending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 如果没有待上传的文件，则直接返回</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingTasks<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 获取第一个待上传的文件</span>\n  <span class="token keyword">const</span> task <span class="token operator">=</span> pendingTasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  task<span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Uploading<span class="token punctuation">;</span>\n  activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算文件总片数</span>\n  <span class="token comment">// chunkSize = 5 * 1024 * 1024;</span>\n  <span class="token keyword">const</span> totalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>uploadedChunks<span class="token punctuation">.</span>length <span class="token operator">===</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;文件合并失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// const promises = [];</span>\n    <span class="token comment">// 遍历所有片数</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalChunks<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果未上传，则上传</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>uploadedChunks<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        task<span class="token punctuation">.</span>chunkIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>\n        <span class="token comment">// promises.push(uploadChunk(task))</span>\n        <span class="token comment">// eslint-disable-next-line no-await-in-loop</span>\n        <span class="token comment">// 主要逻辑，同时会检验当前文件是否已经传完</span>\n        <span class="token comment">// 如果全传了，那么会出发 merge</span>\n        <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;分片上传失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// await Promise.all(promises)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;%c [ 👉 upload error 👈 ]-168&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;font-size:16px; background:#94cc97; color:#d8ffdb;&#39;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果上传失败，则将任务状态设置为中断</span>\n    <span class="token keyword">const</span> index <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    tasks<span class="token punctuation">.</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Break<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 无论成功或失败，都从活跃队列中移除</span>\n    activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 继续下一个任务</span>\n    <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>具体的文件 chunk 上传 以及 merge 代码</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">task</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> totalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> chunkStart <span class="token operator">=</span> task<span class="token punctuation">.</span>chunkIndex <span class="token operator">*</span> chunkSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> chunkEnd <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>chunkStart <span class="token operator">+</span> chunkSize<span class="token punctuation">,</span> task<span class="token punctuation">.</span>totalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> chunk <span class="token operator">=</span> task<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>chunkStart<span class="token punctuation">,</span> chunkEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  task<span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> requestId <span class="token operator">=</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  task<span class="token punctuation">.</span>requestIds <span class="token operator">??=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  task<span class="token punctuation">.</span>requestIds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token operator">&lt;</span>Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>Progress<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/upload/chunk&#39;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">file</span><span class="token operator">:</span> task<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span>\n      <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">,</span>\n      <span class="token literal-property property">chunkIndex</span><span class="token operator">:</span> task<span class="token punctuation">.</span>chunkIndex<span class="token punctuation">,</span>\n      <span class="token literal-property property">totalSize</span><span class="token operator">:</span> task<span class="token punctuation">.</span>totalSize<span class="token punctuation">,</span>\n      <span class="token literal-property property">fileName</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>\n      <span class="token literal-property property">orgTag</span><span class="token operator">:</span> task<span class="token punctuation">.</span>orgTag<span class="token punctuation">,</span>\n      <span class="token literal-property property">isPublic</span><span class="token operator">:</span> task<span class="token punctuation">.</span>isPublic <span class="token operator">??</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token string-property property">&#39;Content-Type&#39;</span><span class="token operator">:</span> <span class="token string">&#39;multipart/form-data&#39;</span><span class="token punctuation">,</span>\n      <span class="token punctuation">[</span><span class="token constant">REQUEST_ID_KEY</span><span class="token punctuation">]</span><span class="token operator">:</span> requestId\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  task<span class="token punctuation">.</span>requestIds <span class="token operator">=</span> task<span class="token punctuation">.</span>requestIds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> id <span class="token operator">!==</span> requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 更新任务状态</span>\n  <span class="token keyword">const</span> updatedTask <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>\n  updatedTask<span class="token punctuation">.</span>uploadedChunks <span class="token operator">=</span> data<span class="token punctuation">.</span>uploaded<span class="token punctuation">;</span>\n  updatedTask<span class="token punctuation">.</span>progress <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>uploaded<span class="token punctuation">.</span>length <span class="token operator">===</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">task</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/upload/merge&#39;</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">,</span> <span class="token literal-property property">fileName</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileName <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 更新任务状态为已完成</span>\n    <span class="token keyword">const</span> index <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    tasks<span class="token punctuation">.</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的 文件MD5 计算逻辑 (utils/common.ts)：</p><p><code>spark-md5</code> 是一个第三方库，专门用于在浏览器端高效计算 MD5</p><p>支持增量计算，也就是说你可以喂给它一部分数据，它算出中间状态，然后你再喂下一部分，它接着算。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calculateMD5</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">file</span><span class="token operator">:</span> File</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 5MB</span>\n    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">loadNext</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> start <span class="token operator">=</span> currentChunk <span class="token operator">*</span> chunkSize<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>start <span class="token operator">+</span> chunkSize<span class="token punctuation">,</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token operator">?.</span>result <span class="token keyword">as</span> ArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      currentChunk <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    reader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;文件读取失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="后端分析" tabindex="-1"><a class="header-anchor" href="#后端分析"><span>后端分析</span></a></h3><p>前端会计算出上传文件的MD5，然后不断调用后端的 <code>/upload/chunk</code> 接口来传输文件，同时每次成功上传后，会检查是否已经传输完成，如果都传输完成，前端会调用 <code>/upload/merge</code> 接口触发后端的文件合并操作</p><p>文件上传主要涉及的是 <code>UploadController</code> 以及对应的 <code>Service</code>模块代码</p><p>分片上传接口：</p>',29),(0,t.Lk)("ul",null,[(0,t.Lk)("li",null,[(0,t.Lk)("p",null,[(0,t.eW)("URL: "),(0,t.Lk)("code",null,"/api/v1/upload/chunk")])]),(0,t.Lk)("li",null,[(0,t.Lk)("p",null,"Method: POST")]),(0,t.Lk)("li",{token:""},[(0,t.Lk)("p",null,"Headers: Bearer")]),(0,t.Lk)("li",null,[(0,t.Lk)("p",null,"Body: (multipart/form-data)"),(0,t.Lk)("div",{class:"language-http line-numbers-mode","data-ext":"http","data-title":"http"},[(0,t.Lk)("pre",{class:"language-http"},[(0,t.Lk)("code",null,[(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"fileMd5"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"d41d8cd98f00b204e9800998ecf8427e      // 文件MD5值（必需）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"chunkIndex"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"3                                  // 分片索引（必需）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"totalSize"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"15728640                            // 文件总大小（必需）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"fileName"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"年度报告.pdf                         // 文件名（必需，现在支持中文）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"totalChunks"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"64                               // 总分片数量（可选）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"orgTag"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"DEPT_A                                // 组织标签（可选，默认用户主组织标签）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"isPublic"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"true                                // 是否公开（可选，默认false）")]),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token header"},[(0,t.Lk)("span",{class:"token header-name keyword"},"file"),(0,t.Lk)("span",{class:"token punctuation"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token header-value"},"[分片二进制数据]                        // 分片文件数据（必需）")]),(0,t.eW)("\n")])]),(0,t.Lk)("div",{class:"line-numbers","aria-hidden":"true"},[(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"})])])]),(0,t.Lk)("li",null,[(0,t.Lk)("p",null,"Response"),(0,t.Lk)("div",{class:"language-json line-numbers-mode","data-ext":"json","data-title":"json"},[(0,t.Lk)("pre",{class:"language-json"},[(0,t.Lk)("code",null,[(0,t.eW)("\x3c!-- 成功 --\x3e\n"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token property"},'"code"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"200"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token property"},'"message"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"分片上传成功"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token property"},'"data"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token property"},'"uploaded"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"["),(0,t.Lk)("span",{class:"token number"},"0"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"1"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"2"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"3"),(0,t.Lk)("span",{class:"token punctuation"},"]"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token property"},'"progress"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"75.0"),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n\x3c!-- 失败 --\x3e\n"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token property"},'"code"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"500"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n  "),(0,t.Lk)("span",{class:"token property"},'"message"'),(0,t.Lk)("span",{class:"token operator"},":"),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"分片上传失败: 具体错误信息"'),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n")])]),(0,t.Lk)("div",{class:"line-numbers","aria-hidden":"true"},[(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"}),(0,t.Lk)("div",{class:"line-number"})])])])],-1),(0,t.Fv)('<h4 id="contorller层-uploadcontroller" tabindex="-1"><a class="header-anchor" href="#contorller层-uploadcontroller"><span>Contorller层 <code>UploadController</code></span></a></h4><p><code>UploadController/uploadChunk</code> - <code>/chunk</code>接口</p><p>来接受前端的分块文件，并实现文件保存记录</p><ul><li>如果是第一次传这个文件，会把总文件的基本信息保存在 <code>file_upload</code> 表</li><li>存 chunk 到 MinIO 指定临时路径</li><li>存 chunk 的基本信息到 <code>chunk_info</code> 表</li><li>接受完成，在 Redis 的标记 BitMap 对应位的值，作为成功上传</li></ul><h5 id="multipartfile-对象" tabindex="-1"><a class="header-anchor" href="#multipartfile-对象"><span><code>MultipartFile</code> 对象</span></a></h5><p>是 Spring Framework 中用于处理文件上传的核心接口：<code>org.springframework.web.multipart.MultipartFile</code></p><p>是 Spring 对“上传文件”这个概念的抽象</p><p>无论底层使用的是 Tomcat 的标准 Servlet API 还是 Apache Commons FileUpload，Spring 都会把上传的文件封装成这个 MultipartFile 对象让你使用</p><p>在 HTTP multipart/form-data 请求中，每一个<strong>文件部分</strong>（File Part）在 Java 代码中的对象映射</p><p>存在几个方法可以使用</p><ul><li><p>获取元数据：</p><ul><li><code>getName()</code>: 获取表单中 <code>&lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;</code> 的 name 属性值（表单字段名）</li><li><code>getOriginalFilename()</code>: 获取用户电脑上文件的原始名称（例如 photo.jpg）</li><li><code>getContentType()</code>: 获取文件的 MIME 类型（例如 image/jpeg）</li><li><code>getSize()</code>: 获取文件大小（字节数）</li></ul></li><li><p>读取文件内容：</p><ul><li><code>getBytes()</code>: 将文件内容一次性读入内存（byte[]）。注意：大文件慎用，容易导致内存溢出 (OOM)。</li><li><code>getInputStream()</code>: 获取输入流。这是处理大文件的推荐方式，可以流式读取。</li></ul></li><li><p>保存文件（最常用）：</p><ul><li><code>transferTo(File dest)</code>: 将上传的临时文件移动/写入到服务器磁盘上的指定位置。这是最方便的保存文件的方法。</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 1. 获取文件名</span>\n<span class="token class-name">String</span> fileName <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 2. 定义保存路径</span>\n<span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;/data/uploads/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 3. 保存文件 (核心方法调用)</span>\nfile<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h5 id="参数分析" tabindex="-1"><a class="header-anchor" href="#参数分析"><span>参数分析</span></a></h5><p>前面几个都是由前端传来的参数 包括了 文件的MD5 分片索引 文件总大小 文件名 总分片数量等</p><p>但还有一个参数是从 Attribute 获取的，这是由于在到 Controller 处理之前，会经过组织验证过滤器，成功会将 userId 塞到该请求的 Attribute 中</p><p>Spring 都会把上传的文件封装成这个 <code>MultipartFile</code> 对象来使用</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**\n * 上传文件分片接口\n *\n * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> 文件的MD5值，用于唯一标识文件\n * <span class="token keyword">@param</span> <span class="token parameter">chunkIndex</span> 分片索引，表示当前分片的位置\n * <span class="token keyword">@param</span> <span class="token parameter">totalSize</span> 文件总大小\n * <span class="token keyword">@param</span> <span class="token parameter">fileName</span> 文件名\n * <span class="token keyword">@param</span> <span class="token parameter">totalChunks</span> 总分片数量\n * <span class="token keyword">@param</span> <span class="token parameter">orgTag</span> 组织标签，如果未指定则使用用户的主组织标签\n * <span class="token keyword">@param</span> <span class="token parameter">isPublic</span> 是否公开，默认为false\n * <span class="token keyword">@param</span> <span class="token parameter">file</span> 分片文件对象\n * <span class="token keyword">@return</span> 返回包含已上传分片和上传进度的响应\n * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> 当文件读写发生错误时抛出\n */</span>\n<span class="token comment">// 其中 userId 参数是从 组织过滤器 中获取的</span>\n<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/chunk&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunkIndex&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;totalSize&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;totalChunks&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> totalChunks<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;orgTag&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;isPublic&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>\n        <span class="token annotation punctuation">@RequestAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="验证合理性" tabindex="-1"><a class="header-anchor" href="#验证合理性"><span>验证合理性</span></a></h5><p><code>fileTypeValidationService</code> | <code>userService</code></p><p>如果 <code>chunkIndex == 0</code> 说明是第一个分片，会调用 <code>fileTypeValidationService.validateFileType</code> 来判断文件类型是否能支持，进而返回一个 文件类型验证结果类 <code>FileTypeValidationResult</code></p><p>如果是不支持的类型 <code>!validationResult.isValid()</code>，进而就返回并通知前端</p><p>如果文件类型支持或者 <code>chunkIndex != 0</code> (文件没问题)，是否设置了文件属于哪个组织，即对应参数 <code>orgTag</code> 可选</p><p>当前端没有给定该参数，那么就需要给该文件默认一个组织参数 (当前用户的默认主组织)</p><p>通过 <code>userService.getUserPrimaryOrg(userId)</code> 获取，如果没有就报错，否则就将该文件属于该用户对应的主组织</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token comment">// 文件类型验证（仅在第一个分片时进行验证）</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token class-name">FileTypeValidationService<span class="token punctuation">.</span>FileTypeValidationResult</span> validationResult <span class="token operator">=</span> \n      fileTypeValidationService<span class="token punctuation">.</span><span class="token function">validateFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  \n  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;文件类型验证结果: fileName=%s, valid=%s, fileType=%s, message=%s&quot;</span><span class="token punctuation">,</span> \n          fileName<span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  \n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResult<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;文件类型验证失败: fileName=%s, fileType=%s&quot;</span><span class="token punctuation">,</span> \n              <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;文件类型验证失败: &quot;</span> <span class="token operator">+</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;fileType&quot;</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;supportedTypes&quot;</span><span class="token punctuation">,</span> fileTypeValidationService<span class="token punctuation">.</span><span class="token function">getSupportedFileTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">String</span> contentType <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;接收到分片上传请求: fileMd5=%s, chunkIndex=%d, fileName=%s, fileType=%s, contentType=%s, fileSize=%d, totalSize=%d, orgTag=%s, isPublic=%s&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 如果未指定组织标签，则获取用户的主组织标签</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>orgTag <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orgTag<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;组织标签未指定，尝试获取用户主组织标签: fileName=%s&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">String</span> primaryOrg <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserPrimaryOrg</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      orgTag <span class="token operator">=</span> primaryOrg<span class="token punctuation">;</span>\n      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;成功获取用户主组织标签: fileName=%s, orgTag=%s&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> orgTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;获取用户主组织标签失败: fileName=%s&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;获取主组织标签失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;获取用户主组织标签失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logFileOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> <span class="token string">&quot;PROCESSING&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="上传保存分块" tabindex="-1"><a class="header-anchor" href="#上传保存分块"><span>上传保存分块</span></a></h5><p><code>uploadService</code></p><p>当文件没问题，对应属于哪个组织也确定了，那么就可以上传了，调用 <code>uploadService.uploadChunk</code> 来实现</p><p>并通过 <code>uploadService.getUploadedChunks</code> 来获取成功上传的 chunk 之后可以返回前端</p><p>以及实际总 chunks <code>uploadService.getTotalChunks</code> 以及当前的进度 <code>double progress = calculateProgress(uploadedChunks, actualTotalChunks);</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>uploadService<span class="token punctuation">.</span><span class="token function">uploadChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> file<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getUploadedChunks</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> actualTotalChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getTotalChunks</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">double</span> progress <span class="token operator">=</span> <span class="token function">calculateProgress</span><span class="token punctuation">(</span>uploadedChunks<span class="token punctuation">,</span> actualTotalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;分片上传成功: fileMd5=%s, fileName=%s, fileType=%s, chunkIndex=%d, 进度=%.2f%%&quot;</span><span class="token punctuation">,</span> \n        fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmonitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;分片上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calculateProgress</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks<span class="token punctuation">,</span> <span class="token keyword">int</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>totalChunks <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">&quot;CALCULATE_PROGRESS&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;计算上传进度时总分片数为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> totalChunks <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="成功构建请求" tabindex="-1"><a class="header-anchor" href="#成功构建请求"><span>成功构建请求</span></a></h5><p>包含了已上传的 chunks 和 当前进度百分比</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 构建数据对象</span>\n<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ndata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;uploaded&quot;</span><span class="token punctuation">,</span> uploadedChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\ndata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;progress&quot;</span><span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 构建统一响应格式</span>\n<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nresponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nresponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;分片上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nresponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="异常捕获处理" tabindex="-1"><a class="header-anchor" href="#异常捕获处理"><span>异常捕获处理</span></a></h5><p>会捕获当前的异常，来设置请求返回</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">&quot;UPLOAD_CHUNK&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;分片上传失败: fileMd5=%s, fileName=%s, fileType=%s, chunkIndex=%d&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;分片上传失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;分片上传失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="service层-—-uploadservice" tabindex="-1"><a class="header-anchor" href="#service层-—-uploadservice"><span>Service层 — <code>UploadService</code></span></a></h4><p>主要是 <code>UploadService</code>，但也有 <code>fileTypeValidationService</code> 和 <code>userService</code></p><p>重点分析 <code>UploadService</code> 的 <code>uploadChunk</code>方法</p><h5 id="主要参数" tabindex="-1"><a class="header-anchor" href="#主要参数"><span>主要参数</span></a></h5><p>主要就是文件相关的信息以及用户信息</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 上传文件分片\n *\n * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> 文件的 MD5 值，用于唯一标识文件\n * <span class="token keyword">@param</span> <span class="token parameter">chunkIndex</span> 分片索引，表示这是文件的第几个分片\n * <span class="token keyword">@param</span> <span class="token parameter">totalSize</span> 文件总大小\n * <span class="token keyword">@param</span> <span class="token parameter">fileName</span> 文件名称\n * <span class="token keyword">@param</span> <span class="token parameter">file</span> 要上传的分片文件\n * <span class="token keyword">@param</span> <span class="token parameter">orgTag</span> 组织标签，指定文件所属的组织\n * <span class="token keyword">@param</span> <span class="token parameter">isPublic</span> 是否公开，标识文件访问权限\n * <span class="token keyword">@param</span> <span class="token parameter">userId</span> 上传用户ID\n * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> 如果文件读取失败\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="主要步骤" tabindex="-1"><a class="header-anchor" href="#主要步骤"><span>主要步骤</span></a></h5><ul><li><p>检查分块对应的文件元信息是否存入 <code>file_upload</code> 表中；不在需要插入信息</p></li><li><p>检查分块是否已经上传过了 <code>isChunkUploaded(fileMd5, chunkIndex, userId)</code></p><p>分块上传信息保存在 redis 缓存中 (BitMap)</p><p>key: <code>&quot;upload:&quot; + userId + &quot;:&quot; + fileMd5</code></p><p><code>boolean isUploaded = redisTemplate.opsForValue().getBit(redisKey, chunkIndex);</code></p><p>对应返回判断 <code>chunkUploaded</code></p></li><li><p>检查分块的元信息是否存入 <code>chunk_info</code> 表中，先进行判断 <code>chunkInfoExists</code></p></li><li><p>根据 <code>chunkUploaded</code> 判断是否已经上传</p><ul><li>如果上传了，那么判断 <code>chunkInfoExists</code> 元信息是否存在数据库 <ul><li>如果分片已上传但数据库中不存在记录，需要创建记录</li><li>并检查MinIO中是否存在该分片</li><li>如果MinIO中不存在，将chunkUploaded设为false以触发上传流程</li></ul></li></ul></li><li><p>进而，进入分块未上传逻辑 <code>!chunkUploaded</code></p><ul><li>先计算 chunk 的 MD5 (chunkMd5) || 已知其总文件的 MD5 (fileMd5)</li><li>构建分片的存储路径 <code>storagePath = &quot;chunks/&quot; + fileMd5 + &quot;/&quot; + chunkIndex;</code></li><li>存储到 MinIO, 路径为 <code>storagePath</code>, bucket 为 <code>uploads</code></li><li>如果成功了，标记已上传 <ul><li>去 Redis 对应的 BitMap 位(chunkIndex)设为 true</li></ul></li></ul></li><li><p>不管分片是否已上传，都确保数据库中有分片信息 <code>(!chunkInfoExists &amp;&amp; chunkMd5 != null &amp;&amp; storagePath != null)</code></p><ul><li><p>保存 chunk 元信息到 <code>chunk_info</code> 表中</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token function">saveChunkInfo</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul></li></ul><h5 id="检查文件元信息是否保存file-upload-表中" tabindex="-1"><a class="header-anchor" href="#检查文件元信息是否保存file-upload-表中"><span>检查文件元信息是否保存<code>file_upload</code> 表中</span></a></h5><p>在 <code>file_upload</code> 表中元数据包括</p><ul><li>fileMd5 (文件的MD5)</li><li>fileName (文件的原始名称)</li><li>totalSize (文件的总大小)</li><li>status (文件上传的状态 0表示文件正在上传中，1表示文件上传已完成)</li><li>userId (上传文件的用户的标识符)</li><li>orgTag (文件所属组织标签)</li><li>isPublic (文件是否公开)</li><li>createdAt</li><li>mergeAt</li></ul><p>对应的 Repository 为 <code>FileUploadRepository</code></p><p>先根据文件的MD5值去 <code>file_upload</code> 表中检查是否已经保存了 <code>fileUploadRepository.findByFileMd5AndUserId(fileMd5, userId).isPresent()</code></p><p>如果表内没有数据，那么就需要把该chunk对应的文件信息存入 <code>file_upload</code> 表中</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取文件类型信息</span>\n  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">String</span> contentType <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  \n  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[uploadChunk] 开始处理分片上传请求 =&gt; fileMd5: {}, chunkIndex: {}, totalSize: {}, fileName: {}, fileType: {}, contentType: {}, fileSize: {}, orgTag: {}, isPublic: {}, userId: {}&quot;</span><span class="token punctuation">,</span> \n              fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  \n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 检查 file_upload 表中是否存在该 file_md5</span>\n    <span class="token keyword">boolean</span> fileExists <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;检查文件记录是否存在 =&gt; fileMd5: {}, fileName: {}, fileType: {}, exists: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> fileExists<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建新的文件记录 =&gt; fileMd5: {}, fileName: {}, fileType: {}, totalSize: {}, userId: {}, orgTag: {}, isPublic: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 插入 file_upload 表</span>\n      <span class="token class-name">FileUpload</span> fileUpload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setFileMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件名可以从请求中获取</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setTotalSize</span><span class="token punctuation">(</span>totalSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件总大小</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 表示上传中</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置上传用户ID</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setOrgTag</span><span class="token punctuation">(</span>orgTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置组织标签</span>\n      fileUpload<span class="token punctuation">.</span><span class="token function">setPublic</span><span class="token punctuation">(</span>isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置是否公开</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        fileUploadRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>fileUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;文件记录创建成功 =&gt; fileMd5: {}, fileName: {}, fileType: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;创建文件记录失败 =&gt; fileMd5: {}, fileName: {}, fileType: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;创建文件记录失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n  <span class="token punctuation">}</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="检查分片是否上传-redis内缓存" tabindex="-1"><a class="header-anchor" href="#检查分片是否上传-redis内缓存"><span>检查分片是否上传 (Redis内缓存)</span></a></h5><p>将文件的分片上传信息存在 Redis 的BitMap中，对应位的信息 == chunkIndex是否成功上传</p><p><code>redisKey = &quot;upload:&quot; + userId + &quot;:&quot; + fileMd5;</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">boolean</span> chunkUploaded <span class="token operator">=</span> <span class="token function">isChunkUploaded</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\nlogger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;检查分片是否已上传 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, isUploaded: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkUploaded<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的 <code>isChunkUploaded</code> 函数</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isChunkUploaded</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;检查分片是否已上传 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;无效的分片索引 =&gt; fileMd5: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;chunkIndex must be non-negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">&quot;upload:&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>\n    <span class="token keyword">boolean</span> isUploaded <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;分片上传状态 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, isUploaded: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> isUploaded<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> isUploaded<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;检查分片上传状态失败 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 或者根据业务需求返回其他值</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="检查分片元信息是否保存在-chunk-info-表中" tabindex="-1"><a class="header-anchor" href="#检查分片元信息是否保存在-chunk-info-表中"><span>检查分片元信息是否保存在 <code>chunk_info</code> 表中</span></a></h5><p><code>chunk_info</code>表中存储的字段主要包括</p><ul><li>id (分块信息的唯一标识符 由数据库自动生成，用于唯一确定一个分块信息)</li><li>fileMd5 (文件的MD5, 同个文件的不同chunk的文件MD5都是一样的)</li><li>chunkIndex (表示文件中的第几个分块，用于保持分块的顺序)</li><li>chunkMd5 (分块的MD5值, 每个分块的唯一标识，用于校验分块的完整性和正确性)</li><li>storagePath (分块的存储路径, 对应MinIO的存储, 表示分块在系统中的存储位置，可以是绝对路径或相对路径)</li></ul><p>根据 fileMd5 去 <code>chunk_info</code> 中获取该文件的所有已保存的chunk的信息，然后遍历判断当前chunk是否保存</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 检查数据库中是否存在分片信息</span>\n<span class="token keyword">boolean</span> chunkInfoExists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token keyword">try</span> <span class="token punctuation">{</span>\n  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChunkInfo</span><span class="token punctuation">&gt;</span></span> chunkInfos <span class="token operator">=</span> chunkInfoRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5OrderByChunkIndexAsc</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  chunkInfoExists <span class="token operator">=</span> chunkInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>chunk <span class="token operator">-&gt;</span> chunk<span class="token punctuation">.</span><span class="token function">getChunkIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;检查数据库中分片信息 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, exists: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkInfoExists<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;检查数据库中分片信息失败 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 失败时假设不存在，继续处理</span>\n  chunkInfoExists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="根据-chunkupload-和-chunkinfoexists-结果来处理分片保存逻辑" tabindex="-1"><a class="header-anchor" href="#根据-chunkupload-和-chunkinfoexists-结果来处理分片保存逻辑"><span>根据 <code>chunkUpload</code> 和 <code>chunkInfoExists</code> 结果来处理分片保存逻辑</span></a></h5><h5 id="若-redis-已记录文件上传-但表中没数据" tabindex="-1"><a class="header-anchor" href="#若-redis-已记录文件上传-但表中没数据"><span>若 Redis 已记录文件上传，但表中没数据</span></a></h5><p>如果分片已上传但数据库中不存在记录，需要去表里创建记录</p><p>首先先基于对应 MinIO 的路径 <code>storagePath = &quot;chunks/&quot; + fileMd5 + &quot;/&quot; + chunkIndex;</code></p><p>进一步去查找是否存储，如果MinIO中不存在，将chunkUploaded设为false</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">String</span> chunkMd5 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token class-name">String</span> storagePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkUploaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;分片已在Redis中标记为已上传 =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  \n  <span class="token comment">// 如果分片已上传但数据库中不存在记录，需要创建记录</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkInfoExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片已上传但数据库无记录，需要补充分片信息 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n      <span class="token comment">// 计算分片的MD5值</span>\n      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      chunkMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n      <span class="token comment">// 构建存储路径</span>\n      storagePath <span class="token operator">=</span> <span class="token string">&quot;chunks/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>\n      \n      <span class="token comment">// 检查MinIO中是否存在该分片</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n          <span class="token class-name">StatObjectResponse</span> stat <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">statObject</span><span class="token punctuation">(</span>\n              <span class="token class-name">StatObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;uploads&quot;</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span>\n                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;MinIO中存在分片文件 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, path: {}, size: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> storagePath<span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MinIO中不存在分片文件，需要重新上传 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token comment">// 如果MinIO中不存在，将chunkUploaded设为false以触发上传流程</span>\n          chunkUploaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片已上传且数据库有记录，跳过处理 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 完全跳过处理</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="redis-未记录且表内无数据-—-上传chunk至minio" tabindex="-1"><a class="header-anchor" href="#redis-未记录且表内无数据-—-上传chunk至minio"><span>Redis 未记录且表内无数据 — 上传chunk至MinIO</span></a></h5><p>经过上面的逻辑，即使 Redis 有数据但表中无数据，且发现 MinIO 没存，就把 <code>chunkUploaded</code> 设为 false，从而可以触发下面的逻辑</p><p>成功保存到 MinIO 中后，再将 Redis 对应的 chunkIndex 为设为 true</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 如果分片未上传或需要重新上传</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkUploaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 计算分片的 MD5 值</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;计算分片MD5 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  chunkMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;分片MD5计算完成 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, chunkMd5: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n              \n  <span class="token comment">// 构建分片的存储路径</span>\n  storagePath <span class="token operator">=</span> <span class="token string">&quot;chunks/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;构建分片存储路径 =&gt; fileName: {}, path: {}&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 存储到 MinIO</span>\n    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始上传分片到MinIO =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}, bucket: uploads, path: {}, size: {}, contentType: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> storagePath<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    <span class="token class-name">PutObjectArgs</span> putObjectArgs <span class="token operator">=</span> <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;uploads&quot;</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>putObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片上传到MinIO成功 =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;分片上传到MinIO失败 =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}, 错误类型: {}, 错误信息: {}&quot;</span><span class="token punctuation">,</span> \n              fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    <span class="token comment">// 详细记录不同类型的MinIO错误</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span> ere <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>\n        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;MinIO错误响应详情 =&gt; fileName: {}, code: {}, message: {}, resource: {}, requestId: {}&quot;</span><span class="token punctuation">,</span> \n                  fileName<span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \n                  ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    \n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;上传分片到MinIO失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 标记分片已上传</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;标记分片为已上传 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">markChunkUploaded</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;分片标记完成 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;标记分片已上传失败 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 这里不抛出异常，因为分片已经上传成功，即使标记失败也不影响后续操作</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应在 Redis 记录文件成功上传逻辑</p><p>如果是第一次保存（Key 不存在），Redis 会创建一个刚好能容纳下这个 chunkIndex 的字节数组（String）</p><p>Redis 底层通过 Byte（字节） 来存储 Bitmap（位图），1 Byte = 8 Bits</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markChunkUploaded</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;标记分片为已上传 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;无效的分片索引 =&gt; fileMd5: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;chunkIndex must be non-negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">&quot;upload:&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>\n    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;分片已标记为已上传 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;标记分片为已上传失败 =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to mark chunk as uploaded&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="最后保存-chunk-元信息至-chunk-info-表内" tabindex="-1"><a class="header-anchor" href="#最后保存-chunk-元信息至-chunk-info-表内"><span>最后保存 chunk 元信息至 <code>chunk_info</code> 表内</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 不管分片是否已上传，都确保数据库中有分片信息</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkInfoExists <span class="token operator">&amp;&amp;</span> chunkMd5 <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> storagePath <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存分片信息到数据库 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, chunkMd5: {}, storagePath: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">saveChunkInfo</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片信息已保存到数据库 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;保存分片信息到数据库失败 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;保存分片信息失败: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nlogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片处理完成 =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的保存逻辑 <code>ChunkInfoRepository</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveChunkInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> chunkMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> storagePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存分片信息到数据库 =&gt; fileMd5: {}, chunkIndex: {}, chunkMd5: {}, storagePath: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token class-name">ChunkInfo</span> chunkInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    chunkInfo<span class="token punctuation">.</span><span class="token function">setFileMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    chunkInfo<span class="token punctuation">.</span><span class="token function">setChunkIndex</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    chunkInfo<span class="token punctuation">.</span><span class="token function">setChunkMd5</span><span class="token punctuation">(</span>chunkMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    chunkInfo<span class="token punctuation">.</span><span class="token function">setStoragePath</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    chunkInfoRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>chunkInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;分片信息已保存 =&gt; fileMd5: {}, chunkIndex: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;保存分片信息失败 =&gt; fileMd5: {}, chunkIndex: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> \n              fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save chunk info&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="uploadservice-getuploadedchunks-获取成功上传的chunk索引" tabindex="-1"><a class="header-anchor" href="#uploadservice-getuploadedchunks-获取成功上传的chunk索引"><span><code>uploadService.getUploadedChunks</code> 获取成功上传的chunk索引</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUploadedChunks</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取已上传分片列表 =&gt; fileMd5: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 优化：一次性获取所有分片状态</span>\n      <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">&quot;upload:&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>\n      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmapData <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n      <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Redis中无分片状态记录 =&gt; fileMd5: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span> uploadedChunks<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      \n      <span class="token comment">// 解析bitmap，找出已上传的分片</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> chunkIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> chunkIndex <span class="token operator">&lt;</span> totalChunks<span class="token punctuation">;</span> chunkIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBitSet</span><span class="token punctuation">(</span>bitmapData<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              uploadedChunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      \n      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取到已上传分片列表 =&gt; fileMd5: {}, userId: {}, 已上传数量: {}, 总分片数: {}, 优化方式: 一次性获取&quot;</span><span class="token punctuation">,</span> \n                fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> uploadedChunks<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取已上传分片列表失败 =&gt; fileMd5: {}, userId: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get uploaded chunks&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="redistemplate-execute-解析" tabindex="-1"><a class="header-anchor" href="#redistemplate-execute-解析"><span><code>redisTemplate.execute()</code>解析</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExposeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Execute 方法 (<code>connection.get(keyBytes)</code>)：直接给你返回 byte[]</p><p>对于 Bitmap（位图）操作，我们需要的就是原始的二进制字节，不需要 Spring 把它转成乱码字符串</p><p>他的参数是一个 <code>RedisCallback&lt;T&gt;</code> 接口，需要实现 <code>doInRedis</code> 方法，其参数是 <code>RedisConnection connection</code>, 直接拿到最底层的 Redis 连接（Connection） 进行操作</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>\n  <span class="token annotation punctuation">@Nullable</span>\n  <span class="token class-name">T</span> <span class="token function">doInRedis</span><span class="token punctuation">(</span><span class="token class-name">RedisConnection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以这里是</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmapData <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从而避免Spring 的层层封装，根据你配置的序列化器（比如 Jackson/JSON）转成一个 Java 对象或字符串</p><h5 id="uploadservice-gettotalchunks-获取文件的总-chunk-数量" tabindex="-1"><a class="header-anchor" href="#uploadservice-gettotalchunks-获取文件的总-chunk-数量"><span><code>uploadService.getTotalChunks</code> 获取文件的总 chunk 数量</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotalChunks</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;计算文件总分片数 =&gt; fileMd5: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileUpload</span><span class="token punctuation">&gt;</span></span> fileUpload <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileUpload<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;文件记录不存在，无法计算分片数 =&gt; fileMd5: {}, userId: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    \n    <span class="token keyword">long</span> totalSize <span class="token operator">=</span> fileUpload<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 默认每个分片5MB</span>\n    <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>\n    <span class="token keyword">int</span> totalChunks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;文件总分片数计算结果 =&gt; fileMd5: {}, userId: {}, totalSize: {}, chunkSize: {}, totalChunks: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> totalChunks<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;计算文件总分片数失败 =&gt; fileMd5: {}, userId: {}, 错误: {}&quot;</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to calculate total chunks&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文件合并" tabindex="-1"><a class="header-anchor" href="#文件合并"><span>文件合并</span></a></h4><p>会自动触发，应该是每次成功上传完分片会检查是否全部完成了</p><figure><img src="'+e+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure>',97)],c={},l=(0,a(83671).A)(c,[["render",function(n,s){return(0,t.uX)(),(0,t.CE)("div",null,o)}]]),i=JSON.parse('{"path":"/code/java_item/3-smart/article6.html","title":"item3 - 6 文件上传解析模块2","lang":"zh-CN","frontmatter":{"title":"item3 - 6 文件上传解析模块2","category":["code"],"tag":["java_item","PaiSmart"],"order":-0.6,"description":"实现大文件的分片上传、断点续传、文件合并以及文档解析功能 目的 通过 Redis 和 MinIO 的结合，确保大文件上传的可靠性 并通过 Kafka 实现异步处理，进行文件解析等操作 模块支持多种文档格式（PDF、Word、Excel）的解析，并提取文本内容用于后续向量化处理 文本向量化通过调用阿里向量化 API 实现，生成的向量数据目前存储在 Ela...","head":[["meta",{"property":"og:url","content":"http://ekkosonya.cn/code/java_item/3-smart/article6.html"}],["meta",{"property":"og:site_name","content":"EkkoSonya\'s Blog"}],["meta",{"property":"og:title","content":"item3 - 6 文件上传解析模块2"}],["meta",{"property":"og:description","content":"实现大文件的分片上传、断点续传、文件合并以及文档解析功能 目的 通过 Redis 和 MinIO 的结合，确保大文件上传的可靠性 并通过 Kafka 实现异步处理，进行文件解析等操作 模块支持多种文档格式（PDF、Word、Excel）的解析，并提取文本内容用于后续向量化处理 文本向量化通过调用阿里向量化 API 实现，生成的向量数据目前存储在 Ela..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-20T14:17:03.000Z"}],["meta",{"property":"article:author","content":"EkkoSonya"}],["meta",{"property":"article:tag","content":"java_item"}],["meta",{"property":"article:tag","content":"PaiSmart"}],["meta",{"property":"article:modified_time","content":"2026-01-20T14:17:03.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"item3 - 6 文件上传解析模块2\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-01-20T14:17:03.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"EkkoSonya\\",\\"url\\":\\"http://ekkosonya.cn\\"}]}"]]},"headers":[{"level":2,"title":"目的","slug":"目的","link":"#目的","children":[]},{"level":2,"title":"文件上传","slug":"文件上传","link":"#文件上传","children":[{"level":3,"title":"前端分析","slug":"前端分析","link":"#前端分析","children":[]},{"level":3,"title":"后端分析","slug":"后端分析","link":"#后端分析","children":[{"level":4,"title":"Contorller层 UploadController","slug":"contorller层-uploadcontroller","link":"#contorller层-uploadcontroller","children":[{"level":5,"title":"MultipartFile 对象","slug":"multipartfile-对象","link":"#multipartfile-对象","children":[]},{"level":5,"title":"参数分析","slug":"参数分析","link":"#参数分析","children":[]},{"level":5,"title":"验证合理性","slug":"验证合理性","link":"#验证合理性","children":[]},{"level":5,"title":"上传保存分块","slug":"上传保存分块","link":"#上传保存分块","children":[]},{"level":5,"title":"成功构建请求","slug":"成功构建请求","link":"#成功构建请求","children":[]},{"level":5,"title":"异常捕获处理","slug":"异常捕获处理","link":"#异常捕获处理","children":[]}]},{"level":4,"title":"Service层 — UploadService","slug":"service层-—-uploadservice","link":"#service层-—-uploadservice","children":[{"level":5,"title":"主要参数","slug":"主要参数","link":"#主要参数","children":[]},{"level":5,"title":"主要步骤","slug":"主要步骤","link":"#主要步骤","children":[]},{"level":5,"title":"检查文件元信息是否保存file_upload 表中","slug":"检查文件元信息是否保存file-upload-表中","link":"#检查文件元信息是否保存file-upload-表中","children":[]},{"level":5,"title":"检查分片是否上传 (Redis内缓存)","slug":"检查分片是否上传-redis内缓存","link":"#检查分片是否上传-redis内缓存","children":[]},{"level":5,"title":"检查分片元信息是否保存在 chunk_info 表中","slug":"检查分片元信息是否保存在-chunk-info-表中","link":"#检查分片元信息是否保存在-chunk-info-表中","children":[]},{"level":5,"title":"根据 chunkUpload 和 chunkInfoExists 结果来处理分片保存逻辑","slug":"根据-chunkupload-和-chunkinfoexists-结果来处理分片保存逻辑","link":"#根据-chunkupload-和-chunkinfoexists-结果来处理分片保存逻辑","children":[]},{"level":5,"title":"若 Redis 已记录文件上传，但表中没数据","slug":"若-redis-已记录文件上传-但表中没数据","link":"#若-redis-已记录文件上传-但表中没数据","children":[]},{"level":5,"title":"Redis 未记录且表内无数据 — 上传chunk至MinIO","slug":"redis-未记录且表内无数据-—-上传chunk至minio","link":"#redis-未记录且表内无数据-—-上传chunk至minio","children":[]},{"level":5,"title":"最后保存 chunk 元信息至 chunk_info 表内","slug":"最后保存-chunk-元信息至-chunk-info-表内","link":"#最后保存-chunk-元信息至-chunk-info-表内","children":[]},{"level":5,"title":"uploadService.getUploadedChunks 获取成功上传的chunk索引","slug":"uploadservice-getuploadedchunks-获取成功上传的chunk索引","link":"#uploadservice-getuploadedchunks-获取成功上传的chunk索引","children":[]},{"level":5,"title":"redisTemplate.execute()解析","slug":"redistemplate-execute-解析","link":"#redistemplate-execute-解析","children":[]},{"level":5,"title":"uploadService.getTotalChunks 获取文件的总 chunk 数量","slug":"uploadservice-gettotalchunks-获取文件的总-chunk-数量","link":"#uploadservice-gettotalchunks-获取文件的总-chunk-数量","children":[]}]},{"level":4,"title":"文件合并","slug":"文件合并","link":"#文件合并","children":[]}]}]}],"git":{"createdTime":1768918623000,"updatedTime":1768918623000,"contributors":[{"name":"EkkoSonya","email":"ekkosonya@163.com","commits":1}]},"readingTime":{"minutes":21.22,"words":6367},"filePathRelative":"code/java_item/3-smart/article6.md","localizedDate":"2026年1月20日","excerpt":"<p>实现大文件的分片上传、断点续传、文件合并以及文档解析功能</p>\\n<h2>目的</h2>\\n<ul>\\n<li>通过 Redis 和 MinIO 的结合，确保大文件上传的可靠性</li>\\n<li>并通过 Kafka 实现异步处理，进行文件解析等操作</li>\\n<li>模块支持多种文档格式（PDF、Word、Excel）的解析，并提取文本内容用于后续向量化处理</li>\\n<li>文本向量化通过调用阿里向量化 API 实现，生成的向量数据目前存储在 <code>Elasticsearch</code> 中，未来将同时支持 FAISS 存储</li>\\n</ul>\\n<h2>文件上传</h2>\\n<p>首先前端对于用户上传的文件，由前端来计算对应的MD5值 (分片读取 + 增量计算)</p>","autoDesc":true}')},26129:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>i,data:()=>u});var t=a(7847);const p=a.p+"assets/img/16.09c60a4a.png",e=a.p+"assets/img/17.915e6b0b.png",o=a.p+"assets/img/18.2e738914.png",c=[(0,t.Fv)('<h2 id="juc6" tabindex="-1"><a class="header-anchor" href="#juc6"><span>JUC6</span></a></h2><h3 id="原子类" tabindex="-1"><a class="header-anchor" href="#原子类"><span>原子类</span></a></h3><p>如果要保证<code>i++</code>的原子性，那么我们的唯一选择就是加锁，那么，除了加锁之外，还有没有其他更好的解决方法呢？</p><p>JUC为我们提供了原子类，底层采用CAS算法，它是一种用法简单、性能高效、线程安全地更新变量的方式。</p><p>所有的原子类都位于<code>java.util.concurrent.atomic</code>包下</p><h4 id="原子类介绍" tabindex="-1"><a class="header-anchor" href="#原子类介绍"><span>原子类介绍</span></a></h4><p>常用基本数据类，有对应的原子类封装：</p><ul><li><code>AtomicInteger</code>：原子更新int</li><li><code>AtomicLong</code>：原子更新long</li><li><code>AtomicBoolean</code>：原子更新boolean</li></ul><h5 id="简单使用" tabindex="-1"><a class="header-anchor" href="#简单使用"><span>简单使用</span></a></h5><p>正常情况下使用一个基本类型：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在我们使用int类型对应的原子类，要实现同样的代码：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">AtomicInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  \n        <span class="token comment">// 如果想实现i += 2这种操作，可以使用 addAndGet() 自由设置delta 值</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以将int数值封装到此类中（注意必须调用构造方法，它不像Integer那样有装箱机制），并且通过调用此类提供的方法来获取或是对封装的int值进行自增</p><h5 id="保证原子性" tabindex="-1"><a class="header-anchor" href="#保证原子性"><span>保证原子性</span></a></h5><p>它不仅仅是简单的包装，它的自增操作是具有原子性的：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>\n                i<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;自增完成！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样是直接进行自增操作，我们发现，使用原子类是可以保证自增操作原子性的，就跟我们前面加锁一样。</p><h5 id="底层实现" tabindex="-1"><a class="header-anchor" href="#底层实现"><span>底层实现</span></a></h5><h6 id="_1-构造方法-volatile-保证可见性" tabindex="-1"><a class="header-anchor" href="#_1-构造方法-volatile-保证可见性"><span>1. 构造方法 <code>volatile</code> 保证可见性</span></a></h6><p>它的底层是如何实现的，直接从构造方法点进去：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    value <span class="token operator">=</span> initialValue<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，它的底层是比较简单的，其实本质上就是封装了一个<code>volatile</code>类型的int值，这样能够保证<strong>可见性</strong> (对数据进行操作更新，其他有该数据的线程会立刻知道)，在CAS操作的时候不会出现问题。</p><h6 id="_2-记录-value-字段对应的偏移地址-unsafe" tabindex="-1"><a class="header-anchor" href="#_2-记录-value-字段对应的偏移地址-unsafe"><span>2. 记录 value 字段对应的偏移地址 <code>Unsafe</code></span></a></h6><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>\n\n<span class="token keyword">static</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset\n            <span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到最上面是和AQS采用了类似的机制，因为要使用CAS算法更新value的值，所以得先计算出value字段在对象中的偏移地址，CAS直接修改对应位置的内存即可（可见Unsafe类的作用巨大，很多的底层操作都要靠它来完成）</p><h6 id="自增操作源码分析" tabindex="-1"><a class="header-anchor" href="#自增操作源码分析"><span>自增操作源码分析</span></a></h6><p>接着我们来看自增操作是怎么在运行的：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到这里调用了<code>unsafe.getAndAddInt()</code></p><p>接着看看Unsafe里面写了什么：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>  \n    <span class="token comment">// delta就是变化的值，++操作就是自增1</span>\n    <span class="token comment">// object 对应这个原子类 然后根据 offset 锁定 value 字段</span>\n    <span class="token keyword">int</span> v<span class="token punctuation">;</span>\n    <span class="token keyword">do</span> <span class="token punctuation">{</span>\n        <span class="token comment">// volatile版本的getInt() 能够保证可见性</span>\n        v <span class="token operator">=</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  \n    <span class="token comment">// 这里是开始cas替换int的值</span>\n    <span class="token comment">// 每次都去拿最新的值去进行替换，如果成功则离开循环</span>\n    <span class="token comment">// 不成功说明这个时候其他线程先修改了值，就进下一次循环再获取最新的值然后再cas一次，直到成功为止</span>\n\n    <span class="token comment">// 返回的是修改自增前的value</span>\n    <span class="token keyword">return</span> v<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到这是一个<code>do-while</code>循环，和AQS队列中的机制差不多，也是采用自旋形式，来不断进行CAS操作，直到成功。</p><figure><img src="'+p+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>可见，原子类底层也是采用了CAS算法来保证的原子性，包括<code>getAndSet</code>、<code>getAndAdd</code>等方法都是这样。</p><h5 id="cas操作方法" tabindex="-1"><a class="header-anchor" href="#cas操作方法"><span>CAS操作方法</span></a></h5><p>原子类也直接提供了CAS操作方法，我们可以直接使用：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n    <span class="token class-name">AtomicInteger</span> integer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>integer<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>integer<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果想以普通变量的方式来设定值，那么可以使用<code>lazySet()</code>方法，这样就不采用<code>volatile</code>的立即可见机制了。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">AtomicInteger</span> integer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ninteger<span class="token punctuation">.</span><span class="token function">lazySet</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="数组类型的原子类" tabindex="-1"><a class="header-anchor" href="#数组类型的原子类"><span>数组类型的原子类</span></a></h5><p>除了基本类有原子类以外，基本类型的数组类型也有原子类：</p><ul><li><code>AtomicIntegerArray</code>：原子更新int数组</li><li><code>AtomicLongArray</code>：原子更新long数组</li><li><code>AtomicReferenceArray</code>：原子更新引用数组</li></ul><p>其实原子数组和原子类型一样的，不过我们可以对数组内的元素进行原子操作：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n    <span class="token class-name">AtomicIntegerArray</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicIntegerArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n            array<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="adder-记录增值" tabindex="-1"><a class="header-anchor" href="#adder-记录增值"><span><code>Adder</code> 记录增值</span></a></h5><p>在JDK8之后，新增了<code>DoubleAdder</code>和<code>LongAdder</code></p><p>在高并发情况下，<code>LongAdder</code>的性能比<code>AtomicLong</code>的性能更好，主要体现在自增上</p><p>它的大致原理如下：在低并发情况下，和<code>AtomicLong</code>是一样的，对value值进行CAS操作，但是出现高并发的情况时，<code>AtomicLong</code>会进行大量的循环操作来保证同步</p><p>而<code>LongAdder</code>会将对value值的CAS操作分散为对数组<code>cells</code>中多个元素的CAS操作（内部维护一个Cell[] as数组，每个Cell里面有一个初始值为0的long型变量，在高并发时会进行分散CAS，就是不同的线程可以对数组中不同的元素进行CAS自增，这样就避免了所有线程都对同一个值进行CAS），只需要最后再将结果加起来即可。</p><figure><img src="'+e+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>使用如下：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n    <span class="token class-name">LongAdder</span> adder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n            adder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//100个线程</span>\n    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>adder<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//最后求和即可</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于底层源码比较复杂，这里就不做讲解了。</p><p>两者的性能对比（这里用到了CountDownLatch）：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;使用AtomicLong的时间消耗：&quot;</span><span class="token operator">+</span><span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;使用LongAdder的时间消耗：&quot;</span><span class="token operator">+</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">LongAdder</span> adder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">long</span> timeStart <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n                adder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeStart<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">AtomicLong</span> atomicLong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">long</span> timeStart <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n                atomicLong<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>\n            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeStart<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="引用类型的原子操作-atomicreference" tabindex="-1"><a class="header-anchor" href="#引用类型的原子操作-atomicreference"><span>引用类型的原子操作 <code>AtomicReference&lt;&gt;</code></span></a></h5><p>除了对基本数据类型支持原子操作外，对于引用类型，也是可以实现原子操作的：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n    <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>\n    <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">;</span>\n    <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    reference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JUC还提供了字段原子更新器，可以对类中的某个指定字段进行原子操作（注意字段<strong>必须添加volatile关键字</strong>）：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> fieldUpdater <span class="token operator">=</span>\n                <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fieldUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">{</span>\n        <span class="token keyword">volatile</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="aba问题及解决方案" tabindex="-1"><a class="header-anchor" href="#aba问题及解决方案"><span>ABA问题及解决方案</span></a></h3><p>我们来想象一下这种场景：</p><figure><img src="'+o+'" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>线程1和线程2同时开始对<code>a</code>的值进行CAS修改</p><p>但是线程1的速度比较快，将a的值修改为2之后紧接着又修改回1，这时线程2才开始进行判断，发现a的值是1，所以CAS操作成功。</p><p>很明显，这里的1已经不是一开始的那个1了，而是被重新赋值的1，这也是CAS操作存在的问题（无锁虽好，但是问题多多），它只会机械地比较当前值是不是预期值，但是并不会关心当前值是否被修改过，这种问题称之为<code>ABA</code>问题。</p><h4 id="atomicstampedreference" tabindex="-1"><a class="header-anchor" href="#atomicstampedreference"><span><code>AtomicStampedReference</code></span></a></h4><p>那么如何解决这种<code>ABA</code>问题呢，JUC提供了带版本号的引用类型，只要每次操作都记录一下版本号，并且版本号不会重复，那么就可以解决ABA问题了：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>\n    <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>\n    <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">;</span>\n    <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//在构造时需要指定初始值和对应的版本号</span>\n    reference<span class="token punctuation">.</span><span class="token function">attemptStamp</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//可以中途对版本号进行修改，注意要填写当前的引用对象</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//CAS操作时不仅需要提供预期值和修改值，还要提供预期版本号和新的版本号</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',70)],l={},i=(0,a(83671).A)(l,[["render",function(n,s){return(0,t.uX)(),(0,t.CE)("div",null,c)}]]),u=JSON.parse('{"path":"/code/%E5%85%AB%E8%82%A1/JUC/article6.html","title":"JUC6 - 原子类","lang":"zh-CN","frontmatter":{"title":"JUC6 - 原子类","date":"2025-12-28T00:00:00.000Z","category":["code"],"tag":["java","juc"],"order":-0.5,"description":"JUC6 原子类 如果要保证i++的原子性，那么我们的唯一选择就是加锁，那么，除了加锁之外，还有没有其他更好的解决方法呢？ JUC为我们提供了原子类，底层采用CAS算法，它是一种用法简单、性能高效、线程安全地更新变量的方式。 所有的原子类都位于java.util.concurrent.atomic包下 原子类介绍 常用基本数据类，有对应的原子类封装： ...","head":[["meta",{"property":"og:url","content":"http://ekkosonya.cn/code/%E5%85%AB%E8%82%A1/JUC/article6.html"}],["meta",{"property":"og:site_name","content":"EkkoSonya\'s Blog"}],["meta",{"property":"og:title","content":"JUC6 - 原子类"}],["meta",{"property":"og:description","content":"JUC6 原子类 如果要保证i++的原子性，那么我们的唯一选择就是加锁，那么，除了加锁之外，还有没有其他更好的解决方法呢？ JUC为我们提供了原子类，底层采用CAS算法，它是一种用法简单、性能高效、线程安全地更新变量的方式。 所有的原子类都位于java.util.concurrent.atomic包下 原子类介绍 常用基本数据类，有对应的原子类封装： ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-30T16:05:43.000Z"}],["meta",{"property":"article:author","content":"EkkoSonya"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"juc"}],["meta",{"property":"article:published_time","content":"2025-12-28T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-12-30T16:05:43.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"JUC6 - 原子类\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-12-28T00:00:00.000Z\\",\\"dateModified\\":\\"2025-12-30T16:05:43.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"EkkoSonya\\",\\"url\\":\\"http://ekkosonya.cn\\"}]}"]]},"headers":[{"level":2,"title":"JUC6","slug":"juc6","link":"#juc6","children":[{"level":3,"title":"原子类","slug":"原子类","link":"#原子类","children":[{"level":4,"title":"原子类介绍","slug":"原子类介绍","link":"#原子类介绍","children":[{"level":5,"title":"简单使用","slug":"简单使用","link":"#简单使用","children":[]},{"level":5,"title":"保证原子性","slug":"保证原子性","link":"#保证原子性","children":[]},{"level":5,"title":"底层实现","slug":"底层实现","link":"#底层实现","children":[{"level":6,"title":"1. 构造方法 volatile 保证可见性","slug":"_1-构造方法-volatile-保证可见性","link":"#_1-构造方法-volatile-保证可见性","children":[]},{"level":6,"title":"2. 记录 value 字段对应的偏移地址 Unsafe","slug":"_2-记录-value-字段对应的偏移地址-unsafe","link":"#_2-记录-value-字段对应的偏移地址-unsafe","children":[]},{"level":6,"title":"自增操作源码分析","slug":"自增操作源码分析","link":"#自增操作源码分析","children":[]}]},{"level":5,"title":"CAS操作方法","slug":"cas操作方法","link":"#cas操作方法","children":[]},{"level":5,"title":"数组类型的原子类","slug":"数组类型的原子类","link":"#数组类型的原子类","children":[]},{"level":5,"title":"Adder 记录增值","slug":"adder-记录增值","link":"#adder-记录增值","children":[]},{"level":5,"title":"引用类型的原子操作 AtomicReference<>","slug":"引用类型的原子操作-atomicreference","link":"#引用类型的原子操作-atomicreference","children":[]}]}]},{"level":3,"title":"ABA问题及解决方案","slug":"aba问题及解决方案","link":"#aba问题及解决方案","children":[{"level":4,"title":"AtomicStampedReference","slug":"atomicstampedreference","link":"#atomicstampedreference","children":[]}]}]}],"git":{"createdTime":1767110743000,"updatedTime":1767110743000,"contributors":[{"name":"EkkoSonya","email":"ekkosonya@163.com","commits":1}]},"readingTime":{"minutes":7.17,"words":2152},"filePathRelative":"code/八股/JUC/article6.md","localizedDate":"2025年12月28日","excerpt":"<h2>JUC6</h2>\\n<h3>原子类</h3>\\n<p>如果要保证<code>i++</code>的原子性，那么我们的唯一选择就是加锁，那么，除了加锁之外，还有没有其他更好的解决方法呢？</p>\\n<p>JUC为我们提供了原子类，底层采用CAS算法，它是一种用法简单、性能高效、线程安全地更新变量的方式。</p>\\n<p>所有的原子类都位于<code>java.util.concurrent.atomic</code>包下</p>\\n<h4>原子类介绍</h4>\\n<p>常用基本数据类，有对应的原子类封装：</p>\\n<ul>\\n<li><code>AtomicInteger</code>：原子更新int</li>\\n<li><code>AtomicLong</code>：原子更新long</li>\\n<li><code>AtomicBoolean</code>：原子更新boolean</li>\\n</ul>","autoDesc":true}')}}]);