<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="keywords" content="EkkoSonya's Blog" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #252232);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="http://ekkosonya.cn/code/java_item/2-hmdp/article8.html"><meta property="og:site_name" content="EkkoSonya's Blog"><meta property="og:title" content="item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission)"><meta property="og:description" content="åˆ†å¸ƒå¼é”-redission ç®€å•ä»‹ç» ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜ åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥) é‡å…¥é—®é¢˜æ˜¯æŒ‡è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ å¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-12-14T08:36:49.000Z"><meta property="article:author" content="EkkoSonya"><meta property="article:tag" content="java_item"><meta property="article:modified_time" content="2025-12-14T08:36:49.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission)","image":[""],"dateModified":"2025-12-14T08:36:49.000Z","author":[{"@type":"Person","name":"EkkoSonya","url":"http://ekkosonya.cn"}]}</script><link rel="alternate" type="application/rss+xml" href="http://ekkosonya.cn/rss.xml" title="EkkoSonya's Blog RSS Feed"><title>item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission) | EkkoSonya's Blog</title><meta name="description" content="åˆ†å¸ƒå¼é”-redission ç®€å•ä»‹ç» ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜ åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥) é‡å…¥é—®é¢˜æ˜¯æŒ‡è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ å¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥...">
    <link rel="stylesheet" href="/assets/css/styles.f179cd96.css">
    <link rel="preload" href="/assets/js/runtime~app.ec89e054.js" as="script"><link rel="preload" href="/assets/css/styles.f179cd96.css" as="style"><link rel="preload" href="/assets/js/731.ee5b1103.js" as="script"><link rel="preload" href="/assets/js/app.ff358c8f.js" as="script">
    
    <!-- ç»Ÿè®¡ä»£ç åŒºåŸŸ-->
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/penguin1.png" alt><!----><span class="vp-site-name hide-in-pad">EkkoSonya&#39;s Blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><!---->ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/academic/" aria-label="å­¦æœ¯"><!---->å­¦æœ¯<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/code/" aria-label="ä»£ç "><!---->ä»£ç <!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/daily/" aria-label="éšç¬”"><!---->éšç¬”<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="å·¥å…·"><span class="title"><span class="font-icon icon iconfont icon-tool" style=""></span>å·¥å…·</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://www.aishort.top/" rel="noopener noreferrer" target="_blank" aria-label="ChatGPT SC" class="nav-link"><span class="font-icon icon iconfont icon-creative" style=""></span>ChatGPT SC<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://prompt.newzone.top/" rel="noopener noreferrer" target="_blank" aria-label="IMGPrompt" class="nav-link"><span class="font-icon icon iconfont icon-pic" style=""></span>IMGPrompt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://tools.newzone.top/json-translate" rel="noopener noreferrer" target="_blank" aria-label="å¤šè¯­è¨€å¤„ç†" class="nav-link"><span class="font-icon icon iconfont icon-others" style=""></span>å¤šè¯­è¨€å¤„ç†<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://nav.newzone.top/" rel="noopener noreferrer" target="_blank" aria-label="å·¥å…·æ”¶è—" class="nav-link"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>å·¥å…·æ”¶è—<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/EkkoSonya" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">å­¦æœ¯</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">ä»£ç </span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Java 9 17</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Java Hint</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Java Item</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">1 è‹ç©¹å¤–å–</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">2 Hmdp</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article1.html" aria-label="item2-1 (é¡¹ç›®ä»‹ç»+ç¯å¢ƒæ­å»º)"><!---->item2-1 (é¡¹ç›®ä»‹ç»+ç¯å¢ƒæ­å»º)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article2.html" aria-label="item2-2 (çŸ­ä¿¡ç™»å½•)"><!---->item2-2 (çŸ­ä¿¡ç™»å½•)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article3.html" aria-label="item2-3 (çŸ­ä¿¡ç™»å½•2)"><!---->item2-3 (çŸ­ä¿¡ç™»å½•2)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article4.html" aria-label="item2-4 (å•†æˆ·æŸ¥è¯¢ç¼“å­˜1)"><!---->item2-4 (å•†æˆ·æŸ¥è¯¢ç¼“å­˜1)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article5.html" aria-label="item2-5 (å•†æˆ·æŸ¥è¯¢ç¼“å­˜2)"><!---->item2-5 (å•†æˆ·æŸ¥è¯¢ç¼“å­˜2)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article6.html" aria-label="item2-6 (ä¼˜æƒ åˆ¸ç§’æ€1)"><!---->item2-6 (ä¼˜æƒ åˆ¸ç§’æ€1)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article7.html" aria-label="item2-7 (ä¼˜æƒ åˆ¸ç§’æ€2 - åˆ†å¸ƒå¼é”)"><!---->item2-7 (ä¼˜æƒ åˆ¸ç§’æ€2 - åˆ†å¸ƒå¼é”)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/code/java_item/2-hmdp/article8.html" aria-label="item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission)"><!---->item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission)<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#åˆ†å¸ƒå¼é”-redission" aria-label="åˆ†å¸ƒå¼é”-redission"><!---->åˆ†å¸ƒå¼é”-redission<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ç®€å•ä»‹ç»" aria-label="ç®€å•ä»‹ç»"><!---->ç®€å•ä»‹ç»<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜" aria-label="ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜"><!---->ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#é‡å…¥é—®é¢˜-ä¸å¯é‡å…¥" aria-label="é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥)"><!---->é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥)<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ä¸å¯é‡è¯•" aria-label="ä¸å¯é‡è¯•"><!---->ä¸å¯é‡è¯•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#è¶…æ—¶é‡Šæ”¾" aria-label="è¶…æ—¶é‡Šæ”¾"><!---->è¶…æ—¶é‡Šæ”¾<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ä¸»ä»ä¸€è‡´æ€§" aria-label="ä¸»ä»ä¸€è‡´æ€§"><!---->ä¸»ä»ä¸€è‡´æ€§<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#redission" aria-label="Redission"><!---->Redission<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#å¿«é€Ÿå…¥é—¨" aria-label="å¿«é€Ÿå…¥é—¨"><!---->å¿«é€Ÿå…¥é—¨<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#é…ç½®" aria-label="é…ç½®"><!---->é…ç½®<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ç®€å•ç¤ºä¾‹" aria-label="ç®€å•ç¤ºä¾‹"><!---->ç®€å•ç¤ºä¾‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#ä½¿ç”¨" aria-label="ä½¿ç”¨"><!---->ä½¿ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#åŸç†åˆ†æ" aria-label="åŸç†åˆ†æ"><!---->åŸç†åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#redissionå¯é‡å…¥é”åŸç†" aria-label="redissionå¯é‡å…¥é”åŸç†"><!---->redissionå¯é‡å…¥é”åŸç†<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#æµ‹è¯•ä»£ç " aria-label="æµ‹è¯•ä»£ç "><!---->æµ‹è¯•ä»£ç <!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#redissionæºç åˆ†æ" aria-label="Redissionæºç åˆ†æ"><!---->Redissionæºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#redissioné”é‡è¯•å’Œwatchdogæœºåˆ¶" aria-label="redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶"><!---->redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#trylockå«å‚æ•°ä¸‹çš„é”é‡è¯•-waittime" aria-label="trylockå«å‚æ•°ä¸‹çš„é”é‡è¯• (waitTime)"><!---->trylockå«å‚æ•°ä¸‹çš„é”é‡è¯• (waitTime)<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#é”è¶…æ—¶-â€”-watchdogæœºåˆ¶" aria-label="é”è¶…æ—¶ â€” watchDogæœºåˆ¶"><!---->é”è¶…æ—¶ â€” watchDogæœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#æ€»ç»“" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#redissioné”çš„mutilockåŸç†" aria-label="redissioné”çš„MutiLockåŸç†"><!---->redissioné”çš„MutiLockåŸç†<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#mutilockåŸç†" aria-label="MutiLockåŸç†"><!---->MutiLockåŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/code/java_item/2-hmdp/article8.html#æ€»ç»“-1" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article9.html" aria-label="item2-9 (ç§’æ€ä¼˜åŒ–1)"><!---->item2-9 (ç§’æ€ä¼˜åŒ–1)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article10.html" aria-label="item2-10 (ç§’æ€ä¼˜åŒ–2 - æ¶ˆæ¯é˜Ÿåˆ—)"><!---->item2-10 (ç§’æ€ä¼˜åŒ–2 - æ¶ˆæ¯é˜Ÿåˆ—)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article11.html" aria-label="item2-11 (è¾¾äººæ¢åº—1)"><!---->item2-11 (è¾¾äººæ¢åº—1)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article12.html" aria-label="item2-12 (å¥½å‹å…³æ³¨ - zset | æ»šåŠ¨æŸ¥è¯¢)"><!---->item2-12 (å¥½å‹å…³æ³¨ - zset | æ»šåŠ¨æŸ¥è¯¢)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java_item/2-hmdp/article13.html" aria-label="item2-13 (é™„è¿‘å•†é“º + ç”¨æˆ·ç­¾åˆ° - GEO + BitMapæ•°æ®ç»“æ„)"><!---->item2-13 (é™„è¿‘å•†é“º + ç”¨æˆ·ç­¾åˆ° - GEO + BitMapæ•°æ®ç»“æ„)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">3 Smart</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Java Ssm</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Javaweb</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ä¸­é—´ä»¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">å…«è‚¡</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">éšç¬”</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->item2-8 (ä¼˜æƒ åˆ¸ç§’æ€3 - åˆ†å¸ƒå¼é”-redission)</h1><div class="page-info"><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category6 clickable" role="navigation">code</span><!--]--><meta property="articleSection" content="code"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag7 clickable" role="navigation">java_item</span><!--]--><meta property="keywords" content="java_item"></span><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 4575 å­—</span><meta property="wordCount" content="4575"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 15 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT15M"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#åˆ†å¸ƒå¼é”-redission">åˆ†å¸ƒå¼é”-redission</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#ç®€å•ä»‹ç»">ç®€å•ä»‹ç»</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜">ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#é‡å…¥é—®é¢˜-ä¸å¯é‡å…¥">é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥)</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#ä¸å¯é‡è¯•">ä¸å¯é‡è¯•</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#è¶…æ—¶é‡Šæ”¾">è¶…æ—¶é‡Šæ”¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#ä¸»ä»ä¸€è‡´æ€§">ä¸»ä»ä¸€è‡´æ€§</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#redission">Redission</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#å¿«é€Ÿå…¥é—¨">å¿«é€Ÿå…¥é—¨</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#é…ç½®">é…ç½®</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#ç®€å•ç¤ºä¾‹">ç®€å•ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#ä½¿ç”¨">ä½¿ç”¨</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#åŸç†åˆ†æ">åŸç†åˆ†æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#redissionå¯é‡å…¥é”åŸç†">redissionå¯é‡å…¥é”åŸç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç </a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#redissionæºç åˆ†æ">Redissionæºç åˆ†æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#redissioné”é‡è¯•å’Œwatchdogæœºåˆ¶">redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#trylockå«å‚æ•°ä¸‹çš„é”é‡è¯•-waittime">trylockå«å‚æ•°ä¸‹çš„é”é‡è¯• (waitTime)</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#é”è¶…æ—¶-â€”-watchdogæœºåˆ¶">é”è¶…æ—¶ â€” watchDogæœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level4" href="/#redissioné”çš„mutilockåŸç†">redissioné”çš„MutiLockåŸç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level5" href="/#mutilockåŸç†">MutiLockåŸç†</a></li><!----><!--]--></ul></li><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ€»ç»“-1">æ€»ç»“</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="åˆ†å¸ƒå¼é”-redission" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”-redission"><span>åˆ†å¸ƒå¼é”-redission</span></a></h2><h3 id="ç®€å•ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ç®€å•ä»‹ç»"><span>ç®€å•ä»‹ç»</span></a></h3><h4 id="ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜"><span>ä¹‹å‰åˆ†å¸ƒå¼é”é—®é¢˜</span></a></h4><p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><h5 id="é‡å…¥é—®é¢˜-ä¸å¯é‡å…¥" tabindex="-1"><a class="header-anchor" href="#é‡å…¥é—®é¢˜-ä¸å¯é‡å…¥"><span>é‡å…¥é—®é¢˜(ä¸å¯é‡å…¥)</span></a></h5><p>é‡å…¥é—®é¢˜æ˜¯æŒ‡è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­</p><p>å¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿ</p><p>æ„æ€å‡å¦‚æ–¹æ³•Aå…ˆè·å–é”ï¼Œç„¶åæ‰§è¡Œä¸­è¦ç”¨åˆ°æ–¹æ³•Bï¼Œç„¶ååœ¨æ–¹æ³•Bä¸­ä¹Ÿéœ€è¦è·å–ç›¸åŒçš„é”ï¼Œä½†æ­¤æ—¶é”åœ¨æ–¹æ³•Aé‡Œï¼Œå¦‚æœ<strong>ä¸å¯é‡å…¥</strong>ï¼Œå°±å¯¼è‡´æ–¹æ³•Bä¸€ç›´ç­‰ï¼Œæ­»é”äº†å°±</p><p>æ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</p><h5 id="ä¸å¯é‡è¯•" tabindex="-1"><a class="header-anchor" href="#ä¸å¯é‡è¯•"><span>ä¸å¯é‡è¯•</span></a></h5><p>æ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡(éé˜»å¡å¼)ï¼Œå¤±è´¥äº†ç›´æ¥è¿”å› <code>false</code></p><p>åˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œå¯ä»¥å†ç­‰ä¸€ç­‰å†é‡è¯•ï¼Œå†æ¬¡å°è¯•è·å¾—é”ï¼Œå¯ä»¥é‡è¯•</p><h5 id="è¶…æ—¶é‡Šæ”¾" tabindex="-1"><a class="header-anchor" href="#è¶…æ—¶é‡Šæ”¾"><span>è¶…æ—¶é‡Šæ”¾</span></a></h5><p>æˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</p><h5 id="ä¸»ä»ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»ä¸€è‡´æ€§"><span>ä¸»ä»ä¸€è‡´æ€§</span></a></h5><p>å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œæ­¤æ—¶ä»èŠ‚ç‚¹æ²¡æœ‰é”çš„æ•°æ®ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹å¯ä»¥è·å–é”ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜</p><h4 id="redission" tabindex="-1"><a class="header-anchor" href="#redission"><span>Redission</span></a></h4><p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰</p><p>å®˜ç½‘ï¼š<a href="https://redisson.org" target="_blank" rel="noopener noreferrer">https://redisson.org<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>GitHubï¼š<a href="https://github.com/redisson/redisson" target="_blank" rel="noopener noreferrer">https://github.com/redisson/redisson<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p><p>Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½</p><figure><img src="/assets/img/47.7f679ca8.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h3 id="å¿«é€Ÿå…¥é—¨" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿå…¥é—¨"><span>å¿«é€Ÿå…¥é—¨</span></a></h3><h4 id="é…ç½®" tabindex="-1"><a class="header-anchor" href="#é…ç½®"><span>é…ç½®</span></a></h4><p>å¼•å…¥ä¾èµ–ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨å†Œ<code>Redisson</code>å®¢æˆ·ç«¯é…ç½®é¡¹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// é…ç½®</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.150.101:6379&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç®€å•ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç®€å•ç¤ºä¾‹"><span>ç®€å•ç¤ºä¾‹</span></a></h4><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissionClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token comment">//é‡Šæ”¾é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨"><span>ä½¿ç”¨</span></a></h4><p>åœ¨ <code>VoucherOrderServiceImpl</code>æ³¨å…¥ <code>RedissonClient</code> æ¥æ›¿ä»£æˆ‘ä»¬è‡ªå·±å»ºç«‹çš„é”</p><p>é€šè¿‡ <code>getLock</code> è·å–é”å¯¹è±¡ -&gt; ç„¶åç”¨é”å¯¹è±¡æ¥<code>trylock</code>å°è¯•è·å–é” -&gt; æœ€ååˆ¤æ–­</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°šæœªå¼€å§‹</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°šæœªå¼€å§‹</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åº“å­˜ä¸è¶³</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span>
        <span class="token comment">// SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–é”å¯¹è±¡</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token comment">// åŠ é”å¤±è´¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//é‡Šæ”¾é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#åŸç†åˆ†æ"><span>åŸç†åˆ†æ</span></a></h3><h4 id="redissionå¯é‡å…¥é”åŸç†" tabindex="-1"><a class="header-anchor" href="#redissionå¯é‡å…¥é”åŸç†"><span>redissionå¯é‡å…¥é”åŸç†</span></a></h4><p>åœ¨Locké”ä¸­ï¼Œä»–æ˜¯å€ŸåŠ©äºåº•å±‚çš„ä¸€ä¸ªvoaltileçš„ä¸€ä¸ªstateå˜é‡æ¥è®°å½•é‡å…¥çš„çŠ¶æ€çš„ï¼Œæ¯”å¦‚å½“å‰æ²¡æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate=0ï¼Œå‡å¦‚æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate=1ï¼Œå¦‚æœæŒæœ‰è¿™æŠŠé”çš„äººå†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstateå°±ä¼š+1</p><p>å¦‚æœæ˜¯å¯¹äºsynchronizedè€Œè¨€ï¼Œä»–åœ¨cè¯­è¨€ä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ªcountï¼ŒåŸç†å’Œstateç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡å…¥ä¸€æ¬¡å°±åŠ ä¸€ï¼Œé‡Šæ”¾ä¸€æ¬¡å°±-1 ï¼Œç›´åˆ°å‡å°‘æˆ0æ—¶ï¼Œè¡¨ç¤ºå½“å‰è¿™æŠŠé”æ²¡æœ‰è¢«äººæŒæœ‰ã€‚</p><p>åœ¨redissionä¸­ï¼Œæ”¯æŒå¯é‡å…¥é”</p><p>åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œé‡‡ç”¨hashç»“æ„ç”¨æ¥å­˜å‚¨é”ï¼Œå…¶ä¸­å¤§keyè¡¨ç¤ºè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œç”¨å°keyè¡¨ç¤ºå½“å‰è¿™æŠŠé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ï¼Œå¯¹åº”çš„ value åˆ™æ˜¯è¯¥é”è¢«åŒä¸€ä¸ªçº¿ç¨‹è·å–çš„æ¬¡æ•°ï¼Œç±»ä¼¼çš„ï¼Œå½“æœ‰äººæ¥å†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œå¯¹åº”çš„ value + 1ï¼Œé‡Šæ”¾ä¸€æ¬¡å°± -1ã€</p><h5 id="æµ‹è¯•ä»£ç " tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•ä»£ç "><span>æµ‹è¯•ä»£ç </span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–å¤±è´¥ 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–é”æˆåŠŸ 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡æ‰§è¡Œ 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;é‡Šæ”¾é” 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–å¤±è´¥ 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–é”æˆåŠŸ 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡æ‰§è¡Œ 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;é‡Šæ”¾é” 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æ‰§è¡Œç¬¬ä¸€ä¸ª test æ—¶è·å–é”ï¼š</p><figure><img src="data:image/png;base64,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" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>å½“è¿›å…¥ <code>method2</code> æ—¶å†æ¬¡è·å–é”:</p><figure><img src="data:image/png;base64,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" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>éšåå…ˆ <code>method2</code> é‡Šæ”¾é” -1 ç„¶å <code>method1</code> é‡Šæ”¾é” -1 æœ€ç»ˆçœŸæ­£é‡Šæ”¾</p><figure><img src="/assets/img/50.688e2b0a.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="redissionæºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#redissionæºç åˆ†æ"><span>Redissionæºç åˆ†æ</span></a></h5><h6 id="è·å–é”-lock-trylock" tabindex="-1"><a class="header-anchor" href="#è·å–é”-lock-trylock"><span>è·å–é” <code>lock.trylock()</code></span></a></h6><p>å¯¹äº <code>Lock</code> çš„å®ç°ç±» <code>RedissonLock</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¯¹åº”çš„tryLockAsync</span>
<span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquireOnceAsync</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireOnceAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…ˆåˆ¤æ–­ leaseTime æ˜¯å¦ä¸º -1 (æ‰€è‡ªåŠ¨é‡Šæ”¾çš„æ—¶é—´)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_NULL_BOOLEAN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ²¡æœ‰é‡Šæ”¾æ—¶é—´ï¼Œè®¾ç½®é»˜è®¤å€¼</span>
        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCfg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLockWatchdogTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_NULL_BOOLEAN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ttlRemainingFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†æå¯¹åº”çš„ <code>tryLockInnerAsync</code> æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisStrictCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token function">evalWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LongCodec</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> 
    <span class="token string">&quot;if (redis.call(&#39;exists&#39;, KEYS[1]) == 0) &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;then redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return nil; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;end; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;then redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return nil; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;end; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return redis.call(&#39;pttl&#39;, KEYS[1]);&quot;</span>
    <span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLockName</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ <code>lua</code> è„šæœ¬æ¥è¿›è¡Œåˆ¤æ–­</p><p>å…ˆåˆ¤æ–­é”æ˜¯ä¸æ˜¯å­˜åœ¨-&gt; ä¸å­˜åœ¨, åˆ›å»ºé”è‡ªå¢1 + è®¾ç½®è¿‡æœŸæ—¶é—´, è¿”å› nil | å­˜åœ¨ -&gt; åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±çš„ -&gt; æ˜¯ +1 é‡ç½®è¿‡æœŸæ—¶é—´ | ä¸æ˜¯ å¤±è´¥</p><h6 id="é‡Šæ”¾é”-lock-unlock" tabindex="-1"><a class="header-anchor" href="#é‡Šæ”¾é”-lock-unlock"><span>é‡Šæ”¾é” <code>lock.unlock()</code></span></a></h6><p>å¯¹åº”åœ¨ <code>RedissonLock</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RedisException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RPromise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlockInnerAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>opStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">tryFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>opStatus <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IllegalMonitorStateException</span> cause <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">&quot; thread-id: &quot;</span> <span class="token operator">+</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">tryFailure</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†æå¯¹åº”çš„ <code>unlickInnerAsync()</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockInnerAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token function">evalWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LongCodec</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_BOOLEAN</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[3]) == 0) &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;then return nil; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;end; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;local counter = redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[3], -1); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;if (counter &gt; 0) &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;then redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[2]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return 0; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;else redis.call(&#39;del&#39;, KEYS[1]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;redis.call(&#39;publish&#39;, KEYS[2], ARGV[1]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return 1; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;end; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return nil;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChannelName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LockPubSub</span><span class="token punctuation">.</span><span class="token constant">UNLOCK_MESSAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLockName</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ ·ä¹Ÿæ˜¯åˆ©ç”¨ <code>lua</code> è„šæœ¬æ¥åˆ¤æ–­åˆ é™¤é”çš„é€»è¾‘</p><p>å…ˆåˆ¤æ–­é”æ˜¯ä¸æ˜¯è‡ªå·± -&gt; æ˜¯è‡ªå·±, é”æ¬¡æ•°å°±å‡1 -&gt; åˆ¤æ–­é”é‡å¤æ¬¡æ•°æ˜¯å¦ä¸º0 -&gt; å¤§äº0, é‡ç½®æœ‰æ•ˆæœŸ | ä¸º0 åˆ é™¤é”ï¼Œå¹¶è¿›è¡Œé€šçŸ¥</p><h4 id="redissioné”é‡è¯•å’Œwatchdogæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#redissioné”é‡è¯•å’Œwatchdogæœºåˆ¶"><span>redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</span></a></h4><figure><img src="/assets/img/51.a9f03be8.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="trylockå«å‚æ•°ä¸‹çš„é”é‡è¯•-waittime" tabindex="-1"><a class="header-anchor" href="#trylockå«å‚æ•°ä¸‹çš„é”é‡è¯•-waittime"><span><code>trylock</code>å«å‚æ•°ä¸‹çš„é”é‡è¯• (waitTime)</span></a></h5><p><code>boolean isLock = lock.tryLock(1L, TimeUnit.SECONDS);</code></p><p>æ­¤æ—¶è®¾ç½®äº†ç­‰å¾…æ—¶é—´ï¼Œå¯¹åº”çš„æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ç»™äº† waitTime æ‰€ä»¥å­˜åœ¨ç­‰å¾…æ—¶é—´ å¯èƒ½ä¼šé”é‡è¯•</span>
<span class="token comment">// leaseTime ä¸ºé‡Šæ”¾æ—¶é—´ï¼Œ-1ä¸ºé»˜è®¤å€¼ 30s</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> time <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> ttl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…ˆåˆ†æ <code>this.tryAcquire(waitTime, leaseTime, unit, threadId);</code></p><p>å¯¹åº”æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ç°åœ¨ç‰ˆæœ¬åŠ äº†ä¸€ä¸ª tryAcquireAsync0</span>
<span class="token comment">// åŸæ¥æ˜¯ç›´æ¥ return get(tryAcquireAsync(waitTime, leaseTime, unit, threadId));</span>
<span class="token comment">// get æ¥ç­‰å¾…é˜»å¡è·å–æœ€ç»ˆçš„ç»“æœ</span>
<span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquireAsync0</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync0</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœç»™äº†é‡Šæ”¾æ—¶é—´</span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®¾å®šé»˜è®¤é‡Šæ”¾æ—¶é—´</span>
        <span class="token comment">// this.internalLockLeaseTime = this.getServiceManager().getCfg().getLockWatchdogTimeout();</span>
        <span class="token comment">// ä¾ç„¶æ˜¯å¯¹åº”çš„çœ‹é—¨ç‹—æ—¶é—´ 30000ms</span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// tryLockInnerAsync</span>
    <span class="token comment">// å°±æ˜¯ä¹‹å‰åˆ†æå¯é‡å…¥æ—¶ è°ƒç”¨ lua è„šæœ¬çš„å‡½æ•°</span>

    <span class="token comment">// å¥½åƒæ˜¯è¿”å›ä¸€ä¸ªåŒ…è£…</span>
    <span class="token comment">// ä¹‹å‰ç‰ˆæœ¬çš„å®šä¹‰æ¯”è¾ƒç®€å• è¿”å›çš„æ˜¯ RFuture&lt;Long&gt; ä¸€ä¸ªå¼‚æ­¥ æ¥ç­‰å¾…é”é‡Šæ”¾</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleNoSync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">,</span> ttlRemainingFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ttlRemaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¦‚æœé”ä¸å­˜åœ¨ redis.call(&#39;exists&#39;, KEYS[1]) == 0</span>
<span class="token comment">// æˆ–è€… é”å­˜åœ¨ä¸”æœ‰å±äºè‡ªå·± redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1)</span>
<span class="token comment">// å°±è‡ªå¢1 å¹¶ä¸”æ›´æ–° æœ‰æ•ˆæœŸ</span>
<span class="token comment">// æˆåŠŸå°±è¿”å› nil å¦åˆ™è¿”å›é”çš„å‰©ä½™æœ‰æ•ˆæœŸ</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisStrictCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutor<span class="token punctuation">.</span><span class="token function">syncedEval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LongCodec</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> 
    <span class="token string">&quot;if ((redis.call(&#39;exists&#39;, KEYS[1]) == 0) or (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1)) then &quot;</span> <span class="token operator">+</span> 
    <span class="token string">&quot;redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;return nil; &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;end; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return redis.call(&#39;pttl&#39;, KEYS[1]);&quot;</span><span class="token punctuation">,</span>
     <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLockName</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// debug</span>
<span class="token comment">// this.getRawName() -&gt;è¿”å›çš„æ˜¯ &quot;lock&quot;</span>
<span class="token comment">// this.getLockName(threadId) -&gt; &quot;48820612-407a-4588-b79c-0b068041bd01:3&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è·å–é”æ—¶ï¼ŒæˆåŠŸè¿”å› <code>null</code>ï¼Œå¤±è´¥è¿”å› é”çš„å‰©ä½™æœ‰æ•ˆæœŸ æœ€ç»ˆè¿”å› <code>RFuture&lt;Long&gt; ttlRemainingFuture</code></p><p>é€šè¿‡ <code>get</code> æ¥ç­‰å¾…é˜»å¡å¾—åˆ°é”çš„å‰©ä½™æœ‰æ•ˆæœŸåï¼Œå›åˆ° <code>tryLock</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯ä»¥ç­‰å¾…çš„æ—¶é—´</span>
    <span class="token keyword">long</span> time <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾—åˆ°é”çš„æœ‰æ•ˆæœŸ</span>
    <span class="token class-name">Long</span> ttl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–é”å¤±è´¥é€»è¾‘</span>

        <span class="token comment">// è®¡ç®—å‰é¢æ¶ˆè€—çš„æ—¶é—´ï¼Œç„¶åå¾—åˆ°å‰©ä½™çš„ç­‰å¾…æ—¶é—´</span>
        time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç­‰å¾…ä¹…äº† è·å–é”å¤±è´¥ è¿”å› false</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            
            <span class="token comment">// ç»§ç»­å°è¯•è·å–é”</span>
            <span class="token comment">// é‡æ–°è·å–å½“å‰æ—¶é—´</span>
            current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// subscribe è®¢é˜… æ¥ç­‰å¾…åˆ«äººé‡Šæ”¾é”çš„ä¿¡å·</span>
            <span class="token comment">// å› ä¸ºåœ¨ é‡Šæ”¾é”ä¸­çš„ lua è„šæœ¬ </span>
            <span class="token comment">// redis.call(&#39;publish&#39;, KEYS[2], ARGV[1]); </span>
            <span class="token comment">// æ¥é€šçŸ¥</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedissonLockEntry</span><span class="token punctuation">&gt;</span></span> subscribeFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°è¯•ç­‰å¾…</span>
                subscribeFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> var21<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ç­‰å¾…æ—¶é—´è¶…äº† å°±false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscribeFuture<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisTimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to acquire subscription lock after &quot;</span> <span class="token operator">+</span> time <span class="token operator">+</span> <span class="token string">&quot;ms. Try to increase &#39;subscriptionsPerConnection&#39; and/or &#39;subscriptionConnectionPoolSize&#39; parameters.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    subscribeFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> ex<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// å–æ¶ˆè®¢é˜…</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> var22<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰§è¡Œå¤±è´¥ï¼Ÿ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> e<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æˆåŠŸå¾—åˆ°é€šçŸ¥ é”é‡Šæ”¾äº†</span>
                <span class="token comment">// è®¡ç®—å‰©ä½™å¯ä»¥ç­‰å¾…æ—¶é—´</span>
                time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¦‚æœè¿˜æœ‰å‰©ä½™ å¯ä»¥å†æ¬¡å°è¯•è·å–é”</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å†æ¬¡å°è¯•è·å–</span>
                        ttl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// æˆåŠŸè·å– è¿”å›true</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">boolean</span> var32 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> var32<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">// å¤±è´¥å°±åœ¨æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´</span>
                        time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentTime<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">boolean</span> var31 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> var31<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å†è¯•ä¸€æ¬¡</span>
                        <span class="token comment">// é‡‡ç”¨çš„æ˜¯ä¿¡å·é‡ï¼Ÿæ¥ç­‰å¾…è·å–</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">&gt;=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> ttl <span class="token operator">&lt;</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// ttl å°äºæˆ‘å‰©ä½™çš„ç­‰å¾…æ—¶é—´</span>
                            <span class="token comment">// è¡¨ç¤ºæˆ‘æœ‰è¶³å¤Ÿçš„æ—¶é—´å¯ä»¥ç­‰åˆ°è¿™ä¸ªé”é‡Šæ”¾</span>
                            <span class="token comment">// æ‰€ä»¥å°±ç­‰ ttl æ—¶é—´é‡Šæ”¾å°±ç«‹å³å°è¯•è·å–</span>
                            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedissonLockEntry</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// ç­‰timeçš„æ—¶é—´ å¦‚æœè¿˜æ²¡é‡Šæ”¾å°±æ²¡å¿…è¦ç­‰äº†</span>
                            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedissonLockEntry</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentTime<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// ç­‰å¾…æ—¶é—´æ²¡äº† è¿”å›false</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> var16 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> var16<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ²¡å‰©ä½™ å¤±è´¥ false</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                e <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// å–æ¶ˆè®¢é˜…</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedissonLockEntry</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="é”è¶…æ—¶-â€”-watchdogæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é”è¶…æ—¶-â€”-watchdogæœºåˆ¶"><span>é”è¶…æ—¶ â€” watchDogæœºåˆ¶</span></a></h5><p>å¿…é¡»ç¡®ä¿æˆ‘çš„é”æ˜¯å› ä¸ºä¸šåŠ¡æ‰§è¡Œå®Œé‡Šæ”¾ï¼Œè€Œä¸æ˜¯è¶…æ—¶é‡Šæ”¾ï¼Œè€Œæˆ‘çš„ä¸šåŠ¡è¿˜åœ¨é˜»å¡æ²¡ç»“æŸ</p><p>åœ¨å°è¯•è·å–é”çš„æ—¶å€™ï¼Œä¼šå®šä¹‰ <code>RFuture&lt;Long&gt; ttlRemainingFuture</code>ï¼Œé€šè¿‡å¯¹åº”çš„å¼‚æ­¥å®Œæˆæœºåˆ¶æ¥ä¿è¯</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleNoSync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">,</span> ttlRemainingFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ttlRemainingFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›è°ƒæˆåŠŸæ‰§è¡Œ</span>
        <span class="token comment">// å‰©ä½™æœ‰æ•ˆæœŸä¸ºnull (è¡¨ç¤ºè·å–åˆ°é”äº†)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// é‡æ–°å®šä¹‰é”çš„æœ‰æ•ˆæœŸ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ttlRemaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…·ä½“å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">(</span><span class="token class-name">CommandAsyncExecutor</span> commandExecutor<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>commandExecutor<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entryName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// newä¸€ä¸ªæ–°çš„entry</span>
    <span class="token comment">// é‡Œé¢å°è£…äº†ï¼šå½“å‰çº¿ç¨‹id + å¯¹åº”çš„å®šæ—¶åˆ·æ–°ä»»åŠ¡</span>
    <span class="token class-name">ExpirationEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpirationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// EXPIRATION_RENEWAL_MAP æ˜¯ä¸ªConcurrentMap å°±æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„map</span>
    <span class="token comment">// this.getEntryName() è¯´å¯ä»¥ç†è§£ä¸ºæ˜¯é”çš„åç§°</span>
    <span class="token comment">// å°±æ˜¯ä¹‹å‰å¯ä»¥çœ‹åˆ°ç±»ä¼¼ 48820612-407a-4588-b79c-0b068041bd01:3 è¿™ç§</span>

    <span class="token comment">// ä¸åŒçš„é”éƒ½ä¼šæ”¾åœ¨è¿™ä¸ªmapé‡Œ</span>
    <span class="token comment">// å¦‚æœé”ä¸å­˜åœ¨ æ‰æ”¾è¿›å» è¿”å›ä¸º null</span>
    <span class="token comment">// å¦‚æœå·²ç»å­˜åœ¨äº† å°±ä¸æ”¾ è¿”å›æ—§çš„ entry</span>
    <span class="token comment">// ä¿è¯ä¸ç®¡è¿™ä¸ªé”æ›´æ–°äº†å‡ æ¬¡ éƒ½æ˜¯ä¸€ä¸ªentry</span>
    <span class="token class-name">ExpirationEntry</span> oldEntry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExpirationEntry</span><span class="token punctuation">)</span><span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å§è¿™ä¸ªçº¿ç¨‹idæ”¾åˆ° entryé‡Œ</span>
        <span class="token comment">// å› ä¸ºå®šæ—¶ä»»åŠ¡æœ‰äº† å°±ä¸ç”¨å­˜äº†</span>
        oldEntry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¥ å°±ä¼šæ›´æ–°æœ‰æ•ˆæœŸ</span>
        entry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªå»¶æ—¶ä»»åŠ¡ è¿™ä¸ªä»»åŠ¡ä¼šåœ¨(é»˜è®¤10s)åæ‰§è¡Œ</span>
<span class="token comment">// å…ˆåˆ·æ–°é”çš„æœ‰æ•ˆæœŸ ç„¶ååˆé‡æ–°è°ƒç”¨è¿™ä¸ªæ–¹æ³• æ¥åˆ›å»ºå»¶æ—¶ä»»åŠ¡</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExpirationEntry</span> ee <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExpirationEntry</span><span class="token punctuation">)</span><span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ee <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å®šæ—¶ å»¶æ—¶ä»»åŠ¡</span>
        <span class="token comment">// å»¶æ—¶ this.internalLockLeaseTime / 3L (é»˜è®¤10s) å†æ‰§è¡Œ</span>
        <span class="token class-name">Timeout</span> task <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token comment">// å–å‡ºå¯¹åº” entry</span>
                <span class="token class-name">ExpirationEntry</span> ent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExpirationEntry</span><span class="token punctuation">)</span><span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å–å¯¹åº”çº¿ç¨‹id</span>
                    <span class="token class-name">Long</span> threadId <span class="token operator">=</span> ent<span class="token punctuation">.</span><span class="token function">getFirstThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// åˆ·æ–°æœ‰æ•ˆæœŸ</span>
                        <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t update lock {} expiration&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment">// é€’å½’ é‡æ–°è°ƒç”¨è‡ªå·±æ¥åˆ·æ–°é”</span>
                                    <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// entryæ¥å­˜å®šæ—¶ä»»åŠ¡</span>
        ee<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ·æ–°å½“å‰çº¿ç¨‹æŒæœ‰é”æœ‰æ•ˆæœŸ</span>
<span class="token keyword">protected</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token function">evalWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LongCodec</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_BOOLEAN</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;then redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;return 1; &quot;</span><span class="token operator">+</span>
    <span class="token string">&quot;end; return 0;&quot;</span><span class="token punctuation">,</span> 
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>internalLockLeaseTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLockName</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªæœ‰ç­‰é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ‰ä¼šåœæ­¢ä»»åŠ¡ï¼Œä¸åˆ·æ–°æœ‰æ•ˆæœŸ</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RedisException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlockAsync0</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync0</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlockInnerAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>opStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// æˆåŠŸæ—¶ å°±ä¼šå–æ¶ˆæ›´æ–°ä»»åŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">CompletionException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">CompletionException</span><span class="token punctuation">)</span>e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CompletionException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>opStatus <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IllegalMonitorStateException</span> cause <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">&quot; thread-id: &quot;</span> <span class="token operator">+</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CompletionException</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å–æ¶ˆå®šæ—¶ä»»åŠ¡</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token class-name">Long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å¯¹åº”å®šæ—¶ä»»åŠ¡</span>
    <span class="token class-name">ExpirationEntry</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExpirationEntry</span><span class="token punctuation">)</span><span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æŠŠidæ¸…ç©º</span>
            task<span class="token punctuation">.</span><span class="token function">removeThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> task<span class="token punctuation">.</span><span class="token function">hasNoThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å»é™¤å¯¹åº”ä»»åŠ¡ cancel</span>
            <span class="token class-name">Timeout</span> timeout <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                timeout<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å†æŠŠ entry ä¹Ÿå»æ‰</span>
            <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h5><p>waitTime æ˜¯è·å–é”å¤±è´¥åå¯ç­‰å¾…æ—¶é—´ï¼Œè§¦å‘ä¼šè¿›è¡Œé”é‡è¯•</p><p>leaseTime æ˜¯é”çš„æœ‰æ•ˆæ—¶é—´ï¼Œé»˜è®¤ä¸º-1ï¼Œä¼šè§¦å‘çœ‹é—¨ç‹—æœºåˆ¶ï¼Œä¸æ–­åˆ·æ–°é”çš„æœ‰æ•ˆæœŸï¼Œç¡®ä¿åªæœ‰åœ¨ä¸šåŠ¡ç»“æŸæ‰é‡Šæ”¾é”ï¼Œå¦åˆ™æ ¹æ®å¯¹åº”çš„æ—¶é—´é‡Šæ”¾</p><figure><img src="/assets/img/51.a9f03be8.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>Redissonåˆ†å¸ƒå¼é”åŸç†ï¼š</p><ul><li>å¯é‡å…¥ï¼šåˆ©ç”¨ hash ç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°ï¼Œåœ¨redisä¸­</li><li>å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’ŒPubSubåŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</li><li>è¶…æ—¶ç»­çº¦ï¼šé»˜è®¤æ²¡è®¾ leaseTimeæ—¶ï¼Œåˆ©ç”¨ watchDogï¼Œæ¯ä¸ªä¸€æ®µæ—¶é—´(releaseTime/2)é‡ç½®è¶…æ—¶æ—¶é—´</li></ul><figure><img src="/assets/img/52.1901d6e5.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h4 id="redissioné”çš„mutilockåŸç†" tabindex="-1"><a class="header-anchor" href="#redissioné”çš„mutilockåŸç†"><span>redissioné”çš„MutiLockåŸç†</span></a></h4><p>ä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p><p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†</p><figure><img src="/assets/img/53.f8942bb0.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œredissionæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§</p><figure><img src="/assets/img/54.e4a08360.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h5 id="mutilockåŸç†" tabindex="-1"><a class="header-anchor" href="#mutilockåŸç†"><span><code>MutiLock</code>åŸç†</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Rlock</span> lock1 <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Rlock</span> lock2 <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Rlock</span> lock3 <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼Œredissionä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦åŠ é”çš„ä¸ªæ•° * 1500ms</p><p>å‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œé‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•</p><figure><img src="/assets/img/55.b04ca19f.png" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><h3 id="æ€»ç»“-1" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-1"><span>æ€»ç»“</span></a></h3><ol><li><p>ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é” (æœ€ç®€å•, è‡ªå·±å®ç°çš„)</p><ul><li>åŸç†ï¼šåˆ©ç”¨<code>setnx</code>å‘½ä»¤çš„äº’æ–¥æ€§ï¼›åˆ©ç”¨<code>ex</code>é¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºï¼Œé¿å…è¯¯åˆ </li><li>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å°±ç›´æ¥å¤±æ•ˆ</li></ul></li><li><p>å¯é‡å…¥çš„Redisåˆ†å¸ƒå¼é” (Redissonä¸­Lock)</p><ul><li>åŸç†ï¼šåˆ©ç”¨hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡ç¤ºå’Œé‡å…¥æ¬¡æ•° (å¯é‡å…¥)ï¼›åˆ©ç”¨watchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•</li><li>ç¼ºé™·ï¼šå¤šredisï¼Œä¸»èŠ‚ç‚¹å¤±æ•ˆæ— æ³•åŒæ­¥æ—¶ä¸è¡Œ</li></ul></li><li><p>Redissonçš„ multiLockï¼š</p><ul><li>åŸç†ï¼šå¤šä¸ªredisç‹¬ç«‹èŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–æˆåŠŸ</li><li>ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ï¼Œå®ç°å¤æ‚</li></ul></li></ol></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><!----></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/code/java_item/2-hmdp/article7.html" aria-label="item2-7 (ä¼˜æƒ åˆ¸ç§’æ€2 - åˆ†å¸ƒå¼é”)"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->item2-7 (ä¼˜æƒ åˆ¸ç§’æ€2 - åˆ†å¸ƒå¼é”)</div></a><a class="route-link nav-link next" href="/code/java_item/2-hmdp/article9.html" aria-label="item2-9 (ç§’æ€ä¼˜åŒ–1)"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">item2-9 (ç§’æ€ä¼˜åŒ–1)<!----></div></a></nav><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><img src="/beian.png" style="width:1.2rem;margin-right:2px;"> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=33019202000049" rel="noopener noreferrer" target="_blank">æµ™å…¬ç½‘å®‰å¤‡33019202000049</a></div><div class="vp-copyright">Copyright Â© 2024-present <a href="http://ekkosonya.cn/" target="_blank" rel="noopener noreferrer">EkkoSonya's Blog</a></div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.ec89e054.js" defer></script><script src="/assets/js/731.ee5b1103.js" defer></script><script src="/assets/js/app.ff358c8f.js" defer></script>
    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <!-- <script src="/live2d-widget/autoload.js"></script> -->
    <!-- End çœ‹æ¿å¨˜åŒºå— -->
  </body>
</html>
