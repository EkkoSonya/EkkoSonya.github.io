<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="http://ekkosonya.cn/rss.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <atom:link href="http://ekkosonya.cn/rss.xml" rel="self" type="application/rss+xml"/>
    <title>EkkoSonya&amp;apos;s Blog</title>
    <link>http://ekkosonya.cn/</link>
    <description>ç¬”è®°è®°å½•</description>
    <language>zh-CN</language>
    <pubDate>Tue, 20 Jan 2026 14:31:01 GMT</pubDate>
    <lastBuildDate>Tue, 20 Jan 2026 14:31:01 GMT</lastBuildDate>
    <generator>@vuepress/plugin-feed</generator>
    <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
    <category>code</category>
    <item>
      <title>item3 - 5 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—1</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article5.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article5.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 5 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—1</source>
      <description>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½ ç›®çš„ é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§ å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç† æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ Ela...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:17:03 GMT</pubDate>
      <content:encoded><![CDATA[<p>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½</p>
<h2>ç›®çš„</h2>
<ul>
<li>é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§</li>
<li>å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ</li>
<li>æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç†</li>
<li>æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ <code>Elasticsearch</code> ä¸­ï¼Œæœªæ¥å°†åŒæ—¶æ”¯æŒ FAISS å­˜å‚¨</li>
</ul>
<h3>ä¸»è¦å®ç°åŠŸèƒ½</h3>
<h4>æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ä¸æ–­ç‚¹ç»­ä¼ </h4>
<h5>æŠ€æœ¯</h5>
<p>å‰ç«¯ï¼š</p>
<p>å°†éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œåˆ†ç‰‡ï¼Œåˆ©ç”¨ Fine Uploader å·¥å…·å°†å¤§æ–‡ä»¶æŒ‰ç…§ <code>5MBÂ±10%</code> è¿›è¡Œåˆ†å‰²ä¼ è¾“</p>
<p>åç«¯ï¼š</p>
<p>æ–‡ä»¶çŠ¶æ€å­˜å‚¨ï¼šåˆ©ç”¨ Redis çš„ BitSet å­˜å‚¨å„åˆ†ç‰‡çš„ä¸Šä¼ çŠ¶æ€</p>
<p>å¯¹è±¡å­˜å‚¨ï¼šåˆ©ç”¨ MinIO ä½œä¸ºåˆ†ç‰‡æ–‡ä»¶çš„å­˜å‚¨ç³»ç»Ÿ</p>
<p>æ–­ç‚¹ç»­ä¼ ï¼šRedis è®°å½•åˆ†ç‰‡çŠ¶æ€ï¼Œå¯ä»¥æ”¯æŒå®¢æˆ·ç«¯ä¸­æ–­åç»§ç»­ä¸Šä¼ æœªå®Œæˆçš„åˆ†ç‰‡</p>
<figure><figcaption>alt text</figcaption></figure>
<h4>å¼‚æ­¥å¤„ç† kafka</h4>
<p>åœ¨æˆåŠŸä¸Šä¼ å®Œæ–‡ä»¶åï¼Œå°±ä¼šç»“æŸä¸å‰ç«¯çš„äº¤äº’ï¼Œåˆ©ç”¨ kafka æ¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç° ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå°† æ–‡ä»¶åˆå¹¶ å’Œ å‘é‡åŒ– ä»»åŠ¡å¼‚æ­¥åˆ†å‘</p>
<p>å¤šæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†ï¼Œæ¥æå‡ç³»ç»Ÿååé‡</p>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ–‡ä»¶åˆå¹¶</h4>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ–‡æ¡£è§£æ</h4>
<p>åˆ©ç”¨ Apache PDFBox, Apache POI, Apache Tika æ¥åˆ†åˆ«å¤„ç†è§£æ</p>
<p>æŒ‰å›ºå®šå¤§å°å°†æå–çš„æ–‡æœ¬å†…å®¹åˆ†æ®µ</p>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ–‡æœ¬å‘é‡åŒ–</h4>
<p>é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ <code>Elasticsearch</code> ä¸­</p>
<p>å› ä¸ºéœ€è¦å­˜çš„æ˜¯ 2048 ç»´çš„å‘é‡è¡¨ç¤ºï¼Œè€Œè±†åŒ…ä¸æ”¯æŒ</p>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ–‡æ¡£ç®¡ç†</h4>
<ul>
<li>æ–‡æ¡£åˆ é™¤ï¼šæ”¯æŒç”¨æˆ·åˆ é™¤å·²ä¸Šä¼ çš„æ–‡æ¡£ä»¥åŠç›¸å…³æ•°æ®</li>
<li>æƒé™æ§åˆ¶ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„æ–‡æ¡£ï¼Œç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•æ–‡æ¡£</li>
</ul>
<h3>æ–‡ä»¶ä¸Šä¼ ä¸»è¦é€»è¾‘</h3>
<ul>
<li>å®¢æˆ·ç«¯è®¡ç®—æ–‡ä»¶ MD5ï¼Œå‘èµ·ä¸Šä¼ è¯·æ±‚â†’æœåŠ¡ç«¯éªŒè¯æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œè¿”å›åˆ†ç‰‡ç­–ç•¥</li>
<li>å®¢æˆ·ç«¯æ ¹æ®ç­–ç•¥åˆ†ç‰‡ä¸Šä¼ æ–‡ä»¶</li>
<li>æœåŠ¡ç«¯æ¥æ”¶åˆ†ç‰‡ï¼Œå­˜å…¥ MinIO å¹¶æ›´æ–° Redis çŠ¶æ€</li>
<li>æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè§¦å‘åˆå¹¶æ“ä½œ</li>
<li>åˆå¹¶å®Œæˆåå‘é€è§£æä»»åŠ¡åˆ° Kafkaâ†’è§£ææœåŠ¡æ¶ˆè´¹ä»»åŠ¡ï¼Œæ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ç›¸åº”è§£æå™¨æå–æ–‡æœ¬</li>
<li>æ–‡æœ¬åˆ†å—åå‘é€å‘é‡åŒ–ä»»åŠ¡åˆ° Kafkaâ†’å‘é‡åŒ–æœåŠ¡æ¶ˆè´¹ä»»åŠ¡ï¼Œè°ƒç”¨è±†åŒ… API å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º</li>
<li>å‘é‡æ•°æ®å†™å…¥ Elasticsearch å’Œé¢„ç•™ FAISS æ¥å£â†’æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œé€šçŸ¥ç”¨æˆ·å¤„ç†å®Œæˆ</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<h4>Mysql æ•°æ®è¡¨</h4>
<ul>
<li>
<p>æ–‡ä»¶ä¸»è¡¨(file_upload)ï¼šå­˜å‚¨æ–‡ä»¶å…ƒä¿¡æ¯ï¼Œå¦‚ MD5ã€åç§°ã€å¤§å°ã€çŠ¶æ€</p>
</li>
<li>
<p>åˆ†ç‰‡è¡¨(chunk_info)ï¼šè®°å½•æ¯ä¸ªåˆ†ç‰‡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç´¢å¼•ã€MD5ã€å­˜å‚¨è·¯å¾„</p>
</li>
<li>
<p>è§£æç»“æœè¡¨(document_vectors)ï¼šå­˜å‚¨æ–‡æœ¬åˆ†å—å’Œå‘é‡åŒ–ç»“æœçš„å…ƒæ•°æ®</p>
</li>
</ul>
<h4>Redis</h4>
<p>ä½¿ç”¨ BitSet è®°å½•å·²ä¸Šä¼ åˆ†ç‰‡çš„ä½å›¾ï¼ˆSETBITå‘½ä»¤ï¼‰</p>
<p>å­˜å‚¨ä¸Šä¼ ä»»åŠ¡çš„ä¸´æ—¶çŠ¶æ€å’Œè¿›åº¦</p>
<p>ç¼“å­˜çƒ­ç‚¹æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›</p>
<h4>MinIO</h4>
<p>ä¸´æ—¶åˆ†ç‰‡ï¼šå­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶åˆ†ç‰‡ï¼Œè·¯å¾„ç»“æ„ä¸º <code>/temp/{fileMd5}/{chunkIndex}</code></p>
<p>å®Œæ•´æ–‡ä»¶ï¼šåˆå¹¶åçš„æ–‡ä»¶å­˜å‚¨åœ¨ <code>/documents/{userId}/{fileName}</code></p>
<p>å­˜å‚¨ç­–ç•¥ï¼šå®ç°çƒ­å†·æ•°æ®åˆ†ç¦»</p>
<h4>Elasticsearch</h4>
<p>å­˜å‚¨æ–‡æœ¬å‘é‡æ•°æ®å’ŒåŸå§‹æ–‡æœ¬å†…å®¹ï¼Œç´¢å¼•åŸºäºæ–‡ä»¶ MD5 å’Œåˆ†å— ID ç»„ç»‡</p>
]]></content:encoded>
    </item>
    <item>
      <title>item3 - 6 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—2</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article6.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article6.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 6 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—2</source>
      <description>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½ ç›®çš„ é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§ å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç† æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ Ela...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:17:03 GMT</pubDate>
      <content:encoded><![CDATA[<p>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½</p>
<h2>ç›®çš„</h2>
<ul>
<li>é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§</li>
<li>å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ</li>
<li>æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç†</li>
<li>æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ <code>Elasticsearch</code> ä¸­ï¼Œæœªæ¥å°†åŒæ—¶æ”¯æŒ FAISS å­˜å‚¨</li>
</ul>
<h2>æ–‡ä»¶ä¸Šä¼ </h2>
<p>é¦–å…ˆå‰ç«¯å¯¹äºç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œç”±å‰ç«¯æ¥è®¡ç®—å¯¹åº”çš„MD5å€¼ (åˆ†ç‰‡è¯»å– + å¢é‡è®¡ç®—)</p>
<p>ç„¶åæ ¹æ®åˆ†ç‰‡ç­–ç•¥é€»è¾‘ (5MB ä¸ºä¸€ä¸ª chunk)ï¼ŒåŸºäºæ­¤å¼€å§‹ä¸æ–­åœ°å‘é€åˆ†ç‰‡ä¸Šä¼ è¯·æ±‚(æ–‡ä»¶MD5, åˆ†ç‰‡ç´¢å¼•ä»¥åŠåˆ†ç‰‡æ•°æ®)</p>
<p>åç«¯ä¸æ–­æ¥å—ä¼ æ¥çš„åˆ†ç‰‡ï¼Œå…ˆæ ¡éªŒå…¶å®Œæ•´æ€§å’Œåˆæ³•æ€§</p>
<p>ç„¶åå°†åˆ†ç‰‡å­˜å‚¨åˆ° MinIO ä¸­ï¼Œå¯¹åº”çš„åœ¨ MinIO çš„ä¸´æ—¶è·¯å¾„ <code>/temp/{fileMd5}/{chunkIndex}</code></p>
<p>ä¹‹ååœ¨ Redis ä¸Šè®°å½•ç›®å‰æ¥å—äº†å“ªäº›åˆ†ç‰‡ç´¢å¼•</p>
<p>ç„¶åå°†ä¿¡æ¯ (åˆ†ç‰‡è®°å½•ä»¥åŠä¸Šä¼ è¿›åº¦) æ›´æ–°åˆ° Mysql çš„è¡¨å†…(chunk_info file_upload)</p>
<figure><figcaption>alt text</figcaption></figure>
<p>æ„Ÿè§‰å‰ç«¯é‚£å—å¤„ç†çš„ä¸œè¥¿ä¹Ÿæœ‰ä¸€äº›</p>
<h3>å‰ç«¯åˆ†æ</h3>
<p>ä¸»è¦ä¸Šä¼ é€»è¾‘(ç‚¹å‡»ä¿å­˜æŒ‰é’®å)é€»è¾‘å— (åœ¨ views/knowledge-base/moudles/upload-dialog.vue ç»„ä»¶é‡Œ)</p>
<div class="language-javascript" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useKnowledgeBaseStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¡¨å•æ ¡éªŒ (å¿…å¡«é¡¹æ£€æŸ¥ï¼šç»„ç»‡æ ‡ç­¾ã€å…¬å¼€æ€§ã€æ˜¯å¦é€‰äº†æ–‡ä»¶)</span>
  <span class="token keyword">await</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å‡ºç°ä¸Šä¼ åŠ¨ç”»</span>
  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// å°†æ•°æ®â€œæ‰”â€ç»™ Pinia Store</span>
  <span class="token comment">// æ³¨æ„ï¼šè¿™é‡Œä¼ è¿›å»çš„ model.value åŒ…å«äº† fileList (ä¹Ÿå°±æ˜¯æ–‡ä»¶æœ¬èº«)</span>
  <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">enqueueUpload</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸Šä¼ æˆåŠŸ</span>
  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹åº”çš„ä¸Šä¼ é€»è¾‘å°±æ˜¯åœ¨ <code>store.enqueueUpload(model.value)</code></p>
<p>å…·ä½“ä¿å­˜åœ¨ <code>store/knowledge-base/index.ts</code></p>
<p>ä¸»è¦é€»è¾‘å°±æ˜¯å¯¹äº <code>upload-dialog</code> ç»„ä»¶å­˜çš„æ–‡ä»¶ï¼Œå…ˆè®¡ç®—å‡º MD5 å€¼ï¼Œç„¶ååˆ›å»ºä¸ªä¸Šä¼ ä»»åŠ¡ï¼Œå°†æ–‡ä»¶å¤§å°ä»¥ 5MB ä¸ºä¸€ä¸ª chunk è¿›è¡Œåˆ‡å‰²ï¼Œå¹¶é™åˆ¶ä¸€æ¬¡å¯ä»¥å¹¶å‘ä¼ è¾“çš„ chunk æ•°é‡æ¥ä¼ è¾“</p>
<div class="language-javascript" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
 * å¼‚æ­¥å‡½æ•°ï¼šå°†ä¸Šä¼ è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
 *
 * æœ¬å‡½æ•°å¤„ç†ä¸Šä¼ ä»»åŠ¡çš„æ’é˜Ÿå’Œåˆå§‹åŒ–å·¥ä½œå®ƒé¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒçš„æ–‡ä»¶ï¼Œ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¼ ä»»åŠ¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ€åå¯åŠ¨ä¸Šä¼ æµç¨‹
 *
 * <span class="token keyword">@param</span> <span class="token parameter">form</span> åŒ…å«ä¸Šä¼ ä¿¡æ¯çš„è¡¨å•ï¼ŒåŒ…æ‹¬æ–‡ä»¶åˆ—è¡¨å’Œæ˜¯å¦å…¬å¼€çš„æ ‡ç­¾
 * <span class="token keyword">@returns</span> è¿”å›ä¸€ä¸ªä¸Šä¼ ä»»åŠ¡å¯¹è±¡ï¼Œæ— è®ºæ˜¯å·²å­˜åœ¨çš„è¿˜æ˜¯æ–°åˆ›å»ºçš„
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">enqueueUpload</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">form</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>Form</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–æ–‡ä»¶åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> form<span class="token punctuation">.</span>fileList<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>file<span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¡ç®—æ–‡ä»¶çš„MD5å€¼ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ–‡ä»¶</span>
  <span class="token keyword">const</span> md5 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateMD5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶</span>
  <span class="token keyword">const</span> existingTask <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> md5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼Œç›´æ¥è¿”å›è¯¥ä¸Šä¼ ä»»åŠ¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>$message<span class="token operator">?.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'æ–‡ä»¶å·²å­˜åœ¨'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Pending <span class="token operator">||</span> existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Uploading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>$message<span class="token operator">?.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Break<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      existingTask<span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Pending<span class="token punctuation">;</span>
      <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ›å»ºæ–°çš„ä¸Šä¼ ä»»åŠ¡å¯¹è±¡</span>
  <span class="token keyword">const</span> <span class="token literal-property property">newTask</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">,</span>
    <span class="token literal-property property">chunk</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">chunkIndex</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> md5<span class="token punctuation">,</span>
    <span class="token literal-property property">fileName</span><span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token literal-property property">totalSize</span><span class="token operator">:</span> file<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
    <span class="token literal-property property">isPublic</span><span class="token operator">:</span> form<span class="token punctuation">.</span>isPublic<span class="token punctuation">,</span>
    <span class="token literal-property property">uploadedChunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> UploadStatus<span class="token punctuation">.</span>Pending<span class="token punctuation">,</span>
    <span class="token literal-property property">orgTag</span><span class="token operator">:</span> form<span class="token punctuation">.</span>orgTag
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  newTask<span class="token punctuation">.</span>orgTagName <span class="token operator">=</span> form<span class="token punctuation">.</span>orgTagName <span class="token operator">??</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// å°†æ–°çš„ä¸Šä¼ ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­</span>
  tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¯åŠ¨ä¸Šä¼ æµç¨‹</span>
  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å›æ–°çš„ä¸Šä¼ ä»»åŠ¡</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** å¯åŠ¨æ–‡ä»¶ä¸Šä¼ çš„å¼‚æ­¥å‡½æ•° è¯¥å‡½æ•°è´Ÿè´£ä»å¾…ä¸Šä¼ é˜Ÿåˆ—ä¸­å¯åŠ¨æ–‡ä»¶ä¸Šä¼ ä»»åŠ¡ï¼Œå¹¶ç®¡ç†å¹¶å‘ä¸Šä¼ çš„æ•°é‡ */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é™åˆ¶å¯åŒæ—¶ä¸Šä¼ çš„æ–‡ä»¶ä¸ªæ•°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å–å¾…ä¸Šä¼ çš„æ–‡ä»¶</span>
  <span class="token keyword">const</span> pendingTasks <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>status <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span>Pending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å¦‚æœæ²¡æœ‰å¾…ä¸Šä¼ çš„æ–‡ä»¶ï¼Œåˆ™ç›´æ¥è¿”å›</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingTasks<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–ç¬¬ä¸€ä¸ªå¾…ä¸Šä¼ çš„æ–‡ä»¶</span>
  <span class="token keyword">const</span> task <span class="token operator">=</span> pendingTasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Uploading<span class="token punctuation">;</span>
  activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¡ç®—æ–‡ä»¶æ€»ç‰‡æ•°</span>
  <span class="token comment">// chunkSize = 5 * 1024 * 1024;</span>
  <span class="token keyword">const</span> totalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>uploadedChunks<span class="token punctuation">.</span>length <span class="token operator">===</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'æ–‡ä»¶åˆå¹¶å¤±è´¥'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// const promises = [];</span>
    <span class="token comment">// éå†æ‰€æœ‰ç‰‡æ•°</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalChunks<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæœªä¸Šä¼ ï¼Œåˆ™ä¸Šä¼ </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>uploadedChunks<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span>chunkIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token comment">// promises.push(uploadChunk(task))</span>
        <span class="token comment">// eslint-disable-next-line no-await-in-loop</span>
        <span class="token comment">// ä¸»è¦é€»è¾‘ï¼ŒåŒæ—¶ä¼šæ£€éªŒå½“å‰æ–‡ä»¶æ˜¯å¦å·²ç»ä¼ å®Œ</span>
        <span class="token comment">// å¦‚æœå…¨ä¼ äº†ï¼Œé‚£ä¹ˆä¼šå‡ºå‘ merge</span>
        <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'åˆ†ç‰‡ä¸Šä¼ å¤±è´¥'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// await Promise.all(promises)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'%c [ ğŸ‘‰ upload error ğŸ‘ˆ ]-168'</span><span class="token punctuation">,</span> <span class="token string">'font-size:16px; background:#94cc97; color:#d8ffdb;'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œåˆ™å°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸ºä¸­æ–­</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Break<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä»æ´»è·ƒé˜Ÿåˆ—ä¸­ç§»é™¤</span>
    activeUploads<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡</span>
    <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…·ä½“çš„æ–‡ä»¶ chunk ä¸Šä¼  ä»¥åŠ merge ä»£ç </p>
<div class="language-javascript" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">task</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> totalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> chunkStart <span class="token operator">=</span> task<span class="token punctuation">.</span>chunkIndex <span class="token operator">*</span> chunkSize<span class="token punctuation">;</span>
  <span class="token keyword">const</span> chunkEnd <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>chunkStart <span class="token operator">+</span> chunkSize<span class="token punctuation">,</span> task<span class="token punctuation">.</span>totalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> chunk <span class="token operator">=</span> task<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>chunkStart<span class="token punctuation">,</span> chunkEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  task<span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
  <span class="token keyword">const</span> requestId <span class="token operator">=</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>requestIds <span class="token operator">??=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>requestIds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token operator">&lt;</span>Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>Progress<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/upload/chunk'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> task<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span>
      <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">,</span>
      <span class="token literal-property property">chunkIndex</span><span class="token operator">:</span> task<span class="token punctuation">.</span>chunkIndex<span class="token punctuation">,</span>
      <span class="token literal-property property">totalSize</span><span class="token operator">:</span> task<span class="token punctuation">.</span>totalSize<span class="token punctuation">,</span>
      <span class="token literal-property property">fileName</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
      <span class="token literal-property property">orgTag</span><span class="token operator">:</span> task<span class="token punctuation">.</span>orgTag<span class="token punctuation">,</span>
      <span class="token literal-property property">isPublic</span><span class="token operator">:</span> task<span class="token punctuation">.</span>isPublic <span class="token operator">??</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'multipart/form-data'</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token constant">REQUEST_ID_KEY</span><span class="token punctuation">]</span><span class="token operator">:</span> requestId
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  task<span class="token punctuation">.</span>requestIds <span class="token operator">=</span> task<span class="token punctuation">.</span>requestIds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> id <span class="token operator">!==</span> requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// æ›´æ–°ä»»åŠ¡çŠ¶æ€</span>
  <span class="token keyword">const</span> updatedTask <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  updatedTask<span class="token punctuation">.</span>uploadedChunks <span class="token operator">=</span> data<span class="token punctuation">.</span>uploaded<span class="token punctuation">;</span>
  updatedTask<span class="token punctuation">.</span>progress <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>uploaded<span class="token punctuation">.</span>length <span class="token operator">===</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">task</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/upload/merge'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">,</span> <span class="token literal-property property">fileName</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileName <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹åº”çš„ æ–‡ä»¶MD5 è®¡ç®—é€»è¾‘ (utils/common.ts)ï¼š</p>
<p><code>spark-md5</code> æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä¸“é—¨ç”¨äºåœ¨æµè§ˆå™¨ç«¯é«˜æ•ˆè®¡ç®— MD5</p>
<p>æ”¯æŒå¢é‡è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥å–‚ç»™å®ƒä¸€éƒ¨åˆ†æ•°æ®ï¼Œå®ƒç®—å‡ºä¸­é—´çŠ¶æ€ï¼Œç„¶åä½ å†å–‚ä¸‹ä¸€éƒ¨åˆ†ï¼Œå®ƒæ¥ç€ç®—ã€‚</p>
<div class="language-javascript" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calculateMD5</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">file</span><span class="token operator">:</span> File</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 5MB</span>
    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">loadNext</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> currentChunk <span class="token operator">*</span> chunkSize<span class="token punctuation">;</span>
      <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>start <span class="token operator">+</span> chunkSize<span class="token punctuation">,</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token operator">?.</span>result <span class="token keyword">as</span> ArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentChunk <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    reader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'æ–‡ä»¶è¯»å–å¤±è´¥'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>åç«¯åˆ†æ</h3>
<p>å‰ç«¯ä¼šè®¡ç®—å‡ºä¸Šä¼ æ–‡ä»¶çš„MD5ï¼Œç„¶åä¸æ–­è°ƒç”¨åç«¯çš„ <code>/upload/chunk</code> æ¥å£æ¥ä¼ è¾“æ–‡ä»¶ï¼ŒåŒæ—¶æ¯æ¬¡æˆåŠŸä¸Šä¼ åï¼Œä¼šæ£€æŸ¥æ˜¯å¦å·²ç»ä¼ è¾“å®Œæˆï¼Œå¦‚æœéƒ½ä¼ è¾“å®Œæˆï¼Œå‰ç«¯ä¼šè°ƒç”¨ <code>/upload/merge</code> æ¥å£è§¦å‘åç«¯çš„æ–‡ä»¶åˆå¹¶æ“ä½œ</p>
<p>æ–‡ä»¶ä¸Šä¼ ä¸»è¦æ¶‰åŠçš„æ˜¯ <code>UploadController</code> ä»¥åŠå¯¹åº”çš„ <code>Service</code>æ¨¡å—ä»£ç </p>
<p>åˆ†ç‰‡ä¸Šä¼ æ¥å£ï¼š</p>
<ul>
<li>
<p>URL: <code>/api/v1/upload/chunk</code></p>
</li>
<li>
<p>Method: POST</p>
</li>
<li token="">
<p>Headers: Bearer</p>
</li>
<li>
<p>Body: (multipart/form-data)</p>
<div class="language-http" data-ext="http" data-title="http"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">fileMd5</span><span class="token punctuation">:</span> <span class="token header-value">d41d8cd98f00b204e9800998ecf8427e      // æ–‡ä»¶MD5å€¼ï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">chunkIndex</span><span class="token punctuation">:</span> <span class="token header-value">3                                  // åˆ†ç‰‡ç´¢å¼•ï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">totalSize</span><span class="token punctuation">:</span> <span class="token header-value">15728640                            // æ–‡ä»¶æ€»å¤§å°ï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">fileName</span><span class="token punctuation">:</span> <span class="token header-value">å¹´åº¦æŠ¥å‘Š.pdf                         // æ–‡ä»¶åï¼ˆå¿…éœ€ï¼Œç°åœ¨æ”¯æŒä¸­æ–‡ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">totalChunks</span><span class="token punctuation">:</span> <span class="token header-value">64                               // æ€»åˆ†ç‰‡æ•°é‡ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">orgTag</span><span class="token punctuation">:</span> <span class="token header-value">DEPT_A                                // ç»„ç»‡æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé»˜è®¤ç”¨æˆ·ä¸»ç»„ç»‡æ ‡ç­¾ï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">isPublic</span><span class="token punctuation">:</span> <span class="token header-value">true                                // æ˜¯å¦å…¬å¼€ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰</span></span>
<span class="token header"><span class="token header-name keyword">file</span><span class="token punctuation">:</span> <span class="token header-value">[åˆ†ç‰‡äºŒè¿›åˆ¶æ•°æ®]                        // åˆ†ç‰‡æ–‡ä»¶æ•°æ®ï¼ˆå¿…éœ€ï¼‰</span></span>
</code></pre></div></li>
<li>
<p>Response</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code>&lt;!-- æˆåŠŸ --&gt;
<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ"</span><span class="token punctuation">,</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"uploaded"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"progress"</span><span class="token operator">:</span> <span class="token number">75.0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
&lt;!-- å¤±è´¥ --&gt;
<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: å…·ä½“é”™è¯¯ä¿¡æ¯"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
</ul>
<h4>Contorllerå±‚ <code>UploadController</code></h4>
<p><code>UploadController/uploadChunk</code> - <code>/chunk</code>æ¥å£</p>
<p>æ¥æ¥å—å‰ç«¯çš„åˆ†å—æ–‡ä»¶ï¼Œå¹¶å®ç°æ–‡ä»¶ä¿å­˜è®°å½•</p>
<ul>
<li>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¼ è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šæŠŠæ€»æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ä¿å­˜åœ¨ <code>file_upload</code> è¡¨</li>
<li>å­˜ chunk åˆ° MinIO æŒ‡å®šä¸´æ—¶è·¯å¾„</li>
<li>å­˜ chunk çš„åŸºæœ¬ä¿¡æ¯åˆ° <code>chunk_info</code> è¡¨</li>
<li>æ¥å—å®Œæˆï¼Œåœ¨ Redis çš„æ ‡è®° BitMap å¯¹åº”ä½çš„å€¼ï¼Œä½œä¸ºæˆåŠŸä¸Šä¼ </li>
</ul>
<h5><code>MultipartFile</code> å¯¹è±¡</h5>
<p>æ˜¯ Spring Framework ä¸­ç”¨äºå¤„ç†æ–‡ä»¶ä¸Šä¼ çš„æ ¸å¿ƒæ¥å£ï¼š<code>org.springframework.web.multipart.MultipartFile</code></p>
<p>æ˜¯ Spring å¯¹â€œä¸Šä¼ æ–‡ä»¶â€è¿™ä¸ªæ¦‚å¿µçš„æŠ½è±¡</p>
<p>æ— è®ºåº•å±‚ä½¿ç”¨çš„æ˜¯ Tomcat çš„æ ‡å‡† Servlet API è¿˜æ˜¯ Apache Commons FileUploadï¼ŒSpring éƒ½ä¼šæŠŠä¸Šä¼ çš„æ–‡ä»¶å°è£…æˆè¿™ä¸ª MultipartFile å¯¹è±¡è®©ä½ ä½¿ç”¨</p>
<p>åœ¨ HTTP multipart/form-data è¯·æ±‚ä¸­ï¼Œæ¯ä¸€ä¸ª<strong>æ–‡ä»¶éƒ¨åˆ†</strong>ï¼ˆFile Partï¼‰åœ¨ Java ä»£ç ä¸­çš„å¯¹è±¡æ˜ å°„</p>
<p>å­˜åœ¨å‡ ä¸ªæ–¹æ³•å¯ä»¥ä½¿ç”¨</p>
<ul>
<li>
<p>è·å–å…ƒæ•°æ®ï¼š</p>
<ul>
<li><code>getName()</code>: è·å–è¡¨å•ä¸­ <code>&lt;input type="file" name="file"&gt;</code> çš„ name å±æ€§å€¼ï¼ˆè¡¨å•å­—æ®µåï¼‰</li>
<li><code>getOriginalFilename()</code>: è·å–ç”¨æˆ·ç”µè„‘ä¸Šæ–‡ä»¶çš„åŸå§‹åç§°ï¼ˆä¾‹å¦‚ photo.jpgï¼‰</li>
<li><code>getContentType()</code>: è·å–æ–‡ä»¶çš„ MIME ç±»å‹ï¼ˆä¾‹å¦‚ image/jpegï¼‰</li>
<li><code>getSize()</code>: è·å–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰</li>
</ul>
</li>
<li>
<p>è¯»å–æ–‡ä»¶å†…å®¹ï¼š</p>
<ul>
<li><code>getBytes()</code>: å°†æ–‡ä»¶å†…å®¹ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜ï¼ˆbyte[]ï¼‰ã€‚æ³¨æ„ï¼šå¤§æ–‡ä»¶æ…ç”¨ï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æº¢å‡º (OOM)ã€‚</li>
<li><code>getInputStream()</code>: è·å–è¾“å…¥æµã€‚è¿™æ˜¯å¤„ç†å¤§æ–‡ä»¶çš„æ¨èæ–¹å¼ï¼Œå¯ä»¥æµå¼è¯»å–ã€‚</li>
</ul>
</li>
<li>
<p>ä¿å­˜æ–‡ä»¶ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š</p>
<ul>
<li><code>transferTo(File dest)</code>: å°†ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶ç§»åŠ¨/å†™å…¥åˆ°æœåŠ¡å™¨ç£ç›˜ä¸Šçš„æŒ‡å®šä½ç½®ã€‚è¿™æ˜¯æœ€æ–¹ä¾¿çš„ä¿å­˜æ–‡ä»¶çš„æ–¹æ³•ã€‚</li>
</ul>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 1. è·å–æ–‡ä»¶å</span>
<span class="token class-name">String</span> fileName <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. å®šä¹‰ä¿å­˜è·¯å¾„</span>
<span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/data/uploads/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3. ä¿å­˜æ–‡ä»¶ (æ ¸å¿ƒæ–¹æ³•è°ƒç”¨)</span>
file<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li>
</ul>
<h5>å‚æ•°åˆ†æ</h5>
<p>å‰é¢å‡ ä¸ªéƒ½æ˜¯ç”±å‰ç«¯ä¼ æ¥çš„å‚æ•° åŒ…æ‹¬äº† æ–‡ä»¶çš„MD5 åˆ†ç‰‡ç´¢å¼• æ–‡ä»¶æ€»å¤§å° æ–‡ä»¶å æ€»åˆ†ç‰‡æ•°é‡ç­‰</p>
<p>ä½†è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ä» Attribute è·å–çš„ï¼Œè¿™æ˜¯ç”±äºåœ¨åˆ° Controller å¤„ç†ä¹‹å‰ï¼Œä¼šç»è¿‡ç»„ç»‡éªŒè¯è¿‡æ»¤å™¨ï¼ŒæˆåŠŸä¼šå°† userId å¡åˆ°è¯¥è¯·æ±‚çš„ Attribute ä¸­</p>
<p>Spring éƒ½ä¼šæŠŠä¸Šä¼ çš„æ–‡ä»¶å°è£…æˆè¿™ä¸ª <code>MultipartFile</code> å¯¹è±¡æ¥ä½¿ç”¨</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
 * ä¸Šä¼ æ–‡ä»¶åˆ†ç‰‡æ¥å£
 *
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> æ–‡ä»¶çš„MD5å€¼ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ–‡ä»¶
 * <span class="token keyword">@param</span> <span class="token parameter">chunkIndex</span> åˆ†ç‰‡ç´¢å¼•ï¼Œè¡¨ç¤ºå½“å‰åˆ†ç‰‡çš„ä½ç½®
 * <span class="token keyword">@param</span> <span class="token parameter">totalSize</span> æ–‡ä»¶æ€»å¤§å°
 * <span class="token keyword">@param</span> <span class="token parameter">fileName</span> æ–‡ä»¶å
 * <span class="token keyword">@param</span> <span class="token parameter">totalChunks</span> æ€»åˆ†ç‰‡æ•°é‡
 * <span class="token keyword">@param</span> <span class="token parameter">orgTag</span> ç»„ç»‡æ ‡ç­¾ï¼Œå¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨ç”¨æˆ·çš„ä¸»ç»„ç»‡æ ‡ç­¾
 * <span class="token keyword">@param</span> <span class="token parameter">isPublic</span> æ˜¯å¦å…¬å¼€ï¼Œé»˜è®¤ä¸ºfalse
 * <span class="token keyword">@param</span> <span class="token parameter">file</span> åˆ†ç‰‡æ–‡ä»¶å¯¹è±¡
 * <span class="token keyword">@return</span> è¿”å›åŒ…å«å·²ä¸Šä¼ åˆ†ç‰‡å’Œä¸Šä¼ è¿›åº¦çš„å“åº”
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> å½“æ–‡ä»¶è¯»å†™å‘ç”Ÿé”™è¯¯æ—¶æŠ›å‡º
 */</span>
<span class="token comment">// å…¶ä¸­ userId å‚æ•°æ˜¯ä» ç»„ç»‡è¿‡æ»¤å™¨ ä¸­è·å–çš„</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/chunk"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"chunkIndex"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"totalSize"</span><span class="token punctuation">)</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileName"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"totalChunks"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> totalChunks<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orgTag"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"isPublic"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestAttribute</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre></div><h5>éªŒè¯åˆç†æ€§</h5>
<p><code>fileTypeValidationService</code> | <code>userService</code></p>
<p>å¦‚æœ <code>chunkIndex == 0</code> è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¼šè°ƒç”¨ <code>fileTypeValidationService.validateFileType</code> æ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦èƒ½æ”¯æŒï¼Œè¿›è€Œè¿”å›ä¸€ä¸ª æ–‡ä»¶ç±»å‹éªŒè¯ç»“æœç±» <code>FileTypeValidationResult</code></p>
<p>å¦‚æœæ˜¯ä¸æ”¯æŒçš„ç±»å‹ <code>!validationResult.isValid()</code>ï¼Œè¿›è€Œå°±è¿”å›å¹¶é€šçŸ¥å‰ç«¯</p>
<p>å¦‚æœæ–‡ä»¶ç±»å‹æ”¯æŒæˆ–è€… <code>chunkIndex != 0</code> (æ–‡ä»¶æ²¡é—®é¢˜)ï¼Œæ˜¯å¦è®¾ç½®äº†æ–‡ä»¶å±äºå“ªä¸ªç»„ç»‡ï¼Œå³å¯¹åº”å‚æ•° <code>orgTag</code> å¯é€‰</p>
<p>å½“å‰ç«¯æ²¡æœ‰ç»™å®šè¯¥å‚æ•°ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»™è¯¥æ–‡ä»¶é»˜è®¤ä¸€ä¸ªç»„ç»‡å‚æ•° (å½“å‰ç”¨æˆ·çš„é»˜è®¤ä¸»ç»„ç»‡)</p>
<p>é€šè¿‡ <code>userService.getUserPrimaryOrg(userId)</code> è·å–ï¼Œå¦‚æœæ²¡æœ‰å°±æŠ¥é”™ï¼Œå¦åˆ™å°±å°†è¯¥æ–‡ä»¶å±äºè¯¥ç”¨æˆ·å¯¹åº”çš„ä¸»ç»„ç»‡</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token comment">// æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆä»…åœ¨ç¬¬ä¸€ä¸ªåˆ†ç‰‡æ—¶è¿›è¡ŒéªŒè¯ï¼‰</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">FileTypeValidationService<span class="token punctuation">.</span>FileTypeValidationResult</span> validationResult <span class="token operator">=</span> 
      fileTypeValidationService<span class="token punctuation">.</span><span class="token function">validateFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶ç±»å‹éªŒè¯ç»“æœ: fileName=%s, valid=%s, fileType=%s, message=%s"</span><span class="token punctuation">,</span> 
          fileName<span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResult<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶ç±»å‹éªŒè¯å¤±è´¥: fileName=%s, fileType=%s"</span><span class="token punctuation">,</span> 
              <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ç±»å‹éªŒè¯å¤±è´¥: "</span> <span class="token operator">+</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fileType"</span><span class="token punctuation">,</span> validationResult<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"supportedTypes"</span><span class="token punctuation">,</span> fileTypeValidationService<span class="token punctuation">.</span><span class="token function">getSupportedFileTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> contentType <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ¥æ”¶åˆ°åˆ†ç‰‡ä¸Šä¼ è¯·æ±‚: fileMd5=%s, chunkIndex=%d, fileName=%s, fileType=%s, contentType=%s, fileSize=%d, totalSize=%d, orgTag=%s, isPublic=%s"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¦‚æœæœªæŒ‡å®šç»„ç»‡æ ‡ç­¾ï¼Œåˆ™è·å–ç”¨æˆ·çš„ä¸»ç»„ç»‡æ ‡ç­¾</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>orgTag <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orgTag<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"ç»„ç»‡æ ‡ç­¾æœªæŒ‡å®šï¼Œå°è¯•è·å–ç”¨æˆ·ä¸»ç»„ç»‡æ ‡ç­¾: fileName=%s"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> primaryOrg <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserPrimaryOrg</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      orgTag <span class="token operator">=</span> primaryOrg<span class="token punctuation">;</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æˆåŠŸè·å–ç”¨æˆ·ä¸»ç»„ç»‡æ ‡ç­¾: fileName=%s, orgTag=%s"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> orgTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"è·å–ç”¨æˆ·ä¸»ç»„ç»‡æ ‡ç­¾å¤±è´¥: fileName=%s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"è·å–ä¸»ç»„ç»‡æ ‡ç­¾å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"è·å–ç”¨æˆ·ä¸»ç»„ç»‡æ ‡ç­¾å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logFileOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> <span class="token string">"PROCESSING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>ä¸Šä¼ ä¿å­˜åˆ†å—</h5>
<p><code>uploadService</code></p>
<p>å½“æ–‡ä»¶æ²¡é—®é¢˜ï¼Œå¯¹åº”å±äºå“ªä¸ªç»„ç»‡ä¹Ÿç¡®å®šäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸Šä¼ äº†ï¼Œè°ƒç”¨ <code>uploadService.uploadChunk</code> æ¥å®ç°</p>
<p>å¹¶é€šè¿‡ <code>uploadService.getUploadedChunks</code> æ¥è·å–æˆåŠŸä¸Šä¼ çš„ chunk ä¹‹åå¯ä»¥è¿”å›å‰ç«¯</p>
<p>ä»¥åŠå®é™…æ€» chunks <code>uploadService.getTotalChunks</code> ä»¥åŠå½“å‰çš„è¿›åº¦ <code>double progress = calculateProgress(uploadedChunks, actualTotalChunks);</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code>uploadService<span class="token punctuation">.</span><span class="token function">uploadChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> file<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getUploadedChunks</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> actualTotalChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getTotalChunks</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> progress <span class="token operator">=</span> <span class="token function">calculateProgress</span><span class="token punctuation">(</span>uploadedChunks<span class="token punctuation">,</span> actualTotalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ: fileMd5=%s, fileName=%s, fileType=%s, chunkIndex=%d, è¿›åº¦=%.2f%%"</span><span class="token punctuation">,</span> 
        fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calculateProgress</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks<span class="token punctuation">,</span> <span class="token keyword">int</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>totalChunks <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"CALCULATE_PROGRESS"</span><span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"è®¡ç®—ä¸Šä¼ è¿›åº¦æ—¶æ€»åˆ†ç‰‡æ•°ä¸º0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> totalChunks <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æˆåŠŸæ„å»ºè¯·æ±‚</h5>
<p>åŒ…å«äº†å·²ä¸Šä¼ çš„ chunks å’Œ å½“å‰è¿›åº¦ç™¾åˆ†æ¯”</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ„å»ºæ•°æ®å¯¹è±¡</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"uploaded"</span><span class="token punctuation">,</span> uploadedChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"progress"</span><span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ„å»ºç»Ÿä¸€å“åº”æ ¼å¼</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>å¼‚å¸¸æ•è·å¤„ç†</h5>
<p>ä¼šæ•è·å½“å‰çš„å¼‚å¸¸ï¼Œæ¥è®¾ç½®è¯·æ±‚è¿”å›</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"UPLOAD_CHUNK"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: fileMd5=%s, fileName=%s, fileType=%s, chunkIndex=%d"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>Serviceå±‚ â€” <code>UploadService</code></h4>
<p>ä¸»è¦æ˜¯ <code>UploadService</code>ï¼Œä½†ä¹Ÿæœ‰ <code>fileTypeValidationService</code> å’Œ <code>userService</code></p>
<p>é‡ç‚¹åˆ†æ <code>UploadService</code> çš„ <code>uploadChunk</code>æ–¹æ³•</p>
<h5>ä¸»è¦å‚æ•°</h5>
<p>ä¸»è¦å°±æ˜¯æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯ä»¥åŠç”¨æˆ·ä¿¡æ¯</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ä¸Šä¼ æ–‡ä»¶åˆ†ç‰‡
 *
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> æ–‡ä»¶çš„ MD5 å€¼ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ–‡ä»¶
 * <span class="token keyword">@param</span> <span class="token parameter">chunkIndex</span> åˆ†ç‰‡ç´¢å¼•ï¼Œè¡¨ç¤ºè¿™æ˜¯æ–‡ä»¶çš„ç¬¬å‡ ä¸ªåˆ†ç‰‡
 * <span class="token keyword">@param</span> <span class="token parameter">totalSize</span> æ–‡ä»¶æ€»å¤§å°
 * <span class="token keyword">@param</span> <span class="token parameter">fileName</span> æ–‡ä»¶åç§°
 * <span class="token keyword">@param</span> <span class="token parameter">file</span> è¦ä¸Šä¼ çš„åˆ†ç‰‡æ–‡ä»¶
 * <span class="token keyword">@param</span> <span class="token parameter">orgTag</span> ç»„ç»‡æ ‡ç­¾ï¼ŒæŒ‡å®šæ–‡ä»¶æ‰€å±çš„ç»„ç»‡
 * <span class="token keyword">@param</span> <span class="token parameter">isPublic</span> æ˜¯å¦å…¬å¼€ï¼Œæ ‡è¯†æ–‡ä»¶è®¿é—®æƒé™
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> ä¸Šä¼ ç”¨æˆ·ID
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> å¦‚æœæ–‡ä»¶è¯»å–å¤±è´¥
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre></div><h5>ä¸»è¦æ­¥éª¤</h5>
<ul>
<li>
<p>æ£€æŸ¥åˆ†å—å¯¹åº”çš„æ–‡ä»¶å…ƒä¿¡æ¯æ˜¯å¦å­˜å…¥ <code>file_upload</code> è¡¨ä¸­ï¼›ä¸åœ¨éœ€è¦æ’å…¥ä¿¡æ¯</p>
</li>
<li>
<p>æ£€æŸ¥åˆ†å—æ˜¯å¦å·²ç»ä¸Šä¼ è¿‡äº† <code>isChunkUploaded(fileMd5, chunkIndex, userId)</code></p>
<p>åˆ†å—ä¸Šä¼ ä¿¡æ¯ä¿å­˜åœ¨ redis ç¼“å­˜ä¸­ (BitMap)</p>
<p>key: <code>"upload:" + userId + ":" + fileMd5</code></p>
<p><code>boolean isUploaded = redisTemplate.opsForValue().getBit(redisKey, chunkIndex);</code></p>
<p>å¯¹åº”è¿”å›åˆ¤æ–­ <code>chunkUploaded</code></p>
</li>
<li>
<p>æ£€æŸ¥åˆ†å—çš„å…ƒä¿¡æ¯æ˜¯å¦å­˜å…¥ <code>chunk_info</code> è¡¨ä¸­ï¼Œå…ˆè¿›è¡Œåˆ¤æ–­ <code>chunkInfoExists</code></p>
</li>
<li>
<p>æ ¹æ® <code>chunkUploaded</code> åˆ¤æ–­æ˜¯å¦å·²ç»ä¸Šä¼ </p>
<ul>
<li>å¦‚æœä¸Šä¼ äº†ï¼Œé‚£ä¹ˆåˆ¤æ–­ <code>chunkInfoExists</code> å…ƒä¿¡æ¯æ˜¯å¦å­˜åœ¨æ•°æ®åº“
<ul>
<li>å¦‚æœåˆ†ç‰‡å·²ä¸Šä¼ ä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨è®°å½•ï¼Œéœ€è¦åˆ›å»ºè®°å½•</li>
<li>å¹¶æ£€æŸ¥MinIOä¸­æ˜¯å¦å­˜åœ¨è¯¥åˆ†ç‰‡</li>
<li>å¦‚æœMinIOä¸­ä¸å­˜åœ¨ï¼Œå°†chunkUploadedè®¾ä¸ºfalseä»¥è§¦å‘ä¸Šä¼ æµç¨‹</li>
</ul>
</li>
</ul>
</li>
<li>
<p>è¿›è€Œï¼Œè¿›å…¥åˆ†å—æœªä¸Šä¼ é€»è¾‘ <code>!chunkUploaded</code></p>
<ul>
<li>å…ˆè®¡ç®— chunk çš„ MD5 (chunkMd5) || å·²çŸ¥å…¶æ€»æ–‡ä»¶çš„ MD5 (fileMd5)</li>
<li>æ„å»ºåˆ†ç‰‡çš„å­˜å‚¨è·¯å¾„ <code>storagePath = "chunks/" + fileMd5 + "/" + chunkIndex;</code></li>
<li>å­˜å‚¨åˆ° MinIO, è·¯å¾„ä¸º <code>storagePath</code>, bucket ä¸º <code>uploads</code></li>
<li>å¦‚æœæˆåŠŸäº†ï¼Œæ ‡è®°å·²ä¸Šä¼ 
<ul>
<li>å» Redis å¯¹åº”çš„ BitMap ä½(chunkIndex)è®¾ä¸º true</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸ç®¡åˆ†ç‰‡æ˜¯å¦å·²ä¸Šä¼ ï¼Œéƒ½ç¡®ä¿æ•°æ®åº“ä¸­æœ‰åˆ†ç‰‡ä¿¡æ¯ <code>(!chunkInfoExists &amp;&amp; chunkMd5 != null &amp;&amp; storagePath != null)</code></p>
<ul>
<li>
<p>ä¿å­˜ chunk å…ƒä¿¡æ¯åˆ° <code>chunk_info</code> è¡¨ä¸­</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token function">saveChunkInfo</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h5>æ£€æŸ¥æ–‡ä»¶å…ƒä¿¡æ¯æ˜¯å¦ä¿å­˜<code>file_upload</code> è¡¨ä¸­</h5>
<p>åœ¨ <code>file_upload</code> è¡¨ä¸­å…ƒæ•°æ®åŒ…æ‹¬</p>
<ul>
<li>fileMd5 (æ–‡ä»¶çš„MD5)</li>
<li>fileName (æ–‡ä»¶çš„åŸå§‹åç§°)</li>
<li>totalSize (æ–‡ä»¶çš„æ€»å¤§å°)</li>
<li>status (æ–‡ä»¶ä¸Šä¼ çš„çŠ¶æ€ 0è¡¨ç¤ºæ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œ1è¡¨ç¤ºæ–‡ä»¶ä¸Šä¼ å·²å®Œæˆ)</li>
<li>userId (ä¸Šä¼ æ–‡ä»¶çš„ç”¨æˆ·çš„æ ‡è¯†ç¬¦)</li>
<li>orgTag (æ–‡ä»¶æ‰€å±ç»„ç»‡æ ‡ç­¾)</li>
<li>isPublic (æ–‡ä»¶æ˜¯å¦å…¬å¼€)</li>
<li>createdAt</li>
<li>mergeAt</li>
</ul>
<p>å¯¹åº”çš„ Repository ä¸º <code>FileUploadRepository</code></p>
<p>å…ˆæ ¹æ®æ–‡ä»¶çš„MD5å€¼å» <code>file_upload</code> è¡¨ä¸­æ£€æŸ¥æ˜¯å¦å·²ç»ä¿å­˜äº† <code>fileUploadRepository.findByFileMd5AndUserId(fileMd5, userId).isPresent()</code></p>
<p>å¦‚æœè¡¨å†…æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠè¯¥chunkå¯¹åº”çš„æ–‡ä»¶ä¿¡æ¯å­˜å…¥ <code>file_upload</code> è¡¨ä¸­</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–æ–‡ä»¶ç±»å‹ä¿¡æ¯</span>
  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> contentType <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[uploadChunk] å¼€å§‹å¤„ç†åˆ†ç‰‡ä¸Šä¼ è¯·æ±‚ =&gt; fileMd5: {}, chunkIndex: {}, totalSize: {}, fileName: {}, fileType: {}, contentType: {}, fileSize: {}, orgTag: {}, isPublic: {}, userId: {}"</span><span class="token punctuation">,</span> 
              fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ£€æŸ¥ file_upload è¡¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥ file_md5</span>
    <span class="token keyword">boolean</span> fileExists <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥æ–‡ä»¶è®°å½•æ˜¯å¦å­˜åœ¨ =&gt; fileMd5: {}, fileName: {}, fileType: {}, exists: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> fileExists<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ›å»ºæ–°çš„æ–‡ä»¶è®°å½• =&gt; fileMd5: {}, fileName: {}, fileType: {}, totalSize: {}, userId: {}, orgTag: {}, isPublic: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> orgTag<span class="token punctuation">,</span> isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ’å…¥ file_upload è¡¨</span>
      <span class="token class-name">FileUpload</span> fileUpload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setFileMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶åå¯ä»¥ä»è¯·æ±‚ä¸­è·å–</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setTotalSize</span><span class="token punctuation">(</span>totalSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶æ€»å¤§å°</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 è¡¨ç¤ºä¸Šä¼ ä¸­</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®ä¸Šä¼ ç”¨æˆ·ID</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setOrgTag</span><span class="token punctuation">(</span>orgTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®ç»„ç»‡æ ‡ç­¾</span>
      fileUpload<span class="token punctuation">.</span><span class="token function">setPublic</span><span class="token punctuation">(</span>isPublic<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®æ˜¯å¦å…¬å¼€</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileUploadRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>fileUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶è®°å½•åˆ›å»ºæˆåŠŸ =&gt; fileMd5: {}, fileName: {}, fileType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ›å»ºæ–‡ä»¶è®°å½•å¤±è´¥ =&gt; fileMd5: {}, fileName: {}, fileType: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"åˆ›å»ºæ–‡ä»¶è®°å½•å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦ä¸Šä¼  (Rediså†…ç¼“å­˜)</h5>
<p>å°†æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ä¿¡æ¯å­˜åœ¨ Redis çš„BitMapä¸­ï¼Œå¯¹åº”ä½çš„ä¿¡æ¯ == chunkIndexæ˜¯å¦æˆåŠŸä¸Šä¼ </p>
<p><code>redisKey = "upload:" + userId + ":" + fileMd5;</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">boolean</span> chunkUploaded <span class="token operator">=</span> <span class="token function">isChunkUploaded</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å·²ä¸Šä¼  =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, isUploaded: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkUploaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯¹åº”çš„ <code>isChunkUploaded</code> å‡½æ•°</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isChunkUploaded</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å·²ä¸Šä¼  =&gt; fileMd5: {}, chunkIndex: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ— æ•ˆçš„åˆ†ç‰‡ç´¢å¼• =&gt; fileMd5: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"chunkIndex must be non-negative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"upload:"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isUploaded <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€ =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, isUploaded: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> isUploaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> isUploaded<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€å¤±è´¥ =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// æˆ–è€…æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿”å›å…¶ä»–å€¼</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æ£€æŸ¥åˆ†ç‰‡å…ƒä¿¡æ¯æ˜¯å¦ä¿å­˜åœ¨ <code>chunk_info</code> è¡¨ä¸­</h5>
<p><code>chunk_info</code>è¡¨ä¸­å­˜å‚¨çš„å­—æ®µä¸»è¦åŒ…æ‹¬</p>
<ul>
<li>id (åˆ†å—ä¿¡æ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ ç”±æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºå”¯ä¸€ç¡®å®šä¸€ä¸ªåˆ†å—ä¿¡æ¯)</li>
<li>fileMd5 (æ–‡ä»¶çš„MD5, åŒä¸ªæ–‡ä»¶çš„ä¸åŒchunkçš„æ–‡ä»¶MD5éƒ½æ˜¯ä¸€æ ·çš„)</li>
<li>chunkIndex (è¡¨ç¤ºæ–‡ä»¶ä¸­çš„ç¬¬å‡ ä¸ªåˆ†å—ï¼Œç”¨äºä¿æŒåˆ†å—çš„é¡ºåº)</li>
<li>chunkMd5 (åˆ†å—çš„MD5å€¼, æ¯ä¸ªåˆ†å—çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºæ ¡éªŒåˆ†å—çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§)</li>
<li>storagePath (åˆ†å—çš„å­˜å‚¨è·¯å¾„, å¯¹åº”MinIOçš„å­˜å‚¨, è¡¨ç¤ºåˆ†å—åœ¨ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„)</li>
</ul>
<p>æ ¹æ® fileMd5 å» <code>chunk_info</code> ä¸­è·å–è¯¥æ–‡ä»¶çš„æ‰€æœ‰å·²ä¿å­˜çš„chunkçš„ä¿¡æ¯ï¼Œç„¶åéå†åˆ¤æ–­å½“å‰chunkæ˜¯å¦ä¿å­˜</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨åˆ†ç‰‡ä¿¡æ¯</span>
<span class="token keyword">boolean</span> chunkInfoExists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChunkInfo</span><span class="token punctuation">&gt;</span></span> chunkInfos <span class="token operator">=</span> chunkInfoRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5OrderByChunkIndexAsc</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  chunkInfoExists <span class="token operator">=</span> chunkInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>chunk <span class="token operator">-&gt;</span> chunk<span class="token punctuation">.</span><span class="token function">getChunkIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥æ•°æ®åº“ä¸­åˆ†ç‰‡ä¿¡æ¯ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, exists: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkInfoExists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"æ£€æŸ¥æ•°æ®åº“ä¸­åˆ†ç‰‡ä¿¡æ¯å¤±è´¥ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¤±è´¥æ—¶å‡è®¾ä¸å­˜åœ¨ï¼Œç»§ç»­å¤„ç†</span>
  chunkInfoExists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æ ¹æ® <code>chunkUpload</code> å’Œ <code>chunkInfoExists</code> ç»“æœæ¥å¤„ç†åˆ†ç‰‡ä¿å­˜é€»è¾‘</h5>
<h5>è‹¥ Redis å·²è®°å½•æ–‡ä»¶ä¸Šä¼ ï¼Œä½†è¡¨ä¸­æ²¡æ•°æ®</h5>
<p>å¦‚æœåˆ†ç‰‡å·²ä¸Šä¼ ä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨è®°å½•ï¼Œéœ€è¦å»è¡¨é‡Œåˆ›å»ºè®°å½•</p>
<p>é¦–å…ˆå…ˆåŸºäºå¯¹åº” MinIO çš„è·¯å¾„ <code>storagePath = "chunks/" + fileMd5 + "/" + chunkIndex;</code></p>
<p>è¿›ä¸€æ­¥å»æŸ¥æ‰¾æ˜¯å¦å­˜å‚¨ï¼Œå¦‚æœMinIOä¸­ä¸å­˜åœ¨ï¼Œå°†chunkUploadedè®¾ä¸ºfalse</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">String</span> chunkMd5 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> storagePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkUploaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å·²åœ¨Redisä¸­æ ‡è®°ä¸ºå·²ä¸Šä¼  =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¦‚æœåˆ†ç‰‡å·²ä¸Šä¼ ä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨è®°å½•ï¼Œéœ€è¦åˆ›å»ºè®°å½•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkInfoExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å·²ä¸Šä¼ ä½†æ•°æ®åº“æ— è®°å½•ï¼Œéœ€è¦è¡¥å……åˆ†ç‰‡ä¿¡æ¯ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// è®¡ç®—åˆ†ç‰‡çš„MD5å€¼</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      chunkMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// æ„å»ºå­˜å‚¨è·¯å¾„</span>
      storagePath <span class="token operator">=</span> <span class="token string">"chunks/"</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>
      
      <span class="token comment">// æ£€æŸ¥MinIOä¸­æ˜¯å¦å­˜åœ¨è¯¥åˆ†ç‰‡</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token class-name">StatObjectResponse</span> stat <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">statObject</span><span class="token punctuation">(</span>
              <span class="token class-name">StatObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"MinIOä¸­å­˜åœ¨åˆ†ç‰‡æ–‡ä»¶ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, path: {}, size: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> storagePath<span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"MinIOä¸­ä¸å­˜åœ¨åˆ†ç‰‡æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°ä¸Šä¼  =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// å¦‚æœMinIOä¸­ä¸å­˜åœ¨ï¼Œå°†chunkUploadedè®¾ä¸ºfalseä»¥è§¦å‘ä¸Šä¼ æµç¨‹</span>
          chunkUploaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å·²ä¸Šä¼ ä¸”æ•°æ®åº“æœ‰è®°å½•ï¼Œè·³è¿‡å¤„ç† =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// å®Œå…¨è·³è¿‡å¤„ç†</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>Redis æœªè®°å½•ä¸”è¡¨å†…æ— æ•°æ® â€” ä¸Šä¼ chunkè‡³MinIO</h5>
<p>ç»è¿‡ä¸Šé¢çš„é€»è¾‘ï¼Œå³ä½¿ Redis æœ‰æ•°æ®ä½†è¡¨ä¸­æ— æ•°æ®ï¼Œä¸”å‘ç° MinIO æ²¡å­˜ï¼Œå°±æŠŠ <code>chunkUploaded</code> è®¾ä¸º falseï¼Œä»è€Œå¯ä»¥è§¦å‘ä¸‹é¢çš„é€»è¾‘</p>
<p>æˆåŠŸä¿å­˜åˆ° MinIO ä¸­åï¼Œå†å°† Redis å¯¹åº”çš„ chunkIndex ä¸ºè®¾ä¸º true</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// å¦‚æœåˆ†ç‰‡æœªä¸Šä¼ æˆ–éœ€è¦é‡æ–°ä¸Šä¼ </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkUploaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è®¡ç®—åˆ†ç‰‡çš„ MD5 å€¼</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"è®¡ç®—åˆ†ç‰‡MD5 =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  chunkMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡MD5è®¡ç®—å®Œæˆ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, chunkMd5: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
              
  <span class="token comment">// æ„å»ºåˆ†ç‰‡çš„å­˜å‚¨è·¯å¾„</span>
  storagePath <span class="token operator">=</span> <span class="token string">"chunks/"</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ„å»ºåˆ†ç‰‡å­˜å‚¨è·¯å¾„ =&gt; fileName: {}, path: {}"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// å­˜å‚¨åˆ° MinIO</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¸Šä¼ åˆ†ç‰‡åˆ°MinIO =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}, bucket: uploads, path: {}, size: {}, contentType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> storagePath<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">PutObjectArgs</span> putObjectArgs <span class="token operator">=</span> <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>putObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸Šä¼ åˆ°MinIOæˆåŠŸ =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸Šä¼ åˆ°MinIOå¤±è´¥ =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}, é”™è¯¯ç±»å‹: {}, é”™è¯¯ä¿¡æ¯: {}"</span><span class="token punctuation">,</span> 
              fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è¯¦ç»†è®°å½•ä¸åŒç±»å‹çš„MinIOé”™è¯¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span> ere <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span>ErrorResponseException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"MinIOé”™è¯¯å“åº”è¯¦æƒ… =&gt; fileName: {}, code: {}, message: {}, resource: {}, requestId: {}"</span><span class="token punctuation">,</span> 
                  fileName<span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ere<span class="token punctuation">.</span><span class="token function">errorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸Šä¼ åˆ†ç‰‡åˆ°MinIOå¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ ‡è®°åˆ†ç‰‡å·²ä¸Šä¼ </span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ ‡è®°åˆ†ç‰‡ä¸ºå·²ä¸Šä¼  =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">markChunkUploaded</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ ‡è®°å®Œæˆ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ ‡è®°åˆ†ç‰‡å·²ä¸Šä¼ å¤±è´¥ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è¿™é‡Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºåˆ†ç‰‡å·²ç»ä¸Šä¼ æˆåŠŸï¼Œå³ä½¿æ ‡è®°å¤±è´¥ä¹Ÿä¸å½±å“åç»­æ“ä½œ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹åº”åœ¨ Redis è®°å½•æ–‡ä»¶æˆåŠŸä¸Šä¼ é€»è¾‘</p>
<p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¿å­˜ï¼ˆKey ä¸å­˜åœ¨ï¼‰ï¼ŒRedis ä¼šåˆ›å»ºä¸€ä¸ªåˆšå¥½èƒ½å®¹çº³ä¸‹è¿™ä¸ª chunkIndex çš„å­—èŠ‚æ•°ç»„ï¼ˆStringï¼‰</p>
<p>Redis åº•å±‚é€šè¿‡ Byteï¼ˆå­—èŠ‚ï¼‰ æ¥å­˜å‚¨ Bitmapï¼ˆä½å›¾ï¼‰ï¼Œ1 Byte = 8 Bits</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markChunkUploaded</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ ‡è®°åˆ†ç‰‡ä¸ºå·²ä¸Šä¼  =&gt; fileMd5: {}, chunkIndex: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ— æ•ˆçš„åˆ†ç‰‡ç´¢å¼• =&gt; fileMd5: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"chunkIndex must be non-negative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"upload:"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å·²æ ‡è®°ä¸ºå·²ä¸Šä¼  =&gt; fileMd5: {}, chunkIndex: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ ‡è®°åˆ†ç‰‡ä¸ºå·²ä¸Šä¼ å¤±è´¥ =&gt; fileMd5: {}, chunkIndex: {}, userId: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to mark chunk as uploaded"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æœ€åä¿å­˜ chunk å…ƒä¿¡æ¯è‡³ <code>chunk_info</code> è¡¨å†…</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ä¸ç®¡åˆ†ç‰‡æ˜¯å¦å·²ä¸Šä¼ ï¼Œéƒ½ç¡®ä¿æ•°æ®åº“ä¸­æœ‰åˆ†ç‰‡ä¿¡æ¯</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkInfoExists <span class="token operator">&amp;&amp;</span> chunkMd5 <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> storagePath <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"ä¿å­˜åˆ†ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, chunkMd5: {}, storagePath: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">saveChunkInfo</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¿¡æ¯å·²ä¿å­˜åˆ°æ•°æ®åº“ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ä¿å­˜åˆ†ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“å¤±è´¥ =&gt; fileMd5: {}, fileName: {}, chunkIndex: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¿å­˜åˆ†ç‰‡ä¿¡æ¯å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å¤„ç†å®Œæˆ =&gt; fileMd5: {}, fileName: {}, fileType: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯¹åº”çš„ä¿å­˜é€»è¾‘ <code>ChunkInfoRepository</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveChunkInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">,</span> <span class="token class-name">String</span> chunkMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> storagePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"ä¿å­˜åˆ†ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“ =&gt; fileMd5: {}, chunkIndex: {}, chunkMd5: {}, storagePath: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> chunkMd5<span class="token punctuation">,</span> storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">ChunkInfo</span> chunkInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkInfo<span class="token punctuation">.</span><span class="token function">setFileMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkInfo<span class="token punctuation">.</span><span class="token function">setChunkIndex</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkInfo<span class="token punctuation">.</span><span class="token function">setChunkMd5</span><span class="token punctuation">(</span>chunkMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkInfo<span class="token punctuation">.</span><span class="token function">setStoragePath</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    chunkInfoRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>chunkInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¿¡æ¯å·²ä¿å­˜ =&gt; fileMd5: {}, chunkIndex: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ä¿å­˜åˆ†ç‰‡ä¿¡æ¯å¤±è´¥ =&gt; fileMd5: {}, chunkIndex: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> 
              fileMd5<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to save chunk info"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5><code>uploadService.getUploadedChunks</code> è·å–æˆåŠŸä¸Šä¼ çš„chunkç´¢å¼•</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUploadedChunks</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è·å–å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨ =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¼˜åŒ–ï¼šä¸€æ¬¡æ€§è·å–æ‰€æœ‰åˆ†ç‰‡çŠ¶æ€</span>
      <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"upload:"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmapData <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Redisä¸­æ— åˆ†ç‰‡çŠ¶æ€è®°å½• =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> uploadedChunks<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// è§£æbitmapï¼Œæ‰¾å‡ºå·²ä¸Šä¼ çš„åˆ†ç‰‡</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> chunkIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> chunkIndex <span class="token operator">&lt;</span> totalChunks<span class="token punctuation">;</span> chunkIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBitSet</span><span class="token punctuation">(</span>bitmapData<span class="token punctuation">,</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              uploadedChunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è·å–åˆ°å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨ =&gt; fileMd5: {}, userId: {}, å·²ä¸Šä¼ æ•°é‡: {}, æ€»åˆ†ç‰‡æ•°: {}, ä¼˜åŒ–æ–¹å¼: ä¸€æ¬¡æ€§è·å–"</span><span class="token punctuation">,</span> 
                fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> uploadedChunks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"è·å–å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨å¤±è´¥ =&gt; fileMd5: {}, userId: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to get uploaded chunks"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5><code>redisTemplate.execute()</code>è§£æ</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExposeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Execute æ–¹æ³• (<code>connection.get(keyBytes)</code>)ï¼šç›´æ¥ç»™ä½ è¿”å› byte[]</p>
<p>å¯¹äº Bitmapï¼ˆä½å›¾ï¼‰æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åŸå§‹çš„äºŒè¿›åˆ¶å­—èŠ‚ï¼Œä¸éœ€è¦ Spring æŠŠå®ƒè½¬æˆä¹±ç å­—ç¬¦ä¸²</p>
<p>ä»–çš„å‚æ•°æ˜¯ä¸€ä¸ª <code>RedisCallback&lt;T&gt;</code> æ¥å£ï¼Œéœ€è¦å®ç° <code>doInRedis</code> æ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ <code>RedisConnection connection</code>, ç›´æ¥æ‹¿åˆ°æœ€åº•å±‚çš„ Redis è¿æ¥ï¼ˆConnectionï¼‰ è¿›è¡Œæ“ä½œ</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token class-name">T</span> <span class="token function">doInRedis</span><span class="token punctuation">(</span><span class="token class-name">RedisConnection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥è¿™é‡Œæ˜¯</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmapData <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä»è€Œé¿å…Spring çš„å±‚å±‚å°è£…ï¼Œæ ¹æ®ä½ é…ç½®çš„åºåˆ—åŒ–å™¨ï¼ˆæ¯”å¦‚ Jackson/JSONï¼‰è½¬æˆä¸€ä¸ª Java å¯¹è±¡æˆ–å­—ç¬¦ä¸²</p>
<h5><code>uploadService.getTotalChunks</code> è·å–æ–‡ä»¶çš„æ€» chunk æ•°é‡</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotalChunks</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•° =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileUpload</span><span class="token punctuation">&gt;</span></span> fileUpload <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileUpload<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶è®°å½•ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—åˆ†ç‰‡æ•° =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">long</span> totalSize <span class="token operator">=</span> fileUpload<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é»˜è®¤æ¯ä¸ªåˆ†ç‰‡5MB</span>
    <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> totalChunks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> totalSize <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶æ€»åˆ†ç‰‡æ•°è®¡ç®—ç»“æœ =&gt; fileMd5: {}, userId: {}, totalSize: {}, chunkSize: {}, totalChunks: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> totalChunks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•°å¤±è´¥ =&gt; fileMd5: {}, userId: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to calculate total chunks"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>æ–‡ä»¶åˆå¹¶</h4>
<p>ä¼šè‡ªåŠ¨è§¦å‘ï¼Œåº”è¯¥æ˜¯æ¯æ¬¡æˆåŠŸä¸Šä¼ å®Œåˆ†ç‰‡ä¼šæ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆäº†</p>
<figure><figcaption>alt text</figcaption></figure>
]]></content:encoded>
    </item>
    <item>
      <title>item3 - 7 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—3</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article7.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article7.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 7 æ–‡ä»¶ä¸Šä¼ è§£ææ¨¡å—3</source>
      <description>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½ ç›®çš„ é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§ å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç† æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ Ela...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:17:03 GMT</pubDate>
      <content:encoded><![CDATA[<p>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½</p>
<h2>ç›®çš„</h2>
<ul>
<li>é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§</li>
<li>å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ</li>
<li>æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç†</li>
<li>æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ <code>Elasticsearch</code> ä¸­ï¼Œæœªæ¥å°†åŒæ—¶æ”¯æŒ FAISS å­˜å‚¨</li>
</ul>
<h2>æ–‡ä»¶åˆå¹¶</h2>
<p>ä¼šè‡ªåŠ¨è§¦å‘ï¼Œåº”è¯¥æ˜¯æ¯æ¬¡æˆåŠŸä¸Šä¼ å®Œåˆ†ç‰‡ä¼šæ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆäº† (æ£€æŸ¥é€»è¾‘åœ¨å‰ç«¯)</p>
<p>å½“æ”¶åˆ°ç”¨æˆ·çš„ merge è¯·æ±‚åï¼Œä¼šå…ˆè¿›è¡Œæ ¡éªŒï¼Œç„¶åè°ƒç”¨ MinIO çš„ <code>composeObject</code> API æ¥è¿›è¡Œåˆå¹¶</p>
<p>åˆå¹¶æˆåŠŸåï¼Œå» <code>file_upload</code>è¡¨ æ›´æ–°æ–‡ä»¶çš„çŠ¶æ€ï¼ŒåŒæ—¶å» MinIO ä¸­æ¸…ç†ä¸´æ—¶åˆ†ç‰‡æ–‡ä»¶</p>
<p>æœ€åé€šè¿‡ Kafka å‘é€æ–‡æ¡£è§£æä»»åŠ¡è¿›è¡Œå¼‚æ­¥å¤„ç†</p>
<p>ç„¶åè¿”å›è¯·æ±‚ï¼Œåˆå¹¶ç»“æœå’Œæ–‡ä»¶è®¿é—®URL</p>
<figure><figcaption>alt text</figcaption></figure>
<h3>å‰ç«¯åˆ†æ</h3>
<p>å‰ç«¯åœ¨å®Œæˆæ–‡ä»¶ä¸Šä¼ åï¼Œä¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰åˆ†ç‰‡å‡æˆåŠŸ, ç„¶åå°è¯•å‘èµ·æ–‡ä»¶åˆå¹¶è¯·æ±‚</p>
<div class="language-javascript" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>uploaded<span class="token punctuation">.</span>length <span class="token operator">===</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mergeFile</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">task</span><span class="token operator">:</span> Api<span class="token punctuation">.</span>KnowledgeBase<span class="token punctuation">.</span>UploadTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/upload/merge'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">fileMd5</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">,</span> <span class="token literal-property property">fileName</span><span class="token operator">:</span> task<span class="token punctuation">.</span>fileName <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> tasks<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fileMd5 <span class="token operator">===</span> task<span class="token punctuation">.</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UploadStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>MinIO</h3>
<p>åœ¨ä½¿ç”¨æ—¶ï¼Œç”¨çš„æ˜¯ <code>MinioClient</code> å¯¹è±¡</p>
<p>MinIO æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œè®¾è®¡åˆè¡·æ˜¯ä½œä¸ºäº‘åŸç”Ÿå­˜å‚¨ç³»ç»Ÿçš„æ›¿ä»£æ–¹æ¡ˆ</p>
<p>å¯¹è±¡å­˜å‚¨çš„æ¦‚å¿µä¸æ ‡å‡† Unix æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œä½† å®ƒä½¿ç”¨çš„æ˜¯"æ¡¶(bucket)"å’Œ"å¯¹è±¡(object)"çš„æ¦‚å¿µï¼Œè€Œä¸æ˜¯ç›®å½•å’Œæ–‡ä»¶</p>
<p>æ¡¶å¯ä»¥åƒç›®å½•ä¸€æ ·åµŒå¥—å½¢æˆå±‚çº§ç»“æ„ï¼Œè€Œå¯¹è±¡åˆ™æ˜¯ä¸€ç»„ä»»æ„çš„å­—èŠ‚æ•°æ®ï¼Œå¯ä»¥æ˜¯å›¾ç‰‡ã€PDF æˆ–å…¶ä»–ä»»ä½•æ–‡ä»¶ç±»å‹</p>
<p>ä¸æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¡¶å’Œå¯¹è±¡ä¹Ÿå¯ä»¥è®¾ç½®æƒé™ï¼Œå®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶</p>
<p>åœ¨å®‰è£…å¥½ MinIO åï¼Œå¯ä»¥å»åŸºäº Web çš„ç®¡ç†æ§åˆ¶å°è®¿é—®ç®¡ç†</p>
<h4>MinIO JAVA SDK</h4>
<p>ä¸è¿‡åœ¨ JAVA ä¸­æ›´å¤šçš„æ˜¯é€šè¿‡ Java SDK ä½¿ç”¨ MinIO</p>
<p>é¦–å…ˆåœ¨é¡¹ç›®ä¸­æ·»åŠ ä¾èµ–ï¼š</p>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.5.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>ä¹‹åï¼Œé€šè¿‡ Spring çš„ <code>@Value</code> ä»¥åŠ <code>@Bean</code>ç­‰æ³¨é‡Šï¼Œæ¥è‡ªåŠ¨æ³¨å†Œä¸€ä¸ª <code>MinIOClient</code> çš„å®ä¾‹ï¼Œç”¨äºä¹‹åçš„æ“ä½œ</p>
<p>ä¸»è¦é…ç½®æ–‡ä»¶åœ¨ <code>MinioConfig</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinioConfig</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.endpoint}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.accessKey}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.secretKey}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.publicUrl}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> publicUrl<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">MinioClient</span> <span class="token function">minioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">// ç«¯å£ï¼Œå­˜å‚¨åœ°å€</span>
              <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span>
              <span class="token comment">// å…¬é’¥å’Œç§˜é’¥</span>
              <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">minioPublicUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> publicUrl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>ä¸»è¦API</h4>
<h5>æ¡¶æ“ä½œ</h5>
<ul>
<li>
<p><code>bucketExists(BucketExistsArgs)</code>: æ£€æŸ¥æŸä¸ªæ¡¶æ˜¯å¦å­˜åœ¨ã€‚</p>
</li>
<li>
<p><code>makeBucket(MakeBucketArgs)</code>: åˆ›å»ºæ–°æ¡¶ã€‚</p>
</li>
<li>
<p><code>listBuckets()</code>: åˆ—å‡ºå½“å‰è´¦å·ä¸‹æ‰€æœ‰çš„æ¡¶ã€‚</p>
</li>
<li>
<p><code>removeBucket(RemoveBucketArgs)</code>: åˆ é™¤ç©ºæ¡¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šåœ¨ä¸Šä¼ æ–‡ä»¶å‰ï¼Œé€šå¸¸ä¼šå…ˆè°ƒç”¨ bucketExists æ£€æŸ¥ï¼Œä¸å­˜åœ¨åˆ™è°ƒç”¨ makeBucket åˆ›å»º</p>
</blockquote>
<h5>å¯¹è±¡æ“ä½œ</h5>
<p>è¿™æ˜¯æœ€é¢‘ç¹ä½¿ç”¨çš„éƒ¨åˆ†ï¼Œç”¨äºå¤„ç†å®é™…çš„æ–‡ä»¶</p>
<ul>
<li>ä¸Šä¼ 
<ul>
<li><code>putObject(PutObjectArgs)</code>: æœ€é€šç”¨çš„ä¸Šä¼ æ¥å£ï¼Œæ”¯æŒä» InputStream ä¸Šä¼ </li>
<li><code>uploadObject(UploadObjectArgs)</code>: ç›´æ¥ä»æœ¬åœ°ç£ç›˜æ–‡ä»¶è·¯å¾„ä¸Šä¼ ï¼Œæ•ˆç‡æ›´é«˜</li>
</ul>
</li>
<li>ä¸‹è½½ä¸æŸ¥çœ‹
<ul>
<li><code>getObject(GetObjectArgs)</code>: è·å–æ–‡ä»¶çš„è¾“å…¥æµï¼ˆInputStreamï¼‰ï¼Œç”¨äºåç«¯å¤„ç†æ–‡ä»¶å†…å®¹ã€‚</li>
<li><code>statObject(StatObjectArgs)</code>: è·å–å…ƒæ•°æ®ï¼ˆæ–‡ä»¶å¤§å°ã€æœ€åä¿®æ”¹æ—¶é—´ã€Content-Type ç­‰ï¼‰ï¼Œä½†ä¸ä¸‹è½½æ–‡ä»¶æœ¬èº«ã€‚</li>
</ul>
</li>
<li>åˆ—è¡¨ä¸åˆ é™¤
<ul>
<li><code>listObjects(ListObjectsArgs)</code>: éå†æ¡¶å†…çš„æ–‡ä»¶</li>
<li><code>removeObject(RemoveObjectArgs)</code>: åˆ é™¤å•ä¸ªå¯¹è±¡</li>
<li><code>removeObjects(RemoveObjectsArgs)</code>: æ‰¹é‡åˆ é™¤</li>
</ul>
</li>
</ul>
<h5>é¢„ç­¾åæ“ä½œ</h5>
<p>æ˜¯ MinIO éå¸¸å¼ºå¤§çš„ä¸€ç±» APIï¼Œä¸»è¦è§£å†³ â€œæƒé™å®‰å…¨â€ é—®é¢˜ã€‚</p>
<ul>
<li>
<p><code>getPresignedObjectUrl(GetPresignedObjectUrlArgs)</code>: ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ—¶æ•ˆæ€§çš„ HTTP GET é“¾æ¥</p>
<p>åœºæ™¯ï¼š ä½ çš„æ–‡ä»¶æ˜¯ç§æœ‰çš„ï¼Œä½†ä½ æƒ³è®©ç”¨æˆ·åœ¨æ¥ä¸‹æ¥çš„ 10 åˆ†é’Ÿå†…å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ä¸€å¼ å›¾ç‰‡</p>
</li>
</ul>
<h4>ç®€å•ç¤ºä¾‹</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ„å»ºä¸Šä¼ å‚æ•°</span>
minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>
  <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"my-bucket"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test.jpg"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 è¡¨ç¤ºä¸é™åˆ¶åˆ†ç‰‡å¤§å°</span>
      <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span>      <span class="token comment">// è®¾ç½®æ–‡ä»¶ç±»å‹ï¼Œæ–¹ä¾¿æµè§ˆå™¨ç›´æ¥é¢„è§ˆ</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3>åç«¯åˆ†æ</h3>
<p>å½“å‰ç«¯æŠŠæ‰€æœ‰æ–‡ä»¶chunkå‡ä¸Šä¼ åï¼Œä¼šè‡ªåŠ¨å‘é€æ–‡ä»¶åˆå¹¶è¯·æ±‚ï¼Œ<code>POST /api/v1/upload/merge</code> æ¥è§¦å‘åç«¯æ–‡ä»¶åˆå¹¶é€»è¾‘</p>
<p>ä¸´æ—¶çš„chunkå­˜æ”¾åœ¨ MinIO ä¸­ï¼Œéœ€è¦å°†ä»–ä»¬åˆå¹¶</p>
<ul>
<li>
<p>ä¸´æ—¶åˆ†ç‰‡ï¼šå­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶åˆ†ç‰‡ï¼Œè·¯å¾„ç»“æ„ä¸º <code>/temp/{fileMd5}/{chunkIndex}</code></p>
</li>
<li>
<p>å®Œæ•´æ–‡ä»¶ï¼šåˆå¹¶åçš„æ–‡ä»¶å­˜å‚¨åœ¨ <code>/documents/{userId}/{fileName}</code></p>
</li>
</ul>
<p>å½“åˆå¹¶ç»“æŸäº†ï¼Œä¼šå‘ Kafka å‘é€ä¸€ä¸ªä»»åŠ¡æ¥å¼‚æ­¥è§£æè¯¥æ–‡æ¡£å‘é‡åŒ–</p>
<p>æ–‡ä»¶åˆå¹¶æ¥å£ï¼š</p>
<ul>
<li>
<p>URL: <code>/api/v1/upload/merge</code></p>
</li>
<li>
<p>Method: POST</p>
</li>
<li token="">
<p>Headers: Bearer</p>
</li>
<li>
<p>Request Body:</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"file_md5"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
  <span class="token property">"file_name"</span><span class="token operator">:</span> <span class="token string">"å¹´åº¦æŠ¥å‘Š.pdf"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
<li>
<p>Response</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code>&lt;!-- æˆåŠŸ --&gt;
<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"File merged successfully"</span><span class="token punctuation">,</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"object_url"</span><span class="token operator">:</span> <span class="token string">"https://minio.example.com/reports/å¹´åº¦æŠ¥å‘Š.pdf"</span><span class="token punctuation">,</span>
    <span class="token property">"file_size"</span><span class="token operator">:</span> <span class="token number">15728640</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
&lt;!-- å¤±è´¥ --&gt;
<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Not all chunks have been uploaded"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
</ul>
<h4>Contorllerå±‚ <code>UploadController</code></h4>
<p><code>UploadController/uploadChunk</code> - <code>/merge</code>æ¥å£</p>
<p>å½“æ‰€æœ‰chunkä¸Šä¼ å®Œæ¯•ï¼Œä¼šæ”¶åˆ°å‰ç«¯çš„ merge è¯·æ±‚</p>
<h5>ç›¸å…³å‚æ•°</h5>
<p>ä¸»è¦ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ æ–‡ä»¶çš„ MD5 ä»¥åŠ æ–‡ä»¶çš„åå­—</p>
<p>userId åˆ™æ˜¯ç»„ç»‡è¿‡æ»¤å™¨å¡åˆ°è¯·æ±‚é‡Œçš„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åˆå¹¶è¯·æ±‚çš„è¾…åŠ©ç±»ï¼ŒåŒ…å«æ–‡ä»¶çš„MD5å€¼å’Œæ–‡ä»¶å
 * ä½œä¸º DTO (Data Transfer Objectï¼Œæ•°æ®ä¼ è¾“å¯¹è±¡)ï¼Œç”¨æ¥æ¥æ”¶å‰ç«¯å‘æ¥çš„ JSON æ•°æ®
 */</span>
<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">MergeRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * åˆå¹¶æ–‡ä»¶åˆ†ç‰‡æ¥å£
 *
 * <span class="token keyword">@param</span> <span class="token parameter">request</span> åŒ…å«æ–‡ä»¶MD5å’Œæ–‡ä»¶åçš„è¯·æ±‚ä½“
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> å½“å‰ç”¨æˆ·ID
 * <span class="token keyword">@return</span> è¿”å›åŒ…å«åˆå¹¶åæ–‡ä»¶è®¿é—®URLçš„å“åº”
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/merge"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">mergeFile</span><span class="token punctuation">(</span>
  <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MergeRequest</span> request<span class="token punctuation">,</span>
  <span class="token annotation punctuation">@RequestAttribute</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><h5>æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ä¸æƒé™æ ¡éªŒ</h5>
<p>æ ¹æ®è¯·æ±‚ä¼ æ¥æ–‡ä»¶åå’Œå¯¹åº”çš„ç”¨æˆ·idå» <code>file_upload</code>è¡¨è¿›è¡Œæ£€æŸ¥</p>
<p>ç›´æ¥é€šè¿‡ <code>FileUploadRepository</code> çš„ <code>findByFileMd5AndUserId(request.fileMd5(), userId)</code> æ–¹æ³•æ¥è·å–å¯¹åº”çš„ <code>fileUpload</code> å¯¹è±¡(æ–‡ä»¶ä¸Šä¼ å®ä½“ç±»)</p>
<p>è‹¥ <code>fileUpload</code> ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå¿…ç„¶æ˜¯å¤±è´¥çš„</p>
<p>å½“å¾—åˆ°äº† <code>fileUpload</code> å¯¹è±¡ï¼Œé‚£ä¹ˆè¿›ä¸€æ­¥éœ€è¦åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ï¼Œåªæœ‰ æ–‡ä»¶å¯¹åº”ç”¨æˆ·æ‰å¯ä»¥åˆå¹¶è¯¥æ–‡ä»¶</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">LogUtils<span class="token punctuation">.</span>PerformanceMonitor</span> monitor <span class="token operator">=</span> <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">startPerformanceMonitor</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ¥æ”¶åˆ°åˆå¹¶æ–‡ä»¶è¯·æ±‚: fileMd5=%s, fileName=%s, fileType=%s"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§å’Œæƒé™</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ£€æŸ¥æ–‡ä»¶è®°å½•å’Œæƒé™: fileMd5=%s, fileName=%s"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">FileUpload</span> fileUpload <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FAILED_FILE_NOT_FOUND"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶è®°å½•ä¸å­˜åœ¨"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¡®ä¿ç”¨æˆ·æœ‰æƒé™æ“ä½œè¯¥æ–‡ä»¶</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileUpload<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FAILED_PERMISSION_DENIED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æƒé™éªŒè¯å¤±è´¥: å°è¯•åˆå¹¶ä¸å±äºè‡ªå·±çš„æ–‡ä»¶, fileMd5=%s, fileName=%s, å®é™…æ‰€æœ‰è€…=%s"</span><span class="token punctuation">,</span> 
            request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileUpload<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"åˆå¹¶å¤±è´¥ï¼šæƒé™ä¸è¶³"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"æ²¡æœ‰æƒé™æ“ä½œæ­¤æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æƒé™éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åˆå¹¶æ–‡ä»¶: fileMd5=%s, fileName=%s, fileType=%s"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å…¨éƒ¨ä¸Šä¼ å®Œæˆ</h5>
<p>é€šè¿‡ <code>UploadService</code> çš„ <code>getUploadedChunks</code> æ–¹æ³•è·å–æˆåŠŸä¸Šä¼ çš„chunksç´¢å¼• (ä»Redisè·å–) ä»¥åŠ <code>getTotalChunks</code> æ–¹æ³•è·å–è¯¥æ–‡ä»¶çš„æ€»chunkæ•°é‡</p>
<p>ä¸¤è€…å¯¹æ¯”æ¥åˆ¤æ–­åˆ†ç‰‡æ˜¯å¦å…¨éƒ¨ä¸Šä¼ å®Œæˆ</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å…¨éƒ¨ä¸Šä¼ å®Œæˆ</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> uploadedChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getUploadedChunks</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> totalChunks <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">getTotalChunks</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€: fileMd5=%s, fileName=%s, å·²ä¸Šä¼ =%d/%d"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>uploadedChunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FAILED_INCOMPLETE_CHUNKS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"åˆå¹¶å¤±è´¥ï¼šåˆ†ç‰‡æœªå…¨éƒ¨ä¸Šä¼ "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶åˆ†ç‰‡æœªå…¨éƒ¨ä¸Šä¼ ï¼Œæ— æ³•åˆå¹¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>åˆå¹¶æ–‡ä»¶</h5>
<p>é€šè¿‡ <code>uploadService.mergeChunks</code> æ–¹æ³•æ¥å®ç°æ–‡ä»¶çš„åˆå¹¶ï¼Œæ‰€éœ€å‚æ•°ä¸ºè¯¥æ–‡ä»¶çš„Md5å’Œæ–‡ä»¶åä»¥åŠç”¨æˆ·id</p>
<p>å®ç°åœ¨MinIOçš„åˆå¹¶ï¼Œä»¥åŠåˆ é™¤ä¸´æ—¶chunkï¼Œæœ€ç»ˆè¿”å›è¯¥æ€»æ–‡ä»¶å­˜å‚¨çš„ä½ç½®URL</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// åˆå¹¶æ–‡ä»¶</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"å¼€å§‹åˆå¹¶æ–‡ä»¶åˆ†ç‰‡: fileMd5=%s, fileName=%s, fileType=%s, åˆ†ç‰‡æ•°é‡=%d"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> totalChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> objectUrl <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">mergeChunks</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logFileOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"MERGE"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>å°†è§£æä»»åŠ¡å‘é€è‡³ Kafka</h5>
<p>å…ˆæ„å»ºäº†ä¸€ä¸ª <code>FileProcessingTask</code> å¯¹è±¡ï¼ŒåŒ…å«äº†å½“å‰æ–‡ä»¶çš„Md5ã€MinIOçš„å­˜å‚¨ä½ç½®ã€æ–‡ä»¶åç§°ã€ç”¨æˆ·Idã€ç”¨æˆ·ç»„ç»‡æ ‡ç­¾ã€æ–‡ä»¶æ˜¯å¦å…¬å¼€çš„ä¿¡æ¯</p>
<p>ç„¶åç›´æ¥è°ƒç”¨Kafkaå¯¹åº”APIå°†è¯¥ä»»åŠ¡å‘é€åˆ° <code>kafkaConfig.getFileProcessingTopic()</code> Topicä¸­</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code>kafkaTemplate<span class="token punctuation">.</span><span class="token function">executeInTransaction</span><span class="token punctuation">(</span>kt <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  kt<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>kafkaConfig<span class="token punctuation">.</span><span class="token function">getFileProcessingTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç›¸å…³ä»£ç ï¼š</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// å‘é€ä»»åŠ¡åˆ° Kafkaï¼ŒåŒ…å«å®Œæ•´çš„æƒé™ä¿¡æ¯</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"åˆ›å»ºæ–‡ä»¶å¤„ç†ä»»åŠ¡: fileMd5=%s, fileName=%s, fileType=%s, orgTag=%s, isPublic=%s"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> fileUpload<span class="token punctuation">.</span><span class="token function">getOrgTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileUpload<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">FileProcessingTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileProcessingTask</span><span class="token punctuation">(</span>
  request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  objectUrl<span class="token punctuation">,</span>
  request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  fileUpload<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  fileUpload<span class="token punctuation">.</span><span class="token function">getOrgTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  fileUpload<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"å‘é€æ–‡ä»¶å¤„ç†ä»»åŠ¡åˆ°Kafka(äº‹åŠ¡): topic=%s, fileMd5=%s, fileName=%s"</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getFileProcessingTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kafkaTemplate<span class="token punctuation">.</span><span class="token function">executeInTransaction</span><span class="token punctuation">(</span>kt <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  kt<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>kafkaConfig<span class="token punctuation">.</span><span class="token function">getFileProcessingTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶å¤„ç†ä»»åŠ¡å·²å‘é€: fileMd5=%s, fileName=%s, fileType=%s"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯¹åº”è®¾è®¡äº†ä¸€ä¸ªæ–‡ä»¶å¤„ç†çš„ä»»åŠ¡ç±» (<code>FileProcessingTask</code>), ç”¨äºKafkaæ¶ˆæ¯ä¼ é€’</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ–‡ä»¶å¤„ç†ä»»åŠ¡ç±»ï¼Œç”¨äºKafkaæ¶ˆæ¯ä¼ é€’
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileProcessingTask</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶çš„ MD5 æ ¡éªŒå€¼</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> filePath<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶å­˜å‚¨è·¯å¾„</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶å</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> userId<span class="token punctuation">;</span>   <span class="token comment">// ä¸Šä¼ ç”¨æˆ·ID</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> orgTag<span class="token punctuation">;</span>   <span class="token comment">// æ–‡ä»¶æ‰€å±ç»„ç»‡æ ‡ç­¾</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> isPublic<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶æ˜¯å¦å…¬å¼€</span>
  
  <span class="token doc-comment comment">/**
   * å‘åå…¼å®¹çš„æ„é€ å‡½æ•°
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">FileProcessingTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> filePath<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileMd5 <span class="token operator">=</span> fileMd5<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>orgTag <span class="token operator">=</span> <span class="token string">"DEFAULT"</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPublic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>è¿”å›æˆåŠŸå“åº”</h5>
<p>å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæ‰€æœ‰æ“ä½œæˆåŠŸï¼Œé‚£ä¹ˆä¼šæ„å»ºæˆåŠŸå“åº”ï¼Œè¿”å›æ–‡ä»¶çš„å¯¹åº”URLè·¯å¾„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token comment">// æ„å»ºæ•°æ®å¯¹è±¡</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"object_url"</span><span class="token punctuation">,</span> objectUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ„å»ºç»Ÿä¸€å“åº”æ ¼å¼</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶åˆå¹¶æˆåŠŸï¼Œä»»åŠ¡å·²å‘é€åˆ° Kafka"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆå¹¶æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>å¼‚å¸¸å¤„ç†</h5>
<p>å¯¹äºä¸Šé¢æ“ä½œå¯èƒ½å­˜åœ¨çš„å¼‚å¸¸ï¼Œä¼šç»Ÿä¸€è¿›è¡Œæ•è·</p>
<p>è¿”å› <code>500</code> å“åº”å’Œå¯¹åº”åŸå› </p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"MERGE_FILE"</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶åˆå¹¶å¤±è´¥: fileMd5=%s, fileName=%s, fileType=%s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> 
          request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆå¹¶å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorResponse<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"æ–‡ä»¶åˆå¹¶å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>errorResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>Serviceå±‚ <code>UploadService</code></h4>
<p>ä¸»è¦åœ¨ Controller å±‚ç”¨åˆ°äº†ä¸‰ä¸ªæ–¹æ³•</p>
<ul>
<li><code>getUploadedChunks(request.fileMd5(), userId)</code> æ¥è·å–æˆåŠŸä¸Šä¼ çš„chunksç´¢å¼•</li>
<li><code>getTotalChunks(request.fileMd5(), userId)</code> è·å–è¯¥MD5å¯¹åº”æ–‡ä»¶çš„æ€»chunkæ•°é‡</li>
<li><code>mergeChunks(request.fileMd5(), request.fileName(), userId)</code> å®ç°æ–‡ä»¶åˆå¹¶é€»è¾‘</li>
</ul>
<p><code>getUploadedChunks</code> åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶åˆ†æè¿‡ï¼Œä¸»è¦å°±æ˜¯ä»Redisç¼“å­˜ä¸­è·å–å¯¹åº”çš„BitMapå€¼ç„¶åè½¬æ¢</p>
<p><code>getTotalChunks</code> è·å–æ–‡ä»¶çš„æ€» chunk æ•°é‡ ä¹Ÿåˆ†æè¿‡</p>
<p>æ‰€ä»¥é‡ç‚¹åˆ†æ <code>mergeChunks</code> æ–¹æ³•</p>
<h5>ä¸»è¦å‚æ•°</h5>
<p>ä¸»è¦å°±æ˜¯æ–‡ä»¶çš„ MD5 å’Œæ–‡ä»¶åä»¥åŠç”¨æˆ·çš„IDä¿¡æ¯</p>
<p>æœ€ç»ˆè¿”å›çš„æ˜¯å­˜åœ¨ MinIO çš„æ–‡ä»¶è·¯å¾„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åˆå¹¶æ‰€æœ‰åˆ†ç‰‡
 *
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> æ–‡ä»¶çš„ MD5 å€¼
 * <span class="token keyword">@param</span> <span class="token parameter">fileName</span> æ–‡ä»¶å
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> ç”¨æˆ·ID
 * <span class="token keyword">@return</span> åˆæˆæ–‡ä»¶çš„è®¿é—® URL
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">mergeChunks</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre></div><h5>ä¸»è¦æ­¥éª¤</h5>
<p>è°ƒç”¨ MinIO åˆå¹¶ -&gt; æ¸…ç† MinIO ä¸­çš„åˆ†ç‰‡ -&gt; åˆ é™¤ Redis ç¼“å­˜ -&gt; æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸ºâ€œå·²å®Œæˆâ€</p>
<ul>
<li>æ ¹æ®æ–‡ä»¶çš„MD5ï¼Œå» <code>chunk_info</code> è¡¨ä¸­è·å–æ‰€æœ‰è¢«è®°å½•åœ¨è¡¨é‡Œçš„ chunk çš„ä¿¡æ¯ <code>List&lt;ChunkInfo&gt;</code></li>
<li>ç„¶åè°ƒç”¨ <code>getTotalChunks</code> æ¥è·å–æ€»åˆ‡ç‰‡æ•°ï¼Œè¿›ä¸€æ­¥ä¸å‰é¢å¾—åˆ°çš„åˆ—è¡¨æ¯”è¾ƒï¼Œæ£€æŸ¥æ•°é‡æ˜¯å¦ä¸€è‡´ (Controllerå±‚åªæ˜¯æ£€æŸ¥äº† å°äº)</li>
<li>æ£€éªŒå®Œæ¯•åï¼Œæ ¹æ®æ‰€æœ‰chunkçš„è·¯å¾„åˆ—è¡¨ï¼Œå» MinIO æ£€æŸ¥æ˜¯å¦æˆåŠŸå­˜å‚¨äº†</li>
<li>éšåï¼Œè®¾ç½® åˆå¹¶è·¯å¾„ (<code>mergedPath = "merged/" + fileName</code>)</li>
<li>å¼€å§‹åˆå¹¶æ–‡ä»¶ï¼Œåˆ©ç”¨ MinIO çš„ <code>ComposeSource</code> æ¥åˆå¹¶æ‰€æœ‰chunk</li>
<li>æ£€æŸ¥åˆå¹¶åçš„æ–‡ä»¶ <code>minioClient.statObject</code></li>
<li>æ¸…ç†åˆ†ç‰‡æ–‡ä»¶</li>
<li>åˆ é™¤ Redis ä¸­çš„åˆ†ç‰‡çŠ¶æ€çš„ç¼“å­˜è®°å½•</li>
<li>æ›´æ–°æ–‡ä»¶çŠ¶æ€ä¸º 1 è¡¨ç¤ºå·²å®Œæˆ</li>
<li>ç”Ÿæˆé¢„ç­¾å URLï¼ˆæœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼‰</li>
<li>æœ€ç»ˆè¿”å›è¿™ä¸ª URL</li>
</ul>
<h5>æ£€æŸ¥æ‰€æœ‰chunkæ˜¯å¦å‡å·²ä¿å­˜</h5>
<p>ä» <code>chunk_info</code>è¡¨æ ¹æ®æ‰€ç»™æ–‡ä»¶çš„Md5å‡åºæ’åºè·å¾—æ‰€æœ‰å­˜åœ¨æ•°æ®è¡¨ä¸­çš„å¯¹åº”æ–‡ä»¶çš„chunkçš„ä¿¡æ¯ï¼Œä¸ºä¸€ä¸ª List é›†åˆ <code>List&lt;ChunkInfo&gt;</code></p>
<p>å†åˆ©ç”¨ <code>getTotalChunks</code> æ ¹æ®æ–‡ä»¶Md5å’Œç”¨æˆ·idå»å¯¹åº”çš„ <code>file_upload</code> è¡¨å¾—åˆ°æ–‡ä»¶çš„å¤§å°ä¿¡æ¯ï¼Œå†ä»¥ <code>int chunkSize = 5 * 1024 * 1024;</code> é»˜è®¤è®¡ç®—å¯¹åº”çš„é¢„æœŸchunkæ•°é‡</p>
<p>ä¸å‰é¢ä» <code>chunk_info</code> ä¸­è·å–çš„sizeè¿›è¡Œå¯¹æ¯”</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">String</span> fileType <span class="token operator">=</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹åˆå¹¶æ–‡ä»¶åˆ†ç‰‡ =&gt; fileMd5: {}, fileName: {}, fileType: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡ä¿¡æ¯</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æŸ¥è¯¢åˆ†ç‰‡ä¿¡æ¯ =&gt; fileMd5: {}, fileName: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChunkInfo</span><span class="token punctuation">&gt;</span></span> chunks <span class="token operator">=</span> chunkInfoRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5OrderByChunkIndexAsc</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æŸ¥è¯¢åˆ°åˆ†ç‰‡ä¿¡æ¯ =&gt; fileMd5: {}, fileName: {}, fileType: {}, åˆ†ç‰‡æ•°é‡: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ£€æŸ¥åˆ†ç‰‡æ•°é‡æ˜¯å¦ä¸é¢„æœŸä¸€è‡´</span>
  <span class="token keyword">int</span> expectedChunks <span class="token operator">=</span> <span class="token function">getTotalChunks</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>chunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> expectedChunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ•°é‡ä¸åŒ¹é… =&gt; fileMd5: {}, fileName: {}, fileType: {}, æœŸæœ›: {}, å®é™…: {}"</span><span class="token punctuation">,</span> 
                fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> expectedChunks<span class="token punctuation">,</span> chunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ•°é‡ä¸åŒ¹é…ï¼ŒæœŸæœ›: %d, å®é™…: %d"</span><span class="token punctuation">,</span> expectedChunks<span class="token punctuation">,</span> chunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>è·å–æ‰€æœ‰chunkä¸´æ—¶è·¯å¾„</h5>
<p>åˆ©ç”¨ <code>stream</code> æœºåˆ¶ä» chunks åˆ—è¡¨è·å–æ‰€æœ‰chunkçš„å­˜å‚¨è·¯å¾„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> partPaths <span class="token operator">=</span> chunks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ChunkInfo</span><span class="token operator">::</span><span class="token function">getStoragePath</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡è·¯å¾„åˆ—è¡¨ =&gt; fileMd5: {}, fileName: {}, è·¯å¾„æ•°é‡: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> partPaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>æ£€æŸ¥MinIOä¸­æ˜¯å¦å­˜å‚¨äº†æ‰€æœ‰chunk</h5>
<p>åˆ©ç”¨çš„æ˜¯ <code>minioClient.statObject()</code> æ–¹æ³•æ¥å¾—åˆ° <code>StatObjectResponse</code> å¯¹è±¡</p>
<p>å¦‚æœæŸ¥æ‰¾çš„chunkä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿›è€Œè¢«æ•è·</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ£€æŸ¥æ¯ä¸ªåˆ†ç‰‡æ˜¯å¦å­˜åœ¨</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ£€æŸ¥æ¯ä¸ªåˆ†ç‰‡æ˜¯å¦å­˜åœ¨ =&gt; fileMd5: {}, fileName: {}, fileType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> partPaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> path <span class="token operator">=</span> partPaths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">StatObjectResponse</span> stat <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">statObject</span><span class="token punctuation">(</span>
          <span class="token class-name">StatObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡å­˜åœ¨ =&gt; fileName: {}, index: {}, path: {}, size: {}"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> i<span class="token punctuation">,</span> path<span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—® =&gt; fileName: {}, index: {}, path: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> i<span class="token punctuation">,</span> path<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡ "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ£€æŸ¥å®Œæˆï¼Œæ‰€æœ‰åˆ†ç‰‡éƒ½å­˜åœ¨ =&gt; fileMd5: {}, fileName: {}, fileType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>æ ¹æ®<code>mergedPath</code>å¼€å§‹åˆå¹¶chunks</h5>
<p>ä¼šåœ¨åŸå…ˆçš„ <code>try</code> è¯­å¥å—å†åŒ…ä¸€å±‚ <code>try</code></p>
<p>å…ˆåŸºäºæ‰€æœ‰chunksçš„å­˜å‚¨è·¯å¾„ï¼Œæ„å»ºä¸€ä¸ª ComposeSource åˆ—è¡¨ (éœ€è¦åˆå¹¶çš„æ–‡ä»¶) <code>List&lt;ComposeSource&gt;</code></p>
<p>ç„¶åè°ƒç”¨ <code>minioClient.composeObject()</code> æ–¹æ³•, ä¼ å…¥ <code>ComposeObjectArgs</code> å¯¹è±¡æ¥è®¾ç½®åˆå¹¶æ–‡ä»¶å³å¯</p>
<p>sources åˆ—è¡¨ä¸­çš„é¡ºåºå†³å®šäº†æœ€ç»ˆåˆå¹¶æ–‡ä»¶çš„å†…å®¹é¡ºåº</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆå¹¶åˆ†ç‰‡</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComposeSource</span><span class="token punctuation">&gt;</span></span> sources <span class="token operator">=</span> partPaths<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>path <span class="token operator">-&gt;</span> <span class="token class-name">ComposeSource</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ„å»ºåˆå¹¶è¯·æ±‚ =&gt; fileMd5: {}, fileName: {}, targetPath: {}, sourcePaths: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> mergedPath<span class="token punctuation">,</span> partPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  minioClient<span class="token punctuation">.</span><span class="token function">composeObject</span><span class="token punctuation">(</span>
    <span class="token class-name">ComposeObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mergedPath<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡åˆå¹¶æˆåŠŸ =&gt; fileMd5: {}, fileName: {}, fileType: {}, mergedPath: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> mergedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>æ£€æŸ¥åˆå¹¶æ–‡ä»¶æ˜¯å¦æˆåŠŸç„¶åæ¸…ç†chunks</h5>
<p>è¿˜æ˜¯ç”¨ <code>minioClient.statObject</code> æ¥å°è¯•è·å–åˆå¹¶åçš„æ–‡ä»¶ï¼Œå¦‚æœè·å–ä¸åˆ°å°±ä¼šæŠ¥é”™è¢«æ•è·ï¼Œè¯´æ˜åˆå¹¶å¤±è´¥äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ¸…ç†chunks</p>
<p>åˆå¹¶æˆåŠŸå¹¶åˆå¹¶çš„æ–‡ä»¶å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå­˜åœ¨ä¸´æ—¶ç›®å½•é‡Œçš„æ–‡ä»¶æ¸…ç†äº†ï¼Œä¾æ¬¡å¾ªç¯éå†è·¯å¾„ï¼Œè°ƒç”¨ <code>minioClient.removeObject</code> æ¥æ¸…ç†</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ£€æŸ¥åˆå¹¶åçš„æ–‡ä»¶</span>
<span class="token class-name">StatObjectResponse</span> stat <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">statObject</span><span class="token punctuation">(</span>
  <span class="token class-name">StatObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mergedPath<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆå¹¶æ–‡ä»¶ä¿¡æ¯ =&gt; fileMd5: {}, fileName: {}, fileType: {}, path: {}, size: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> mergedPath<span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ¸…ç†åˆ†ç‰‡æ–‡ä»¶</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ¸…ç†åˆ†ç‰‡æ–‡ä»¶ =&gt; fileMd5: {}, fileName: {}, åˆ†ç‰‡æ•°é‡: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> partPaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> path <span class="token operator">:</span> partPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      minioClient<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>
              <span class="token class-name">RemoveObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ–‡ä»¶å·²åˆ é™¤ =&gt; fileName: {}, path: {}"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­æµç¨‹</span>
      logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"åˆ é™¤åˆ†ç‰‡æ–‡ä»¶å¤±è´¥ï¼Œå°†ç»§ç»­å¤„ç† =&gt; fileName: {}, path: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> path<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡æ–‡ä»¶æ¸…ç†å®Œæˆ =&gt; fileMd5: {}, fileName: {}, fileType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>åˆå¹¶æˆåŠŸï¼Œå…ˆåˆ é™¤Redisåˆ†ç‰‡è®°å½•</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// åˆ é™¤ Redis ä¸­çš„åˆ†ç‰‡çŠ¶æ€è®°å½•</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ é™¤Redisä¸­çš„åˆ†ç‰‡çŠ¶æ€è®°å½• =&gt; fileMd5: {}, fileName: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">deleteFileMark</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"åˆ†ç‰‡çŠ¶æ€è®°å½•å·²åˆ é™¤ =&gt; fileMd5: {}, fileName: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token doc-comment comment">/**
 * åˆ é™¤æ–‡ä»¶æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ æ ‡è®°
 *
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> æ–‡ä»¶çš„ MD5 å€¼
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> ç”¨æˆ·ID
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteFileMark</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"åˆ é™¤æ–‡ä»¶æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ æ ‡è®° =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"upload:"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">;</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ æ ‡è®°å·²åˆ é™¤ =&gt; fileMd5: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ é™¤æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ æ ‡è®°å¤±è´¥ =&gt; fileMd5: {}, userId: {}, é”™è¯¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to delete file mark"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>å†å» <code>file_upload</code> è¡¨æ›´æ–°æ–‡ä»¶çŠ¶æ€</h5>
<p>æ ¹æ®æ–‡ä»¶MD5å’ŒuserIdå» <code>file_upload</code> å°†æ–‡ä»¶çŠ¶æ€ä» 0 -&gt; 1</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// æ›´æ–°æ–‡ä»¶çŠ¶æ€</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ›´æ–°æ–‡ä»¶çŠ¶æ€ä¸ºå·²å®Œæˆ =&gt; fileMd5: {}, fileName: {}, fileType: {}, userId: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FileUpload</span> fileUpload <span class="token operator">=</span> fileUploadRepository<span class="token punctuation">.</span><span class="token function">findByFileMd5AndUserId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ›´æ–°æ–‡ä»¶çŠ¶æ€å¤±è´¥ï¼Œæ–‡ä»¶è®°å½•ä¸å­˜åœ¨ =&gt; fileMd5: {}, fileName: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶è®°å½•ä¸å­˜åœ¨: "</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fileUpload<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å·²å®Œæˆ</span>
fileUpload<span class="token punctuation">.</span><span class="token function">setMergedAt</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fileUploadRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>fileUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶çŠ¶æ€å·²æ›´æ–°ä¸ºå·²å®Œæˆ =&gt; fileMd5: {}, fileName: {}, fileType: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>è¿”å›é¢„ç­¾åURL</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token comment">// ç”Ÿæˆé¢„ç­¾å URLï¼ˆæœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼‰</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ç”Ÿæˆé¢„ç­¾åURL =&gt; fileMd5: {}, fileName: {}, path: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> mergedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> presignedUrl <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getPresignedObjectUrl</span><span class="token punctuation">(</span>
  <span class="token class-name">GetPresignedObjectUrlArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mergedPath<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">expiry</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span> <span class="token comment">// è®¾ç½®æœ‰æ•ˆæœŸä¸º 1 å°æ—¶</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"é¢„ç­¾åURLå·²ç”Ÿæˆ =&gt; fileMd5: {}, fileName: {}, fileType: {}, URL: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> presignedUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> presignedUrl<span class="token punctuation">;</span>
</code></pre></div><h5>å¼‚å¸¸æ•è·</h5>
<p>æœ‰ä¸¤ä¸ª <code>try</code> å…ˆæ˜¯å†…å±‚çš„ï¼Œä¸»è¦ä»æ–‡ä»¶åˆå¹¶å¼€å§‹</p>
<p>æ•è·çš„å°±æ˜¯æ–‡ä»¶åˆå¹¶æŠ›å‡ºçš„å¼‚å¸¸</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆå¹¶æ–‡ä»¶å¤±è´¥ =&gt; fileMd5: {}, fileName: {}, fileType: {}, é”™è¯¯ç±»å‹: {}, é”™è¯¯ä¿¡æ¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"åˆå¹¶æ–‡ä»¶å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¤–å±‚åˆ™æ˜¯æ€»çš„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆå¹¶è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ =&gt; fileMd5: {}, fileName: {}, fileType: {}, é”™è¯¯ç±»å‹: {}, é”™è¯¯ä¿¡æ¯: {}"</span><span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆå¹¶å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>item3 - 8 æ–‡ä»¶è§£ææ¨¡å—1</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article8.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article8.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 8 æ–‡ä»¶è§£ææ¨¡å—1</source>
      <description>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½ ç›®çš„ é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§ å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç† æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ Ela...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:17:03 GMT</pubDate>
      <content:encoded><![CDATA[<p>å®ç°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶åˆå¹¶ä»¥åŠæ–‡æ¡£è§£æåŠŸèƒ½</p>
<h2>ç›®çš„</h2>
<ul>
<li>é€šè¿‡ Redis å’Œ MinIO çš„ç»“åˆï¼Œç¡®ä¿å¤§æ–‡ä»¶ä¸Šä¼ çš„å¯é æ€§</li>
<li>å¹¶é€šè¿‡ Kafka å®ç°å¼‚æ­¥å¤„ç†ï¼Œè¿›è¡Œæ–‡ä»¶è§£æç­‰æ“ä½œ</li>
<li>æ¨¡å—æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆPDFã€Wordã€Excelï¼‰çš„è§£æï¼Œå¹¶æå–æ–‡æœ¬å†…å®¹ç”¨äºåç»­å‘é‡åŒ–å¤„ç†</li>
<li>æ–‡æœ¬å‘é‡åŒ–é€šè¿‡è°ƒç”¨é˜¿é‡Œå‘é‡åŒ– API å®ç°ï¼Œç”Ÿæˆçš„å‘é‡æ•°æ®ç›®å‰å­˜å‚¨åœ¨ <code>Elasticsearch</code> ä¸­ï¼Œæœªæ¥å°†åŒæ—¶æ”¯æŒ FAISS å­˜å‚¨</li>
</ul>
<h2>æ–‡ä»¶å¤„ç†(è§£æ+å‘é‡åŒ–)</h2>
<figure><figcaption>alt text</figcaption></figure>
<h3>Kafka</h3>
<p>Apache Kafkaæ˜¯ç”±LinkedIné‡‡â½¤Scalaå’ŒJavaå¼€å‘çš„å¼€æºæµå¤„ç†è½¯ä»¶å¹³å°ï¼Œå¹¶æèµ ç»™äº†Apache Software Foundation</p>
<p>Kafkaä½¿ç”¨é«˜æ•ˆçš„æ•°æ®å­˜å‚¨å’Œç®¡ç†æŠ€æœ¯ï¼Œèƒ½å¤Ÿè½»æ¾åœ°å¤„ç†TBçº§åˆ«çš„æ•°æ®é‡ã€‚å…¶ä¼˜ç‚¹åŒ…æ‹¬é«˜ååé‡ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§ã€æŒä¹…æ€§å’Œå®¹é”™æ€§ç­‰</p>
<p>Kafkaçš„è®¾è®¡ç›®æ ‡æ˜¯é«˜ååã€ä½å»¶è¿Ÿå’Œå¯æ‰©å±•ï¼Œä¸»è¦å…³æ³¨æ¶ˆæ¯ä¼ é€’è€Œä¸æ˜¯æ¶ˆæ¯å¤„ç†</p>
<p>æ‰€ä»¥ï¼ŒKafkaå¹¶æ²¡æœ‰æ”¯æŒæ­»ä¿¡é˜Ÿåˆ—ã€é¡ºåºæ¶ˆæ¯ç­‰é«˜çº§åŠŸèƒ½ (éœ€è¦è‡ªå·±è®¾è®¡?)</p>
<h4>åŸºæœ¬æ¦‚å¿µ</h4>
<figure><figcaption>alt text</figcaption></figure>
<h5>ç”Ÿäº§è€…(Producer)å’Œæ¶ˆè´¹è€…(Consumer) - å®¢æˆ·ç«¯</h5>
<p>å®¢æˆ·ç«¯(Client)åŒ…æ‹¬ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</p>
<p>å‘ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºç§°ä¸ºç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…ç¨‹åºé€šå¸¸æŒç»­ä¸æ–­åœ°å‘â¼€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜å‘é€æ¶ˆæ¯</p>
<p>è®¢é˜…è¿™äº›ä¸»é¢˜æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå°±è¢«ç§°ä¸ºæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ä¹Ÿèƒ½å¤ŸåŒæ—¶è®¢é˜…å¤šä¸ªä¸»é¢˜çš„æ¶ˆæ¯</p>
<h5>æœåŠ¡ç«¯(Broker)</h5>
<p>ä¸€ä¸ª KafkaæœåŠ¡å™¨ å°±æ˜¯ä¸€ä¸ª Broker</p>
<p>é›†ç¾¤ç”±å¤šä¸ª Broker ç»„æˆï¼ŒBroker è´Ÿè´£æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯(å³æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…)å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œä»¥åŠå¯¹æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–</p>
<p>è™½ç„¶å¤šä¸ª Broker è¿›ç¨‹èƒ½å¤Ÿè¿è¡Œåœ¨åŒâ¼€å°æœºå™¨ä¸Šï¼Œä½†æ›´å¸¸è§çš„åšæ³•æ˜¯å°†ä¸åŒçš„ Broker åˆ†æ•£è¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·å¦‚æœé›†ç¾¤ä¸­æŸâ¼€å°æœºå™¨å®•æœºï¼Œå³ä½¿åœ¨å®ƒä¸Šé¢è¿è¡Œçš„æ‰€æœ‰ Broker è¿›ç¨‹éƒ½æŒ‚æ‰äº†ï¼Œå…¶ä»–æœºå™¨ä¸Šçš„ Broker ä¹Ÿå¯ä»¥å¯¹å¤–æä¾›æœåŠ¡</p>
<h5>Topic(ä¸»é¢˜)</h5>
<p>æ˜¯â¼€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œâ¼€ä¸ªTopicè¢«è®¤ä¸ºæ˜¯ä¸šåŠ¡å«ä¹‰ç›¸åŒçš„â¼€ç»„æ¶ˆæ¯</p>
<p>å‘å¸ƒè®¢é˜…çš„å¯¹è±¡æ˜¯ä¸»é¢˜(Topic)ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªä¸šåŠ¡ã€æ¯ä¸ªåº”ç”¨ç”šè‡³æ˜¯æ¯ç±»æ•°æ®éƒ½åˆ›å»ºä¸“å±çš„ä¸»é¢˜</p>
<p>å®¢æˆ·ç«¯éƒ½é€šè¿‡ç»‘å®š Topic æ¥ç”Ÿäº§æˆ–è€…æ¶ˆè´¹è‡ªå·±æ„Ÿå…´è¶£çš„è¯é¢˜</p>
<h5>Partition(åˆ†åŒº)</h5>
<p>Topicåªæ˜¯â¼€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œâ½½Partitionå°±æ˜¯å®é™…å­˜å‚¨æ¶ˆæ¯çš„ç»„ä»¶ï¼Œæ¯ä¸ªTopicå¯ä»¥å¯¹åº”å¤šä¸ªPartitionï¼Œå¹¶ä¸”è¿™äº›åˆ†åŒºå¯ä»¥å­˜åœ¨ä¸åŒçš„Brokerä¸­</p>
<p>æ¯ä¸ªPartitonå°±æ˜¯â¼€ä¸ªqueueé˜Ÿåˆ—ç»“æ„ï¼Œæ‰€æœ‰æ¶ˆæ¯ä»¥FIFOå…ˆè¿›å…ˆå‡ºçš„é¡ºåºä¿å­˜åœ¨è¿™äº›Partitionåˆ†åŒºä¸­</p>
<p>ç”Ÿäº§è€…ç”Ÿäº§çš„æ¯æ¡æ¶ˆæ¯åªä¼šè¢«å‘é€åˆ°â¼€ä¸ªåˆ†åŒºä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå‘â¼€ä¸ªåŒåˆ†åŒºçš„ä¸»é¢˜å‘é€â¼€æ¡æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯è¦ä¹ˆåœ¨åˆ†åŒº 0 ä¸­ï¼Œè¦ä¹ˆåœ¨åˆ†åŒº 1 ä¸­</p>
<p>æ¯ä¸ªåˆ†åŒºä¸‹å¯ä»¥é…ç½®è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œå…¶ä¸­åªèƒ½æœ‰ 1 ä¸ªé¢†å¯¼è€…å‰¯æœ¬å’Œ N-1 ä¸ªè¿½éšè€…å‰¯æœ¬</p>
<p>ç”Ÿäº§è€…å‘åˆ†åŒºå†™å…¥æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®ä¿¡æ¯å«ä½ç§»</p>
<h5>æ¶ˆè´¹è€…ç»„</h5>
<p>æ¯ä¸ªæ¶ˆè´¹è€…å¯ä»¥æŒ‡å®šâ¼€ä¸ªæ‰€å±çš„æ¶ˆè´¹è€…ç»„ï¼Œç›¸åŒæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å…±åŒæ„æˆâ¼€ä¸ªé€»è¾‘æ¶ˆè´¹è€…ç»„</p>
<p>æ¯â¼€ä¸ªæ¶ˆæ¯ä¼šè¢«å¤šä¸ªæ„Ÿå…´è¶£çš„æ¶ˆè´¹è€…ç»„æ¶ˆè´¹ï¼Œä½†æ˜¯åœ¨æ¯â¼€ä¸ªæ¶ˆè´¹è€…ç»„å†…éƒ¨ï¼Œâ¼€ä¸ªæ¶ˆæ¯åªä¼šè¢«æ¶ˆè´¹â¼€æ¬¡</p>
<p>å¦‚æœæ‰€æœ‰å®ä¾‹éƒ½å±äºåŒâ¼€ä¸ª Group, é‚£ä¹ˆå®ƒå®ç°çš„å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</p>
<p>å¦‚æœæ‰€æœ‰å®ä¾‹åˆ†åˆ«å±äºä¸åŒçš„ Group ï¼Œé‚£ä¹ˆå®ƒå®ç°çš„å°±æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹</p>
<h4>dockeréƒ¨ç½²</h4>
<p>åœ¨ dokcker æ‹‰å–é•œåƒæ—¶éƒ¨ç½²Kafka</p>
<p>æ•´ä½“ä¸»è¦åšä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>
<p>å¯åŠ¨ä¸€ä¸ªå•èŠ‚ç‚¹ Kafkaï¼ˆä¸ä¾èµ– Zookeeperï¼Œç”¨ KRaft æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>ç­‰ Kafka çœŸæ­£èµ·æ¥ä¹‹åï¼Œè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ª Topicï¼š<code>file-processing</code> å’Œ <code>vectorization</code></p>
<p>Kafka å¯ç”¨åï¼Œåˆ›å»ºä¸¤ä¸ª topicï¼š<code>file-processing</code> å’Œ <code>vectorization</code>
æ¯ä¸ªéƒ½æ˜¯ï¼š<code>replication-factor 1</code>ï¼ˆå•å‰¯æœ¬ï¼‰+ <code>partitions 1</code>ï¼ˆ1 åˆ†åŒºï¼‰</p>
</li>
<li>
<p>åšå¥åº·æ£€æŸ¥ + æŒä¹…åŒ–æ•°æ®</p>
</li>
</ul>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bitnamilegacy/kafka<span class="token punctuation">:</span>latest
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka       <span class="token comment"># å¦‚æœéœ€è¦æŒ‰ç…§æ–°çš„å‘½åè§„åˆ™ï¼Œè¯·æ”¹ä¸º pai_smart_kafka</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token comment"># Kafka å®¢æˆ·ç«¯è¿æ¥ç«¯å£ï¼ˆproducer/consumer è¿æ¥ç”¨ï¼‰</span>
      <span class="token punctuation">-</span> <span class="token string">"9092:9092"</span>
      <span class="token comment"># KRaft controller é€šä¿¡ç«¯å£ï¼ˆKafka å†…éƒ¨æ§åˆ¶é¢ç”¨ï¼‰</span>
      <span class="token punctuation">-</span> <span class="token string">"9093:9093"</span>
    <span class="token comment"># æŠŠ Kafka æ•°æ®ç›®å½•æŒ‚åˆ° volumeï¼Œé‡å¯å®¹å™¨æ•°æ®ä¸ä¸¢</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> kafka<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/bitnami/kafka
    <span class="token comment"># </span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Kafka - 1</title>
      <link>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/1.html</link>
      <guid>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/1.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Kafka - 1</source>
      <description>MQ(æ¶ˆæ¯é˜Ÿåˆ—) MQï¼šMessageQueueï¼Œæ¶ˆæ¯é˜Ÿåˆ— é˜Ÿåˆ—ï¼Œæ˜¯â¼€ç§FIFO å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œæ¶ˆæ¯åˆ™æ˜¯è·¨è¿›ç¨‹ä¼ é€’çš„æ•°æ® â¼€ä¸ªå…¸å‹çš„MQç³»ç»Ÿï¼Œä¼šå°†æ¶ˆæ¯æ¶ˆæ¯ç”±ç”Ÿäº§è€…å‘é€åˆ°MQè¿›è¡Œæ’é˜Ÿï¼Œç„¶åæ ¹æ®ä¸€å®šçš„é¡ºåºäº¤ç”±æ¶ˆæ¯çš„æ¶ˆè´¹è€…è¿›è¡Œå¤„ç† ä½œç”¨ä¸»è¦åŒ…æ‹¬ å¼‚æ­¥ å¯ä»¥æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ã€ååé‡ è§£è€¦ æœåŠ¡ä¹‹é—´è¿›è¡Œè§£è€¦ï¼Œæ‰å¯ä»¥å‡å°‘æœåŠ¡ä¹‹é—´çš„å½±å“ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:16:53 GMT</pubDate>
      <content:encoded><![CDATA[<h2>MQ(æ¶ˆæ¯é˜Ÿåˆ—)</h2>
<p>MQï¼šMessageQueueï¼Œæ¶ˆæ¯é˜Ÿåˆ—</p>
<p>é˜Ÿåˆ—ï¼Œæ˜¯â¼€ç§FIFO å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œæ¶ˆæ¯åˆ™æ˜¯è·¨è¿›ç¨‹ä¼ é€’çš„æ•°æ®</p>
<p>â¼€ä¸ªå…¸å‹çš„MQç³»ç»Ÿï¼Œä¼šå°†æ¶ˆæ¯æ¶ˆæ¯ç”±ç”Ÿäº§è€…å‘é€åˆ°MQè¿›è¡Œæ’é˜Ÿï¼Œç„¶åæ ¹æ®ä¸€å®šçš„é¡ºåºäº¤ç”±æ¶ˆæ¯çš„æ¶ˆè´¹è€…è¿›è¡Œå¤„ç†</p>
<p>ä½œç”¨ä¸»è¦åŒ…æ‹¬</p>
<ul>
<li>
<p>å¼‚æ­¥</p>
<p>å¯ä»¥æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ã€ååé‡</p>
</li>
<li>
<p>è§£è€¦</p>
<p>æœåŠ¡ä¹‹é—´è¿›è¡Œè§£è€¦ï¼Œæ‰å¯ä»¥å‡å°‘æœåŠ¡ä¹‹é—´çš„å½±å“ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ä»¥åŠå¯æ‰©å±•æ€§</p>
<p>å¦å¤–ï¼Œè§£è€¦åå¯ä»¥å®ç°æ•°æ®åˆ†å‘ã€‚ç”Ÿäº§è€…å‘é€ä¸€ä¸ªæ¶ˆæ¯åï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ï¼Œå¹¶ä¸”æ¶ˆè´¹è€…çš„å¢åŠ æˆ–è€…å‡å°‘å¯¹ç”Ÿäº§è€…æ²¡æœ‰å½±å“</p>
</li>
<li>
<p>å‰Šå³°</p>
<p>åœ¨æµé‡å†²å‡»æ¯”è¾ƒå¤§çš„åœºæ™¯æ—¶ï¼Œå‰ç«¯å¤§é‡è¯·æ±‚å‘é€å¯ä»¥åœ¨MQä¸­å­˜èµ·æ¥ï¼Œè€Œä¸‹æ¸¸çš„æ¶ˆè´¹è€…æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦ç¨³å®šä»é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œï¼Œé¿å…åç«¯æœåŠ¡è¢«å¤§æµé‡å†²å®çš„æƒ…å†µ</p>
</li>
</ul>
<h2>Kafka</h2>
<p>Apache Kafkaæ˜¯ç”±LinkedIné‡‡â½¤Scalaå’ŒJavaå¼€å‘çš„å¼€æºæµå¤„ç†è½¯ä»¶å¹³å°ï¼Œå¹¶æèµ ç»™äº†Apache Software Foundation</p>
<p>å®˜ç½‘åœ°å€ï¼š<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">https://kafka.apache.org/</a></p>
<p>Kafkaä½¿ç”¨é«˜æ•ˆçš„æ•°æ®å­˜å‚¨å’Œç®¡ç†æŠ€æœ¯ï¼Œèƒ½å¤Ÿè½»æ¾åœ°å¤„ç†TBçº§åˆ«çš„æ•°æ®é‡ã€‚å…¶ä¼˜ç‚¹åŒ…æ‹¬é«˜ååé‡ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§ã€æŒä¹…æ€§å’Œå®¹é”™æ€§ç­‰</p>
<p>Kafkaçš„è®¾è®¡ç›®æ ‡æ˜¯é«˜ååã€ä½å»¶è¿Ÿå’Œå¯æ‰©å±•ï¼Œä¸»è¦å…³æ³¨æ¶ˆæ¯ä¼ é€’è€Œä¸æ˜¯æ¶ˆæ¯å¤„ç†</p>
<p>æ‰€ä»¥ï¼ŒKafkaå¹¶æ²¡æœ‰æ”¯æŒæ­»ä¿¡é˜Ÿåˆ—ã€é¡ºåºæ¶ˆæ¯ç­‰é«˜çº§åŠŸèƒ½ (éœ€è¦è‡ªå·±è®¾è®¡?)</p>
<h3>åŸºæœ¬æ¦‚å¿µ</h3>
<figure><figcaption>alt text</figcaption></figure>
<p>Kafkaçš„æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…é€šè¿‡Topicè¿™æ ·ä¸€ä¸ªé€»è¾‘æ¦‚å¿µæ¥è¿›è¿›è¡Œä¸šåŠ¡æ²Ÿé€š</p>
<p>ä½†æ˜¯å®é™…ä¸Šï¼Œæ‰€æœ‰çš„æ¶ˆæ¯æ˜¯å­˜åœ¨æœåŠ¡ç«¯çš„Partitionè¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„å½“ä¸­çš„</p>
<h4>ç”Ÿäº§è€…(Producer)å’Œæ¶ˆè´¹è€…(Consumer) - å®¢æˆ·ç«¯</h4>
<p>å®¢æˆ·ç«¯(Client)åŒ…æ‹¬ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</p>
<p>å‘ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºç§°ä¸ºç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…ç¨‹åºé€šå¸¸æŒç»­ä¸æ–­åœ°å‘â¼€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜å‘é€æ¶ˆæ¯</p>
<p>è®¢é˜…è¿™äº›ä¸»é¢˜æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå°±è¢«ç§°ä¸ºæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ä¹Ÿèƒ½å¤ŸåŒæ—¶è®¢é˜…å¤šä¸ªä¸»é¢˜çš„æ¶ˆæ¯</p>
<h4>æœåŠ¡ç«¯(Broker)</h4>
<p>ä¸€ä¸ª KafkaæœåŠ¡å™¨ å°±æ˜¯ä¸€ä¸ª Broker</p>
<p>é›†ç¾¤ç”±å¤šä¸ª Broker ç»„æˆï¼ŒBroker è´Ÿè´£æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯(å³æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…)å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œä»¥åŠå¯¹æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–</p>
<p>è™½ç„¶å¤šä¸ª Broker è¿›ç¨‹èƒ½å¤Ÿè¿è¡Œåœ¨åŒâ¼€å°æœºå™¨ä¸Šï¼Œä½†æ›´å¸¸è§çš„åšæ³•æ˜¯å°†ä¸åŒçš„ Broker åˆ†æ•£è¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·å¦‚æœé›†ç¾¤ä¸­æŸâ¼€å°æœºå™¨å®•æœºï¼Œå³ä½¿åœ¨å®ƒä¸Šé¢è¿è¡Œçš„æ‰€æœ‰ Broker è¿›ç¨‹éƒ½æŒ‚æ‰äº†ï¼Œå…¶ä»–æœºå™¨ä¸Šçš„ Broker ä¹Ÿå¯ä»¥å¯¹å¤–æä¾›æœåŠ¡</p>
<h4>Topic(ä¸»é¢˜)</h4>
<p>æ˜¯â¼€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œâ¼€ä¸ªTopicè¢«è®¤ä¸ºæ˜¯ä¸šåŠ¡å«ä¹‰ç›¸åŒçš„â¼€ç»„æ¶ˆæ¯</p>
<p>å‘å¸ƒè®¢é˜…çš„å¯¹è±¡æ˜¯ä¸»é¢˜(Topic)ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªä¸šåŠ¡ã€æ¯ä¸ªåº”ç”¨ç”šè‡³æ˜¯æ¯ç±»æ•°æ®éƒ½åˆ›å»ºä¸“å±çš„ä¸»é¢˜</p>
<p>å®¢æˆ·ç«¯éƒ½é€šè¿‡ç»‘å®š Topic æ¥ç”Ÿäº§æˆ–è€…æ¶ˆè´¹è‡ªå·±æ„Ÿå…´è¶£çš„è¯é¢˜</p>
<h4>Partition(åˆ†åŒº)</h4>
<p>Topicåªæ˜¯â¼€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œâ½½Partitionå°±æ˜¯å®é™…å­˜å‚¨æ¶ˆæ¯çš„ç»„ä»¶ï¼Œæ¯ä¸ªTopicå¯ä»¥å¯¹åº”å¤šä¸ªPartitionï¼Œå¹¶ä¸”è¿™äº›åˆ†åŒºå¯ä»¥å­˜åœ¨ä¸åŒçš„Brokerä¸­</p>
<p>æ¯ä¸ªPartitonå°±æ˜¯â¼€ä¸ªqueueé˜Ÿåˆ—ç»“æ„ï¼Œæ‰€æœ‰æ¶ˆæ¯ä»¥FIFOå…ˆè¿›å…ˆå‡ºçš„é¡ºåºä¿å­˜åœ¨è¿™äº›Partitionåˆ†åŒºä¸­</p>
<p>ç”Ÿäº§è€…ç”Ÿäº§çš„æ¯æ¡æ¶ˆæ¯åªä¼šè¢«å‘é€åˆ°â¼€ä¸ªåˆ†åŒºä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå‘â¼€ä¸ªåŒåˆ†åŒºçš„ä¸»é¢˜å‘é€â¼€æ¡æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯è¦ä¹ˆåœ¨åˆ†åŒº 0 ä¸­ï¼Œè¦ä¹ˆåœ¨åˆ†åŒº 1 ä¸­</p>
<p>æ¯ä¸ªåˆ†åŒºä¸‹å¯ä»¥é…ç½®è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œå…¶ä¸­åªèƒ½æœ‰ 1 ä¸ªé¢†å¯¼è€…å‰¯æœ¬å’Œ N-1 ä¸ªè¿½éšè€…å‰¯æœ¬</p>
<p>ç”Ÿäº§è€…å‘åˆ†åŒºå†™å…¥æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®ä¿¡æ¯å«ä½ç§»</p>
<h4>æ¶ˆè´¹è€…ç»„</h4>
<p>æ¯ä¸ªæ¶ˆè´¹è€…å¯ä»¥æŒ‡å®šâ¼€ä¸ªæ‰€å±çš„æ¶ˆè´¹è€…ç»„ï¼Œç›¸åŒæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å…±åŒæ„æˆâ¼€ä¸ªé€»è¾‘æ¶ˆè´¹è€…ç»„</p>
<p>æ¯â¼€ä¸ªæ¶ˆæ¯ä¼šè¢«å¤šä¸ªæ„Ÿå…´è¶£çš„æ¶ˆè´¹è€…ç»„æ¶ˆè´¹ï¼Œä½†æ˜¯åœ¨æ¯â¼€ä¸ªæ¶ˆè´¹è€…ç»„å†…éƒ¨ï¼Œâ¼€ä¸ªæ¶ˆæ¯åªä¼šè¢«æ¶ˆè´¹â¼€æ¬¡</p>
<p>å¦‚æœæ‰€æœ‰å®ä¾‹éƒ½å±äºåŒâ¼€ä¸ª Group, é‚£ä¹ˆå®ƒå®ç°çš„å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</p>
<p>å¦‚æœæ‰€æœ‰å®ä¾‹åˆ†åˆ«å±äºä¸åŒçš„ Group ï¼Œé‚£ä¹ˆå®ƒå®ç°çš„å°±æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹</p>
<h3>Kafkaé›†ç¾¤</h3>
<figure><figcaption>alt text</figcaption></figure>
<p>å•æœºæœåŠ¡ä¸‹ï¼ŒKafkaå·²ç»å…·å¤‡äº†éå¸¸é«˜çš„æ€§èƒ½ï¼ŒTPSèƒ½å¤Ÿè¾¾åˆ°ç™¾ä¸‡çº§åˆ«ã€‚ä½†æ˜¯ï¼Œåœ¨å®é™…å·¥ä½œä¸­ä½¿ç”¨æ—¶ï¼Œå•æœºæ­å»ºçš„Kafkaä¼šæœ‰å¾ˆå¤§çš„å±€é™æ€§</p>
<p>ä¸€æ–¹é¢:æ¶ˆæ¯å¤ªå¤šï¼Œéœ€è¦åˆ†å¼€ä¿å­˜ã€‚</p>
<p>Kafkaæ˜¯é¢å‘æµ·é‡æ¶ˆæ¯è®¾è®¡çš„ï¼Œä¸€ä¸ªTopicä¸‹çš„æ¶ˆæ¯ä¼šéå¸¸å¤šï¼Œå•æœºæœåŠ¡å¾ˆéš¾å­˜å¾—ä¸‹æ¥ã€‚è¿™äº›æ¶ˆæ¯å°±éœ€è¦åˆ†æˆä¸åŒçš„Partitionï¼Œåˆ†å¸ƒåˆ°å¤šä¸ªä¸åŒçš„Brokerä¸Šã€‚è¿™æ ·æ¯ä¸ªBrokerå°±åªéœ€è¦ä¿å­˜ä¸€éƒ¨åˆ†æ•°æ®ã€‚è¿™äº›åˆ†åŒºçš„ä¸ªæ•°å°±ç§°ä¸ºåˆ†åŒºæ•°ã€‚</p>
<p>å¦ä¸€æ–¹é¢:æœåŠ¡ä¸ç¨³å®šï¼Œæ•°æ®å®¹æ˜“ä¸¢å¤±ã€‚</p>
<p>å•æœºæœåŠ¡ä¸‹ï¼Œå¦‚æœæœåŠ¡å´©æºƒï¼Œæ•°æ®å°±ä¸¢å¤±äº†ã€‚</p>
<p>ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ï¼Œå°±éœ€è¦ç»™æ¯ä¸ªPartitioné…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå¤‡ä»½ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚</p>
<p>Kafkaçš„é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªPartitionéƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå¤‡ä»½ã€‚Kafkaä¼šé€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„Zookeeperé›†ç¾¤ä½œä¸ºé€‰ä¸¾ä¸­å¿ƒï¼Œç»™æ¯ä¸ªPartitioné€‰ä¸¾å‡ºä¸€ä¸ªä¸»èŠ‚ç‚¹Leader,å…¶ä»–èŠ‚ç‚¹å°±æ˜¯ä»èŠ‚ç‚¹Followerã€‚</p>
<p>ä¸»èŠ‚ç‚¹è´Ÿè´£å“åº”å®¢æˆ·ç«¯çš„å…·ä½“ä¸šåŠ¡è¯·æ±‚ï¼Œå¹¶ä¿å­˜æ¶ˆæ¯ã€‚è€Œä»èŠ‚ç‚¹åˆ™è´Ÿè´£åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ•°æ®ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼ŒKafkaä¼šé€‰ä¸¾å‡ºä¸€ä¸ªä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>å¯ä»¥åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªBrokerï¼Œç„¶åå¯¹äºä¸€ä¸ªTopicï¼Œå…¶å¯¹åº”æ¶ˆæ¯çš„å…·ä½“å­˜å‚¨ä¼šå¯¹åº”å¤šä¸ª Partitionï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„Brokerä¸Šï¼›åŒæ—¶é˜²æ­¢æŸä¸ªèŠ‚ç‚¹å®•æœºä»è€Œæ‰€å­˜å‚¨çš„Partitionæ²¡äº†ï¼Œæ¯ä¸ªPartitionå¯ä»¥è®¾ç½®å¤šä¸ªå‰¯æœ¬(Replication)å¤‡ä»½</p>
<p>Zookeeperç›®çš„å°±æ˜¯ç®¡ç†è¿™äº›å…ƒä¿¡æ¯
Zookeeperæ˜¯ä¸€ç§å¤šæ•°åŒæ„çš„é€‰ä¸¾æœºåˆ¶ï¼Œå…è®¸é›†ç¾¤ä¸­å°‘æ•°èŠ‚ç‚¹å‡ºç°æ•…éšœã€‚å› æ­¤ï¼Œåœ¨æ­å»ºé›†ç¾¤æ—¶ï¼Œé€šå¸¸éƒ½æ˜¯é‡‡â½¤3ï¼Œ5ï¼Œ7è¿™æ ·çš„å¥‡æ•°èŠ‚ç‚¹ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§åŒ–é›†ç¾¤çš„é«˜å¯ç”¨ç‰¹æ€§</p>
<p>ç›®å‰å¼•å…¥äº†ä¸éœ€è¦Zookeeperçš„é›†ç¾¤æœºåˆ¶ï¼ŒKrafté›†ç¾¤</p>
</blockquote>
<h3>dockeréƒ¨ç½²</h3>
<p>åœ¨ dokcker æ‹‰å–é•œåƒæ—¶éƒ¨ç½²Kafka</p>
<p>æ•´ä½“ä¸»è¦åšä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>
<p>å¯åŠ¨ä¸€ä¸ªå•èŠ‚ç‚¹ Kafkaï¼ˆä¸ä¾èµ– Zookeeperï¼Œç”¨ KRaft æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>ç­‰ Kafka çœŸæ­£èµ·æ¥ä¹‹åï¼Œè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ª Topicï¼š<code>file-processing</code> å’Œ <code>vectorization</code></p>
<p>Kafka å¯ç”¨åï¼Œåˆ›å»ºä¸¤ä¸ª topicï¼š<code>file-processing</code> å’Œ <code>vectorization</code>
æ¯ä¸ªéƒ½æ˜¯ï¼š<code>replication-factor 1</code>ï¼ˆå•å‰¯æœ¬ï¼‰+ <code>partitions 1</code>ï¼ˆ1 åˆ†åŒºï¼‰</p>
</li>
<li>
<p>åšå¥åº·æ£€æŸ¥ + æŒä¹…åŒ–æ•°æ®</p>
</li>
</ul>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bitnamilegacy/kafka<span class="token punctuation">:</span>latest
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka       <span class="token comment"># å¦‚æœéœ€è¦æŒ‰ç…§æ–°çš„å‘½åè§„åˆ™ï¼Œè¯·æ”¹ä¸º pai_smart_kafka</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token comment"># Kafka å®¢æˆ·ç«¯è¿æ¥ç«¯å£ï¼ˆproducer/consumer è¿æ¥ç”¨ï¼‰</span>
      <span class="token punctuation">-</span> <span class="token string">"9092:9092"</span>
      <span class="token comment"># KRaft controller é€šä¿¡ç«¯å£ï¼ˆKafka å†…éƒ¨æ§åˆ¶é¢ç”¨ï¼‰</span>
      <span class="token punctuation">-</span> <span class="token string">"9093:9093"</span>
    <span class="token comment"># æŠŠ Kafka æ•°æ®ç›®å½•æŒ‚åˆ° volumeï¼Œé‡å¯å®¹å™¨æ•°æ®ä¸ä¸¢</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> kafka<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/bitnami/kafka
    <span class="token comment"># </span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Kafka - 2 å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶1</title>
      <link>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/2.html</link>
      <guid>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/2.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Kafka - 2 å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶1</source>
      <description>å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶ å…¶å®Kafkaçš„è®¾è®¡ç²¾é«“ï¼Œæ˜¯åœ¨ç½‘ç»œä¸ç¨³å®šï¼ŒæœåŠ¡ä¹Ÿéšæ—¶ä¼šå´©æºƒçš„è¿™äº›ä½œæ­»çš„å¤æ‚åœºæ™¯ä¸‹ï¼Œå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é«˜å¹¶å‘ã€é«˜ååï¼Œé‚£æ‰æ˜¯Kafkaæœ€ä¸ºç²¾å¦™çš„åœ°æ–¹ã€‚ä½†æ˜¯è¦ç†è§£é‚£äº›å¤æ‚çš„é—®é¢˜ï¼Œéƒ½æ˜¯éœ€è¦å»ºç«‹åœ¨è¿™ä¸ªåŸºç¡€æ¨¡å‹åŸºç¡€ä¸Šçš„ æ¶ˆè´¹è€…åˆ†ç»„æ¶ˆè´¹æœºåˆ¶ GROUP_ID_CONFIG â€‹åœ¨Consumerä¸­ï¼Œéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ª GROUP_ID_CONFIG å±æ€§ï¼Œè¿™...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:16:53 GMT</pubDate>
      <content:encoded><![CDATA[<h2>å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶</h2>
<p>å…¶å®Kafkaçš„è®¾è®¡ç²¾é«“ï¼Œæ˜¯åœ¨ç½‘ç»œä¸ç¨³å®šï¼ŒæœåŠ¡ä¹Ÿéšæ—¶ä¼šå´©æºƒçš„è¿™äº›ä½œæ­»çš„å¤æ‚åœºæ™¯ä¸‹ï¼Œå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é«˜å¹¶å‘ã€é«˜ååï¼Œé‚£æ‰æ˜¯Kafkaæœ€ä¸ºç²¾å¦™çš„åœ°æ–¹ã€‚ä½†æ˜¯è¦ç†è§£é‚£äº›å¤æ‚çš„é—®é¢˜ï¼Œéƒ½æ˜¯éœ€è¦å»ºç«‹åœ¨è¿™ä¸ªåŸºç¡€æ¨¡å‹åŸºç¡€ä¸Šçš„</p>
<h3>æ¶ˆè´¹è€…åˆ†ç»„æ¶ˆè´¹æœºåˆ¶</h3>
<h4><code>GROUP_ID_CONFIG</code></h4>
<p>â€‹åœ¨Consumerä¸­ï¼Œéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ª <code>GROUP_ID_CONFIG</code> å±æ€§ï¼Œè¿™è¡¨ç¤ºå½“å‰Consumeræ‰€å±çš„æ¶ˆè´¹è€…ç»„</p>
<p>å¯¹åº”çš„ <code>ConsumerConfig</code> å¯¹åº”çš„é…ç½®</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GROUP_ID_CONFIG</span> <span class="token operator">=</span> <span class="token string">"group.id"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GROUP_ID_DOC</span> <span class="token operator">=</span> <span class="token string">"A unique string that identifies the consumer group this consumer belongs to. This property is required if the consumer uses either the group management functionality by using &lt;code&gt;subscribe(topic)&lt;/code&gt; or the Kafka-based offset management strategy."</span><span class="token punctuation">;</span>
</code></pre></div><blockquote>
<p>æ—¢ç„¶è¿™é‡Œæåˆ°äº†kafka-based offset management strategyï¼Œé‚£æ˜¯ä¸æ˜¯ä¹Ÿæœ‰éKafkaç®¡ç†Offsetçš„ç­–ç•¥å‘¢ï¼Ÿ</p>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„å‚æ•° <code>GROUP_INSTANCE_ID_CONFIG</code>, å¯ä»¥ç»™ç»„æˆå‘˜è®¾ç½®ä¸€ä¸ªå›ºå®šçš„instanceIdï¼Œè¿™ä¸ªå‚æ•°é€šå¸¸å¯ä»¥ç”¨æ¥å‡å°‘Kafkaä¸å¿…è¦çš„rebalance</p>
<p>å¦‚æœæ²¡è®¾ç½®ï¼Œå°±æŒ‰ç…§åŠ¨æ€çš„æ¥è¿›è¡Œåˆ†é…memberï¼Œè®¾ç½®äº†è¿™ä¸ªconsumerå°±è¢«è§†ä¸ºä¸€ä¸ªé™æ€çš„memberï¼Œå¯ä»¥ç”¨æ¥å‡å°‘ Kafka ç»„çš„ä¸å¿…è¦çš„rebalance</p>
</blockquote>
<p>å¯¹äºConsumerï¼Œå¦‚æœéœ€è¦åœ¨subcribeæ—¶ä½¿ç”¨ç»„ç®¡ç†åŠŸèƒ½ä»¥åŠKafkaæä¾›çš„offsetç®¡ç†ç­–ç•¥ï¼Œé‚£å°±å¿…é¡»è¦é…ç½® <code>GROUP_ID_CONFIG</code> å±æ€§</p>
<p>è¿™ä¸ªåˆ†ç»„æ¶ˆè´¹æœºåˆ¶ç®€å•æè¿°å°±æ˜¯è¿™æ ·çš„ï¼š</p>
<figure><figcaption>alt text</figcaption></figure>
<p>â€‹ç”Ÿäº§è€…å¾€Topicä¸‹å‘æ¶ˆæ¯æ—¶ï¼Œä¼šå°½é‡å‡åŒ€çš„å°†æ¶ˆæ¯å‘é€åˆ°Topicä¸‹çš„å„ä¸ªPartitionå½“ä¸­ã€‚è€Œè¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå‘æ‰€æœ‰è®¢é˜…äº†è¯¥Topicçš„æ¶ˆè´¹è€…æ¨é€ã€‚æ¨é€æ—¶ï¼Œæ¯ä¸ªConsumerGroupä¸­åªä¼šæ¨é€ä¸€ä»½ã€‚ä¹Ÿå°±æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œåªä¼šå…±åŒæ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯å‰¯æœ¬ã€‚è€Œä¸åŒæ¶ˆè´¹è€…ç»„ä¹‹é—´ï¼Œä¼šé‡å¤æ¶ˆè´¹æ¶ˆæ¯å‰¯æœ¬ã€‚è¿™å°±æ˜¯æ¶ˆè´¹è€…ç»„çš„ä½œç”¨ã€‚</p>
<h4>rebalance</h4>
<p>rebalance å°±æ˜¯ kafka ä¼šåˆç†å¹³è¡¡åœ°ä¸ºä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„æ¶ˆè´¹è€…åˆ†é…å¯¹åº”çš„partition</p>
<p>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ æ˜¯ç”±å¤šä¸ª æ¶ˆè´¹è€… ç»„æˆçš„ï¼Œæ¶ˆè´¹è€…ç»„ä¼šå…±åŒæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ª topic ä¸‹çš„æ‰€æœ‰ åˆ†åŒºã€‚ä½†æ˜¯ï¼Œå½“æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…æ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…å½“ Kafka é›†ç¾¤ä¸­çš„åˆ†åŒºæ•°é‡å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘ rebalanceï¼Œå³é‡æ–°åˆ†é…åˆ†åŒº</p>
<p>åˆ†åŒºæ˜¯æ¶ˆè´¹çš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ªåˆ†åŒºåªèƒ½è¢« ä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€… æ¶ˆè´¹ã€‚å½“æ¶ˆè´¹è€…ç»„çš„æˆå‘˜å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚å¢åŠ /å‡å°‘äº†æ¶ˆè´¹è€…ï¼Œæˆ–è€… Kafka ä¸­çš„ topic åˆ†åŒºå‘ç”Ÿäº†å˜åŒ–ï¼ŒKafka éœ€è¦é€šè¿‡ rebalance æ¥ç¡®ä¿æ¯ä¸ªåˆ†åŒºæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ã€‚</p>
<p>ä¸€ä¸ª Kafka partition é€šå¸¸ å¯¹åº”ä¸€ä¸ª consumerï¼Œä½†è¿™æ˜¯ é’ˆå¯¹åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ çš„æƒ…å†µ</p>
<p>åªè¦ä¸å±äºåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå°±å¯ä»¥åŒæ—¶æ¶ˆè´¹åŒä¸€ä¸ªpartition</p>
<h4>åç§»é‡ offset</h4>
<p>ä¸ä¹‹ç›¸å…³çš„è¿˜æœ‰Offsetåç§»é‡ã€‚è¿™ä¸ªåç§»é‡è¡¨ç¤ºæ¯ä¸ªæ¶ˆè´¹è€…ç»„åœ¨æ¯ä¸ªPartitonä¸­å·²ç»æ¶ˆè´¹å¤„ç†çš„è¿›åº¦ã€‚åœ¨Kafkaä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…ç»„çš„Offsetè®°å½•æƒ…å†µã€‚</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./kafka-consumer-groups.sh --bootstrap-server worker1:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> <span class="token builtin class-name">test</span>
</code></pre></div><p>â€‹è¿™ä¸ªOffsetåç§»é‡ï¼Œéœ€è¦æ¶ˆè´¹è€…å¤„ç†å®Œæˆåä¸»åŠ¨å‘Kafkaçš„Brokeræäº¤</p>
<p>æäº¤å®Œæˆåï¼ŒBrokerå°±ä¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼Œè¡¨ç¤ºè¿™ä¸ªæ¶ˆæ¯å·²ç»è¢«è¿™ä¸ªæ¶ˆè´¹è€…ç»„å¤„ç†å®Œäº†</p>
<p>ä½†æ˜¯å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰æäº¤Offsetï¼ŒBrokerå°±ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰è¢«å¤„ç†è¿‡ï¼Œå°±ä¼šé‡æ–°å¾€å¯¹åº”çš„æ¶ˆè´¹è€…ç»„è¿›è¡Œæ¨é€ï¼Œä¸è¿‡è¿™æ¬¡ï¼Œä¸€èˆ¬ä¼šå°½é‡æ¨é€ç»™åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å½“ä¸­çš„å…¶ä»–æ¶ˆè´¹è€…å®ä¾‹</p>
<p>â€‹åœ¨ç¤ºä¾‹å½“ä¸­ï¼Œæ˜¯é€šè¿‡ä¸šåŠ¡ç«¯ä¸»åŠ¨è°ƒç”¨Consumerçš„<code>commitAsync</code>æ–¹æ³•æˆ–è€…<code>commitSync</code>æ–¹æ³•ä¸»åŠ¨æäº¤çš„ï¼ŒKafkaä¸­è‡ªç„¶ä¹Ÿæä¾›äº†è‡ªåŠ¨æäº¤Offsetçš„æ–¹å¼</p>
<p>ä½¿ç”¨è‡ªåŠ¨æäº¤ï¼Œåªéœ€è¦åœ¨Comsumerä¸­é…ç½®ENABLE_AUTO_COMMIT_CONFIGå±æ€§å³å¯</p>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒOffsetæ˜¯Kafkaè¿›è¡Œæ¶ˆæ¯æ¨é€æ§åˆ¶çš„å…³é”®ä¹‹å¤„ã€‚è¿™é‡Œéœ€è¦æ€è€ƒä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p><code>Offset</code>æ˜¯æ ¹æ®<code>Group</code>ã€<code>Partition</code>åˆ†å¼€è®°å½•çš„ã€‚æ¶ˆè´¹è€…å¦‚æœä¸€ä¸ªPartitionå¯¹åº”å¤šä¸ªConsumeræ¶ˆè´¹è€…å®ä¾‹ï¼Œé‚£ä¹ˆæ¯ä¸ªConsumerå®ä¾‹éƒ½ä¼šå¾€Brokeræäº¤åŒä¸€ä¸ªPartitionçš„ä¸åŒOffsetï¼Œè¿™æ—¶å€™Brokerè¦å¬è°çš„ï¼Ÿ</p>
<p>æ‰€ä»¥ä¸€ä¸ªPartitionæœ€å¤šåªèƒ½åŒæ—¶è¢«ä¸€ä¸ªConsumeræ¶ˆè´¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¤ºä¾‹ä¸­å››ä¸ªPartitionçš„Topicï¼Œé‚£ä¹ˆåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­æœ€å¤šå°±åªèƒ½é…ç½®å››ä¸ªæ¶ˆè´¹è€…å®ä¾‹</p>
</li>
<li>
<p>è¿™ä¹ˆå…³é”®çš„Offsetæ•°æ®ï¼Œä¿å­˜åœ¨Brokerç«¯ï¼Œä½†æ˜¯å´æ˜¯ç”±"ä¸é è°±"çš„æ¶ˆè´¹è€…ä¸»å¯¼æ¨è¿›ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¤Ÿå®‰å…¨çš„ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•æé«˜Offsetæ•°æ®çš„å®‰å…¨æ€§å‘¢ï¼Ÿ</p>
<p>å¦‚æœä½ æœ‰å…´è¶£è‡ªå·±è§‚å¯Ÿï¼Œä¼šå‘ç°åœ¨Consumerä¸­ï¼Œå®é™…ä¸Šä¹Ÿæä¾›äº†<code>AUTO_OFFSET_RESET_CONFIG</code>å‚æ•°ï¼Œæ¥æŒ‡å®šæ¶ˆè´¹è€…ç»„åœ¨æœåŠ¡ç«¯çš„Offsetä¸å­˜åœ¨æ—¶å¦‚ä½•è¿›è¡Œåç»­æ¶ˆè´¹ã€‚(æœ‰å¯èƒ½æœåŠ¡ç«¯åˆå§‹åŒ–Consumer Groupçš„Offsetå¤±è´¥ï¼Œä¹Ÿæœ‰å¯èƒ½Consumer Groupå½“å‰çš„Offsetå¯¹åº”çš„æ•°æ®æ–‡ä»¶è¢«è¿‡æœŸåˆ é™¤äº†)è¿™å°±ç›¸å½“äºæœåŠ¡ç«¯åšçš„å…œåº•ä¿éšœ</p>
</li>
</ul>
<blockquote>
<p>ConsumerConfig.AUTO_OFFSET_RESEWT_CONFIG ï¼šå½“Serverç«¯æ²¡æœ‰å¯¹åº”çš„Offsetæ—¶ï¼Œè¦å¦‚ä½•å¤„ç†ã€‚ å¯é€‰é¡¹ï¼š</p>
<ul>
<li>earliestï¼š è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æœ€æ—©çš„offset</li>
<li>latestï¼šè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æœ€æ™šçš„offset</li>
<li>noneï¼š å¦‚æœæ¶ˆè´¹è€…ç»„å¯¹åº”çš„offsetæ‰¾ä¸åˆ°ï¼Œå°±å‘ConsumeræŠ›å¼‚å¸¸</li>
</ul>
</blockquote>
<p>æœ‰äº†æœåŠ¡ç«¯å…œåº•åï¼Œæ¶ˆè´¹è€…åº”è¯¥è¦å¦‚ä½•ä¿è¯offsetçš„å®‰å…¨æ€§å‘¢ï¼Ÿ</p>
<p>å¼‚æ­¥æäº¤ (æ•ˆç‡é«˜ï¼Œä½†å¯èƒ½ä¼šå‘ç”Ÿæ¶ˆæ¯ä¸¢å¤±)</p>
<p>åŒæ­¥æäº¤ (å¯é æ€§é«˜ï¼Œä½†æ•ˆç‡ç›¸å¯¹ä½ï¼Œå¯èƒ½å‘ç”Ÿé‡å¤å¤„ç†)</p>
<p>æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>ä¸€ç§æ˜¯å¼‚æ­¥æäº¤ã€‚å°±æ˜¯æ¶ˆè´¹è€…åœ¨å¤„ç†ä¸šåŠ¡çš„åŒæ—¶ï¼Œå¼‚æ­¥å‘Brokeræäº¤Offset</p>
<p>è¿™æ ·å¥½å¤„æ˜¯æ¶ˆè´¹è€…çš„æ•ˆç‡ä¼šæ¯”è¾ƒé«˜ï¼Œä½†æ˜¯å¦‚æœæ¶ˆè´¹è€…çš„æ¶ˆæ¯å¤„ç†å¤±è´¥äº†ï¼Œè€ŒoffsetåˆæˆåŠŸæäº¤äº†, è¿™å°±ä¼šé€ æˆ<strong>æ¶ˆæ¯ä¸¢å¤±</strong>ã€‚</p>
<p>å¦ä¸€ç§æ–¹å¼æ˜¯åŒæ­¥æäº¤ã€‚æ¶ˆè´¹è€…ä¿è¯å¤„ç†å®Œæ‰€æœ‰ä¸šåŠ¡åï¼Œå†æäº¤Offset</p>
<p>è¿™æ ·çš„å¥½å¤„è‡ªç„¶æ˜¯æ¶ˆæ¯ä¸ä¼šå› ä¸ºoffsetä¸¢å¤±äº†ã€‚å› ä¸ºå¦‚æœä¸šåŠ¡å¤„ç†å¤±è´¥ï¼Œæ¶ˆè´¹è€…å°±å¯ä»¥ä¸å»æäº¤Offsetï¼Œè¿™æ ·æ¶ˆæ¯è¿˜å¯ä»¥é‡è¯•ã€‚</p>
<p>ä½†æ˜¯åå¤„æ˜¯æ¶ˆè´¹è€…å¤„ç†ä¿¡æ¯è‡ªç„¶å°±æ…¢äº†ã€‚å¦å¤–è¿˜ä¼šäº§ç”Ÿæ¶ˆæ¯é‡å¤ã€‚</p>
<p>å› ä¸ºBrokerç«¯ä¸å¯èƒ½ä¸€ç›´ç­‰å¾…æ¶ˆè´¹è€…æäº¤, å¦‚æœæ¶ˆè´¹è€…çš„ä¸šåŠ¡å¤„ç†æ—¶é—´æ¯”è¾ƒé•¿ï¼Œè¿™æ—¶åœ¨æ¶ˆè´¹è€…æ­£å¸¸å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼ŒBrokerç«¯å°±å·²ç»ç­‰ä¸ä¸‹å»äº†ï¼Œè®¤ä¸ºè¿™ä¸ªæ¶ˆè´¹è€…å¤„ç†å¤±è´¥äº†ã€‚</p>
<p>è¿™æ—¶å°±ä¼šå¾€åŒç»„çš„å…¶ä»–æ¶ˆè´¹è€…å®ä¾‹æŠ•é€’æ¶ˆæ¯ï¼Œè¿™å°±é€ æˆäº†<strong>æ¶ˆæ¯é‡å¤å¤„ç†</strong></p>
<h5>å¯èƒ½è§£å†³æ–¹æ¡ˆ</h5>
<p>å…¶å®è¿™ç±»é—®é¢˜çš„æ ¹æºåœ¨äºOffsetåæ˜ çš„æ˜¯æ¶ˆæ¯çš„å¤„ç†è¿›åº¦ã€‚è€Œæ¶ˆæ¯å¤„ç†è¿›åº¦è·Ÿä¸šåŠ¡çš„å¤„ç†è¿›åº¦åˆæ˜¯ä¸åŒæ­¥çš„ã€‚æ‰€æœ‰æˆ‘ä»¬å¯ä»¥æ¢ä¸€ç§æ€è·¯ï¼Œå°†Offsetä»Brokerç«¯æŠ½å–å‡ºæ¥ï¼Œæ”¾åˆ°ç¬¬ä¸‰æ–¹å­˜å‚¨æ¯”å¦‚Redisé‡Œè‡ªè¡Œç®¡ç†ã€‚è¿™æ ·å°±å¯ä»¥è‡ªå·±æ§åˆ¶ç”¨ä¸šåŠ¡çš„å¤„ç†è¿›åº¦æ¨è¿›Offsetå¾€å‰æ›´æ–°ã€‚</p>
<h3>ç”Ÿäº§è€…æ‹¦æˆªå™¨æœºåˆ¶</h3>
<p>â€‹ç”Ÿäº§è€…æ‹¦æˆªæœºåˆ¶å…è®¸å®¢æˆ·ç«¯åœ¨ç”Ÿäº§è€…åœ¨æ¶ˆæ¯å‘é€åˆ°Kafkaé›†ç¾¤ä¹‹å‰ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œæ‹¦æˆªï¼Œç”šè‡³å¯ä»¥ä¿®æ”¹æ¶ˆæ¯å†…å®¹</p>
<p>è¿™æ¶‰åŠåˆ°Producerä¸­æŒ‡å®šçš„ä¸€ä¸ªå‚æ•°ï¼š<code>INTERCEPTOR_CLASSES_CONFIG</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span> <span class="token operator">=</span> <span class="token string">"interceptor.classes"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">INTERCEPTOR_CLASSES_DOC</span> <span class="token operator">=</span> <span class="token string">"A list of classes to use as interceptors. Implementing the &lt;code&gt;org.apache.kafka.clients.producer.ProducerInterceptor&lt;/code&gt; interface allows you to intercept (and possibly mutate) the records received by the producer before they are published to the Kafka cluster. By default, there are no interceptors."</span><span class="token punctuation">;</span>
</code></pre></div><p>æŒ‰ç…§ä»–çš„è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„æ‹¦æˆªå™¨å®ç°ç±»ï¼š</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span> <span class="token punctuation">{</span>
  <span class="token comment">//å‘é€æ¶ˆæ¯æ—¶è§¦å‘</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span> producerRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"prudocerRecord : "</span> <span class="token operator">+</span> producerRecord<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> producerRecord<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//æ”¶åˆ°æœåŠ¡ç«¯å“åº”æ—¶è§¦å‘</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"acknowledgement recordMetadata:"</span><span class="token operator">+</span>recordMetadata<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//è¿æ¥å…³é—­æ—¶è§¦å‘</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"producer closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//æ•´ç†é…ç½®é¡¹</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=====config start======"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"entry.key:"</span><span class="token operator">+</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" === entry.value: "</span><span class="token operator">+</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=====config end======"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶ååœ¨ç”Ÿäº§è€…ä¸­æŒ‡å®šæ‹¦æˆªå™¨ç±»ï¼ˆå¤šä¸ªæ‹¦æˆªå™¨ç±»ï¼Œç”¨é€—å·éš”å¼€ï¼‰</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code>props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span><span class="token string">"com.roy.kfk.basic.MyInterceptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ‹¦æˆªå™¨æœºåˆ¶ä¸€èˆ¬ç”¨å¾—æ¯”è¾ƒå°‘ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›ç»Ÿä¸€æ·»åŠ æ—¶é—´ç­‰ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯ã€‚æ¯”å¦‚ï¼Œç”¨Kafkaä¼ é€’ä¸€äº›POJOï¼Œå°±å¯ä»¥ç”¨æ‹¦æˆªå™¨ç»Ÿä¸€æ·»åŠ æ—¶é—´å±æ€§ã€‚ä½†æ˜¯æˆ‘ä»¬å¹³å¸¸ç”¨Kafkaä¼ é€’çš„éƒ½æ˜¯Stringç±»å‹çš„æ¶ˆæ¯ï¼ŒPOJOç±»å‹çš„æ¶ˆæ¯ï¼ŒKafkaå¯ä»¥ä¼ å—ï¼Ÿè¿™å°±è¦ç”¨åˆ°ä¸‹é¢çš„æ¶ˆæ¯åºåˆ—åŒ–æœºåˆ¶</p>
<h3>æ¶ˆæ¯åºåˆ—åŒ–æœºåˆ¶</h3>
<h4>Producerçš„åºåˆ—åŒ–</h4>
<p>â€‹åœ¨ä¹‹å‰çš„ç®€å•ç¤ºä¾‹ä¸­ï¼ŒProduceræŒ‡å®šäº†ä¸¤ä¸ªå±æ€§<code>KEY_SERIALIZER_CLASS_CONFIG</code>å’Œ<code>VALUE_SERIALIZER_CLASS_CONFIG</code>ï¼Œå¯¹äºè¿™ä¸¤ä¸ªå±æ€§ï¼Œåœ¨ProducerConfigä¸­éƒ½æœ‰é…å¥—çš„è¯´æ˜å±æ€§</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"key.serializer"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_SERIALIZER_CLASS_DOC</span> <span class="token operator">=</span> <span class="token string">"Serializer class for key that implements the &lt;code&gt;org.apache.kafka.common.serialization.Serializer&lt;/code&gt; interface."</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"value.serializer"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">VALUE_SERIALIZER_CLASS_DOC</span> <span class="token operator">=</span> <span class="token string">"Serializer class for value that implements the &lt;code&gt;org.apache.kafka.common.serialization.Serializer&lt;/code&gt; interface."</span><span class="token punctuation">;</span>
</code></pre></div><p>é€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå¯ä»¥æŒ‡å®šæ¶ˆæ¯ç”Ÿäº§è€…å¦‚ä½•å°†æ¶ˆæ¯çš„keyå’Œvalueåºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ•°æ®</p>
<p>åœ¨Kafkaçš„æ¶ˆæ¯å®šä¹‰ä¸­ï¼Œkeyå’Œvalueçš„ä½œç”¨æ˜¯ä¸åŒçš„</p>
<ul>
<li>keyæ˜¯ç”¨æ¥è¿›è¡Œåˆ†åŒºçš„å¯é€‰é¡¹ã€‚Kafkaé€šè¿‡keyæ¥åˆ¤æ–­æ¶ˆæ¯è¦åˆ†å‘åˆ°å“ªä¸ªPartition</li>
<li>Valueæ˜¯ä¸šåŠ¡ä¸Šæ¯”è¾ƒå…³å¿ƒçš„æ¶ˆæ¯ã€‚KafkaåŒæ ·éœ€è¦å°†Valueå¯¹è±¡é€šè¿‡Serializeråºåˆ—åŒ–æ¥å£ï¼Œå°†Keyè½¬æ¢æˆbyte[]æ•°ç»„ï¼Œè¿™æ ·æ‰èƒ½æ¯”è¾ƒå¥½çš„åœ¨ç½‘ç»œä¸Šä¼ è¾“Valueä¿¡æ¯ï¼Œä»¥åŠå°†Valueä¿¡æ¯è½ç›˜åˆ°æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å½“ä¸­</li>
</ul>
<p>å¦‚æœæ²¡æœ‰å¡«å†™keyï¼Œé‚£ä¹ˆKafkaä¼šè‡ªåŠ¨é€‰æ‹©Partition</p>
<p>å¦‚æœå¡«å†™äº†keyï¼Œé‚£ä¹ˆä¼šé€šè¿‡å£°æ˜çš„Serializeråºåˆ—åŒ–æ¥å£ï¼Œå°†keyè½¬æ¢æˆä¸€ä¸ªbyte[]æ•°ç»„ï¼Œç„¶åå¯¹keyè¿›è¡Œhashï¼Œé€‰æ‹©Partitionã€‚è¿™æ ·å¯ä»¥ä¿è¯keyç›¸åŒçš„æ¶ˆæ¯ä¼šåˆ†é…åˆ°ç›¸åŒçš„Partitionä¸­</p>
<h4>Consumerçš„ååºåˆ—åŒ–</h4>
<p>ç”Ÿäº§è€…è¦å¯¹æ¶ˆæ¯è¿›è¡Œåºåˆ—åŒ–ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œè‡ªç„¶éœ€è¦è¿›è¡Œååºåˆ—åŒ–</p>
<p>æ‰€ä»¥ï¼Œåœ¨Consumerä¸­ï¼Œä¹Ÿæœ‰ååºåˆ—åŒ–çš„ä¸¤ä¸ªé…ç½®</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_DESERIALIZER_CLASS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"key.deserializer"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_DESERIALIZER_CLASS_DOC</span> <span class="token operator">=</span> <span class="token string">"Deserializer class for key that implements the &lt;code&gt;org.apache.kafka.common.serialization.Deserializer&lt;/code&gt; interface."</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">VALUE_DESERIALIZER_CLASS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"value.deserializer"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">VALUE_DESERIALIZER_CLASS_DOC</span> <span class="token operator">=</span> <span class="token string">"Deserializer class for value that implements the &lt;code&gt;org.apache.kafka.common.serialization.Deserializer&lt;/code&gt; interface."</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸ Producer çš„åºåˆ—åŒ–æœºåˆ¶ç›¸åï¼ŒConsumerçš„ååºåˆ—åŒ–æ˜¯å°†ä»Kafkaå¾—åˆ°çš„æ¶ˆæ¯äºŒè¿›åˆ¶æ•°æ®ååºåˆ—åŒ–ä¸ºå¯¹åº”çš„ key å’Œ valueï¼Œä»¥ä¾¿åç»­çš„ä¸šåŠ¡æ“ä½œ</p>
<h4>è‡ªå®šä¹‰åºåˆ—åŒ–</h4>
<p>åœ¨Kafkaä¸­ï¼Œå¯¹äºå¸¸ç”¨çš„ä¸€äº›åŸºç¡€æ•°æ®ç±»å‹ï¼Œéƒ½å·²ç»æä¾›äº†å¯¹åº”çš„å®ç°ç±»ã€‚ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸€äº›è‡ªå®šä¹‰çš„æ¶ˆæ¯æ ¼å¼ï¼Œæ¯”å¦‚è‡ªå·±å®šåˆ¶çš„POJOï¼Œå°±éœ€è¦å®šåˆ¶å…·ä½“çš„å®ç°ç±»äº†</p>
<figure><figcaption>alt text</figcaption></figure>
<p>â€‹åœ¨è‡ªå·±è¿›è¡Œåºåˆ—åŒ–æœºåˆ¶æ—¶ï¼Œéœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•ç”¨äºŒè¿›åˆ¶æ¥æè¿°ä¸šåŠ¡æ•°æ®</p>
<p>ä¾‹å¦‚å¯¹äºä¸€ä¸ªé€šå¸¸çš„POJOç±»å‹ï¼Œå¯ä»¥å°†ä»–çš„å±æ€§æ‹†åˆ†æˆä¸¤ç§ç±»å‹ï¼š</p>
<p>ä¸€ç§ç±»å‹æ˜¯å®šé•¿çš„åŸºç¡€ç±»å‹ï¼Œæ¯”å¦‚Integer,Long,Doubleç­‰</p>
<p>è¿™äº›åŸºç¡€ç±»å‹è½¬åŒ–æˆäºŒè¿›åˆ¶æ•°ç»„éƒ½æ˜¯å®šé•¿çš„ã€‚è¿™ç±»å±æ€§å¯ä»¥ç›´æ¥è½¬æˆåºåˆ—åŒ–æ•°ç»„ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œåªè¦æŒ‰ç…§å®šé•¿å»è¯»å–äºŒè¿›åˆ¶æ•°æ®å°±å¯ä»¥ååºåˆ—åŒ–äº†</p>
<p>å¦ä¸€ç§æ˜¯ä¸å®šé•¿çš„æµ®åŠ¨ç±»å‹ï¼Œæ¯”å¦‚Stringï¼Œæˆ–è€…åŸºäºStringçš„JSONç±»å‹ç­‰</p>
<p>è¿™ç§æµ®åŠ¨ç±»å‹çš„åŸºç¡€æ•°æ®è½¬åŒ–æˆäºŒè¿›åˆ¶æ•°ç»„ï¼Œé•¿åº¦éƒ½æ˜¯ä¸ä¸€å®šçš„</p>
<p>å¯¹äºè¿™ç±»æ•°æ®ï¼Œé€šå¸¸çš„å¤„ç†æ–¹å¼éƒ½æ˜¯å…ˆå¾€äºŒè¿›åˆ¶æ•°ç»„ä¸­å†™å…¥ä¸€ä¸ªå®šé•¿çš„æ•°æ®çš„é•¿åº¦æ•°æ®(Integeræˆ–è€…Longç±»å‹)ï¼Œç„¶åå†ç»§ç»­å†™å…¥æ•°æ®æœ¬èº«</p>
<p>è¿™æ ·ï¼Œååºåˆ—åŒ–æ—¶ï¼Œå°±å¯ä»¥å…ˆè¯»å–ä¸€ä¸ªå®šé•¿çš„é•¿åº¦ï¼Œå†æŒ‰ç…§è¿™ä¸ªé•¿åº¦å»è¯»å–å¯¹åº”é•¿åº¦çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™æ ·å°±èƒ½è¯»å–åˆ°æ•°æ®çš„å®Œæ•´äºŒè¿›åˆ¶å†…å®¹</p>
<blockquote>
<p>åºåˆ—åŒ–æœºåˆ¶æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¼˜åŒ–æœºåˆ¶</p>
<p>é«˜æ•ˆçš„ç³»åˆ—åŒ–å®ç°èƒ½å¤Ÿæå¤§çš„æå‡åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç½‘ç»œä¼ è¾“ä»¥åŠæ•°æ®è½ç›˜çš„èƒ½åŠ›</p>
<p>ä¾‹å¦‚å¯¹äºä¸€ä¸ªUserå¯¹è±¡ï¼Œå³å¯ä»¥ä½¿ç”¨JSONå­—ç¬¦ä¸²è¿™ç§ç®€å•ç²—æš´çš„åºåˆ—åŒ–æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æŒ‰ç…§å„ä¸ªå­—æ®µè¿›è¡Œç»„åˆåºåˆ—åŒ–çš„æ–¹å¼ã€‚ä½†æ˜¯æ˜¾ç„¶åè€…çš„å ç”¨ç©ºé—´æ¯”è¾ƒå°ï¼Œåºåˆ—åŒ–é€Ÿåº¦ä¹Ÿä¼šæ¯”è¾ƒå¿«ã€‚è€ŒKafkaåœ¨æ–‡ä»¶è½ç›˜æ—¶ï¼Œä¹Ÿè®¾è®¡äº†éå¸¸é«˜æ•ˆçš„æ•°æ®åºåˆ—åŒ–å®ç°ï¼Œè¿™ä¹Ÿæ˜¯Kafkaé«˜æ•ˆè¿è¡Œçš„ä¸€å¤§æ”¯æ’‘ã€‚</p>
<p>åœ¨å¾ˆå¤šå…¶ä»–ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¹Ÿéœ€è¦æˆ‘ä»¬æä¾›æ›´é«˜æ•ˆçš„åºåˆ—åŒ–å®ç°</p>
<p>ä¾‹å¦‚ä½¿ç”¨MapReduceæ¡†æ¶æ—¶ï¼Œå°±éœ€è¦è‡ªè¡Œå®šä¹‰æ•°æ®çš„åºåˆ—åŒ–æ–¹å¼ã€‚ä½¿ç”¨Nettyæ¡†æ¶è¿›è¡Œç½‘ç»œè°ƒç”¨æ—¶ï¼Œä¸ºäº†é˜²æ­¢ç²˜åŒ…ï¼Œä¹Ÿéœ€è¦å®šåˆ¶æ•°æ®çš„åºåˆ—åŒ–æœºåˆ¶ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œè¿›è¡Œåºåˆ—åŒ–çš„åŸºç¡€æ€æƒ³ï¼Œå’Œæˆ‘ä»¬è¿™é‡Œä»‹ç»çš„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è®¾è®¡å‡ºæ›´ç®€çŸ­é«˜æ•ˆçš„æ•°æ®å‹ç¼©ç®—æ³•ï¼Œé‚£ä¹Ÿå°±èƒ½æ›´è¿›ä¸€æ­¥æé«˜æ•°æ®ä¼ è¾“çš„æ•ˆç‡ã€‚æ¯”å¦‚å¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œå‹ç¼©ã€‚è€Œè¿™å°±æ˜¯ç®—æ³•æœ€ç›´æ¥çš„ä½œç”¨</p>
</blockquote>
<h3>æ¶ˆæ¯åˆ†åŒºè·¯ç”±æœºåˆ¶</h3>
<p>æ¶ˆæ¯å¦‚ä½•è¿›è¡Œè·¯ç”±ï¼Œä¹Ÿå°±æ˜¯å‘é€çš„æ¶ˆæ¯åˆ°åº•æ˜¯æ ¹æ®ä»€ä¹ˆæ¥å­˜å‚¨åˆ°å¯¹åº”çš„Topicçš„æŒ‡å®šPartitionä¸‹çš„å‘¢</p>
<ul>
<li>å¯¹äº Producerï¼Œä¼šæ ¹æ®æ¶ˆæ¯çš„keyé€‰æ‹©Partitionï¼Œé‚£å…·ä½“å¦‚ä½•é€šè¿‡keyæ‰¾Partitionå‘¢ï¼Ÿ</li>
<li>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¼šå…±åŒæ¶ˆè´¹ä¸€ä¸ªTopicä¸‹çš„å¤šä¸ªPartitionä¸­çš„åŒä¸€å¥—æ¶ˆæ¯å‰¯æœ¬ï¼Œé‚£å…·ä½“åˆ°å¯¹åº”çš„ConsumerèŠ‚ç‚¹æ˜¯ä¸æ˜¯å¯ä»¥å†³å®šè‡ªå·±æ¶ˆè´¹å“ªäº›Partitionçš„æ¶ˆæ¯å‘¢ï¼Ÿ</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<p>è¿™ä¸¤ä¸ªé—®é¢˜ä¸éš¾ï¼ŒåŒæ ·çš„æ–¹æ³•ï¼Œä¾æ—§å»å¯¹åº”çš„Configç±»è¿›è¡ŒæŸ¥æ‰¾å³å¯</p>
<h4>Producer å‘é€æ¶ˆæ¯çš„è·¯ç”±æœºåˆ¶ <code>PARTITIONER_CLASS_CONFIG</code></h4>
<p>å½“ç»™å®šäº† <code>PARTITIONER_CLASS_CONFIG</code> çš„å±æ€§å°±å¯ä»¥è‡ªå®šä¹‰Producerçš„åˆ†åŒºæœºåˆ¶(å†³å®šå‘é€çš„æ¶ˆæ¯åˆ°å“ªä¸ªPartition)</p>
<p>å…·ä½“è¯´æ˜å¦‚ä¸‹</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PARTITIONER_CLASS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"partitioner.class"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PARTITIONER_CLASS_DOC</span> <span class="token operator">=</span> <span class="token string">"Determines which partition to send a record to when records are produced. Available options are: "</span> <span class="token operator">+</span> 
<span class="token string">"&lt;ul&gt;"</span> <span class="token operator">+</span> 
<span class="token string">"&lt;li&gt;If not set, the default partitioning logic is used. This strategy send records to a partition until at least batch.size bytes is produced to the partition."</span> <span class="token operator">+</span> 
<span class="token string">"It works with the strategy:"</span><span class="token operator">+</span>
<span class="token string">"&lt;ol&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;If no partition is specified but a key is present, choose a partition based on a hash of the key.&lt;/li&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;If no partition or key is present, choose the sticky partition that changes when at least batch.size bytes are produced to the partition.&lt;/li&gt;&lt;/ol&gt;&lt;/li&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;&lt;code&gt;org.apache.kafka.clients.producer.RoundRobinPartitioner&lt;/code&gt;:"</span> <span class="token operator">+</span>
<span class="token string">"A partitioning strategy where each record in a series of consecutive records is sent to a different partition, regardless of whether the 'key' is provided or not, until partitions run out and the process starts over again."</span><span class="token operator">+</span>
<span class="token string">"Note: There's a known issue that will cause uneven distribution when a new batch is created. See KAFKA-9965 for more detail."</span><span class="token operator">+</span>
<span class="token string">"&lt;/li&gt;&lt;/ul&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;p&gt;Implementing the &lt;code&gt;org.apache.kafka.clients.producer.Partitioner&lt;/code&gt; interface allows you to plug in a custom partitioner."</span><span class="token punctuation">;</span>
</code></pre></div><p>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å±æ€§ï¼Œé‚£ä¹ˆä¼šé‡‡ç”¨é»˜è®¤çš„åˆ†åŒºæœºåˆ¶</p>
<p>| <strong>åœºæ™¯</strong> | <strong>ç­–ç•¥åç§°</strong> | <strong>è¡Œä¸ºé€»è¾‘</strong> |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>Kafka - 3 å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶2</title>
      <link>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/3.html</link>
      <guid>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/3.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Kafka - 3 å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶2</source>
      <description>å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶2 ç”Ÿäº§è€…æ¶ˆæ¯ç¼“å­˜æœºåˆ¶ ç›®å‰å·²ç»åˆ†æäº†æ¶ˆè´¹è€…ç»„ã€æ¶ˆæ¯å‘é€å’Œæ¥å—æ—¶çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä»¥åŠå…·ä½“æ¶ˆæ¯å‘é€æ˜¯åˆ°å“ªä¸ªpartitionå’Œconsumeræ¥å—å“ªä¸ªpartitionçš„æ¶ˆæ¯ æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•å…·ä½“å‘é€æ¶ˆæ¯äº† â€‹Kafkaç”Ÿäº§è€…ä¸ºäº†é¿å…é«˜å¹¶å‘è¯·æ±‚å¯¹æœåŠ¡ç«¯é€ æˆè¿‡å¤§å‹åŠ›ï¼Œæ¯æ¬¡å‘æ¶ˆæ¯æ—¶å¹¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡å‘å¾€æœåŠ¡ç«¯ï¼Œè€Œæ˜¯å¢åŠ äº†ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œå°†æ¶ˆæ¯é›†ä¸­åˆ°...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:16:53 GMT</pubDate>
      <content:encoded><![CDATA[<h2>å®¢æˆ·ç«¯å·¥ä½œæœºåˆ¶2</h2>
<h3>ç”Ÿäº§è€…æ¶ˆæ¯ç¼“å­˜æœºåˆ¶</h3>
<p>ç›®å‰å·²ç»åˆ†æäº†æ¶ˆè´¹è€…ç»„ã€æ¶ˆæ¯å‘é€å’Œæ¥å—æ—¶çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä»¥åŠå…·ä½“æ¶ˆæ¯å‘é€æ˜¯åˆ°å“ªä¸ªpartitionå’Œconsumeræ¥å—å“ªä¸ªpartitionçš„æ¶ˆæ¯</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•å…·ä½“å‘é€æ¶ˆæ¯äº†</p>
<p>â€‹Kafkaç”Ÿäº§è€…ä¸ºäº†é¿å…é«˜å¹¶å‘è¯·æ±‚å¯¹æœåŠ¡ç«¯é€ æˆè¿‡å¤§å‹åŠ›ï¼Œæ¯æ¬¡å‘æ¶ˆæ¯æ—¶å¹¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡å‘å¾€æœåŠ¡ç«¯ï¼Œè€Œæ˜¯å¢åŠ äº†ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œå°†æ¶ˆæ¯é›†ä¸­åˆ°ç¼“å­˜åï¼Œæ‰¹é‡è¿›è¡Œå‘é€ã€‚è¿™ç§ç¼“å­˜æœºåˆ¶ä¹Ÿæ˜¯é«˜å¹¶å‘å¤„ç†æ—¶éå¸¸å¸¸ç”¨çš„ä¸€ç§æœºåˆ¶</p>
<p>Kafkaçš„æ¶ˆæ¯ç¼“å­˜æœºåˆ¶æ¶‰åŠåˆ°KafkaProducerä¸­çš„ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼š <code>accumulator</code> å’Œ <code>sender</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">//1.è®°å½•ç´¯åŠ å™¨</span>
<span class="token keyword">int</span> batchSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>accumulator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordAccumulator</span><span class="token punctuation">(</span>logContext<span class="token punctuation">,</span>batchSize<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>compressionType<span class="token punctuation">,</span><span class="token function">lingerMs</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>retryBackoffMs<span class="token punctuation">,</span>deliveryTimeoutMs<span class="token punctuation">,</span> partitionerConfig<span class="token punctuation">,</span>metrics<span class="token punctuation">,</span><span class="token constant">PRODUCER_METRIC_GROUP_NAME</span><span class="token punctuation">,</span>time<span class="token punctuation">,</span>apiVersions<span class="token punctuation">,</span>transactionManager<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">BufferPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalMemorySize<span class="token punctuation">,</span> batchSize<span class="token punctuation">,</span> metrics<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token constant">PRODUCER_METRIC_GROUP_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2. æ•°æ®å‘é€çº¿ç¨‹</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>sender <span class="token operator">=</span> <span class="token function">newSender</span><span class="token punctuation">(</span>logContext<span class="token punctuation">,</span> kafkaClient<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><figure><figcaption>alt text</figcaption></figure>
<h4><code>RecordAccumulator</code></h4>
<p>RecordAccumulatorï¼Œå°±æ˜¯Kafkaç”Ÿäº§è€…çš„æ¶ˆæ¯ç´¯åŠ å™¨</p>
<p>KafkaProducerè¦å‘é€çš„æ¶ˆæ¯éƒ½ä¼šåœ¨<code>ReocrdAccumulator</code>ä¸­ç¼“å­˜èµ·æ¥ï¼Œç„¶åå†åˆ†æ‰¹å‘é€ç»™kafka broker</p>
<p>åœ¨æˆ‘ä»¬è°ƒç”¨ Producer çš„ <code>send</code> æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆå°±ä¼šè°ƒç”¨å°†æˆ‘ä»¬çš„ <code>Record</code> å­˜åˆ°ç´¯åŠ å™¨é‡Œ</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>RecordAppendResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> appendCallbacks<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">,</span> abortOnNewBatch<span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆåŠŸå­˜å®Œä¹‹åï¼Œå†ä¼šå»å°è¯•å”¤é†’ sender æ¥å®ç°æ¶ˆæ¯å‘é€</p>
<p>åœ¨<code>RecordAccumulator</code>ä¸­ï¼Œå…¶æ¯ä¸€ä¸ªDequeåŒç«¯é˜Ÿåˆ—å¯¹åº”çš„æ˜¯å…·ä½“ä¸€ä¸ªTopicä¸‹çš„ä¸€ä¸ªPartition</p>
<p>è¿™äº›Dequeueé˜Ÿåˆ—åŸºæœ¬ä¸Šæ˜¯å’ŒKafkaæœåŠ¡ç«¯çš„Topicä¸‹çš„Partitionå¯¹åº”çš„</p>
<p>æ¯ä¸ªDequeueé‡Œä¼šæ”¾å…¥è‹¥å¹²ä¸ªProducerBatchæ•°æ®</p>
<p>KafkaProduceræ¯æ¬¡å‘é€çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šæ ¹æ®keyåˆ†é…åˆ°å¯¹åº”çš„Dequeé˜Ÿåˆ—ä¸­, ç„¶åæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šä¿å­˜åœ¨è¿™äº›é˜Ÿåˆ—ä¸­çš„æŸä¸€ä¸ªProducerBatchä¸­</p>
<p>è€Œæ¶ˆæ¯åˆ†å‘çš„è§„åˆ™ï¼Œå°±æ˜¯ç”±ä¸Šé¢çš„Partitionerç»„ä»¶å®Œæˆçš„, æ¥é€‰æ‹©æŠŠè¿™ä¸ªæ¶ˆæ¯å‘åˆ°å“ªä¸ªPartitionï¼Œå³å†…éƒ¨æ˜¯å­˜åˆ°å“ªä¸ª Dequeue é‡Œé¢</p>
<h5>ä¸»è¦å‚æ•° <code>BUFFER_MEMORY_CONFIG</code> + <code>BATCH_SIZE_CONFIG</code></h5>
<p>å¯¹äº <code>RecordAccumulator</code> ä¸»è¦æ¶‰åŠä¸¤ä¸ªå‚æ•°</p>
<ul>
<li><code>BUFFER_MEMORY_CONFIG</code>ï¼šå°±æ˜¯è¿™ä¸ªç´¯åŠ å™¨ç¼“å†²åŒºçš„æ€»å¤§å°</li>
<li><code>BATCH_SIZE_CONFIG</code>ï¼šç¼“å†²åŒºæ¯ä¸€ä¸ªbatchçš„å¤§å°ï¼Œä½œä¸ºå‘é€çš„æœ€å°å•ä½ (é»˜è®¤ 16K)</li>
</ul>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">//RecordAccumulatorç¼“å†²åŒºå¤§å°</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BUFFER_MEMORY_CONFIG</span> <span class="token operator">=</span> <span class="token string">"buffer.memory"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BUFFER_MEMORY_DOC</span> <span class="token operator">=</span> <span class="token string">"The total bytes of memory the producer can use to buffer records waiting to be sent to the server."</span> <span class="token operator">+</span> 
<span class="token string">"If records are sent faster than they can be delivered to the server the producer will block for &lt;code&gt;max.block.ms&lt;/code&gt; after which it will throw an exception."</span> <span class="token operator">+</span> 
<span class="token string">"&lt;p&gt;This setting should correspond roughly to the total memory the producer will use, but is not a hard bound since not all memory the producer uses is used for buffering."</span> <span class="token operator">+</span> 
<span class="token string">"Some additional memory will be used for compression (if compression is enabled) as well as for maintaining in-flight requests."</span><span class="token punctuation">;</span>


<span class="token comment">//ç¼“å†²åŒºæ¯ä¸€ä¸ªbatchçš„å¤§å°</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BATCH_SIZE_CONFIG</span> <span class="token operator">=</span> <span class="token string">"batch.size"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BATCH_SIZE_DOC</span> <span class="token operator">=</span> <span class="token string">"The producer will attempt to batch records together into fewer requests whenever multiple records are being sent to the same partition."</span><span class="token operator">+</span>
<span class="token string">"This helps performance on both the client and the server. This configuration controls the default batch size in bytes."</span> <span class="token operator">+</span> 
<span class="token string">"&lt;p&gt;No attempt will be made to batch records larger than this size."</span><span class="token operator">+</span>
<span class="token string">"&lt;p&gt;Requests sent to brokers will contain multiple batches, one for each partition with data available to be sent.&lt;p&gt;"</span><span class="token operator">+</span>
<span class="token string">"A small batch size will make batching less common and may reduce throughput (a batch size of zero will disable batching entirely)."</span><span class="token operator">+</span>
<span class="token string">"A very large batch size may use memory a bit more wastefully as we will always allocate a buffer of the specified batch size in anticipation of additional records."</span><span class="token operator">+</span>
<span class="token string">"&lt;p&gt;Note: This setting gives the upper bound of the batch size to be sent."</span><span class="token operator">+</span>
<span class="token string">"If we have fewer than this many bytes accumulated for this partition, we will 'linger' for the &lt;code&gt;linger.ms&lt;/code&gt; time waiting for more records to show up."</span><span class="token operator">+</span>
<span class="token string">"This &lt;code&gt;linger.ms&lt;/code&gt; setting defaults to 0, which means we'll immediately send out a record even the accumulated batch size is under this &lt;code&gt;batch.size&lt;/code&gt; setting."</span><span class="token punctuation">;</span>
</code></pre></div><h4><code>Sender</code></h4>
<figure><figcaption>alt text</figcaption></figure>
<p>senderå°±æ˜¯KafkaProducerä¸­ç”¨æ¥å‘é€æ¶ˆæ¯çš„ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹</p>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªKafkaProducerå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªsenderçº¿ç¨‹</p>
<p>ä»–ä¼šè´Ÿè´£å°†RecordAccumulatorä¸­çš„æ¶ˆæ¯å‘é€ç»™Kafka</p>
<p>Senderä¹Ÿå¹¶ä¸æ˜¯ä¸€æ¬¡å°±æŠŠRecordAccumulatorä¸­ç¼“å­˜çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å‘é€å‡ºå»ï¼Œè€Œæ˜¯æ¯æ¬¡åªæ‹¿ä¸€éƒ¨åˆ†æ¶ˆæ¯</p>
<p>ä»–åªè·å–<code>RecordAccumulator</code>ä¸­ç¼“å­˜å†…å®¹è¾¾åˆ°<code>BATCH_SIZE_CONFIG</code>å¤§å°çš„<code>ProducerBatch</code>æ¶ˆæ¯</p>
<p>å½“ç„¶ï¼Œå¦‚æœæ¶ˆæ¯æ¯”è¾ƒå°‘ï¼Œ<code>ProducerBatch</code>ä¸­çš„æ¶ˆæ¯å¤§å°é•¿æœŸè¾¾ä¸åˆ°<code>BATCH_SIZE_CONFIG</code>çš„è¯ï¼ŒSenderä¹Ÿä¸ä¼šä¸€ç›´ç­‰å¾…ï¼Œæœ€å¤šç­‰å¾…<code>LINGER_MS_CONFIG</code>æ—¶é•¿ï¼Œç„¶åå°±ä¼šå°†<code>ProducerBatch</code>ä¸­çš„æ¶ˆæ¯è¯»å–å‡ºæ¥</p>
<p><code>LINGER_MS_CONFIG</code>é»˜è®¤å€¼æ˜¯0ï¼Œè¿™æ„å‘³ç€ Sender é»˜è®¤æ˜¯ä¸ä¼šç­‰å¾…çš„</p>
<p>â€‹ç„¶åï¼ŒSenderå¯¹è¯»å–å‡ºæ¥çš„æ¶ˆæ¯ï¼Œä¼šä»¥Brokerä¸ºkeyï¼Œç¼“å­˜åˆ°ä¸€ä¸ªå¯¹åº”çš„é˜Ÿåˆ—å½“ä¸­ (<code>InflightBatches</code>)</p>
<p>è¿™äº›é˜Ÿåˆ—å½“ä¸­çš„æ¶ˆæ¯å°±ç§°ä¸º<code>InflightRequest</code></p>
<p>æ¥ä¸‹æ¥è¿™äº›<code>Inflight</code>å°±ä¼šä¸€ä¸€å‘å¾€Kafkaå¯¹åº”çš„Brokerä¸­ï¼Œç›´åˆ°æ”¶åˆ°Brokerçš„å“åº”ï¼Œæ‰ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤</p>
<p>è¿™äº›é˜Ÿåˆ—ä¹Ÿå¹¶ä¸ä¼šæ— é™ç¼“å­˜ï¼Œæœ€å¤šç¼“å­˜<code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</code>(é»˜è®¤å€¼ä¸º5)ä¸ªè¯·æ±‚</p>
<p>å³æ¯æ¬¡ ç´¯åŠ å™¨å”¤é†’senderæ—¶ï¼Œå®ƒå°±ä¼šæ ¹æ®å¯¹åº”çš„è®¾ç½®<code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</code> é»˜è®¤ä»ç´¯åŠ å™¨ä¸­æœ€å¤šæ‹‰å–5æ¡æ¶ˆæ¯æ”¾åˆ° <code>InflightBatches</code>ä¸­ï¼Œç„¶åå»å‘ç»™kafkaçš„Broker</p>
<p>ç„¶åå‘é€è¿‡å»ä¸ä¼šç«‹åˆ»åˆå‘ï¼Œä¼šç­‰å¾… Broker è¿”å›å“åº”ç¡®è®¤æ¶ˆæ¯å·²ç»æˆåŠŸå‘é€äº† (ackåº”ç­”)</p>
<blockquote>
<p>ç”Ÿäº§è€…ç¼“å­˜æœºåˆ¶çš„ä¸»è¦ç›®çš„æ˜¯å°†æ¶ˆæ¯æ‰“åŒ…ï¼Œå‡å°‘ç½‘ç»œIOé¢‘ç‡ã€‚æ‰€ä»¥ï¼Œåœ¨Senderçš„InflightRequesté˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯ä¹Ÿä¸æ˜¯ä¸€æ¡ä¸€æ¡å‘é€ç»™Brokerçš„ï¼Œè€Œæ˜¯ä¸€æ‰¹æ¶ˆæ¯ä¸€èµ·å¾€Brokerå‘é€ã€‚è€Œè¿™å°±æ„å‘³ç€è¿™ä¸€æ‰¹æ¶ˆæ¯æ˜¯æ²¡æœ‰å›ºå®šçš„å…ˆåé¡ºåºçš„ã€‚</p>
</blockquote>
<h5>sender ä»€ä¹ˆæ—¶å€™å» Deque æ‹‰å–æ¶ˆæ¯</h5>
<p>å½“ä¸€ä¸ª<code>Dequeue</code>ä¸­æ¶ˆæ¯å®¹é‡è¶…è¿‡äº†è®¾å®šçš„ <code>BATCH_SIZE_CONFIG</code>ï¼Œé‚£ä¹ˆå°±ä¼šå”¤é†’senderï¼Œå«ä»–æ¥æ”¶ä¿¡æ¯å»å‘é€</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">//org.apache.kafka.clients.producer.KafkaProducer#doSend</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Waking up the sender since topic {} partition {} is either full or getting a new batch"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appendCallbacks<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ–è€…ç­‰å¾…æ—¶é—´è¶…è¿‡äº† <code>LINGER_MS_CONFIG</code>ï¼Œé‚£ä¹ˆ sender ä¹Ÿä¼šè‡ªåŠ¨å»æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯</p>
<h5>ä¸»è¦å‚æ•° <code>LINGER_MS_CONFIG</code> + <code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</code></h5>
<ul>
<li><code>LINGER_MS_CONFIG</code>ï¼šé»˜è®¤0ï¼Œæ„æ€é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šç­‰ä½ è£…æ»¡ï¼Œè€Œæ˜¯ä¸€ç›´ä¼šå°è¯•æ‹‰å–æ¶ˆæ¯å»å‘é€</li>
<li><code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</code>ï¼šé»˜è®¤æ˜¯5ï¼Œ</li>
</ul>
<p>è¿™ä¸¤ä¸ªè¢«æ ‡è®° <code>@Deprecated</code>, ä¸ºäº†ç¡®ä¿å¹‚ç­‰æ€§ï¼Œ<code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</code> å¿…é¡»å°äº5</p>
<p>Kafka ç¤¾åŒºå¸Œæœ›ç”¨æˆ· åªå…³æ³¨â€œå¼€å¯å¹‚ç­‰æ€§â€è¿™ä¸€é«˜å±‚æ„å›¾ï¼Œè€Œä¸å¿…å»å¾®è°ƒåº•å±‚çš„ max.in.flight å‚æ•°</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LINGER_MS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"linger.ms"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LINGER_MS_DOC</span> <span class="token operator">=</span> <span class="token string">"The producer groups together any records that arrive in between request transmissions into a single batched request. Normally this occurs only under load when records arrive faster than they can be sent out. However in some circumstances the client may want to reduce the number of requests even under moderate load. This setting accomplishes this by adding a small amount of artificial delay&amp;mdash;that is, rather than immediately sending out a record, the producer will wait for up to the given delay to allow other records to be sent so that the sends can be batched together. This can be thought of as analogous to Nagle's algorithm in TCP. This setting gives the upper bound on the delay for batching: once we get &lt;code&gt;batch.size&lt;/code&gt; worth of records for a partition it will be sent immediately regardless of this setting, however if we have fewer than this many bytes accumulated for this partition we will 'linger' for the specified time waiting for more records to show up. This setting defaults to 0 (i.e. no delay). Setting &lt;code&gt;linger.ms=5&lt;/code&gt;, for example, would have the effect of reducing the number of requests sent but would add up to 5ms of latency to records sent in the absence of load."</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION_FOR_IDEMPOTENCE</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION</span> <span class="token operator">=</span> <span class="token string">"max.in.flight.requests.per.connection"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION_DOC</span> <span class="token operator">=</span> <span class="token string">"The maximum number of unacknowledged requests the client will send on a single connection before blocking."</span><span class="token operator">+</span>
<span class="token string">"Note that if this configuration is set to be greater than 1 and &lt;code&gt;enable.idempotence&lt;/code&gt; is set to false, there is a risk of message reordering after a failed send due to retries (i.e., if retries are enabled);"</span><span class="token operator">+</span>
<span class="token string">"if retries are disabled or if &lt;code&gt;enable.idempotence&lt;/code&gt; is set to true, ordering will be preserved."</span><span class="token operator">+</span>
<span class="token string">"Additionally, enabling idempotence requires the value of this configuration to be less than or equal to 5."</span><span class="token operator">+</span>
<span class="token string">"If conflicting configurations are set and idempotence is not explicitly enabled, idempotence is disabled. "</span><span class="token punctuation">;</span>
</code></pre></div><p>æœ€åï¼ŒSenderä¼šé€šè¿‡å…¶ä¸­çš„ä¸€ä¸ªSelectorç»„ä»¶å®Œæˆä¸Kafkaçš„IOè¯·æ±‚ï¼Œå¹¶æ¥æ”¶Kafkaçš„å“åº”, æˆåŠŸæ‹¿åˆ°ACKå“åº”åï¼Œæ‰ä¼šæŠŠå¯¹åº”çš„æ¶ˆæ¯ç§»é™¤æ‰</p>
<p>Kafkaçš„ç”Ÿäº§è€…ç¼“å­˜æœºåˆ¶æ˜¯Kafkaé¢å¯¹æµ·é‡æ¶ˆæ¯æ—¶éå¸¸é‡è¦çš„ä¼˜åŒ–æœºåˆ¶</p>
<p>åˆç†ä¼˜åŒ–è¿™äº›å‚æ•°ï¼Œå¯¹äºKafkaé›†ç¾¤æ€§èƒ½æå‡æ˜¯éå¸¸é‡è¦çš„</p>
<p>æ¯”å¦‚å¦‚æœä½ çš„æ¶ˆæ¯ä½“æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆåº”è¯¥è€ƒè™‘åŠ å¤§batch.sizeï¼Œå°½é‡æå‡batchçš„ç¼“å­˜æ•ˆç‡</p>
<p>è€Œå¦‚æœProducerè¦å‘é€çš„æ¶ˆæ¯ç¡®å®éå¸¸å¤šï¼Œé‚£ä¹ˆå°±éœ€è¦è€ƒè™‘åŠ å¤§total.memoryå‚æ•°ï¼Œå°½é‡é¿å…ç¼“å­˜ä¸å¤Ÿé€ æˆçš„é˜»å¡</p>
<p>å¦‚æœå‘ç°ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ¯”è¾ƒæ…¢ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘æå‡<code>max.in.flight.requests.per.connection</code>å‚æ•°ï¼Œè¿™æ ·èƒ½åŠ å¤§æ¶ˆæ¯å‘é€çš„ååé‡</p>
<h3>å‘é€åº”ç­”æœºåˆ¶</h3>
<p>åœ¨Producerå°†æ¶ˆæ¯å‘é€åˆ°Brokeråï¼Œè¦æ€ä¹ˆç¡®å®šæ¶ˆæ¯æ˜¯ä¸æ˜¯æˆåŠŸå‘åˆ°Brokerä¸Šäº†å‘¢ï¼Ÿ</p>
<p>â€‹è¿™æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæœºåˆ¶ï¼Œä¹Ÿæ˜¯é¢è¯•è¿‡ç¨‹ä¸­æœ€å–œæ¬¢é—®çš„ä¸€ä¸ªæœºåˆ¶</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°çš„ï¼Œå°±æ˜¯åœ¨Producerç«¯ä¸€ä¸ªä¸å¤ªèµ·çœ¼çš„å±æ€§<code>ACKS_CONFIG</code></p>
<p>è¿™è¯´æ˜åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æˆåŠŸæ¥æ”¶ï¼Œè¿™ä¸ªè®¾ç½®æ˜¯ç”±æˆ‘ä»¬å®¢æˆ·ç«¯å†³å®šçš„ï¼Œç„¶åè¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯ç”±æœåŠ¡ç«¯kafkaå†³å®šçš„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ACKS_CONFIG</span> <span class="token operator">=</span> <span class="token string">"acks"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ACKS_DOC</span> <span class="token operator">=</span> <span class="token string">"The number of acknowledgments the producer requires the leader to have received before considering a request complete."</span><span class="token operator">+</span>
<span class="token string">"This controls the  durability of records that are sent. The following settings are allowed:"</span><span class="token operator">+</span>
<span class="token string">"&lt;ul&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;&lt;code&gt;acks=0&lt;/code&gt; If set to zero then the producer will not wait for any acknowledgment from the server at all."</span><span class="token operator">+</span>
<span class="token string">"The record will be immediately added to the socket buffer and considered sent."</span><span class="token operator">+</span>
<span class="token string">"No guarantee can be made that the server has received the record in this case,"</span><span class="token operator">+</span>
<span class="token string">"and the &lt;code&gt;retries&lt;/code&gt; configuration will not take effect (as the client won't generally know of any failures)."</span><span class="token operator">+</span>
<span class="token string">"The offset given back for each record will always be set to &lt;code&gt;-1&lt;/code&gt;."</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;&lt;code&gt;acks=1&lt;/code&gt; This will mean the leader will write the record to its local log but will respond without awaiting full acknowledgement from all followers."</span><span class="token operator">+</span>
<span class="token string">"In this case should the leader fail immediately after acknowledging the record but before the followers have replicated it then the record will be lost."</span><span class="token operator">+</span>
<span class="token string">"&lt;li&gt;&lt;code&gt;acks=all&lt;/code&gt; This means the leader will wait for the full set of in-sync replicas to acknowledge the record."</span><span class="token operator">+</span>
<span class="token string">"This guarantees that the record will not be lost as long as at least one in-sync replica remains alive."</span><span class="token operator">+</span>
<span class="token string">"This is the strongest available guarantee. This is equivalent to the acks=-1 setting.&lt;/ul&gt;"</span><span class="token operator">+</span>
<span class="token string">"&lt;p&gt;Note that enabling idempotence requires this config value to be 'all'."</span><span class="token operator">+</span>
<span class="token string">"If conflicting configurations are set and idempotence is not explicitly enabled, idempotence is disabled."</span><span class="token punctuation">;</span>
</code></pre></div><p>â€‹å®˜æ–¹ç»™å‡ºçš„è¿™æ®µè§£é‡Šï¼ŒåŒæ ·æ¯”ä»»ä½•å¤–éƒ¨çš„èµ„æ–™éƒ½è¦å‡†ç¡®è¯¦ç»†äº†</p>
<p>å¦‚æœä½ ç†è§£äº†Topicçš„åˆ†åŒºæ¨¡å‹ï¼Œè¿™ä¸ªå±æ€§å°±éå¸¸å®¹æ˜“ç†è§£äº†</p>
<p>è¿™ä¸ªå±æ€§æ›´å¤§çš„ä½œç”¨åœ¨äºä¿è¯æ¶ˆæ¯çš„å®‰å…¨æ€§ï¼Œå°¤å…¶åœ¨<code>replica-factor</code>å¤‡ä»½å› å­æ¯”è¾ƒå¤§çš„Topicä¸­ï¼Œå°¤ä¸ºé‡è¦</p>
<ul>
<li><code>acks=0</code>ï¼Œç”Ÿäº§è€…ä¸å…³å¿ƒBrokerç«¯æœ‰æ²¡æœ‰å°†æ¶ˆæ¯å†™å…¥åˆ°Partitionï¼Œåªå‘é€æ¶ˆæ¯å°±ä¸ç®¡äº†ã€‚ååé‡æ˜¯æœ€é«˜çš„ï¼Œä½†æ˜¯æ•°æ®å®‰å…¨æ€§æ˜¯æœ€ä½çš„</li>
<li><code>acks=1</code>ï¼Œåˆ™æ˜¯ä¸€ç§ç›¸å¯¹ä¸­å’Œçš„ç­–ç•¥ã€‚Leader Partitionåœ¨å®Œæˆè‡ªå·±çš„æ¶ˆæ¯å†™å…¥åï¼Œå°±å‘ç”Ÿäº§è€…è¿”å›ç»“æœ</li>
<li><code>acks=all or -1</code>ï¼Œç”Ÿäº§è€…éœ€è¦ç­‰Brokerç«¯çš„æ‰€æœ‰Partiton(Leader Partitionä»¥åŠå…¶å¯¹åº”çš„Follower Partition)éƒ½å†™å®Œäº†æ‰èƒ½å¾—åˆ°è¿”å›ç»“æœï¼Œè¿™æ ·æ•°æ®æ˜¯æœ€å®‰å…¨çš„ï¼Œä½†æ˜¯æ¯æ¬¡å‘æ¶ˆæ¯éœ€è¦ç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œååé‡æ˜¯æœ€ä½çš„ã€‚</li>
</ul>
<blockquote>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œacks=0å¯é æ€§å¤ªå·®ï¼Œå¾ˆå°‘ä½¿ç”¨ã€‚acks=1ï¼Œä¸€èˆ¬ç”¨äºä¼ è¾“æ—¥å¿—ç­‰ï¼Œå…è®¸ä¸ªåˆ«æ•°æ®ä¸¢å¤±çš„åœºæ™¯ã€‚ä½¿ç”¨èŒƒå›´æœ€å¹¿ã€‚acks=-1ï¼Œä¸€èˆ¬ç”¨äºä¼ è¾“æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚ä¸é’±ç›¸å…³çš„æ•°æ®</p>
</blockquote>
<h4><code>ack=1 or -1</code></h4>
<p>â€‹å¦‚æœackè®¾ç½®ä¸ºallæˆ–è€…-1ï¼ŒKafkaä¹Ÿå¹¶ä¸æ˜¯å¼ºåˆ¶è¦æ±‚æ‰€æœ‰Partitionéƒ½å†™å…¥æ•°æ®åæ‰å“åº”</p>
<p>å®é™…ä¸Šé»˜è®¤Brokeråªè¦æˆåŠŸåŒæ­¥ä¸€ä¸ªFollowerï¼Œå°±ä¼šå‘æœåŠ¡ç«¯è¿”å›å“åº” (å»ºè®®è®¾ç½®ä¸ºå‰¯æœ¬æ•°çš„ä¸€åŠ)</p>
<p>åœ¨Kafkaçš„BrokeræœåŠ¡ç«¯ä¼šæœ‰ä¸€ä¸ªé…ç½®å‚æ•°<code>min.insync.replicas</code>ï¼Œæ§åˆ¶Leader Partitionåœ¨å®Œæˆå¤šå°‘ä¸ªPartitionçš„æ¶ˆæ¯å†™å…¥åï¼Œå¾€Producerè¿”å›å“åº”</p>
<p>è¿™ä¸ªå‚æ•°å¯ä»¥åœ¨broker.confæ–‡ä»¶ä¸­è¿›è¡Œé…ç½®</p>
<div class="language-conf" data-ext="conf" data-title="conf"><pre class="language-conf"><code>min.insync.replicas
When a producer sets acks to "all" (or "-1"), min.insync.replicas specifies the minimum number of replicas that must acknowledge a write for the write to be considered successful. If this minimum cannot be met, then the producer will raise an exception (either NotEnoughReplicas or NotEnoughReplicasAfterAppend).
When used together, min.insync.replicas and acks allow you to enforce greater durability guarantees. A typical scenario would be to create a topic with a replication factor of 3, set min.insync.replicas to 2, and produce with acks of "all". This will ensure that the producer raises an exception if a majority of replicas do not receive a write.

Type: int
Default: 1
Valid Values: [1,...]
Importance: high
Update Mode: cluster-wide
</code></pre></div><p>å…³äºæ¶ˆæ¯åº”ç­”æœºåˆ¶ï¼Œæœ€åå¼ºè°ƒä¸€ç‚¹ï¼šacksè®¾ç½®æˆallæˆ–è€…-1ï¼Œèƒ½å¤Ÿæœ‰æ•ˆæé«˜æ¶ˆæ¯çš„å®‰å…¨æ€§ã€‚ä½†æ˜¯ä»æ¶ˆæ¯å®‰å…¨æ€§æ–¹é¢è€ƒè™‘ï¼Œåº”ç­”æœºåˆ¶åªæ˜¯ä¿è¯Brokerå¯ä»¥ç»™Producerä¸€ä¸ªæ¯”è¾ƒé è°±çš„å“åº”ï¼Œä½†å¹¶ä¸ä»£è¡¨å°±ä¿è¯äº†æ¶ˆæ¯ä¸ä¸¢å¤±</p>
<p>å³è®¾ç½®äº† ACK æœºåˆ¶ç›®çš„åªæ˜¯æ¥è®©æœåŠ¡ç«¯çŸ¥é“è¿™ä¸ªæ¶ˆæ¯æ˜¯ä¼ é€’æˆåŠŸäº†è¿˜æ˜¯å¤±è´¥äº†ï¼Œç„¶åæ ¹æ®åç»­ç»“æœæ¥è‡ªå·±å†³å®šè¯¥æ€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µ</p>
<p><code>Producer</code>æ‹¿åˆ°å“åº”åå¦‚ä½•è¿›è¡Œåç»­å¤„ç†ï¼ŒKafkaæ˜¯ä¸å‚ä¸çš„ã€‚</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RecordMetadata</span> recordMetadata <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>é€šè¿‡ACKsæœºåˆ¶ï¼Œå¯ä»¥ä¿è¯æ‹¿åˆ°è¿™ä¸ª <code>RecordMetadata</code> è¿™ä¸ªå“åº”ç»“æœæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œè€Œä¹‹åæ€ä¹ˆå¤„ç†æœåŠ¡ç«¯æ˜¯ä¸ç®¡çš„</p>
<h4>å¹‚ç­‰æ€§è¦æ±‚</h4>
<p>acksæœºåˆ¶çš„é…ç½®ä¸å…‰å½±å“åˆ°å®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™æ”¶åˆ°ç›¸åº”ï¼ŒåŒæ—¶åœ¨æœåŠ¡ç«¯è¿˜å½±å“åˆ°æ¶ˆæ¯å¹‚ç­‰æ€§æœºåˆ¶(idempotence)</p>
<p>(å¹‚ç­‰æ€§)å½“æˆ‘æ¶ˆæ¯å‘è¿‡å»äº†ï¼ŒæˆåŠŸäº†æœåŠ¡ç«¯å°±åº”è¯¥åªè®°å½•ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¹Ÿåªæœ‰ä¸€æ¡ä¿¡æ¯</p>
<p>ç½‘ç»œæ˜¯ä¸é è°±çš„ï¼Œå¦‚æœç”Ÿäº§è€…å‘é€äº†ä¸€æ¡ä¿¡æ¯ï¼ŒæˆåŠŸä¼ ç»™äº†brokerï¼Œå¯¹åº”æœåŠ¡ç«¯ä¹Ÿä¿å­˜äº†ï¼Œä½†æ˜¯åœ¨å‘é€ ack è¯·æ±‚çš„æ—¶å€™ä¸¢äº†ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ç­‰ä¸åˆ°æ¶ˆæ¯å°±é»˜è®¤å‘é€å¤±è´¥äº†ï¼Œé‚£åˆä¼šé‡æ–°å‘é€ï¼Œè¿™å°±å¯¼è‡´æœ¬æ¥å­˜è¿‡ä¸€æ¬¡çš„æ¶ˆæ¯åˆå­˜äº†ä¸€éï¼Œè¿™å°±éœ€è¦ç¡®ä¿å¹‚ç­‰æ€§</p>
<p>é‚£ä¹ˆæœåŠ¡ç«¯å°±éœ€è¦å¤„ç†è¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œä»è€Œå¯ä»¥ä¿è¯æ¶ˆæ¯çš„å¹‚ç­‰æ€§</p>
<h3>ç”Ÿäº§è€…æ¶ˆæ¯å¹‚ç­‰æ€§</h3>
<p>æºç ä¸­å¯¹äºackså±æ€§çš„è¯´æ˜ï¼Œä¼šçœ‹åˆ°å¦å¤–ä¸€ä¸ªå•è¯ï¼Œidempotence è¿™ä¸ªå•è¯çš„æ„æ€å°±æ˜¯å¹‚ç­‰æ€§</p>
<h4>å¹‚ç­‰æ€§é—®é¢˜</h4>
<p>ä¹‹å‰åˆ†æè¿‡ï¼Œå½“Producerçš„acksè®¾ç½®æˆ1æˆ–-1æ—¶ï¼ŒProduceræ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½æ˜¯éœ€è¦è·å–Brokerç«¯è¿”å›çš„RecordMetadataçš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­å°±éœ€è¦ä¸¤æ¬¡è·¨ç½‘ç»œè¯·æ±‚</p>
<figure><figcaption>alt text</figcaption></figure>
<p>å¦‚æœè¦ä¿è¯æ¶ˆæ¯å®‰å…¨ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸¤æ¬¡ç½‘ç»œè¯·æ±‚å°±å¿…é¡»è¦æ±‚æ˜¯å¹‚ç­‰çš„</p>
<p>ä½†æ˜¯ï¼Œç½‘ç»œæ˜¯ä¸é è°±çš„ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¾€å¾€æ²¡åŠæ³•ä¿è¯è¿™ä¸¤ä¸ªè¯·æ±‚æ˜¯å¹‚ç­‰çš„</p>
<p>Producerå‘é€æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç¬¬ä¸€æ­¥è¯·æ±‚æˆåŠŸäº†ï¼Œä½†æ˜¯ç¬¬äºŒæ­¥å´æ²¡æœ‰è¿”å›ï¼Œè¿™æ—¶ï¼ŒProducerå°±ä¼šè®¤ä¸ºæ¶ˆæ¯å‘é€å¤±è´¥äº†ï¼Œé‚£ä¹ˆProducerå¿…ç„¶ä¼šå‘èµ·é‡è¯•</p>
<p>é‡è¯•æ¬¡æ•°ç”±å‚æ•°<code>ProducerConfig.RETRIES_CONFIG</code>ï¼Œé»˜è®¤å€¼æ˜¯<code>Integer.MAX</code></p>
<p>è¿™æ—¶é—®é¢˜å°±æ¥äº†, Producerä¼šé‡å¤å‘é€å¤šæ¡æ¶ˆæ¯åˆ°Brokerä¸­, Kafkaå¦‚ä½•ä¿è¯æ— è®ºProducerå‘Brokerå‘é€å¤šå°‘æ¬¡é‡å¤çš„æ•°æ®ï¼ŒBrokerç«¯éƒ½åªä¿ç•™ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸ä¼šé‡å¤ä¿å­˜å¤šæ¡æ¶ˆæ¯å‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯Kafkaæ¶ˆæ¯ç”Ÿäº§è€…çš„å¹‚ç­‰æ€§é—®é¢˜</p>
<h5>åˆ†å¸ƒå¼æ•°æ®ä¼ é€’ä¸‰ä¸ªæ•°æ®è¯­ä¹‰</h5>
<ul>
<li><code>at-least-once</code>: è‡³å°‘ä¸€æ¬¡</li>
<li><code>at-most-once</code>: æœ€å¤šä¸€æ¬¡</li>
<li><code>exactly-once</code>: ç²¾ç¡®ä¸€æ¬¡</li>
</ul>
<p>æ¯”å¦‚ï¼Œä½ å¾€é“¶è¡Œå­˜100å—é’±ï¼Œè¿™æ—¶é“¶è¡Œå¾€å¾€éœ€è¦å°†å­˜é’±åŠ¨ä½œè½¬åŒ–æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘åˆ°MQï¼Œç„¶åé€šè¿‡MQé€šçŸ¥å¦å¤–çš„ç³»ç»Ÿå»å®Œæˆä¿®æ”¹ä½ çš„è´¦æˆ·ä½™é¢ä»¥åŠå…¶ä»–ä¸€äº›å…¶ä»–çš„ä¸šåŠ¡åŠ¨ä½œ</p>
<p>è€Œè¿™ä¸ªMQæ¶ˆæ¯çš„å®‰å…¨æ€§ï¼Œå¾€å¾€æ˜¯éœ€è¦åˆ†å±‚æ¬¡æ¥è®¾è®¡çš„</p>
<p>é¦–å…ˆï¼Œä½ è¦ä¿è¯å­˜é’±çš„æ¶ˆæ¯èƒ½å¤Ÿä¸€å®šå‘é€åˆ°MQ, å¦‚æœä¸€æ¬¡å‘é€å¤±è´¥äº†ï¼Œé‚£å°±é‡è¯•å‡ æ¬¡ï¼Œåªåˆ°æˆåŠŸä¸ºæ­¢, è¿™å°±æ˜¯ <strong>at-least-once</strong> è‡³å°‘ä¸€æ¬¡, å¦‚æœä¿è¯ä¸äº†è¿™ä¸ªè¯­ä¹‰ï¼Œé‚£ä¹ˆä½ è‚¯å®šä¸ä¼šæ¥å—</p>
<p>ç„¶åï¼Œä½ å¾€é“¶è¡Œå­˜100å—ï¼Œä¸ç®¡è¿™ä¸ªæ¶ˆæ¯ä½ å‘é€äº†å¤šå°‘æ¬¡ï¼Œé“¶è¡Œæœ€å¤šåªèƒ½è®°å½•ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯100å—å­˜æ¬¾ï¼Œå¯ä»¥å°‘ï¼Œä½†å†³ä¸èƒ½å¤š, è¿™å°±æ˜¯ <strong>at-most-once</strong> æœ€å¤šä¸€æ¬¡</p>
<p>æœ€åï¼Œè¿™ä¸ªä¸šåŠ¡åŠ¨ä½œè¦è®©åŒæ–¹éƒ½æ»¡æ„ï¼Œå°±å¿…é¡»ä¿è¯å­˜é’±è¿™ä¸ªæ¶ˆæ¯æ­£æ­£å¥½å¥½è¢«è®°å½•ä¸€æ¬¡ï¼Œä¸å¤šä¹Ÿä¸å°‘, è¿™å°±æ˜¯ <strong>Exactly-once</strong> è¯­ä¹‰</p>
<p>æ‰€ä»¥ï¼Œé€šå¸¸æ„ä¹‰ä¸Šï¼Œ<strong>at-least-once</strong> å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸é‡å¤</p>
<p>è€Œ <strong>at-most-once</strong> ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œä½†æ˜¯åˆä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±</p>
<p>è¿™ä¸¤ç§è¯­ä¹‰è™½ç„¶éƒ½æœ‰ç¼ºé™·ï¼Œä½†æ˜¯å®ç°èµ·æ¥ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ã€‚ä½†æ˜¯å¯¹ä¸€äº›æ•æ„Ÿçš„ä¸šåŠ¡æ•°æ®ï¼Œå¾€å¾€è¦æ±‚æ•°æ®å³ä¸é‡å¤ä¹Ÿä¸ä¸¢å¤±ï¼Œè¿™å°±éœ€è¦æ”¯æŒ <strong>Exactly-once</strong> è¯­ä¹‰, è€Œè¦æ”¯æŒExactly-onceè¯­ä¹‰ï¼Œéœ€è¦æœ‰éå¸¸ç²¾å¯†çš„è®¾è®¡ã€‚</p>
<p>â€‹å›åˆ°Producerå‘æ¶ˆæ¯ç»™Brokerè¿™ä¸ªåœºæ™¯</p>
<p>å¦‚æœè¦ä¿è¯ at-most-once è¯­ä¹‰ï¼Œå¯ä»¥å°†ackçº§åˆ«è®¾ç½®ä¸º0å³å¯ï¼Œæ­¤æ—¶ï¼Œæ˜¯ä¸å­˜åœ¨å¹‚ç­‰æ€§é—®é¢˜çš„</p>
<p>å¦‚æœè¦ä¿è¯at-least-onceè¯­ä¹‰ï¼Œå°±éœ€è¦å°†ackçº§åˆ«è®¾ç½®ä¸º1æˆ–è€…-1ï¼Œè¿™æ ·å°±èƒ½ä¿è¯Leader Partitionä¸­çš„æ¶ˆæ¯è‡³å°‘æ˜¯å†™æˆåŠŸäº†ä¸€æ¬¡çš„ï¼Œä½†æ˜¯ä¸ä¿è¯åªå†™äº†ä¸€æ¬¡</p>
<p>å¦‚æœè¦æ”¯æŒExactly-onceè¯­ä¹‰æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±éœ€è¦ä½¿ç”¨åˆ°idempotenceå¹‚ç­‰æ€§å±æ€§äº†</p>
<h4>kafka å¹‚ç­‰æ€§å®ç°</h4>
<figure><figcaption>alt text</figcaption></figure>
<p>â€‹Kafkaä¸ºäº†ä¿è¯æ¶ˆæ¯å‘é€çš„Exactly-onceè¯­ä¹‰ï¼Œå¢åŠ äº†å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>
<p><code>PID</code>ï¼šæ¯ä¸ªæ–°çš„Produceråœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­å°±ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„PIDã€‚è¿™ä¸ªPIDå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„</p>
</li>
<li>
<p><code>Sequence Numer</code>: å¯¹äºæ¯ä¸ªPIDï¼Œè¿™ä¸ªProduceré’ˆå¯¹Partitionä¼šç»´æŠ¤ä¸€ä¸ªsequenceNumberã€‚è¿™æ˜¯ä¸€ä¸ªä»0å¼€å§‹å•è°ƒé€’å¢çš„æ•°å­—ã€‚å½“Producerè¦å¾€åŒä¸€ä¸ªPartitionå‘é€æ¶ˆæ¯æ—¶ï¼Œè¿™ä¸ªSequence Numberå°±ä¼šåŠ 1ã€‚ç„¶åä¼šéšç€æ¶ˆæ¯ä¸€èµ·å‘å¾€Broker</p>
</li>
<li>
<p><code>SN</code>: Brokerç«¯åˆ™ä¼šé’ˆå¯¹æ¯ä¸ª<code>&lt;PID,Partition&gt;</code>ç»´æŠ¤ä¸€ä¸ªåºåˆ—å·(SN)ï¼Œåªæœ‰å½“å¯¹åº”çš„<code>Sequence Number = SN+1</code>æ—¶ï¼ŒBrokeræ‰ä¼šæ¥æ”¶æ¶ˆæ¯ï¼ŒåŒæ—¶å°†SNæ›´æ–°ä¸ºSN+1ã€‚å¦åˆ™ï¼Œ<code>SequenceNumber</code>è¿‡å°å°±è®¤ä¸ºæ¶ˆæ¯å·²ç»å†™å…¥äº†ï¼Œä¸éœ€è¦å†é‡å¤å†™å…¥ã€‚è€Œå¦‚æœ<code>SequenceNumber</code>è¿‡å¤§ï¼Œå°±ä¼šè®¤ä¸ºä¸­é—´å¯èƒ½æœ‰æ•°æ®ä¸¢å¤±äº†ã€‚å¯¹ç”Ÿäº§è€…å°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>OutOfOrderSequenceException</code></p>
</li>
</ul>
<p>â€‹è¿™æ ·ï¼ŒKafkaåœ¨æ‰“å¼€idempotenceå¹‚ç­‰æ€§æ§åˆ¶åï¼Œåœ¨Brokerç«¯å°±ä¼šä¿è¯æ¯æ¡æ¶ˆæ¯åœ¨ä¸€æ¬¡å‘é€è¿‡ç¨‹ä¸­ï¼ŒBrokerç«¯æœ€å¤šåªä¼šåˆšåˆšå¥½æŒä¹…åŒ–ä¸€æ¡ã€‚è¿™æ ·å°±èƒ½ä¿è¯at-most-onceè¯­ä¹‰ã€‚å†åŠ ä¸Šä¹‹å‰åˆ†æçš„å°†ç”Ÿäº§è€…çš„ackså‚æ•°è®¾ç½®æˆ1æˆ–-1ï¼Œä¿è¯at-least-onceè¯­ä¹‰ï¼Œè¿™æ ·å°±æ•´ä½“ä¸Šä¿è¯äº†Exactaly-onceè¯­ä¹‰</p>
<h4>å¹‚ç­‰æ€§ä½œç”¨èŒƒå›´</h4>
<p>é¦–å…ˆï¼Œå®ƒåªèƒ½ä¿è¯å•åˆ†åŒºä¸Šçš„å¹‚ç­‰æ€§ï¼Œå³â¼€ä¸ªå¹‚ç­‰æ€§Producerèƒ½å¤Ÿä¿è¯æŸä¸ªä¸»é¢˜çš„â¼€ä¸ªåˆ†åŒºä¸Šä¸å‡ºç°é‡å¤æ¶ˆæ¯ï¼Œå®ƒæ— æ³•å®ç°å¤šä¸ªåˆ†åŒºçš„å¹‚ç­‰æ€§</p>
<p>å…¶æ¬¡ï¼Œå®ƒåªèƒ½å®ç°å•ä¼šè¯ä¸Šçš„å¹‚ç­‰æ€§ï¼Œä¸èƒ½å®ç°è·¨ä¼šè¯çš„å¹‚ç­‰æ€§ã€‚</p>
<p>è¿™é‡Œçš„ä¼šè¯ï¼Œå¯ä»¥ç†è§£ä¸ºProducerè¿›ç¨‹çš„â¼€æ¬¡è¿è¡Œï¼Œå½“ä½ é‡å¯äº†Producerè¿›ç¨‹ä¹‹åï¼Œè¿™ç§å¹‚ç­‰æ€§ä¿è¯å°±ä¸§å¤±äº†</p>
<h4>kafka å¹‚ç­‰æ€§é…ç½®</h4>
<p>Kafkaå›´ç»•ç”Ÿäº§è€…å¹‚ç­‰æ€§é—®é¢˜ï¼Œå…¶å®æ˜¯åšäº†ä¸€æ•´å¥—è®¾è®¡çš„</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ENABLE_IDEMPOTENCE_CONFIG</span> <span class="token operator">=</span> <span class="token string">"enable.idempotence"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ENABLE_IDEMPOTENCE_DOC</span> <span class="token operator">=</span> <span class="token string">"When set to 'true', the producer will ensure that exactly one copy of each message is written in the stream."</span><span class="token operator">+</span> 
<span class="token string">"If 'false', producer retries due to broker failures, etc., may write duplicates of the retried message in the stream."</span><span class="token operator">+</span>
<span class="token string">"Note that enabling idempotence"</span><span class="token operator">+</span>
<span class="token string">"requires &lt;code&gt;max.in.flight.requests.per.connection&lt;/code&gt; to be less than or equal to 5 (with message ordering preserved for any allowable value),"</span><span class="token operator">+</span>
<span class="token string">"&lt;code&gt;retries&lt;/code&gt; to be greater than 0, and &lt;code&gt;acks&lt;/code&gt; must be 'all'. &lt;p&gt;"</span><span class="token operator">+</span>
<span class="token string">"Idempotence is enabled by default if no conflicting configurations are set."</span><span class="token operator">+</span>
<span class="token string">"If conflicting configurations are set and idempotence is not explicitly enabled, idempotence is disabled."</span><span class="token operator">+</span>
<span class="token string">"If idempotence is explicitly enabled and conflicting configurations are set, a &lt;code&gt;ConfigException&lt;/code&gt; is thrown."</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨å½“å‰ kafka çš„å¹‚ç­‰æ€§æ˜¯é»˜è®¤å¼€å¯çš„</p>
<p>è¦ä¿è¯å¹‚ç­‰æ€§å¯ä»¥å®ç°</p>
<ul>
<li><code>max.in.flight.requests.per.connection</code> å¿…é¡»å°äº5</li>
<li><code>retries</code> å¿…é¡»å¤§äº0ï¼Œå­˜åœ¨é‡è¯•</li>
<li><code>acks</code> å¿…é¡»è®¾ç½®ä¸º <code>all</code></li>
</ul>
<h3>ç”Ÿäº§è€…æ•°æ®å‹ç¼©æœºåˆ¶</h3>
<p>å½“ç”Ÿäº§è€…å¾€Brokerå‘é€æ¶ˆæ¯æ—¶ï¼Œè¿˜ä¼šå¯¹æ¯ä¸ªæ¶ˆæ¯è¿›è¡Œå‹ç¼©ï¼Œä»è€Œé™ä½Produceråˆ°Brokerçš„ç½‘ç»œæ•°æ®ä¼ è¾“å‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†Brokerçš„æ•°æ®å­˜å‚¨å‹åŠ›</p>
<p>å…·ä½“æ¶‰åŠåˆ°ProducerConfigä¸­çš„ <code>COMPRESSION_TYPE_CONFIG</code> é…ç½®é¡¹</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMPRESSION_TYPE_CONFIG</span> <span class="token operator">=</span> <span class="token string">"compression.type"</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMPRESSION_TYPE_DOC</span> <span class="token operator">=</span> <span class="token string">"The compression type for all data generated by the producer. The default is none (i.e. no compression). Valid  values are &lt;code&gt;none&lt;/code&gt;, &lt;code&gt;gzip&lt;/code&gt;, &lt;code&gt;snappy&lt;/code&gt;, &lt;code&gt;lz4&lt;/code&gt;, or &lt;code&gt;zstd&lt;/code&gt;. Compression is of full batches of data, so the efficacy of batching will also impact the compression ratio (more batching means better compression)."</span><span class="token punctuation">;</span>
</code></pre></div><p>ä»ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒKafkaçš„ç”Ÿäº§è€…æ”¯æŒå››ç§å‹ç¼©ç®—æ³•ã€‚è¿™å‡ ç§å‹ç¼©ç®—æ³•ä¸­ï¼Œzstdç®—æ³•å…·æœ‰æœ€é«˜çš„æ•°æ®å‹ç¼©æ¯”ï¼Œä½†æ˜¯ååé‡ä¸é«˜ã€‚lz4åœ¨ååé‡æ–¹é¢çš„ä¼˜åŠ¿æ¯”è¾ƒæ˜æ˜¾ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µé€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•ã€‚ä½†æ˜¯è¦æ³¨æ„ä¸‹ï¼Œå‹ç¼©æ¶ˆæ¯å¿…ç„¶å¢åŠ CPUçš„æ¶ˆè€—ï¼Œå¦‚æœCPUèµ„æºç´§å¼ ï¼Œå°±ä¸è¦å‹ç¼©äº†</p>
<p>å…³äºæ•°æ®å‹ç¼©æœºåˆ¶ï¼Œåœ¨Brokerç«¯çš„broker.confæ–‡ä»¶ä¸­ï¼Œä¹Ÿæ˜¯å¯ä»¥é…ç½®å‹ç¼©ç®—æ³•çš„ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒBrokerä»Producerç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åä¸ä¼šå¯¹å…¶è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œä½†æ˜¯å¦‚æœBrokerç«¯å’ŒProducerç«¯æŒ‡å®šäº†ä¸åŒçš„å‹ç¼©ç®—æ³•ï¼Œå°±ä¼šäº§ç”Ÿå¾ˆå¤šå¼‚å¸¸çš„è¡¨ç°</p>
<div class="language-conf" data-ext="conf" data-title="conf"><pre class="language-conf"><code>compression.type
Specify the final compression type for a given topic. This configuration accepts the standard compression codecs ('gzip', 'snappy', 'lz4', 'zstd'). It additionally accepts 'uncompressed' which is equivalent to no compression; and 'producer' which means retain the original compression codec set by the producer.

Type: string
Default: producer
Valid Values: [uncompressed, zstd, lz4, snappy, gzip, producer]
Server Default Property: compression.type
Importance: medium
</code></pre></div><p>å¦‚æœå¼€å¯äº†æ¶ˆæ¯å‹ç¼©ï¼Œé‚£ä¹ˆåœ¨æ¶ˆè´¹è€…ç«¯è‡ªç„¶æ˜¯è¦è¿›è¡Œè§£å‹ç¼©çš„</p>
<p>åœ¨Kafkaä¸­ï¼Œæ¶ˆæ¯ä»Produceråˆ°Brokerå†åˆ°Consumerä¼šä¸€ç›´æºå¸¦æ¶ˆæ¯çš„å‹ç¼©æ–¹å¼ï¼Œè¿™æ ·å½“Consumerè¯»å–åˆ°æ¶ˆæ¯é›†åˆæ—¶ï¼Œè‡ªç„¶å°±çŸ¥é“äº†è¿™äº›æ¶ˆæ¯ä½¿ç”¨çš„æ˜¯å“ªç§å‹ç¼©ç®—æ³•ï¼Œä¹Ÿå°±å¯ä»¥è‡ªå·±è¿›è¡Œè§£å‹äº†</p>
<p>ä½†æ˜¯è¿™æ—¶è¦æ³¨æ„çš„æ˜¯åº”ç”¨ä¸­ä½¿ç”¨çš„Kafkaå®¢æˆ·ç«¯ç‰ˆæœ¬å’ŒKafkaæœåŠ¡ç«¯ç‰ˆæœ¬æ˜¯å¦åŒ¹é…ã€‚</p>
<h3>ç”Ÿäº§è€…æ¶ˆæ¯äº‹åŠ¡</h3>
<p>â€‹æ¥ä¸‹æ¥ï¼Œé€šè¿‡ç”Ÿäº§è€…æ¶ˆæ¯å¹‚ç­‰æ€§é—®é¢˜ï¼Œèƒ½å¤Ÿè§£å†³å•ç”Ÿäº§è€…æ¶ˆæ¯å†™å…¥å•åˆ†åŒºçš„çš„å¹‚ç­‰æ€§é—®é¢˜</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ˜¯è¦å†™å…¥å¤šä¸ªåˆ†åŒºå‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚ç”Ÿäº§è€…ä¸€æ¬¡å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œç„¶åç»™ä¸åŒçš„æ¶ˆæ¯æŒ‡å®šä¸åŒçš„key</p>
<p>è¿™æ‰¹æ¶ˆæ¯å°±æœ‰å¯èƒ½å†™å…¥å¤šä¸ªPartitionï¼Œè€Œè¿™äº›Partitionæ˜¯åˆ†å¸ƒåœ¨ä¸åŒBrokerä¸Šçš„, è¿™æ„å‘³ç€ï¼ŒProduceréœ€è¦å¯¹å¤šä¸ªBrokeråŒæ—¶ä¿è¯æ¶ˆæ¯çš„å¹‚ç­‰æ€§</p>
<figure><figcaption>alt text</figcaption></figure>
<p>â€‹è¿™æ—¶å€™ï¼Œé€šè¿‡ä¸Šé¢çš„ç”Ÿäº§è€…æ¶ˆæ¯å¹‚ç­‰æ€§æœºåˆ¶å°±æ— æ³•ä¿è¯æ‰€æœ‰æ¶ˆæ¯çš„å¹‚ç­‰äº†ã€‚è¿™æ—¶å€™å°±éœ€è¦æœ‰ä¸€ä¸ªäº‹åŠ¡æœºåˆ¶ï¼Œä¿è¯è¿™ä¸€æ‰¹æ¶ˆæ¯æœ€å¥½åŒæ—¶æˆåŠŸçš„ä¿æŒå¹‚ç­‰æ€§ã€‚æˆ–è€…è¿™ä¸€æ‰¹æ¶ˆæ¯åŒæ—¶å¤±è´¥ï¼Œè¿™æ ·ç”Ÿäº§è€…å°±å¯ä»¥å¼€å§‹è¿›è¡Œæ•´ä½“é‡è¯•ï¼Œæ¶ˆæ¯ä¸è‡³äºé‡å¤</p>
<p>å³ç›®çš„ï¼šä¿è¯å‘é€å¤šæ¡æ¶ˆæ¯è¿™ä¸ªæ“ä½œä¹Ÿæ˜¯åŸå­æ€§</p>
<h4>äº‹åŠ¡API</h4>
<p>å¯¹è¿™ä¸ªé—®é¢˜ï¼Œ Kafkaå°±å¼•å…¥äº†æ¶ˆæ¯äº‹åŠ¡æœºåˆ¶ã€‚è¿™æ¶‰åŠåˆ°Producerä¸­çš„å‡ ä¸ªAPI</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 1 åˆå§‹åŒ–äº‹åŠ¡</span>
<span class="token keyword">void</span> <span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2 å¼€å¯äº‹åŠ¡</span>
<span class="token keyword">void</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span class="token comment">// 3 æäº¤äº‹åŠ¡</span>
<span class="token keyword">void</span> <span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span class="token comment">// 4 æ”¾å¼ƒäº‹åŠ¡ï¼ˆç±»ä¼¼äºå›æ»šäº‹åŠ¡çš„æ“ä½œï¼‰</span>
<span class="token keyword">void</span> <span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
</code></pre></div><h4>ç¤ºä¾‹</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionErrorDemo</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BOOTSTRAP_SERVERS</span> <span class="token operator">=</span> <span class="token string">"worker1:9092,worker2:9092,worker3:9092"</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC</span> <span class="token operator">=</span> <span class="token string">"disTopic"</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
      <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ­¤å¤„é…ç½®çš„æ˜¯kafkaçš„ç«¯å£</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token constant">BOOTSTRAP_SERVERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// äº‹åŠ¡ID</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONAL_ID_CONFIG</span><span class="token punctuation">,</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// é…ç½®keyçš„åºåˆ—åŒ–ç±»</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// é…ç½®valueçš„åºåˆ—åŒ–ç±»</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      producer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MyProducer"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//å¼‚æ­¥å‘é€ã€‚</span>
          producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token comment">//ç¬¬ä¸‰æ¡æ¶ˆæ¯æ”¾å¼ƒäº‹åŠ¡ä¹‹åï¼Œæ•´ä¸ªè¿™ä¸€æ‰¹æ¶ˆæ¯éƒ½å›é€€äº†ã€‚</span>
              <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              producer<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"message sended"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">//producer.commitTransaction();</span>
      producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥å…ˆå¯åŠ¨ä¸€ä¸ªè®¢é˜…äº†disTopicè¿™ä¸ªTopicçš„æ¶ˆè´¹è€…ï¼Œç„¶åå¯åŠ¨è¿™ä¸ªç”Ÿäº§è€…ï¼Œè¿›è¡Œè¯•éªŒã€‚åœ¨è¿™ä¸ªè¯•éªŒä¸­ï¼Œå‘é€åˆ°ç¬¬3æ¡æ¶ˆæ¯æ—¶ï¼Œä¸»åŠ¨æ”¾å¼ƒäº‹åŠ¡ï¼Œæ­¤æ—¶ä¹‹å‰çš„æ¶ˆæ¯ä¹Ÿä¼šä¸€èµ·å›æ»š</p>
<h4>åˆ†æ</h4>
<p>å®é™…ä¸Šï¼ŒKafkaçš„äº‹åŠ¡æ¶ˆæ¯è¿˜ä¼šåšä¸¤ä»¶äº‹æƒ…ï¼š</p>
<p>1ã€ä¸€ä¸ªTransactionIdåªä¼šå¯¹åº”ä¸€ä¸ªPID</p>
<p>å¦‚æœå½“å‰ä¸€ä¸ªProducerçš„äº‹åŠ¡æ²¡æœ‰æäº¤ï¼Œè€Œå¦ä¸€ä¸ªæ–°çš„Producerä¿æŒç›¸åŒçš„TransactionIdï¼Œè¿™æ—¶æ—§çš„ç”Ÿäº§è€…ä¼šç«‹å³å¤±æ•ˆï¼Œæ— æ³•ç»§ç»­å‘é€æ¶ˆæ¯</p>
<p>2ã€è·¨ä¼šè¯äº‹åŠ¡å¯¹é½</p>
<p>â€‹å¦‚æœæŸä¸ªProducerå®ä¾‹å¼‚å¸¸å®•æœºäº†ï¼Œäº‹åŠ¡æ²¡æœ‰è¢«æ­£å¸¸æäº¤ã€‚é‚£ä¹ˆæ–°çš„TransactionIdç›¸åŒçš„Producerå®ä¾‹ä¼šå¯¹æ—§çš„äº‹åŠ¡è¿›è¡Œè¡¥é½ã€‚ä¿è¯æ—§äº‹åŠ¡è¦ä¹ˆæäº¤ï¼Œè¦ä¹ˆç»ˆæ­¢ã€‚è¿™æ ·æ–°çš„Producerå®ä¾‹å°±å¯ä»¥ä»¥ä¸€ä¸ªæ­£å¸¸çš„çŠ¶æ€å¼€å§‹å·¥ä½œ</p>
<blockquote>
<p>å¦‚æœä½ å¯¹æ¶ˆæ¯äº‹åŠ¡çš„å®ç°æœºåˆ¶æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œå‚çœ‹ä¸‹Apacheä¸‹çš„è¿™ç¯‡æ–‡ç« ï¼š <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging#KIP98ExactlyOnceDeliveryandTransactionalMessaging-AnExampleApplication" target="_blank" rel="noopener noreferrer">https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging#KIP98ExactlyOnceDeliveryandTransactionalMessaging-AnExampleApplication</a></p>
</blockquote>
<p>æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªProduceréœ€è¦å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œé€šå¸¸æ¯”è¾ƒå®‰å…¨çš„å‘é€æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BOOTSTRAP_SERVERS</span> <span class="token operator">=</span> <span class="token string">"worker1:9092,worker2:9092,worker3:9092"</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC</span> <span class="token operator">=</span> <span class="token string">"disTopic"</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
      <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ­¤å¤„é…ç½®çš„æ˜¯kafkaçš„ç«¯å£</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token constant">BOOTSTRAP_SERVERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// äº‹åŠ¡IDã€‚</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONAL_ID_CONFIG</span><span class="token punctuation">,</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// é…ç½®keyçš„åºåˆ—åŒ–ç±»</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// é…ç½®valueçš„åºåˆ—åŒ–ç±»</span>
      props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      producer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span><span class="token punctuation">{</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MyProducer"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//å¼‚æ­¥å‘é€ã€‚</span>
              producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          producer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProducerFencedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
          producer<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
          producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…¶ä¸­å¯¹äºäº‹åŠ¡IDè¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥ä»»æ„èµ·åï¼Œä½†æ˜¯å»ºè®®åŒ…å«ä¸€å®šçš„ä¸šåŠ¡å”¯ä¸€æ€§ã€‚</p>
<p>â€‹ç”Ÿäº§è€…çš„äº‹åŠ¡æ¶ˆæ¯æœºåˆ¶ä¿è¯äº†Producerå‘é€æ¶ˆæ¯çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯ï¼Œä»–å¹¶ä¸ä¿è¯å·²ç»æäº¤çš„æ¶ˆæ¯å°±ä¸€å®šèƒ½è¢«æ‰€æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹</p>
<h3>æµç¨‹æ€»ç»“</h3>
<p>å¯¹äºè¿™äº›å±æ€§ï¼Œä½ å¹¶ä¸éœ€è¦ç…æœ‰ä»‹äº‹çš„å¼ºè¡Œå»è®°å¿†ï¼Œéšæ—¶å¯ä»¥æ ¹æ®ProducerConfigå’ŒConsumerConfigä»¥åŠä»–ä»¬çš„çˆ¶ç±»CommonClientConfigå»ç†è§£ï¼Œå¤§éƒ¨åˆ†çš„å±æ€§éƒ½é…æœ‰éå¸¸ç®€æ˜æ‰¼è¦çš„è§£é‡Šã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸€å®šéœ€è¦å°è¯•è‡ªå·±å»ºç«‹ä¸€ä¸ªæ¶ˆæ¯æµè½¬æ¨¡å‹ï¼Œç†è§£å…¶ä¸­æ¯”è¾ƒé‡è¦çš„è¿‡ç¨‹ã€‚ç„¶åé‡ç‚¹ä»é«˜å¯ç”¨ï¼Œé«˜å¹¶å‘çš„è§’åº¦å»ç†è§£Kafkaå®¢æˆ·ç«¯çš„è®¾è®¡ï¼Œæœ€åå†å°è¯•å¾€å…¶ä¸­å¡«å……å…·ä½“çš„å‚æ•°ã€‚</p>
<figure><figcaption>alt text</figcaption></figure>
]]></content:encoded>
    </item>
    <item>
      <title>Kafka - 3</title>
      <link>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/4.html</link>
      <guid>http://ekkosonya.cn/code/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/4.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Kafka - 3</source>
      <description>SpringBooté›†æˆKafa å‘é€æ¶ˆæ¯ KafkaTemplate KafkaTemplate å°è£…äº†ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¹¶æä¾›äº†ä¾¿æ·æ–¹æ³•å°†æ•°æ®å‘é€åˆ° Kafka ä¸»é¢˜ è¯¥ç±»æ„é€ æ–¹æ³•éœ€è¦ä¼ é€’ä¸€ä¸ª ProducerFactory å¯¹è±¡ï¼Œæ¥è¡¨ç¤ºå¦‚ä½•æ ¹æ®å¯¹åº”é…ç½®åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ä»è€Œè¿›è¡Œæ¶ˆæ¯ä¼ é€’ åˆ›å»º KafkaTemplate å°±éœ€è¦æä¾›ä¸€ä¸ª ProducerFa...</description>
      <category>code</category>
      <pubDate>Tue, 20 Jan 2026 14:16:53 GMT</pubDate>
      <content:encoded><![CDATA[<h2>SpringBooté›†æˆKafa</h2>
<h3>å‘é€æ¶ˆæ¯ <code>KafkaTemplate</code></h3>
<p><code>KafkaTemplate</code> å°è£…äº†ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¹¶æä¾›äº†ä¾¿æ·æ–¹æ³•å°†æ•°æ®å‘é€åˆ° Kafka ä¸»é¢˜</p>
<p>è¯¥ç±»æ„é€ æ–¹æ³•éœ€è¦ä¼ é€’ä¸€ä¸ª <code>ProducerFactory</code> å¯¹è±¡ï¼Œæ¥è¡¨ç¤ºå¦‚ä½•æ ¹æ®å¯¹åº”é…ç½®åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ä»è€Œè¿›è¡Œæ¶ˆæ¯ä¼ é€’</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span><span class="token punctuation">(</span><span class="token class-name">ProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producerFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span>producerFactory<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span><span class="token punctuation">(</span><span class="token class-name">ProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producerFactory<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoFlush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span>producerFactory<span class="token punctuation">,</span> autoFlush<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span><span class="token punctuation">(</span><span class="token class-name">ProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producerFactory<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoFlush<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> configOverrides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogAccessor</span><span class="token punctuation">(</span><span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>producers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>micrometerTags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>clusterIdLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>beanName <span class="token operator">=</span> <span class="token string">"kafkaTemplate"</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>messageConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessagingMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>producerListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingProducerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>closeTimeout <span class="token operator">=</span> <span class="token class-name">ProducerFactoryUtils</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CLOSE_TIMEOUT</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>micrometerEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>observationRegistry <span class="token operator">=</span> <span class="token class-name">ObservationRegistry</span><span class="token punctuation">.</span><span class="token constant">NOOP</span><span class="token punctuation">;</span>
  <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>producerFactory<span class="token punctuation">,</span> <span class="token string">"'producerFactory' cannot be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>autoFlush <span class="token operator">=</span> autoFlush<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>micrometerEnabled <span class="token operator">=</span> <span class="token class-name">KafkaUtils</span><span class="token punctuation">.</span><span class="token constant">MICROMETER_PRESENT</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>customProducerFactory <span class="token operator">=</span> <span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>configOverrides<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>customProducerFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>producerFactory <span class="token operator">=</span> producerFactory<span class="token punctuation">.</span><span class="token function">copyWithConfigurationOverride</span><span class="token punctuation">(</span>configOverrides<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>producerFactory <span class="token operator">=</span> producerFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>transactional <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>producerFactory<span class="token punctuation">.</span><span class="token function">transactionCapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>åˆ›å»º <code>KafkaTemplate</code></h3>
<p>å°±éœ€è¦æä¾›ä¸€ä¸ª <code>ProducerFactory</code> å¯¹è±¡ ç”Ÿäº§è€…å·¥å‚ï¼Œè§„å®šäº†ä¸€äº›åŸºç¡€é…ç½®ï¼Œç„¶ååœ¨ Template æ„é€ æ—¶å¼•ç”¨</p>
<p><code>ProducerConfig</code> æ˜¯ Kafka å®¢æˆ·ç«¯é‡Œå®šä¹‰çš„ç”Ÿäº§è€…é…ç½®é¡¹å¤§å…¨çš„ç±»</p>
<p>ä¾‹å­</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerFactory</span> <span class="token function">producerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKafkaProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">producerConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">producerConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">IntegerSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// See https://kafka.apache.org/41/documentation/#producerconfigs for more properties</span>
    <span class="token keyword">return</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span> <span class="token function">kafkaTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KafkaTemplate</span><span class="token punctuation">(</span><span class="token function">producerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤å¤–ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢æ³¨å†Œäº†ä¸€ä¸ª <code>ProducerFactory&lt;String, Object&gt;</code> çš„ç±», æˆ‘ä»¬åœ¨ç©¿ä»¶åˆ«çš„ï¼Œå¯ä»¥è¦†ç›–è¿™ä¸ªå·¥å‚çš„ <code>ProducerConfig</code> å±æ€§ï¼Œä»¥ä½¿ç”¨ä¸åŒä¸€å·¥å‚ä¸åŒçš„ç”Ÿäº§è€…é…ç½®åˆ›å»ºæ¨¡æ¿</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">reliableTemplate</span><span class="token punctuation">(</span><span class="token class-name">ProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> pf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> overrides <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  overrides<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ACKS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  overrides<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ENABLE_IDEMPOTENCE_CONFIG</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  overrides<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pf<span class="token punctuation">,</span> overrides<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3><code>KafkaTemplate</code>æ–¹æ³•</h3>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendDefault</span><span class="token punctuation">(</span><span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendDefault</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendDefault</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendDefault</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricName</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Metric</span><span class="token punctuation">&gt;</span></span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">partitionsFor</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ProducerCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">executeInTransaction</span><span class="token punctuation">(</span><span class="token class-name">OperationsCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Flush the producer.</span>
<span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ProducerCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">T</span> <span class="token function">doInKafka</span><span class="token punctuation">(</span><span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">OperationsCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">T</span> <span class="token function">doInOperations</span><span class="token punctuation">(</span><span class="token class-name">KafkaOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> operations<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ä¸»è¦æ–¹æ³•æœ‰ <code>send</code> å’Œ <code>sendDefault</code>ï¼Œå¹¶ä¸”è¿”å›çš„éƒ½æ˜¯ <code>Future</code> ç±»å‹ <code>CompletableFuture</code></p>
<p>The sendDefault API requires that a default topic has been provided to the template.</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendDefault</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">V</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultTopic<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å³ç”¨ <code>sendDefault</code> æ–¹æ³•éœ€è¦ç¡®å®š <code>defaultTopic</code></p>
<p>è€Œ <code>send</code> éœ€è¦è‡ªå·±æŒ‡æ˜</p>
<p>è°ƒç”¨ <code>kafkaTemplate.metrics()</code> (æ‹¿ç”Ÿäº§è€…çš„ç›‘æ§æŒ‡æ ‡) å’Œ <code>kafkaTemplate.partitionsFor(topic)</code> (æŸ¥ topic çš„åˆ†åŒºä¿¡æ¯)</p>
<p>KafkaTemplate ä¸è‡ªå·±å®ç°è¿™äº›åŠŸèƒ½ï¼Œå®ƒä¼šæŠŠè°ƒç”¨åŸå°ä¸åŠ¨è½¬å‘ç»™åº•å±‚çš„ <code>org.apache.kafka.clients.producer.KafkaProducer</code>ï¼ˆæˆ–è€…è¯´ Producer å®ä¾‹ï¼‰å»æ‰§è¡Œ</p>
<p>è°ƒç”¨ KafkaTemplate.send(Message&lt;?&gt; message) è¿™ç§æ–¹æ³•æ—¶, æ¶ˆæ¯çš„å…ƒä¿¡æ¯ï¼ˆtopicã€partitionã€keyã€timestampï¼‰ä¸å†å†™åœ¨å‚æ•°é‡Œï¼Œè€Œæ˜¯æ”¾åœ¨ Message çš„ headerï¼ˆæ¶ˆæ¯å¤´ï¼‰é‡Œä¼ é€’</p>
<p><code>Message</code></p>
<p>Spring è‡ªå·±å®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ¶ˆæ¯æ¥å£ï¼š<code>org.springframework.messaging.Message&lt;T&gt;</code></p>
<p>å®ƒçš„å®ç°åœ¨ <code>GenericMessage&lt;T&gt;</code></p>
<p>ä¸»è¦å°±æ˜¯æœ‰ä¸¤ä¸ªå±æ€§ä¸€ä¸ªæ˜¯ <code>payload</code> ä¸€ä¸ªæ˜¯ <code>headers</code></p>
<p>å¦‚æœç”¨ <code>Message</code> ä¼ ä¿¡æ¯å°±å¯ä»¥è¿™æ ·å†™</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">MessageBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">KafkaHeaders</span></span><span class="token punctuation">;</span>

<span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileProcessingTask</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span>
        <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">KafkaHeaders</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getFileProcessingTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">KafkaHeaders</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">fileMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">KafkaHeaders</span><span class="token punctuation">.</span><span class="token constant">TIMESTAMP</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3>å‘ Kafka å‘é€æ¶ˆæ¯</h3>
<p>å‘é€æ–¹æ³•è¿”å›ä¸€ä¸ª <code>CompletableFuture&lt;SendResult&gt;</code> å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ <code>whenComplete(...)</code> å»å†™å›è°ƒ</p>
<p>éé˜»å¡</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendToKafka</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MyOutputData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token function">createRecord</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
  future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> ex<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleSuccess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">handleFailure</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> record<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é˜»å¡</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendToKafka</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MyOutputData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token function">createRecord</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      template<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">handleSuccess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleFailure</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> record<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleFailure</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> record<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>äº‹åŠ¡</h4>
<p>Spring Kafka åœ¨ <code>executeInTransaction</code> é‡Œä¼šåšè¿™äº›äº‹ï¼ˆæ¦‚å¿µä¸Šï¼‰ï¼š</p>
<ul>
<li>ä» ProducerFactory æ‹¿ä¸€ä¸ªâ€œäº‹åŠ¡å‹ Producerâ€ï¼ˆå‰ææ˜¯ä½ è®¾ç½®äº† transactionIdPrefixï¼‰</li>
<li>beginTransaction()</li>
<li>æ‰§è¡Œä½ çš„ lambdaï¼šsend(...)</li>
<li>commitTransaction()
<ul>
<li>å¦‚æœ lambda é‡ŒæŠ›å¼‚å¸¸æˆ–å‘é€å¤±è´¥å¯¼è‡´å¼‚å¸¸å†’æ³¡ï¼šabortTransaction()</li>
</ul>
</li>
</ul>
<p>ç”¨äº‹åŠ¡æ˜¯å¸Œæœ›è¿™ä¸ªä»»åŠ¡æ¶ˆæ¯ä¸€å®šè¦å¯é åœ°å‘å‡ºå»ï¼Œæœ€å¥½å’Œæˆ‘å‰é¢é‚£å †æ•°æ®åº“æ“ä½œï¼ˆæ›´æ–° file_upload çŠ¶æ€ã€å†™è®°å½•ç­‰ï¼‰å½¢æˆä¸€ä¸ªä¸€è‡´çš„æäº¤è¾¹ç•Œ</p>
<h4>ç›‘å¬ <code>ProducerListener</code></h4>
<p>å¯ä»¥ä¸º KafkaTemplate é…ç½®ä¸€ä¸ª ProducerListenerï¼Œä»¥è·å–å‘é€ç»“æœï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰çš„å¼‚æ­¥å›è°ƒï¼Œè€Œä¸æ˜¯ç­‰å¾… Future å®Œæˆ</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProducerListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç¤ºä¾‹</p>
<p>å¯ä»¥ <code>KafkaProducerListenerConfig.java</code> å»ºä¸€ä¸ªç›‘å¬é…ç½®</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerLogListener</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"sent ok topic={}, partition={}, offset={}, key={}"</span><span class="token punctuation">,</span>
                metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span>
                        <span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span>
                        <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> meta <span class="token operator">=</span> <span class="token punctuation">(</span>metadata <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> <span class="token string">"meta=null"</span>
                <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"partition=%d, offset=%d"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"send failed topic={}, key={}, {}"</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> meta<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶ååœ¨ KafkaTemplate é‚£é‡Œæ³¨å…¥å®ƒï¼š</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">kafkaTemplate</span><span class="token punctuation">(</span>
  <span class="token class-name">ProducerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> pf<span class="token punctuation">,</span>
  <span class="token class-name">ProducerListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> producerListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  template<span class="token punctuation">.</span><span class="token function">setProducerListener</span><span class="token punctuation">(</span>producerListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3>æ¥æ”¶æ¶ˆæ¯</h3>
<h4>ç¤ºä¾‹</h4>
<p>ç›‘å¬ Kafka çš„ test topicï¼Œæœ€ç®€å•å°± 3 æ­¥ï¼šåŠ ä¾èµ– â†’ é…ç½® consumer â†’ å†™ <code>@KafkaListener</code></p>
<p>1.åŠ ä¾èµ–</p>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2.é…ç½® application.yml</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9092</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>group
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> earliest   <span class="token comment"># ç¬¬ä¸€æ¬¡æ¶ˆè´¹ä»æœ€æ—©å¼€å§‹ï¼ˆå¯é€‰ï¼‰</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
</code></pre></div><p>3.å†™ç›‘å¬å™¨ Consumer</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">KafkaListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTopicListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">"test-group"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ”¶åˆ° test topic æ¶ˆæ¯: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>æ¶ˆæ¯ç›‘å¬å™¨æ¥å£</h4>
<p>ä½¿ç”¨æ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨æ—¶ï¼Œæ‚¨å¿…é¡»æä¾›ä¸€ä¸ªç›‘å¬å™¨æ¥æ¥æ”¶æ•°æ®ã€‚ç›®å‰æœ‰å…«ç§æ”¯æŒçš„æ¶ˆæ¯ç›‘å¬å™¨æ¥å£</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AcknowledgingMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConsumerAwareMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">MessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AcknowledgingConsumerAwareMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">MessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BatchMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BatchAcknowledgingMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BatchConsumerAwareMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BatchMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BatchAcknowledgingConsumerAwareMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BatchMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>item3 - 2 æ•´ä½“æ¶æ„</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article2.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article2.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 2 æ•´ä½“æ¶æ„</source>
      <description>ç®€ä»‹ è¿™æ˜¯ä¸€ä¸ªåŸºäº RAG çš„ AI çŸ¥è¯†åº“æ™ºèƒ½é—®ç­”å¹³å°ï¼Œç»“åˆäº†å¤§è¯­è¨€æ¨¡å‹ä»¥åŠå‘é‡åŒ–çš„æŠ€æœ¯æ¥æä¾›é«˜æ•ˆã€å‡†ç¡®çš„é—®ç­”æœåŠ¡ ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸Šä¼ å„è‡ªçš„æ–‡æ¡£æ¥æ„å»ºç›¸åº”ä¸“å±çš„ç§æœ‰çŸ¥è¯†åº“ï¼Œå¹¶å¯ä»¥ä¸å¯¹åº”çš„agentå®æ—¶äº¤äº’æé—®ã€‚æ”¯æŒå¤šè½®å¯¹è¯ã€è¯­ä¹‰æ£€ç´¢å’ŒåŠ¨æ€çŸ¥è¯†åº“æ›´æ–° </description>
      <category>code</category>
      <pubDate>Sat, 10 Jan 2026 06:49:04 GMT</pubDate>
      <content:encoded><![CDATA[<h2>ç®€ä»‹</h2>
<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº RAG çš„ AI çŸ¥è¯†åº“æ™ºèƒ½é—®ç­”å¹³å°ï¼Œç»“åˆäº†å¤§è¯­è¨€æ¨¡å‹ä»¥åŠå‘é‡åŒ–çš„æŠ€æœ¯æ¥æä¾›é«˜æ•ˆã€å‡†ç¡®çš„é—®ç­”æœåŠ¡</p>
<p>ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸Šä¼ å„è‡ªçš„æ–‡æ¡£æ¥æ„å»ºç›¸åº”ä¸“å±çš„ç§æœ‰çŸ¥è¯†åº“ï¼Œå¹¶å¯ä»¥ä¸å¯¹åº”çš„agentå®æ—¶äº¤äº’æé—®ã€‚æ”¯æŒå¤šè½®å¯¹è¯ã€è¯­ä¹‰æ£€ç´¢å’ŒåŠ¨æ€çŸ¥è¯†åº“æ›´æ–°</p>
]]></content:encoded>
    </item>
    <item>
      <title>item3 - 3 ç”¨æˆ·ç®¡ç†æ¨¡å—1</title>
      <link>http://ekkosonya.cn/code/java_item/3-smart/article3.html</link>
      <guid>http://ekkosonya.cn/code/java_item/3-smart/article3.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">item3 - 3 ç”¨æˆ·ç®¡ç†æ¨¡å—1</source>
      <description>è§£å†³ç”¨æˆ·æ³¨å†Œã€ç™»å½•ä»¥åŠæƒé™æ§åˆ¶ ç›®çš„ ç¡®ä¿ç”¨æˆ·èº«ä»½å®‰å…¨æ€§ æœ‰çµæ´»æƒé™ç®¡ç†æœºåˆ¶ï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œé€šè¿‡ RBAC å®ç°ä¸åŒè§’è‰²(ç®¡ç†å‘˜|æ™®é€šç”¨æˆ·)åŠŸèƒ½æƒé™åŒºåˆ† ä¸ºå…¶ä»–æ¨¡å—æä¾›ä¿¡æ¯æ”¯æŒ å®ç°åŠŸèƒ½ ç”¨æˆ·æ³¨å†Œ å…è®¸ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œæ³¨å†Œï¼ŒæˆåŠŸæ³¨å†Œåé»˜è®¤åˆ†é…æ™®é€šç”¨æˆ·çš„è§’è‰² æµç¨‹ æ¥æ”¶ç”¨æˆ·æ³¨å†Œè¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·åå’Œå¯†ç  æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨ ä½¿ç”¨ BCrypt...</description>
      <category>code</category>
      <pubDate>Sat, 10 Jan 2026 06:49:04 GMT</pubDate>
      <content:encoded><![CDATA[<p>è§£å†³ç”¨æˆ·æ³¨å†Œã€ç™»å½•ä»¥åŠæƒé™æ§åˆ¶</p>
<h2>ç›®çš„</h2>
<ul>
<li>ç¡®ä¿ç”¨æˆ·èº«ä»½å®‰å…¨æ€§</li>
<li>æœ‰çµæ´»æƒé™ç®¡ç†æœºåˆ¶ï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œé€šè¿‡ RBAC å®ç°ä¸åŒè§’è‰²(ç®¡ç†å‘˜|æ™®é€šç”¨æˆ·)åŠŸèƒ½æƒé™åŒºåˆ†</li>
<li>ä¸ºå…¶ä»–æ¨¡å—æä¾›ä¿¡æ¯æ”¯æŒ</li>
</ul>
<h2>å®ç°åŠŸèƒ½</h2>
<h3>ç”¨æˆ·æ³¨å†Œ</h3>
<p>å…è®¸ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œæ³¨å†Œï¼ŒæˆåŠŸæ³¨å†Œåé»˜è®¤åˆ†é…æ™®é€šç”¨æˆ·çš„è§’è‰²</p>
<h4>æµç¨‹</h4>
<ul>
<li>æ¥æ”¶ç”¨æˆ·æ³¨å†Œè¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·åå’Œå¯†ç </li>
<li>æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨</li>
<li>ä½¿ç”¨ BCrypt åŠ å¯†å¯†ç </li>
<li>åˆ›å»ºç”¨æˆ·è®°å½•ï¼Œè®¾ç½®é»˜è®¤è§’è‰²ä¸ºUSER =&gt; å­˜ users è¡¨</li>
<li>åˆ›å»ºç”¨æˆ·ç§äººç»„ç»‡æ ‡ç­¾ï¼ˆPRIVATE_usernameï¼‰ =&gt; å­˜ organization_tag è¡¨</li>
<li>å°†ç§äººç»„ç»‡æ ‡ç­¾è®¾ç½®ä¸ºç”¨æˆ·çš„ä¸»ç»„ç»‡æ ‡ç­¾</li>
<li>è¿”å›æ³¨å†ŒæˆåŠŸå“åº”</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ¥å£è®¾è®¡</h4>
<ul>
<li>
<p>URL: /api/v1/users/register</p>
</li>
<li>
<p>Method: POST</p>
</li>
<li>
<p>Request Body</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code>  <span class="token punctuation">{</span>
    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>   <span class="token comment">// ç”¨æˆ·åï¼Œå”¯ä¸€</span>
    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"string"</span>    <span class="token comment">// å¯†ç ï¼ˆæ˜æ–‡ä¼ è¾“ï¼Œåç«¯åŠ å¯†å­˜å‚¨ï¼‰</span>
  <span class="token punctuation">}</span>
</code></pre></div></li>
<li>
<p>Response:</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token comment">// æˆåŠŸ</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"User registered successfully"</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token comment">// å¤±è´¥</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Username already exists"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
</ul>
<h4>å…·ä½“å®ç°</h4>
<p>ç”±äºè¿™ä¸ªé¡¹ç›®åœ¨æ•°æ®åº“äº¤äº’ (æ•°æ®è®¿é—®) ç”¨çš„æ˜¯ Spring Data JPAï¼Œæ‰€ä»¥ä¸æ˜¯ Mybatis é‚£æ ·åˆ†çš„æ˜¯ Mapper å±‚</p>
<p>è¿™é‡Œæ›´å¸¸ç”¨çš„ä¸‰å±‚æ˜¯</p>
<ul>
<li><code>UserController</code> (Controllerå±‚)</li>
<li><code>UserService</code> (Serviceå±‚)</li>
<li><code>UserRepository</code> (Repositoryå±‚)</li>
</ul>
<h5><code>UserController</code>å±‚</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogUtils<span class="token punctuation">.</span>PerformanceMonitor</span> monitor <span class="token operator">=</span> <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">startPerformanceMonitor</span><span class="token punctuation">(</span><span class="token string">"USER_REGISTER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”¨æˆ·ä¸åˆè§„æ£€éªŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span><span class="token string">"anonymous"</span><span class="token punctuation">,</span> <span class="token string">"REGISTER"</span><span class="token punctuation">,</span> <span class="token string">"validation"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_EMPTY_PARAMS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ³¨å†Œå¤±è´¥ï¼šå‚æ•°ä¸ºç©º"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Username and password cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// è¿›å…¥ Service å±‚</span>
        userService<span class="token punctuation">.</span><span class="token function">registerUser</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"REGISTER"</span><span class="token punctuation">,</span> <span class="token string">"user_creation"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ³¨å†ŒæˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"User registered successfully"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CustomException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"USER_REGISTER"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ç”¨æˆ·æ³¨å†Œå¤±è´¥: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ³¨å†Œå¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"USER_REGISTER"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ç”¨æˆ·æ³¨å†Œå¼‚å¸¸: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"æ³¨å†Œå¼‚å¸¸: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Internal server error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ç†æµç¨‹è¿˜è¡Œï¼Œä¸»è¦æ—¥å¿—è®°å½•å€’æ˜¯æ²¡æœ‰è§è¿‡ï¼Œéœ€è¦äº†è§£ä¸‹</p>
<h5><code>LogUtils</code>å·¥å…·ç±»</h5>
<p>æš‚æ—¶ç®€å•äº†è§£ä¸‹ï¼Œä¹‹å‰æ˜¯ç›´æ¥å†å¯¹åº”ç±»ä¸ŠåŠ ä¸Š Lombok çš„æ³¨è§£ <code>@Slf4j</code> ç„¶åå°±å¯ä»¥ç”¨ <code>log</code> æ¥å¿«é€Ÿæ—¥å¿—</p>
<p>æœ¬è´¨ä¸Šåœ¨ç±»ä¸Šä½¿ç”¨ <code>@Slf4j</code> æ—¶ï¼ŒLombok é»˜è®¤ç”Ÿæˆçš„ä»£ç å…¶å®å°±æ˜¯ï¼š <code>private static final Logger log = LoggerFactory.getLogger(å½“å‰ç±»å.class)</code></p>
<p>è€Œè¿™é‡Œæ˜¯é›†æˆåˆ°äº†ä¸€ä¸ªå·¥å…·ç±»ä¸Š <code>LogUtils</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogUtils</span> <span class="token punctuation">{</span>
    
  <span class="token comment">// ä¸šåŠ¡æ—¥å¿—è®°å½•å™¨</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">BUSINESS_LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"com.yizhaoqi.smartpai.business"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ€§èƒ½æ—¥å¿—è®°å½•å™¨</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">PERFORMANCE_LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"com.yizhaoqi.smartpai.performance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// MDCé”®åå¸¸é‡</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_ID</span> <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REQUEST_ID</span> <span class="token operator">=</span> <span class="token string">"requestId"</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SESSION_ID</span> <span class="token operator">=</span> <span class="token string">"sessionId"</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">OPERATION</span> <span class="token operator">=</span> <span class="token string">"operation"</span><span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * è®°å½•ä¸šåŠ¡æ—¥å¿—
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">logBusiness</span><span class="token punctuation">(</span><span class="token class-name">String</span> operation<span class="token punctuation">,</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">OPERATION</span><span class="token punctuation">,</span> operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token constant">BUSINESS_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[{}] [ç”¨æˆ·:{}] {}"</span><span class="token punctuation">,</span> operation<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token function">formatMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><p>åˆ†åˆ«è®¾ç½®äº†ä¸¤ä¸ªè®°å½•å™¨æ¥è®°å½•ä¸šåŠ¡å’Œæ€§èƒ½</p>
<p>æœ‰ä¸€ä¸ªæ¦‚å¿µ MDC (Mapped Diagnostic Context)ï¼Œå¯ä»¥ç²—ç•¥çš„ç†è§£æˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å­˜æ”¾è¯Šæ–­æ—¥å¿—çš„å®¹å™¨</p>
<p>ç®€å•äº†è§£æ˜¯ å°†ç±»ä¸­çš„å¯¹åº”é™æ€å˜é‡ï¼ˆå¦‚ userId, requestIdï¼‰ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼Œè¿™æ ·å°±èƒ½æœ‰å…·ä½“ä¿¡æ¯å¯¹åº”ï¼Œå¹¶ä¸”å¤šçº¿ç¨‹ä¸‹å¯ä»¥å¯¹åº”</p>
<p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªæ€§èƒ½ç›‘è§†çš„å†…éƒ¨ç±»</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ€§èƒ½ç›‘æ§è£…é¥°å™¨
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PerformanceMonitor</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> operation<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> startTime<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token class-name">PerformanceMonitor</span><span class="token punctuation">(</span><span class="token class-name">String</span> operation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>operation <span class="token operator">=</span> operation<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">end</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token class-name">String</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
      <span class="token function">logPerformance</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * åˆ›å»ºæ€§èƒ½ç›‘æ§å™¨
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PerformanceMonitor</span> <span class="token function">startPerformanceMonitor</span><span class="token punctuation">(</span><span class="token class-name">String</span> operation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceMonitor</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5><code>UserService</code>å±‚</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ³¨å†Œæ–°ç”¨æˆ·ã€‚
 *
 * <span class="token keyword">@param</span> <span class="token parameter">username</span> è¦æ³¨å†Œçš„ç”¨æˆ·å
 * <span class="token keyword">@param</span> <span class="token parameter">password</span> è¦æ³¨å†Œçš„ç”¨æˆ·å¯†ç 
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">CustomException</span></span> å¦‚æœç”¨æˆ·åå·²å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·å</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è‹¥ç”¨æˆ·åå·²å­˜åœ¨ï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼ŒçŠ¶æ€ç ä¸º 400 Bad Request</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">"Username already exists"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ç¡®ä¿é»˜è®¤ç»„ç»‡æ ‡ç­¾å­˜åœ¨ï¼ˆç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ï¼‰</span>
    <span class="token function">ensureDefaultOrgTagExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¯¹å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†å¹¶è®¾ç½®åˆ° User å¯¹è±¡ä¸­</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">PasswordUtil</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®ç”¨æˆ·è§’è‰²ä¸ºæ™®é€šç”¨æˆ·</span>
    user<span class="token punctuation">.</span><span class="token function">setRole</span><span class="token punctuation">(</span><span class="token class-name">User<span class="token punctuation">.</span>Role</span><span class="token punctuation">.</span><span class="token constant">USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ä¿å­˜ç”¨æˆ·ä»¥ç”ŸæˆID</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// åˆ›å»ºç”¨æˆ·çš„ç§äººç»„ç»‡æ ‡ç­¾</span>
    <span class="token class-name">String</span> privateTagId <span class="token operator">=</span> <span class="token constant">PRIVATE_TAG_PREFIX</span> <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token function">createPrivateOrgTag</span><span class="token punctuation">(</span>privateTagId<span class="token punctuation">,</span> username<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// åªåˆ†é…ç§äººç»„ç»‡æ ‡ç­¾</span>
    user<span class="token punctuation">.</span><span class="token function">setOrgTags</span><span class="token punctuation">(</span>privateTagId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è®¾ç½®ç§äººç»„ç»‡æ ‡ç­¾ä¸ºä¸»ç»„ç»‡æ ‡ç­¾</span>
    user<span class="token punctuation">.</span><span class="token function">setPrimaryOrg</span><span class="token punctuation">(</span>privateTagId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ç¼“å­˜ç»„ç»‡æ ‡ç­¾ä¿¡æ¯</span>
    orgTagCacheService<span class="token punctuation">.</span><span class="token function">cacheUserOrgTags</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>privateTagId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orgTagCacheService<span class="token punctuation">.</span><span class="token function">cacheUserPrimaryOrg</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> privateTagId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"User registered successfully with private organization tag: {}"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>ç”¨æˆ·ç™»å½•</h3>
<p>æ ¹æ®ä¼ æ¥çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼ŒæˆåŠŸå°±ç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œç»„ç»‡æ ‡ç­¾çš„ JWT Tokenï¼Œæ¥è®¤è¯ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¯æŒåç»­æ“ä½œ</p>
<h4>æµç¨‹</h4>
<ul>
<li>æ¥æ”¶ç”¨æˆ·ç™»å½•è¯·æ±‚ï¼Œè·å–ç”¨æˆ·åå’Œå¯†ç </li>
<li>æŸ¥è¯¢ç”¨æˆ·è®°å½•å¹¶éªŒè¯å¯†ç </li>
<li>åŠ è½½ç”¨æˆ·ç»„ç»‡æ ‡ç­¾ä¿¡æ¯</li>
<li>åŸºäºç”¨æˆ·ä¿¡æ¯å’Œç»„ç»‡æ ‡ç­¾ï¼Œç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œç»„ç»‡æ ‡ç­¾çš„ JWT Token</li>
<li>è¿”å›ç™»å½•æˆåŠŸå“åº”å’Œ Token</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<h4>æ¥å£è®¾è®¡</h4>
<ul>
<li>
<p>URL: /api/v1/users/login</p>
</li>
<li>
<p>Method: POST</p>
</li>
<li>
<p>Request Body:</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"string"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
<li>
<p>Response:</p>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token comment">// æˆåŠŸ</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Login successful"</span><span class="token punctuation">,</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"JWT_TOKEN_STRING"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token comment">// å¤±è´¥</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Invalid username or password"</span>
<span class="token punctuation">}</span>
</code></pre></div></li>
</ul>
<h4>å…·ä½“å®ç°</h4>
<p>åŒæ ·çš„ï¼Œç±»ä¼¼è¿˜æ˜¯åˆ†äº†ä¸‰å±‚æ¥è¿›è¡Œå®ç°</p>
<h5><code>UserController</code></h5>
<p>å…ˆåœ¨ Controller å±‚æ¥å¤„ç†è¯·æ±‚</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LogUtils<span class="token punctuation">.</span>PerformanceMonitor</span> monitor <span class="token operator">=</span> <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">startPerformanceMonitor</span><span class="token punctuation">(</span><span class="token string">"USER_LOGIN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
              request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span><span class="token string">"anonymous"</span><span class="token punctuation">,</span> <span class="token string">"LOGIN"</span><span class="token punctuation">,</span> <span class="token string">"validation"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_EMPTY_PARAMS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Username and password cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token class-name">String</span> username <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">authenticateUser</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LOGIN"</span><span class="token punctuation">,</span> <span class="token string">"authentication"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_INVALID_CREDENTIALS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token class-name">String</span> token <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> refreshToken <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">"LOGIN"</span><span class="token punctuation">,</span> <span class="token string">"token_generation"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Login successful"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
          <span class="token string">"token"</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span>
          <span class="token string">"refreshToken"</span><span class="token punctuation">,</span> refreshToken
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CustomException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"USER_LOGIN"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ç™»å½•å¤±è´¥: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å¤±è´¥: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"USER_LOGIN"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ç™»å½•å¼‚å¸¸: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å¼‚å¸¸: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Internal server error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…ˆåˆ¤æ–­è´¦å·åå’Œå¯†ç çš„åˆç†æ€§ï¼Œç„¶åä¼ åˆ° <code>userService</code> å±‚è¿›è¡ŒéªŒè¯</p>
<p>æ ¹æ®è¿”å›çš„ <code>username</code> æ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸ</p>
<p>æˆåŠŸå°±å¼€å§‹å»ºç«‹ JWT token</p>
<h5><code>UserService</code></h5>
<p>å¯¹åº” <code>Service</code> ä¸­çš„å®ç°æ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æŸ¥è¯¢ä¸‹ç”¨æˆ·æ˜¯å¦åœ¨æ•°æ®åº“é‡Œ</p>
<p>é€šè¿‡ä¸ <code>Repository</code> è¿›è¡Œæ•°æ®åº“äº¤äº’</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">authenticateUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">"Invalid username or password"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¯”è¾ƒè¾“å…¥çš„å¯†ç å’Œæ•°æ®åº“ä¸­å­˜å‚¨çš„åŠ å¯†å¯†ç æ˜¯å¦åŒ¹é…</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">PasswordUtil</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è‹¥ä¸åŒ¹é…ï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼ŒçŠ¶æ€ç ä¸º 401 Unauthorized</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">"Invalid username or password"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è®¤è¯æˆåŠŸï¼Œè¿”å›ç”¨æˆ·çš„ç”¨æˆ·å</span>
  <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>JWT Token</h5>
<p>åœ¨ Service å±‚å®Œæˆäº¤äº’è¿”å›ç”¨æˆ·åå­—åï¼Œ<code>Controller</code>å±‚è¿˜éœ€è¦ç»§ç»­å®Œæˆé€»è¾‘ï¼Œå…ˆæ ¡éªŒç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨å†å°†å…¶æ”¾åˆ° JWT Token ä¼ å›</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LOGIN"</span><span class="token punctuation">,</span> <span class="token string">"authentication"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_INVALID_CREDENTIALS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">String</span> token <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> refreshToken <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">"LOGIN"</span><span class="token punctuation">,</span> <span class="token string">"token_generation"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Login successful"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
  <span class="token string">"token"</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span>
  <span class="token string">"refreshToken"</span><span class="token punctuation">,</span> refreshToken
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯¹åº”çš„ JWT ç”Ÿæˆå·¥å…·å°è£…åœ¨ JwtUtils ä¸‹</p>
<p>ä¸€ä¸ªJWTä»¤ç‰Œç”±3éƒ¨åˆ†ç»„æˆï¼šæ ‡å¤´(Header)ã€æœ‰æ•ˆè½½è·(Payload)å’Œç­¾å(Signature)</p>
<p>åœ¨ä¼ è¾“çš„æ—¶å€™ï¼Œä¼šå°†JWTçš„å‰2éƒ¨åˆ†åˆ†åˆ«è¿›è¡ŒBase64ç¼–ç åç”¨.è¿›è¡Œè¿æ¥å½¢æˆæœ€ç»ˆéœ€è¦ä¼ è¾“çš„å­—ç¬¦ä¸²ã€‚</p>
<ul>
<li>
<p>æ ‡å¤´ï¼šåŒ…å«ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚JWTç­¾åæ‰€ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œè¿˜æœ‰ç±»å‹ï¼Œè¿™é‡Œç»Ÿä¸€éƒ½æ˜¯JWTã€‚</p>
</li>
<li>
<p>æœ‰æ•ˆè½½è·ï¼šåŒ…æ‹¬ç”¨æˆ·åç§°ã€ä»¤ç‰Œå‘å¸ƒæ—¶é—´ã€è¿‡æœŸæ—¶é—´ã€JWT IDç­‰ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ·»åŠ å­—æ®µï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ä¿¡æ¯ä¸€èˆ¬éƒ½åœ¨è¿™é‡Œå­˜æ”¾ã€‚</p>
</li>
<li>
<p>ç­¾åï¼šé¦–å…ˆéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼Œè¯¥å¯†é’¥ä»…ä»…ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ï¼Œä¿è¯ä¸èƒ½è®©å…¶ä»–ç”¨æˆ·çŸ¥é“ã€‚ç„¶åä½¿ç”¨Headerä¸­æŒ‡å®šçš„ç®—æ³•å¯¹Headerå’ŒPayloadè¿›è¡Œbase64åŠ å¯†ä¹‹åçš„ç»“æœé€šè¿‡å¯†é’¥è®¡ç®—å“ˆå¸Œå€¼ï¼Œç„¶åå°±å¾—å‡ºä¸€ä¸ªç­¾åå“ˆå¸Œã€‚è¿™ä¸ªä¼šç”¨äºä¹‹åéªŒè¯å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹ã€‚è¿™æ ·å³ä½¿åˆ«äººæ”¹äº†å‰é¢ä¸¤ä¸ªçš„å†…å®¹ï¼Œä¼ å›æ¥é€šè¿‡ç§˜é’¥åŠ å¯†å¯¹æ¯”å°±ä¸ä¸€æ ·äº†</p>
</li>
</ul>
<p>æ ‡å¤´å’Œè½½è·ç›´æ¥é€šè¿‡ base64 ç¼–/è§£ç ï¼Œä½†è¦éªŒè¯æœ‰æ•ˆæ€§ï¼Œå¿…é¡»æ ¹æ®æ ‡å¤´å’Œè½½è·çš„base64ç¼–ç å€¼åˆ©ç”¨å¯¹åº”åŠ å¯†ç®—æ³•å’ŒæŒ‡å®šç§˜é’¥åŠ å¯†åï¼Œä¸ç­¾åæ¯”å¯¹</p>
<h5>åŒ Token æœºåˆ¶</h5>
<p>è¿™é‡Œç™»å½•é‡‡ç”¨äº†åŒ Token æœºåˆ¶ï¼Œæ¥è§£å†³ Token è¢«åˆ«äººæ¶æ„æˆªè·çš„æƒ…å†µ</p>
<p>JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œåç«¯ä¸ä¿å­˜å®ƒã€‚å¦‚æœ Token è¢«å·ä¸”æœ‰æ•ˆæœŸå¾ˆé•¿ï¼ˆæ¯”å¦‚ 7 å¤©ï¼‰ï¼Œé‚£é»‘å®¢å°±èƒ½æ¨ªè¡Œ 7 å¤©ã€‚</p>
<ul>
<li>åŒ Token æœºåˆ¶ï¼ˆAccess + Refreshï¼‰ï¼š
<ul>
<li>Access Tokenï¼šæœ‰æ•ˆæœŸæçŸ­ï¼ˆå¦‚ 15 åˆ†é’Ÿï¼‰ï¼Œè´Ÿè´£æ—¥å¸¸æ¥å£è®¿é—®ã€‚</li>
<li>Refresh Tokenï¼šæœ‰æ•ˆæœŸè¾ƒé•¿ï¼ˆå¦‚ 7 å¤©ï¼‰ï¼Œä»…ç”¨äºæ¢å–æ–°çš„ Access Tokenã€‚</li>
</ul>
</li>
</ul>
<p>æ•ˆæœï¼šå³ä½¿ Access Token è¢«æˆªè·ï¼Œé»‘å®¢ä¹Ÿåªèƒ½æ“ä½œ 15 åˆ†é’Ÿã€‚ç”±äº Refresh Token çš„è°ƒç”¨é¢‘ç‡æä½ï¼Œè¢«æˆªè·çš„æ¦‚ç‡ä¹Ÿå°å¾—å¤š</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">String</span> token <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> refreshToken <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åˆ†åˆ«åˆ›äº†ä¸¤ä¸ª tokenï¼Œå‡ä¿å­˜åˆ° redis ä¸­</p>
<p>ç¬¬ä¸€ä¸ª token æœ‰æ•ˆæœŸæ˜¯ 1 hï¼ŒåŒ…å«äº†ç”¨æˆ·çš„ä¿¡æ¯+ç»„ç»‡+ä¸»ç»„ç»‡ä»¥åŠ uuidç”Ÿæˆçš„å”¯ä¸€tokenIdï¼Œå› æ­¤æœ‰æ•ˆæœŸçŸ­ï¼Œè´Ÿè´£æ—¥å¸¸æ¥å£è®¿é—®</p>
<p>ç¬¬äºŒä¸ª token æ˜¯ refreshTokenï¼Œå°±åŒ…å«äº† uuidç”Ÿæˆçš„å”¯ä¸€tokenId, ä»¥åŠç”¨æˆ·åå­—ï¼Œä¸»è¦ç›®çš„æ˜¯å¯ä»¥åŸºäºè¿™ä¸ªæ¥åˆ·æ–°è·å– ç¬¬ä¸€ä¸ªtoken</p>
<p>å³ä½¿ Access Token è¢«æˆªè·ï¼Œé»‘å®¢ä¹Ÿåªèƒ½æ“ä½œ 15 åˆ†é’Ÿã€‚ç”±äº Refresh Token çš„è°ƒç”¨é¢‘ç‡æä½ï¼Œè¢«æˆªè·çš„æ¦‚ç‡ä¹Ÿå°å¾—å¤š</p>
<p>ä¸ºäº†è®©è¿™ä¸ªæœºåˆ¶çœŸæ­£ç”Ÿæ•ˆï¼Œå…·ä½“æµç¨‹åº”è¯¥æ˜¯ï¼š</p>
<ul>
<li>
<p>å¹³æ—¶ï¼šå‰ç«¯åœ¨è¯·æ±‚å¤´ï¼ˆå¦‚ Authorization: Bearer <code>token</code>ï¼‰ä¸­æºå¸¦ tokenã€‚åç«¯æ ¡éªŒè¿™ä¸ªçŸ­æ•ˆ Tokenã€‚</p>
</li>
<li>
<p>è¿‡æœŸæ—¶ï¼šå½“ token è¿‡æœŸï¼Œåç«¯è¿”å› 401 Unauthorizedã€‚</p>
</li>
<li>
<p>é™é»˜åˆ·æ–°ï¼šå‰ç«¯æ‹¦æˆªåˆ° 401 åï¼Œä¸è·³è½¬ç™»å½•é¡µï¼Œè€Œæ˜¯è‡ªåŠ¨è°ƒç”¨å¦ä¸€ä¸ª /refresh æ¥å£ï¼ŒæŠŠ refreshToken å‘ç»™åç«¯ã€‚</p>
</li>
<li>
<p>ç»­æœŸï¼šåç«¯æ ¡éªŒ refreshToken æœ‰æ•ˆåï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ token è¿”å›ã€‚å‰ç«¯æ‹¿åˆ°æ–° Token åé‡è¯•åˆšæ‰å¤±è´¥çš„è¯·æ±‚ã€‚ç”¨æˆ·å…¨ç¨‹æ— æ„ŸçŸ¥ã€‚</p>
</li>
</ul>
<h3>ç”¨æˆ·æ³¨é”€</h3>
<p>ç”¨æˆ·é€€å‡ºï¼Œå¦‚æœ token æ²¡è¿‡æœŸï¼Œéœ€è¦ä¸»åŠ¨å°†å…¶æ”¾å…¥é»‘åå•é‡Œ</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ç”¨æˆ·ç™»å‡ºæ¥å£</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LogUtils<span class="token punctuation">.</span>PerformanceMonitor</span> monitor <span class="token operator">=</span> <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">startPerformanceMonitor</span><span class="token punctuation">(</span><span class="token string">"USER_LOGOUT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>token<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span><span class="token string">"anonymous"</span><span class="token punctuation">,</span> <span class="token string">"LOGOUT"</span><span class="token punctuation">,</span> <span class="token string">"validation"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_INVALID_TOKEN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å‡ºå¤±è´¥ï¼štokenæ ¼å¼æ— æ•ˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Invalid token format"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token class-name">String</span> jwtToken <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      username <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">extractUsernameFromToken</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> username<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span><span class="token string">"anonymous"</span><span class="token punctuation">,</span> <span class="token string">"LOGOUT"</span><span class="token punctuation">,</span> <span class="token string">"token_extraction"</span><span class="token punctuation">,</span> <span class="token string">"FAILED_NO_USERNAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å‡ºå¤±è´¥ï¼šæ— æ³•æå–ç”¨æˆ·å"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Invalid token"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ä½¿å½“å‰tokenå¤±æ•ˆ</span>
      jwtUtils<span class="token punctuation">.</span><span class="token function">invalidateToken</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logUserOperation</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">"LOGOUT"</span><span class="token punctuation">,</span> <span class="token string">"token_invalidation"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å‡ºæˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Logout successful"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">logBusinessError</span><span class="token punctuation">(</span><span class="token string">"USER_LOGOUT"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token string">"ç™»å‡ºå¼‚å¸¸: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      monitor<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"ç™»å‡ºå¼‚å¸¸: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"Internal server error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆä¼šæ ¹æ®ä¼ æ¥çš„ JWT Token è§£æç”¨æˆ·åæ¥åˆ¤æ–­æ˜¯å¦æ­£ç¡®ï¼Œç„¶åç™»å‡ºï¼Œä¼šå°† token æ‹‰å…¥é»‘åå• <code>jwtUtils.invalidateToken(jwtToken)</code></p>
<p>è€Œå¯¹åº”çš„é»‘åå•çš„æœ‰æ•ˆæœŸå°±æ˜¯è¿™ä¸ªtokenå‰©ä½™çš„æ—¶é•¿å³å¯</p>
<p>å­˜åœ¨ redis å¯¹åº”çš„ key ä¸º<code>jwt:blacklist:token_id</code> Stringç±»å‹ï¼Œvalueä¸ºå¯¹åº” <code>System.currentTimeMillis()</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invalidateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> tokenId <span class="token operator">=</span> <span class="token function">extractTokenIdFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tokenId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">extractClaimsIgnoreExpiration</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">long</span> expireTime <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">String</span> userId <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              
              <span class="token comment">// åŠ å…¥é»‘åå•</span>
              tokenCacheService<span class="token punctuation">.</span><span class="token function">blacklistToken</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// ä»ç¼“å­˜ä¸­ç§»é™¤</span>
              tokenCacheService<span class="token punctuation">.</span><span class="token function">removeToken</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
              
              logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Token invalidated: {}"</span><span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error invalidating token"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
  </channel>
</rss>