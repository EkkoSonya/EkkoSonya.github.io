<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="http://ekkosonya.cn/rss.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <atom:link href="http://ekkosonya.cn/rss.xml" rel="self" type="application/rss+xml"/>
    <title>EkkoSonya&amp;apos;s Blog</title>
    <link>http://ekkosonya.cn/</link>
    <description>笔记记录</description>
    <language>zh-CN</language>
    <pubDate>Sat, 22 Nov 2025 04:06:50 GMT</pubDate>
    <lastBuildDate>Sat, 22 Nov 2025 04:06:50 GMT</lastBuildDate>
    <generator>@vuepress/plugin-feed</generator>
    <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
    <category>code</category>
    <item>
      <title>Javassm - item1-14 (用户下单 + 订单支付 1)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article14.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article14.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-14 (用户下单 + 订单支付 1)</source>
      <description>内容 导入地址簿功能代码 用户下单 订单支付 导入地址簿功能代码 需求分析 产品原型 地址簿，指的是消费者用户的地址信息，用户登录成功后可以维护自己的地址信息。同一个用户可以有多个地址信息，但是只能有一个默认地址 alt textalt text 对于地址簿管理，我们需要实现以下几个功能： 查询地址列表 新增地址 修改地址 删除地址 设置默认地址 查询...</description>
      <category>code</category>
      <pubDate>Tue, 18 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>导入地址簿功能代码</li>
<li>用户下单</li>
<li>订单支付</li>
</ul>
<h2>导入地址簿功能代码</h2>
<h3>需求分析</h3>
<h4>产品原型</h4>
<p>地址簿，指的是消费者用户的地址信息，用户登录成功后可以维护自己的地址信息。同一个用户可以有多个地址信息，但是只能有一个<strong>默认地址</strong></p>
<figure><figcaption>alt text</figcaption></figure>
<p>对于地址簿管理，我们需要实现以下几个功能：</p>
<ul>
<li>查询地址列表</li>
<li>新增地址</li>
<li>修改地址</li>
<li>删除地址</li>
<li>设置默认地址</li>
<li>查询默认地址</li>
</ul>
<h4>接口设计</h4>
<p>根据上述原型图先<strong>粗粒度</strong>设计接口，共包含7个接口</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>新增地址</li>
<li>查询登录用户所有地址</li>
<li>查询默认地址</li>
<li>根据id修改地址</li>
<li>根据id删除地址</li>
<li>根据id查询地址</li>
<li>设置默认地址</li>
</ul>
<p>接下来<strong>细粒度</strong>分析每个接口，明确每个接口的请求方式、请求路径、传入参数和返回值</p>
<p>1). 新增地址 <code>POST /user/addressBook</code></p>
<p>2). 查询登录用户所有地址 <code>GET /user/addressBook/list</code></p>
<p>3). 查询默认地址 <code>GET /user/addressBook/default</code></p>
<p>4). 修改地址 <code>PUT /user/addressBook</code></p>
<p>5). 根据id删除地址 <code>DELETE /user/addressBook/{id}</code></p>
<p>6). 根据id查询地址 <code>GET /user/addressBook/{id}</code></p>
<p>7). 设置默认地址 <code>PUT /user/addressBook/default</code></p>
<h4>数据表设计 <code>address_book</code></h4>
<p>用户的地址信息会存储在address_book表，即地址簿表中。具体表结构如下：</p>
<p>| <strong>字段名</strong>    | <strong>数据类型</strong> | <strong>说明</strong>     | <strong>备注</strong>       |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-15 (用户下单 + 订单支付 2)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article15.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article15.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-15 (用户下单 + 订单支付 2)</source>
      <description>内容 导入地址簿功能代码 用户下单 订单支付 订单支付 微信支付介绍 前面的课程已经实现了用户下单，那接下来就是订单支付，就是完成付款功能。支付大家应该都不陌生了，在现实生活中经常购买商品并且使用支付功能来付款，在付款的时候可能使用比较多的就是微信支付和支付宝支付了。在苍穹外卖项目中，选择的就是微信支付这种支付方式。 要实现微信支付就需要注册微信支付的...</description>
      <category>code</category>
      <pubDate>Wed, 19 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>导入地址簿功能代码</li>
<li>用户下单</li>
<li>订单支付</li>
</ul>
<h2>订单支付</h2>
<h3>微信支付介绍</h3>
<p>前面的课程已经实现了用户下单，那接下来就是订单支付，就是完成付款功能。支付大家应该都不陌生了，在现实生活中经常购买商品并且使用支付功能来付款，在付款的时候可能使用比较多的就是微信支付和支付宝支付了。在苍穹外卖项目中，选择的就是<strong>微信支付</strong>这种支付方式。</p>
<p>要实现微信支付就需要注册微信支付的一个商户号，这个商户号是必须要有一家企业并且有正规的营业执照。只有具备了这些资质之后，才可以去注册商户号，才能开通支付权限。</p>
<p>个人不具备这种资质，所以我们在学习微信支付时，最重要的是了解微信支付的流程，并且能够阅读微信官方提供的接口文档，能够和第三方支付平台对接起来就可以了。</p>
<p>本项目选择<strong>小程序支付</strong></p>
<p>参考：<a href="https://pay.weixin.qq.com/static/product/product_index.shtml" target="_blank" rel="noopener noreferrer">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<h4>微信小程序支付时序图</h4>
<figure><figcaption>alt text</figcaption></figure>
<p>用户首先去小程序下单，然后商户系统(后端)会设置订单号什么返回前端，之后用户准备支付时，向后端发起申请，然后后端去调用 <strong>微信下单接口</strong> (JSAPI下单) 微信支付服务后台生成预支付交易单(对应时序图的第5步)</p>
<p>之后将对应参数返回给前端，然后用户基于此可以进行支付，从而在前端调用了小程序支付(对应时序图的第10步)，最后返回支付结果在前端。</p>
<p>同时，后端收到来自微信后台的推送，从而进一步更新对应订单的状态</p>
<h4>微信相关接口</h4>
<h5>JSAPI下单</h5>
<p>商户系统调用该接口在微信支付服务后台生成预支付交易单(对应时序图的第5步)</p>
<figure><figcaption>alt text</figcaption></figure>
<h5>微信小程序调起支付 (前端用的)</h5>
<p>通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付(对应时序图的第10步)</p>
<figure><figcaption>alt text</figcaption></figure>
<h3>微信支付准备工作</h3>
<h4>证书设置</h4>
<p>完成微信支付有两个关键的步骤：</p>
<p><strong>第一个</strong>就是需要在商户系统当中调用微信后台的一个下单接口，就是生成预支付交易单。</p>
<p><strong>第二个</strong>就是支付成功之后微信后台会给推送消息。</p>
<p>这两个接口数据的安全性，要求其实是非常高的。</p>
<p>**解决：**微信提供的方式就是对数据进行加密、解密、签名多种方式。要完成数据加密解密，需要提前准备相应的一些文件，其实就是一些证书。</p>
<p>需要两个证书： 微信支付平台证书、商户私钥文件</p>
<h4>域名设置</h4>
<p>微信后台会调用到商户系统给推送支付的结果，在这里我们就会遇到一个问题，就是微信后台怎么就能调用到我们这个商户系统呢？因为这个调用过程，其实本质上也是一个HTTP请求。</p>
<p>目前，商户系统它的ip地址就是当前自己电脑的ip地址，只是一个局域网内的ip地址，微信后台无法调用到。</p>
<p><strong>解决：<strong>内网穿透。通过</strong>cpolar软件</strong>可以获得一个临时域名，而这个临时域名是一个公网ip，这样，微信后台就可以请求到商户系统了</p>
<h3>代码导入</h3>
<h4>微信支付相关配置</h4>
<p>application-dev.yml</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">sky</span><span class="token punctuation">:</span>
  <span class="token key atrule">wechat</span><span class="token punctuation">:</span>
    <span class="token key atrule">appid</span><span class="token punctuation">:</span> wxcd2e39f677fd30ba
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> 84fbfdf5ea288f0c432d829599083637
    <span class="token key atrule">mchid</span> <span class="token punctuation">:</span> <span class="token number">1561414331</span>
    <span class="token key atrule">mchSerialNo</span><span class="token punctuation">:</span> 4B3B3DC35414AD50B1B755BAF8DE9CC7CF407606
    <span class="token key atrule">privateKeyFilePath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\apiclient_key.pem
    <span class="token key atrule">apiV3Key</span><span class="token punctuation">:</span> CZBK51236435wxpay435434323FFDuv3
    <span class="token key atrule">weChatPayCertFilePath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem
    <span class="token key atrule">notifyUrl</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.weixin.qq.com/wxpay/pay.php
    <span class="token key atrule">refundNotifyUrl</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.weixin.qq.com/wxpay/pay.php
</code></pre></div><p>application.yml</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">sky</span><span class="token punctuation">:</span>
  <span class="token key atrule">wechat</span><span class="token punctuation">:</span>
    <span class="token key atrule">appid</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.appid<span class="token punctuation">}</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.secret<span class="token punctuation">}</span>
    <span class="token key atrule">mchid</span> <span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.mchid<span class="token punctuation">}</span>
    <span class="token key atrule">mchSerialNo</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.mchSerialNo<span class="token punctuation">}</span>
    <span class="token key atrule">privateKeyFilePath</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.privateKeyFilePath<span class="token punctuation">}</span>
    <span class="token key atrule">apiV3Key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.apiV3Key<span class="token punctuation">}</span>
    <span class="token key atrule">weChatPayCertFilePath</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.weChatPayCertFilePath<span class="token punctuation">}</span>
    <span class="token key atrule">notifyUrl</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.notifyUrl<span class="token punctuation">}</span>
    <span class="token key atrule">refundNotifyUrl</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.wechat.refundNotifyUrl<span class="token punctuation">}</span>
</code></pre></div><p>WeChatProperties.java：读取配置</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sky<span class="token punctuation">.</span>properties</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"sky.wechat"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span> <span class="token comment">//小程序的appid</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span> <span class="token comment">//小程序的秘钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchid<span class="token punctuation">;</span> <span class="token comment">//商户号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchSerialNo<span class="token punctuation">;</span> <span class="token comment">//商户API证书的证书序列号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKeyFilePath<span class="token punctuation">;</span> <span class="token comment">//商户私钥文件</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> apiV3Key<span class="token punctuation">;</span> <span class="token comment">//证书解密的密钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> weChatPayCertFilePath<span class="token punctuation">;</span> <span class="token comment">//平台证书</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span> <span class="token comment">//支付成功的回调地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refundNotifyUrl<span class="token punctuation">;</span> <span class="token comment">//退款成功的回调地址</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1. 实现后端预下单功能 (<code>payment</code> JSAPI下单)</h4>
<h5>Controller层</h5>
<p>在<code>OrderController.java</code>中添加payment方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 订单支付
*
* <span class="token keyword">@param</span> <span class="token parameter">ordersPaymentDTO</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/payment"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"订单支付"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderPaymentVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">payment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">OrdersPaymentDTO</span> ordersPaymentDTO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单支付：{}"</span><span class="token punctuation">,</span> ordersPaymentDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderPaymentVO</span> orderPaymentVO <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">payment</span><span class="token punctuation">(</span>ordersPaymentDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"生成预支付交易单：{}"</span><span class="token punctuation">,</span> orderPaymentVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>orderPaymentVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>Service层</h5>
<p>在<code>OrderService.java</code>中添加<code>payment</code>方法定义</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 订单支付
 * <span class="token keyword">@param</span> <span class="token parameter">ordersPaymentDTO</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">OrderPaymentVO</span> <span class="token function">payment</span><span class="token punctuation">(</span><span class="token class-name">OrdersPaymentDTO</span> ordersPaymentDTO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>OrderServiceImpl.java</code>中实现<code>payment</code>方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">WeChatPayUtil</span> weChatPayUtil<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 订单支付
 *
 * <span class="token keyword">@param</span> <span class="token parameter">ordersPaymentDTO</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">OrderPaymentVO</span> <span class="token function">payment</span><span class="token punctuation">(</span><span class="token class-name">OrdersPaymentDTO</span> ordersPaymentDTO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前登录用户id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">getCurrentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//调用微信支付接口，生成预支付交易单</span>
  <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> weChatPayUtil<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>
          ordersPaymentDTO<span class="token punctuation">.</span><span class="token function">getOrderNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//商户订单号</span>
          <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//支付金额，单位 元</span>
          <span class="token string">"苍穹外卖订单"</span><span class="token punctuation">,</span> <span class="token comment">//商品描述</span>
          user<span class="token punctuation">.</span><span class="token function">getOpenid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//微信用户的openid</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ORDERPAID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderBusinessException</span><span class="token punctuation">(</span><span class="token string">"该订单已支付"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">OrderPaymentVO</span> vo <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJavaObject</span><span class="token punctuation">(</span><span class="token class-name">OrderPaymentVO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vo<span class="token punctuation">.</span><span class="token function">setPackageStr</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>2. 实现支付成功后操作 (<code>paySuccess</code>)</h4>
<h5>Controller层</h5>
<p><code>PayNotifyController.java</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 支付回调相关接口
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/notify"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayNotifyController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">WeChatProperties</span> weChatProperties<span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * 支付成功回调
   *
   * <span class="token keyword">@param</span> <span class="token parameter">request</span>
   */</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/paySuccess"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paySuccessNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">//读取数据</span>
      <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token function">readData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"支付成功回调：{}"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//数据解密</span>
      <span class="token class-name">String</span> plainText <span class="token operator">=</span> <span class="token function">decryptData</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"解密后的文本：{}"</span><span class="token punctuation">,</span> plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> outTradeNo <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商户平台订单号</span>
      <span class="token class-name">String</span> transactionId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"transaction_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//微信支付交易号</span>

      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商户平台订单号：{}"</span><span class="token punctuation">,</span> outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"微信支付交易号：{}"</span><span class="token punctuation">,</span> transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//业务处理，修改订单状态、来单提醒</span>
      orderService<span class="token punctuation">.</span><span class="token function">paySuccess</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//给微信响应</span>
      <span class="token function">responseToWeixin</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * 读取数据
   *
   * <span class="token keyword">@param</span> <span class="token parameter">request</span>
   * <span class="token keyword">@return</span>
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">StringBuilder</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * 数据解密
   *
   * <span class="token keyword">@param</span> <span class="token parameter">body</span>
   * <span class="token keyword">@return</span>
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">decryptData</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">JSONObject</span> resultObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">JSONObject</span> resource <span class="token operator">=</span> resultObject<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> ciphertext <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ciphertext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> nonce <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> associatedData <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"associated_data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">AesUtil</span> aesUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AesUtil</span><span class="token punctuation">(</span>weChatProperties<span class="token punctuation">.</span><span class="token function">getApiV3Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//密文解密</span>
      <span class="token class-name">String</span> plainText <span class="token operator">=</span> aesUtil<span class="token punctuation">.</span><span class="token function">decryptToString</span><span class="token punctuation">(</span>associatedData<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              nonce<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * 给微信响应
   * <span class="token keyword">@param</span> <span class="token parameter">response</span>
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">responseToWeixin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JSONUtils</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>Service层</h5>
<p>在<code>OrderService.java</code>中添加<code>paySuccess</code>方法定义</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 支付成功，修改订单状态
 * <span class="token keyword">@param</span> <span class="token parameter">outTradeNo</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">paySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>OrderServiceImpl.java</code>中实现<code>paySuccess</code>方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 支付成功，修改订单状态
 *
 * <span class="token keyword">@param</span> <span class="token parameter">outTradeNo</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> outTradeNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前登录用户id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">getCurrentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 根据订单号查询当前用户的订单</span>
  <span class="token class-name">Orders</span> ordersDB <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByNumberAndUserId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span>
  <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>ordersDB<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">TO_BE_CONFIRMED</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">payStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">checkoutTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>Mapper层</h5>
<p>在<code>OrderMapper.java</code>中添加<code>getByNumberAndUserId</code>和<code>update</code>两个方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据订单号和用户id查询订单
 * <span class="token keyword">@param</span> <span class="token parameter">orderNumber</span>
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 */</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from orders where number = #{orderNumber} and user_id= #{userId}"</span><span class="token punctuation">)</span>
<span class="token class-name">Orders</span> <span class="token function">getByNumberAndUserId</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNumber<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 修改订单信息
 * <span class="token keyword">@param</span> <span class="token parameter">orders</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>OrderMapper.xml</code>中添加</p>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>update<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sky.entity.Orders<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  update orders
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cancelReason != null and cancelReason!='' <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          cancel_reason=#{cancelReason},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rejectionReason != null and rejectionReason!='' <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          rejection_reason=#{rejectionReason},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cancelTime != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          cancel_time=#{cancelTime},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>payStatus != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          pay_status=#{payStatus},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>payMethod != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          pay_method=#{payMethod},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkoutTime != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          checkout_time=#{checkoutTime},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>status != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          status = #{status},
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>deliveryTime != null<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          delivery_time = #{deliveryTime}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>
  where id = #{id}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-16 (订单定时 来单提醒 客户催单 1)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article16.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article16.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-16 (订单定时 来单提醒 客户催单 1)</source>
      <description>内容 Spring Task 订单状态定时处理 WebSocket 来单提醒 客户催单 功能实现：订单状态定时处理、来单提醒和客户催单 Spring Task Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑 定位：定时任务框架 作用：定时自动执行某段Java代码 应用场景 1). 信用卡每月还款提醒...</description>
      <category>code</category>
      <pubDate>Fri, 21 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>Spring Task</li>
<li>订单状态定时处理</li>
<li>WebSocket</li>
<li>来单提醒</li>
<li>客户催单</li>
</ul>
<p>功能实现：<strong>订单状态定时处理</strong>、<strong>来单提醒</strong>和<strong>客户催单</strong></p>
<h2>Spring Task</h2>
<p><strong>Spring Task</strong> 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑</p>
<p><strong>定位</strong>：定时任务框架</p>
<p><strong>作用</strong>：定时自动执行某段Java代码</p>
<h3>应用场景</h3>
<p>1). 信用卡每月还款提醒</p>
<p>2). 银行贷款每月还款提醒</p>
<p>3). 火车票售票系统处理未支付订单</p>
<p>4). 入职纪念日为用户发送通知</p>
<p><strong>强调</strong>：只要是需要定时处理的场景都可以使用Spring Task</p>
<h3>cron表达式</h3>
<p><strong>cron表达式</strong>其实就是一个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong></p>
<p>**构成规则：**分为6或7个域，由空格分隔开，每个域代表一个含义</p>
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)</p>
<figure><figcaption>alt text</figcaption></figure>
<p><strong>举例</strong>：</p>
<p>2022年10月12日上午9点整 对应的cron表达式为：<strong>0 0 9 12 10 ? 2022</strong></p>
<p><strong>说明</strong>：一般<strong>日</strong>和<strong>周</strong>的值不同时设置，其中一个设置，另一个用？表示。</p>
<p><strong>比如</strong>：描述2月份的最后一天，最后一天具体是几号呢？可能是28号，也有可能是29号，所以就不能写具体数字。</p>
<p>为了描述这些信息，提供一些特殊的字符。这些具体的细节，我们就不用自己去手写，因为这个cron表达式，它其实有在线生成器。</p>
<p>cron表达式在线生成器：<a href="https://cron.qqe2.com/" target="_blank" rel="noopener noreferrer">https://cron.qqe2.com/</a></p>
<h4>通配符</h4>
<ul>
<li>
<p><code>*</code> 表示所有值</p>
</li>
<li>
<p><code>?</code> 表示未说明的值，即不关心它为何值</p>
</li>
<li>
<p><code>-</code> 表示一个指定的范围</p>
</li>
<li>
<p><code>,</code> 表示附加一个可能值</p>
</li>
<li>
<p><code>/</code> 符号前表示开始时间，符号后表示每次递增的</p>
</li>
</ul>
<h4>cron表达式案例</h4>
<ul>
<li>
<p><code>23 0 0/1 L * ? *</code> 本月最后一天从0小时开始, 每一小时执行一次</p>
</li>
<li>
<p><code>*/5 * * * * ?</code> 每隔5秒执行一次</p>
</li>
<li>
<p><code>0 */1 * * * ?</code> 每隔1分钟执行一次</p>
</li>
<li>
<p><code>0 0 5-15 * * ?</code> 每天5-15点整点触发</p>
</li>
<li>
<p><code>0 0/3 * * * ?</code> 每三分钟触发一次</p>
</li>
<li>
<p><code>0 0-5 14 * * ?</code> 在每天下午2点到下午2:05期间的每1分钟触发</p>
</li>
<li>
<p><code>0 0/5 14 * * ?</code> 在每天下午2点到下午2:55期间的每5分钟触发</p>
</li>
<li>
<p><code>0 0/5 14,18 * * ?</code> 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发</p>
</li>
<li>
<p><code>0 0/30 9-17 * * ?</code> 朝九晚五工作时间内每半小时</p>
</li>
<li>
<p><code>0 0 10,14,16 * * ?</code> 每天上午10点，下午2点，4点</p>
</li>
</ul>
<h3>简单示例</h3>
<h4>1. 导入<code>maven</code>坐标 <code>spring-context</code></h4>
<h4>2. 启动类添加注解开启任务调度 <code>@EnableScheduling</code></h4>
<h4>3.自定义定时任务类 <code>@Scheduled</code></h4>
<p>对应方法没有返回值，且名字随意</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 自定义定时任务类
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 定时任务 每隔5秒触发一次
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"定时任务开始执行：{}"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>订单状态定时处理</h2>
<h3>需求分析</h3>
<p>用户下单后可能存在的情况：</p>
<ul>
<li>下单后未支付，订单一直处于<strong>待支付</strong>状态</li>
<li>用户收货后管理端未点击完成按钮，订单一直处于<strong>派送中</strong>状态</li>
</ul>
<p>对于上面两种情况需要通过<strong>定时任务</strong>来修改订单状态，具体逻辑为：</p>
<ul>
<li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li>
<li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li>
</ul>
<h3>代码开发</h3>
<p>自定义定时任务类<code>OrderTask</code></p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTask</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 处理支付超时订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processTimeoutOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理支付超时订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// select * from orders where status = 1 and order_time &lt; 当前时间-15分钟</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> ordersList <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByStatusAndOrderTimeLT</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">PENDING_PAYMENT</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ordersList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ordersList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            ordersList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setCancelReason</span><span class="token punctuation">(</span><span class="token string">"支付超时，自动取消"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setCancelTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 处理“派送中”状态的订单
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 0 1 * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processDeliveryOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理派送中订单：{}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// select * from orders where status = 4 and order_time &lt; 当前时间-1小时</span>
        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> ordersList <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByStatusAndOrderTimeLT</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">DELIVERY_IN_PROGRESS</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>ordersList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ordersList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            ordersList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在OrderMapper接口中扩展方法:</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据状态和下单时间查询订单
 * <span class="token keyword">@param</span> <span class="token parameter">status</span>
 * <span class="token keyword">@param</span> <span class="token parameter">orderTime</span>
 */</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from orders where status = #{status} and order_time &lt; #{orderTime}"</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">getByStatusAndOrdertimeLT</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> orderTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-17 (订单定时 来单提醒 客户催单 2)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article17.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article17.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-17 (订单定时 来单提醒 客户催单 2)</source>
      <description>内容 Spring Task 订单状态定时处理 WebSocket 来单提醒 客户催单 功能实现：订单状态定时处理、来单提醒和客户催单 WebSocket WebSocket 是基于 TCP 的一种新的网络协议。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接， 并进行双向数据传输。 HTTP协议和W...</description>
      <category>code</category>
      <pubDate>Fri, 21 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>Spring Task</li>
<li>订单状态定时处理</li>
<li>WebSocket</li>
<li>来单提醒</li>
<li>客户催单</li>
</ul>
<p>功能实现：<strong>订单状态定时处理</strong>、<strong>来单提醒</strong>和<strong>客户催单</strong></p>
<h2>WebSocket</h2>
<p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。</p>
<p><strong>HTTP协议和WebSocket协议对比</strong></p>
<ul>
<li>HTTP是<strong>短连接</strong></li>
<li>WebSocket是<strong>长连接</strong></li>
<li>HTTP通信是<strong>单向</strong>的，基于请求响应模式</li>
<li>WebSocket支持<strong>双向</strong>通信</li>
<li>HTTP和WebSocket底层都是TCP连接</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<h3>WebSocket缺点</h3>
<p>服务器长期维护长连接需要一定的成本
各个浏览器支持程度不一
WebSocket 是长连接，受网络限制比较大，需要处理好重连</p>
<p>WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</p>
<h3>WebSocket应用场景</h3>
<p>1). 视频弹幕</p>
<p>2). 网页聊天</p>
<p>3). 体育实况更新</p>
<p>4). 股票基金报价实时更新</p>
<h3>简单案例</h3>
<p>实现浏览器与服务器全双工通信。浏览器既可以向服务器发送消息，服务器也可主动向浏览器推送消息</p>
<h4>1). 导入WebSocket的maven坐标</h4>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4>2). 导入WebSocket服务端组件WebSocketServer，用于和客户端通信</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * WebSocket服务
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/ws/{sid}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketServer</span> <span class="token punctuation">{</span>

    <span class="token comment">//存放会话对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> sessionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 连接建立成功调用的方法
     */</span>
    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端："</span> <span class="token operator">+</span> sid <span class="token operator">+</span> <span class="token string">"建立连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sessionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 收到客户端消息后调用的方法
     *
     * <span class="token keyword">@param</span> <span class="token parameter">message</span> 客户端发送过来的消息
     */</span>
    <span class="token annotation punctuation">@OnMessage</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到来自客户端："</span> <span class="token operator">+</span> sid <span class="token operator">+</span> <span class="token string">"的信息:"</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 连接关闭调用的方法
     *
     * <span class="token keyword">@param</span> <span class="token parameter">sid</span>
     */</span>
    <span class="token annotation punctuation">@OnClose</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接断开:"</span> <span class="token operator">+</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sessionMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 群发
     *
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> sessionMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Session</span> session <span class="token operator">:</span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//服务器向客户端发送消息</span>
                session<span class="token punctuation">.</span><span class="token function">getBasicRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendText</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4>3). 导入配置类<code>WebSocketConfiguration</code>，注册WebSocket的服务端组件</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * WebSocket配置类，用于注册WebSocket的Bean
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfiguration</span> <span class="token punctuation">{</span>

    <span class="token comment">// 作用是将 WebSocket 端点（如 @ServerEndpoint 注解的类）注册为 Spring 管理的 Bean</span>
    <span class="token comment">// ServerEndpointExporter 会扫描带有 @ServerEndpoint 注解的类，并自动将它们注册为 WebSocket 端点。</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServerEndpointExporter</span> <span class="token function">serverEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>4). 导入定时任务类WebSocketTask，定时向客户端推送数据</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketTask</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WebSocketServer</span> webSocketServer<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 通过WebSocket每隔5秒向客户端发送消息
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessageToClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token string">"这是来自服务端的消息："</span> <span class="token operator">+</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>来单提醒</h2>
<h3>需求分析和设计</h3>
<p>用户下单并且支付成功后，需要第一时间通知外卖商家。</p>
<p>通知的形式有如下两种：</p>
<ul>
<li>语音播报</li>
<li>弹出提示框</li>
</ul>
<h4>设计思路</h4>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当客户支付后，调用WebSocket的相关API实现服务端向管理端页面推送消息</li>
<li>管理端页面客户浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li>
<li>约定服务端发送给管理端浏览器的数据格式为JSON，字段包括：type，orderId，content
<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<p>其实就是后端与管理端之间建立<code>socket</code>, 用户端不需要，只是在支付完成时来触发后端通知</p>
<h3>代码开发</h3>
<p>在OrderServiceImpl中注入WebSocketServer对象，修改paySuccess方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">WebSocketServer</span> webSocketServer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> outTradeNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前登录用户id</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">getCurrentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据订单号查询当前用户的订单</span>
    <span class="token class-name">Orders</span> ordersDB <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getByNumberAndUserId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>ordersDB<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">TO_BE_CONFIRMED</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">payStatus</span><span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">checkoutTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    orderMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消息类型，1表示来单提醒</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"orderId"</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"订单号："</span> <span class="token operator">+</span> outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过WebSocket实现来单提醒，向管理端浏览器推送消息</span>
    webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>客户催单</h2>
<h3>需求分析和设计</h3>
<p>用户在小程序中点击催单按钮后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报</li>
<li>弹出提示框</li>
</ul>
<h3>设计思路</h3>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报
约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content
<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<p>当用户点击催单按钮时，向服务端发送请求</p>
<h4>接口设计(催单)</h4>
<figure><figcaption>alt text</figcaption></figure>
<h3>代码开发</h3>
<h4>Controller层</h4>
<p>根据用户催单的接口定义，在<code>user/OrderController</code>中创建催单方法</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 客户催单
 * <span class="token keyword">@param</span> <span class="token parameter">orderId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/reminder/{orderId}"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"催单"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户催单：{}"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderService<span class="token punctuation">.</span><span class="token function">reminder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>Service层</h4>
<h5>接口层</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户催单
 * <span class="token keyword">@param</span> <span class="token parameter">id</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5>实现层</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 客户催单
 * <span class="token keyword">@param</span> <span class="token parameter">orderId</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reminder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Orders</span> ordersDB <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ordersDB <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderBusinessException</span><span class="token punctuation">(</span><span class="token class-name">MessageConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消息类型，2表示客户催单</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"orderId"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"订单号："</span> <span class="token operator">+</span> ordersDB<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过WebSocket实现来单提醒，向管理端浏览器推送消息</span>
    webSocketServer<span class="token punctuation">.</span><span class="token function">sendToAllClient</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-12 (缓存商品 + 购物车 1)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article12.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article12.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-12 (缓存商品 + 购物车 1)</source>
      <description>内容 缓存菜品 缓存套餐 添加购物车 查看购物车 清空购物车 功能实现：缓存商品、购物车 缓存菜品 问题说明 用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大 实现思路 通过Redis来缓存菜品数据，减少数据库查询操作 alt textalt text 缓存逻辑分析 每个分类下的菜品保存一份缓存数据 数据...</description>
      <category>code</category>
      <pubDate>Fri, 14 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>缓存菜品</li>
<li>缓存套餐</li>
<li>添加购物车</li>
<li>查看购物车</li>
<li>清空购物车</li>
</ul>
<p>功能实现：<strong>缓存商品</strong>、<strong>购物车</strong></p>
<h2>缓存菜品</h2>
<h3>问题说明</h3>
<p>用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大</p>
<h3>实现思路</h3>
<p>通过Redis来缓存菜品数据，减少数据库查询操作</p>
<figure><figcaption>alt text</figcaption></figure>
<p><strong>缓存逻辑分析</strong></p>
<ul>
<li>每个分类下的菜品保存一份缓存数据</li>
<li>数据库中菜品数据有变更时清理缓存数据</li>
</ul>
<p>key 为对应分类id, value 为对应菜品列表序列化结果字符串</p>
<figure><figcaption>alt text</figcaption></figure>
<h3>代码开发</h3>
<h4>1. 修改用户端接口 DishController 的 list 方法，加入缓存处理逻辑</h4>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 根据分类id查询菜品
 *
 * <span class="token keyword">@param</span> <span class="token parameter">categoryId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"根据分类id查询菜品"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Long</span> categoryId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"dish_"</span> <span class="token operator">+</span> categoryId<span class="token punctuation">;</span>
  <span class="token comment">// 查询 redis 是否存在对应菜品数据</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DishVO</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 存在 就直接返回</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果不存在 去对应数据表查找</span>
  <span class="token class-name">Dish</span> dish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dish<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>categoryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dish<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">StatusConstant</span><span class="token punctuation">.</span><span class="token constant">ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查询起售中的菜品</span>

  list <span class="token operator">=</span> dishService<span class="token punctuation">.</span><span class="token function">listWithFlavor</span><span class="token punctuation">(</span>dish<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将查询数据放入 redis 缓存中</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>2. 数据一致性</h4>
<p>为了保证<strong>数据库</strong>和<strong>Redis</strong>中的数据保持一致，修改<strong>管理端接口 DishController</strong> 的相关方法，加入清理缓存逻辑。</p>
<p>需要改造的方法：</p>
<ul>
<li>新增菜品</li>
<li>修改菜品</li>
<li>批量删除菜品</li>
<li>起售、停售菜品</li>
</ul>
<p><strong>抽取清理缓存的方法：</strong></p>
<p>在管理端DishController中添加</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 清理缓存数据
 * <span class="token keyword">@param</span> <span class="token parameter">pattern</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cleanCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> pattern<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">Set</span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后就是在对应的方法进行缓存删除，一些复杂的就不考虑情况，直接全删了</p>
<h2>缓存套餐</h2>
<h3><code>Spring Cache</code></h3>
<p>Spring Cache 是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。</p>
<p>Spring Cache 提供了一层抽象，底层可以切换不同的缓存实现，例如：</p>
<ul>
<li>EHCache</li>
<li>Caffeine</li>
<li>Redis(常用)</li>
</ul>
<h4>起步依赖</h4>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4>常用注解</h4>
<p>在SpringCache中提供了很多缓存操作的注解，常见的是以下的几个：</p>
<p>| <strong>注解</strong>       | <strong>说明</strong>                                                     |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-13 (缓存商品 + 购物车 2)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article13.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article13.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-13 (缓存商品 + 购物车 2)</source>
      <description>内容 缓存菜品 缓存套餐 添加购物车 查看购物车 清空购物车 功能实现：缓存商品、购物车 添加购物车 用户可以将菜品或者套餐添加到购物车 对于菜品来说，如果设置了口味信息，则需要选择规格后才能加入购物车; 对于套餐来说，可以直接点击 + 号将当前套餐加入购物车 在购物车中可以修改菜品和套餐的数量，也可以清空购物车 接口设计 对应的添加购物车接口 (这是...</description>
      <category>code</category>
      <pubDate>Mon, 17 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>内容</h2>
<ul>
<li>缓存菜品</li>
<li>缓存套餐</li>
<li>添加购物车</li>
<li>查看购物车</li>
<li>清空购物车</li>
</ul>
<p>功能实现：<strong>缓存商品</strong>、<strong>购物车</strong></p>
<h2>添加购物车</h2>
<p>用户可以将菜品或者套餐添加到购物车</p>
<p>对于菜品来说，如果设置了口味信息，则需要选择规格后才能加入购物车;</p>
<p>对于套餐来说，可以直接点击 + 号将当前套餐加入购物车</p>
<p>在购物车中可以修改菜品和套餐的数量，也可以清空购物车</p>
<h3>接口设计</h3>
<p>对应的添加购物车接口 (这是加入购物车，所以一次是加入一个，不会同时存在dishId 和 setmealId)</p>
<figure><figcaption>alt text</figcaption></figure>
<h3>表设计</h3>
<p>用户的购物车数据，也是需要保存在数据库中的，购物车对应的数据表为shopping_cart表，具体表结构如下：</p>
<p>| <strong>字段名</strong>  | <strong>数据类型</strong>  | <strong>说明</strong>     | <strong>备注</strong> |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-10 (微信登录 + 商品浏览 1)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article10.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article10.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-10 (微信登录 + 商品浏览 1)</source>
      <description>HTTPClient HttpClient 是Apache Jakarta Common 下的子项目，可以用来提供高效的、最新的、功能丰富的支持 HTTP 协议的客户端编程工具包，并且它支持 HTTP 协议最新的版本和建议 HttpClient作用 发送HTTP请求 接收响应数据 应用场景 当我们在使用扫描支付、查看地图、获取验证码、查看天气等功能时，...</description>
      <category>code</category>
      <pubDate>Thu, 13 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>HTTPClient</h2>
<p>HttpClient 是Apache Jakarta Common 下的子项目，可以用来提供高效的、最新的、功能丰富的支持 HTTP 协议的客户端编程工具包，并且它支持 HTTP 协议最新的版本和建议</p>
<p><strong>HttpClient作用</strong></p>
<ul>
<li>发送HTTP请求</li>
<li>接收响应数据</li>
</ul>
<h3>应用场景</h3>
<p>当我们在使用扫描支付、查看地图、获取验证码、查看天气等功能时，其实，应用程序本身并未实现这些功能，都是在应用程序里访问提供这些功能的服务，访问这些服务需要发送HTTP请求，并且接收响应数据，可通过HttpClient来实现</p>
<h3><code>maven</code>坐标</h3>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.5.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>HttpClient的核心API</h3>
<ul>
<li>HttpClient：Http客户端对象类型，使用该类型对象可发起Http请求。</li>
<li>HttpClients：可认为是构建器，可创建HttpClient对象。</li>
<li>CloseableHttpClient：实现类，实现了HttpClient接口。</li>
<li>HttpGet：Get方式请求类型。</li>
<li>HttpPost：Post方式请求类型。</li>
</ul>
<h3>HttpClient发送请求步骤</h3>
<ul>
<li>创建HttpClient对象</li>
<li>创建Http请求对象</li>
<li>调用HttpClient的execute方法发送请求</li>
</ul>
<h3>简单案例</h3>
<h4>1. GET方式请求</h4>
<p>进入到sky-server模块，编写测试代码，发送GET请求。</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>创建HttpClient对象</li>
<li>创建请求对象</li>
<li>发送请求，接受响应结果</li>
<li>解析结果</li>
<li>关闭资源</li>
</ol>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpClientTest</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 测试通过httpclient发送GET方式的请求
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token comment">//创建httpclient对象</span>
        <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//创建请求对象</span>
        <span class="token class-name">HttpGet</span> httpGet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/user/shop/status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发送请求，接受响应结果</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpGet<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取服务端返回的状态码</span>
        <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务端返回的状态码为："</span> <span class="token operator">+</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务端返回的数据为："</span> <span class="token operator">+</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//关闭资源</span>
        response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>2. POST方式请求</h4>
<p>在HttpClientTest中添加POST方式请求方法</p>
<p>相比GET请求来说，POST请求若携带参数需要封装请求体对象，并将该对象设置在请求对象中。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>创建HttpClient对象</li>
<li>创建请求对象</li>
<li>发送请求，接收响应结果</li>
<li>解析响应结果</li>
<li>关闭资源</li>
</ol>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 测试通过httpclient发送POST方式的请求
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPOST</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">// 创建httpclient对象</span>
    <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建请求对象</span>
    <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/admin/employee/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">StringEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定请求编码方式</span>
    entity<span class="token punctuation">.</span><span class="token function">setContentEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据格式</span>
    entity<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//发送请求</span>
    <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//解析返回结果</span>
    <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"响应码为："</span> <span class="token operator">+</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpEntity</span> entity1 <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"响应数据为："</span> <span class="token operator">+</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//关闭资源</span>
    response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-11 (微信登录 + 商品浏览 2)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article11.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article11.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-11 (微信登录 + 商品浏览 2)</source>
      <description>微信小程序开发 小程序是一种新的开放能力，开发者可以快速地开发一个小程序。可以在微信内被便捷地获取和传播，同时具有出色的使用体验 入门案例 实际上，小程序的开发本质上属于前端开发，主要使用JavaScript开发，咱们现在的定位主要还是在后端，所以，对于小程序开发简单了解即可 在进行小程序开发时，需要先去注册一个小程序，在注册的时候，它实际上又分成了不...</description>
      <category>code</category>
      <pubDate>Fri, 14 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>微信小程序开发</h2>
<p>小程序是一种新的开放能力，开发者可以快速地开发一个小程序。可以在微信内被便捷地获取和传播，同时具有出色的使用体验</p>
<h3>入门案例</h3>
<p>实际上，小程序的开发本质上属于前端开发，主要使用JavaScript开发，咱们现在的定位主要还是在后端，所以，对于小程序开发简单了解即可</p>
<p>在进行小程序开发时，需要先去注册一个小程序，在注册的时候，它实际上又分成了不同的注册的主体。我们可以以个人的身份来注册一个小程序，当然，也可以以企业政府、媒体或者其他组织的方式来注册小程序。那么，不同的主体注册小程序，最终开放的权限也是不一样的。比如以个人身份来注册小程序，是无法开通支付权限的。若要提供支付功能，必须是企业、政府或者其它组织等。所以，不同的主体注册小程序后，可开发的功能是不一样的。</p>
<p>小程序包含一个描述整体程序的 app 和多个描述各自页面的 page。一个小程序主体部分由三个文件组成，必须放在项目的根目录</p>
<p><strong>app.js</strong>：必须存在，主要存放小程序的逻辑代码</p>
<p><strong>app.json</strong>：必须存在，小程序配置文件，主要存放小程序的公共配置</p>
<p><strong>app.wxss</strong>：非必须存在，主要存放小程序公共样式表，类似于前端的CSS样式</p>
<p>对小程序主体三个文件了解后，其实一个小程序又有多个页面。比如说，有商品浏览页面、购物车的页面、订单支付的页面、商品的详情页面等等，存放在pages目录</p>
<p>主要编写语法可以看文档，类似Vue</p>
<h3>实现微信登录</h3>
<h4>微信登录流程</h4>
<p>微信登录：<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" target="_blank" rel="noopener noreferrer">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</a></p>
<figure><figcaption>alt text</figcaption></figure>
<h5>步骤分析</h5>
<ol>
<li>小程序端，调用<code>wx.login()</code>获取code，就是授权码。</li>
<li>小程序端，调用<code>wx.request()</code>发送请求并携带code，请求开发者服务器(自己编写的后端服务)。</li>
<li>开发者服务端，通过<code>HttpClient</code>向微信接口服务发送请求，并携带appId+appsecret+code三个参数。</li>
<li>开发者服务端，接收微信接口服务返回的数据，<code>session_key</code>+<code>opendId</code>等。<code>opendId</code>是微信用户的唯一标识。</li>
<li>开发者服务端，自定义登录态，生成令牌(token)和openid等数据返回给小程序端，方便后绪请求身份校验。</li>
<li>小程序端，收到自定义登录态，存储storage。</li>
<li>小程序端，后绪通过<code>wx.request()</code>发起业务请求时，携带<code>token</code>。</li>
<li>开发者服务端，收到请求后，通过携带的<code>token</code>，解析当前登录用户的id。</li>
<li>开发者服务端，身份校验通过后，继续相关的业务逻辑处理，最终返回业务数据。</li>
</ol>
<figure><figcaption>alt text</figcaption></figure>
<h4>需求分析</h4>
<p>用户进入到小程序的时候，微信授权登录之后才能点餐。需要获取当前微信用户的相关信息，比如昵称、头像等，这样才能够进入到小程序进行下单操作。是基于微信登录来实现小程序的登录功能，没有采用传统账户密码登录的方式。若第一次使用小程序来点餐，就是一个新用户，需要把这个新的用户保存到数据库当中完成自动注册。</p>
<p><strong>业务规则</strong></p>
<ul>
<li>基于微信登录实现小程序的登录功能</li>
<li>如果是新用户需要自动完成注册</li>
</ul>
<h4>接口设计</h4>
<p>通过微信登录的流程，如果要完成微信登录的话，最终就要获得微信用户的openid。</p>
<p>在小程序端获取授权码后，向后端服务发送请求，并携带授权码，这样后端服务在收到授权码后，就可以去请求微信接口服务。最终，后端向小程序返回openid和token等数据</p>
<p>基于上述的登录流程，就可以设计出该接口的<strong>请求参数</strong>和<strong>返回数据</strong></p>
<figure><figcaption>alt text</figcaption></figure>
<p><strong>说明</strong>：请求路径<code>/user/user/login</code>,第一个user代表用户端，第二个user代表用户模块。</p>
<h4>表设计</h4>
<p>当用户第一次使用小程序时，会完成自动注册，把用户信息存储到<strong>user</strong>表中</p>
<p>| <strong>字段名</strong>  | <strong>数据类型</strong> | <strong>说明</strong>           | <strong>备注</strong> |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-7 (营业状态设置1)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article7.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article7.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-7 (营业状态设置1)</source>
      <description>营业状态设置1 Redis介绍 Redis是一个基于内存的key-value结构数据库。Redis 是互联网技术领域使用最为广泛的存储中间件。 官网: https://redis.io 中文网: https://www.redis.net.cn/ key-value结构存储： 主要特点： 基于内存存储，读写性能高 适合存储热点数据（热点商品、资讯、新闻...</description>
      <category>code</category>
      <pubDate>Wed, 12 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>营业状态设置1</h2>
<h3>Redis介绍</h3>
<p>Redis是一个基于<strong>内存</strong>的key-value结构数据库。Redis 是互联网技术领域使用最为广泛的<strong>存储中间件</strong>。</p>
<p><strong>官网</strong>: <a href="https://redis.io" target="_blank" rel="noopener noreferrer">https://redis.io</a>
<strong>中文网</strong>: <a href="https://www.redis.net.cn/" target="_blank" rel="noopener noreferrer">https://www.redis.net.cn/</a></p>
<p><strong>key-value结构存储：</strong></p>
<p><strong>主要特点：</strong></p>
<ul>
<li>基于内存存储，读写性能高</li>
<li>适合存储热点数据（热点商品、资讯、新闻）</li>
<li>企业应用广泛</li>
</ul>
<p>Redis是用C语言开发的一个开源的高性能键值对(key-value)数据库，官方提供的数据是可以达到100000+的QPS（每秒内查询次数）。它存储的value类型比较丰富，也被称为结构化的NoSql数据库。</p>
<p>NoSql（Not Only SQL），不仅仅是SQL，泛指<strong>非关系型数据库</strong>。NoSql数据库并不是要取代关系型数据库，而是关系型数据库的补充。</p>
<p><strong>关系型数据库(RDBMS)：</strong></p>
<ul>
<li>Mysql</li>
<li>Oracle</li>
<li>DB2</li>
<li>SQLServer</li>
</ul>
<p><strong>非关系型数据库(NoSql)：</strong></p>
<ul>
<li>Redis</li>
<li>Mongo db</li>
<li>MemCached</li>
</ul>
<h4>基本命令</h4>
<p>启动：<code>redis-server.exe redis.conf</code></p>
<p>启动时默认创建了 16 个数据库</p>
<p>连接: <code>redis-cli.exe</code></p>
<p>通过redis-cli.exe命令默认连接的是本地的redis服务，并且使用默认6379端口。也可以通过指定如下参数连接：</p>
<ul>
<li>-h ip地址</li>
<li>-p 端口号</li>
<li>-a 密码（如果需要）</li>
</ul>
<h3>Redis数据类型</h3>
<h4>5种常用数据类型</h4>
<p>Redis存储的是key-value结构的数据，其中key是字符串类型，value有5种常用的数据类型：</p>
<ul>
<li>字符串 string</li>
<li>哈希 hash</li>
<li>列表 list</li>
<li>集合 set</li>
<li>有序集合 sorted set / zset</li>
</ul>
<h4>各自特点</h4>
<figure><figcaption>alt text</figcaption></figure>
<ul>
<li>字符串(string)：普通字符串，Redis中最简单的数据类型</li>
<li>哈希(hash)：也叫散列，类似于Java中的HashMap结构 (适合存对象)</li>
<li>列表(list)：按照插入顺序排序，可以有重复元素，类似于Java中的LinkedList (可以左右插入，适合存储跟顺序有关系的数据)</li>
<li>集合(set)：无序集合，没有重复元素，类似于Java中的HashSet</li>
<li>有序集合(sorted set/zset)：集合中每个元素关联一个分数(score)，根据分数升序排序，没有重复元素 (适合各种排行榜数据)</li>
</ul>
<h3>Redis常用命令</h3>
<p>在Mysql中是通过Sql语句来操作的，与数据类型无关，但在Redis中是不一样的，是根据数据类型不同，命令也不同</p>
<h4>字符串操作命令</h4>
<p>Redis 中字符串类型常用命令：</p>
<ul>
<li><code>SET key value</code>: 设置指定key的值</li>
<li><code>GET key</code>: 获取指定key的值</li>
<li><code>SETEX key seconds value</code>: 设置指定key的值，并将 key 的过期时间设为 seconds 秒 (短信验证码)</li>
<li><code>SETNX key value</code>: 只有在 key 不存在时设置 key 的值 (分布式锁)</li>
</ul>
<p>更多命令可以参考Redis中文网：<a href="https://www.redis.net.cn" target="_blank" rel="noopener noreferrer">https://www.redis.net.cn</a></p>
<h4>哈希操作命令 <code>H</code></h4>
<p>Redis hash 是一个<code>string</code>类型的 field 和 value 的映射表，hash特别适合用于存储对象，常用命令：</p>
<ul>
<li><code>HSET key field value</code>: 将哈希表 key 中的字段 field 的值设为 value</li>
<li><code>HGET key field</code>: 获取存储在哈希表中指定字段的值</li>
<li><code>HDEL key field</code>: 删除存储在哈希表中的指定字段</li>
<li><code>HKEYS key</code>: 获取哈希表中所有字段</li>
<li><code>HVALS key</code>: 获取哈希表中所有值</li>
</ul>
<p>比如，存一个人的示例对象，key为对应id, 然后 field 和 value 为对应属性和值</p>
<figure><figcaption>alt text</figcaption></figure>
<h4>列表操作命令 <code>L|R|BR</code></h4>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序，常用命令：</p>
<ul>
<li><code>LPUSH key value1 [value2]</code>: 将一个或多个值插入到列表头部 (这样插入顺序是 value2 value1 相反的)</li>
<li><code>RPUSH key value1 [value2]</code>: 在列表中添加一个或多个值到列表尾部</li>
<li><code>LRANGE key start stop</code>: 获取列表指定范围内的元素 (全部返回 <code>lrange list 0 -1</code>)</li>
<li><code>RPOP key</code>: 移除并获取列表最后一个元素</li>
<li><code>LLEN key</code>: 获取列表长度</li>
<li><code>BRPOP key1 [key2 ] timeout</code>: 移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止</li>
</ul>
<figure><figcaption>alt text</figcaption></figure>
<h4>集合操作命令 <code>S</code></h4>
<p>Redis set 是string类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据，常用命令：</p>
<ul>
<li><code>SADD key member1 [member2]</code>: 向集合添加一个或多个成员</li>
<li><code>SMEMBERS key</code>: 返回集合中的所有成员</li>
<li><code>SCARD key</code>: 获取集合的成员数</li>
<li><code>SINTER key1 [key2]</code>: 返回给定所有集合的交集</li>
<li><code>SUNION key1 [key2]</code>: 返回所有给定集合的并集</li>
<li><code>SREM key member1 [member2]</code>: 移除集合中一个或多个成员</li>
</ul>
<h4>有序集合操作命令 <code>Z</code></h4>
<p>Redis有序集合是string类型元素的集合，且不允许有重复成员。每个元素都会<strong>关联一个double类型的分数</strong>。常用命令：</p>
<p>常用命令：</p>
<ul>
<li><code>ZADD key score1 member1 [score2 member2]</code>: 向有序集合添加一个或多个成员</li>
<li><code>ZRANGE key start stop [WITHSCORES]</code>: 通过索引区间返回有序集合中指定区间内的成员</li>
<li><code>ZINCRBY key increment member</code>: 有序集合中对指定成员的分数加上增量 increment</li>
<li><code>ZREM key member [member ...]</code>: 移除有序集合中的一个或多个成员</li>
</ul>
<h4>通用命令</h4>
<p>Redis的通用命令是不分数据类型的，都可以使用的命令：</p>
<ul>
<li><code>KEYS pattern</code>: 查找所有符合给定模式(pattern)的 key</li>
<li><code>EXISTS key</code>: 检查给定 key 是否存在</li>
<li><code>TYPE key</code> : 返回 key 所储存的值的类型</li>
<li><code>DEL key</code>:该命令用于在 key 存在是删除 key</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>Javassm - item1-8 (营业状态设置2)</title>
      <link>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article8.html</link>
      <guid>http://ekkosonya.cn/code/java_item/1-%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/article8.html</guid>
      <source url="http://ekkosonya.cn/rss.xml">Javassm - item1-8 (营业状态设置2)</source>
      <description>营业状态设置2 JAVA操作Redis 我们在java程序中应该如何操作Redis呢？这就需要使用Redis的Java客户端，就如同我们使用JDBC操作MySQL数据库一样。 Redis 的 Java 客户端很多，常用的几种： Jedis Lettuce Spring Data Redis Spring 对 Redis 客户端进行了整合，提供了 Spr...</description>
      <category>code</category>
      <pubDate>Wed, 12 Nov 2025 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>营业状态设置2</h2>
<h3>JAVA操作Redis</h3>
<p>我们在java程序中应该如何操作Redis呢？这就需要使用Redis的Java客户端，就如同我们使用JDBC操作MySQL数据库一样。</p>
<p>Redis 的 Java 客户端很多，常用的几种：</p>
<ul>
<li>Jedis</li>
<li>Lettuce</li>
<li>Spring Data Redis</li>
</ul>
<p>Spring 对 Redis 客户端进行了整合，提供了 Spring Data Redis，在Spring Boot项目中还提供了对应的Starter，即 spring-boot-starter-data-redis</p>
<h3>Spring Data Redis使用方式</h3>
<p>Spring Data Redis 是 Spring 的一部分，提供了在 Spring 应用中通过简单的配置就可以访问 Redis 服务，对 Redis 底层开发包进行了高度封装。在 Spring 项目中，可以使用Spring Data Redis来简化 Redis 操作。</p>
<p>网址：<a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">https://spring.io/projects/spring-data-redis</a></p>
<p>Spring Boot提供了对应的Starter，maven坐标：</p>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Spring Data Redis中提供了一个高度封装的类：<strong>RedisTemplate</strong>，对相关api进行了归类封装,将同一类型操作封装为<code>operation</code>接口，具体分类如下：</p>
<ul>
<li>ValueOperations：string数据操作</li>
<li>SetOperations：set类型数据操作</li>
<li>ZSetOperations：zset类型数据操作</li>
<li>HashOperations：hash类型的数据操作</li>
<li>ListOperations：list类型的数据操作</li>
</ul>
<h4>环境搭建</h4>
<figure><figcaption>alt text</figcaption></figure>
<h5>1. 导入Spring Data Redis的maven坐标</h5>
<div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5>2. 配置Redis数据源</h5>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">sky</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre></div><p>在application.yml中添加读取application-dev.yml中的相关Redis配置</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.redis.host<span class="token punctuation">}</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.redis.port<span class="token punctuation">}</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.redis.password<span class="token punctuation">}</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>sky.redis.database<span class="token punctuation">}</span>
</code></pre></div><h5>3. 编写配置类，创建RedisTemplate对象</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始创建redis模板对象..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisTemplate</span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置redis的连接工厂对象</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置redis key的序列化器</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>解释说明：</strong></p>
<p>当前配置类不是必须的，因为 Spring Boot 框架会自动装配 RedisTemplate 对象，但是默认的key序列化器为 <code>JdkSerializationRedisSerializer</code>，导致我们存到Redis中后的数据和原始数据有差别，故设置 <code>StringRedisSerializer</code> 序列化器</p>
<h5>4. 通过RedisTemplate对象操作Redis</h5>
<p>在test下新建测试类</p>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringDataRedisTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//string数据操作</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//hash类型的数据操作</span>
        <span class="token class-name">HashOperations</span> hashOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//list类型的数据操作</span>
        <span class="token class-name">ListOperations</span> listOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//set类型数据操作</span>
        <span class="token class-name">SetOperations</span> setOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//zset类型数据操作</span>
        <span class="token class-name">ZSetOperations</span> zSetOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>操作常见类型数据</h4>
<p>主要流程：</p>
<ol>
<li>先获取对应的 <code>xxOperation</code> 实例通过 <code>redisTemplate.opsForxx</code></li>
<li>再进行对应操作</li>
</ol>
<h5>操作字符串类型数据</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 操作字符串类型的数据
  */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// set get setex setnx</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"小明"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> city <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>操作哈希类型数据</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 操作哈希类型的数据
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//hset hget hdel hkeys hvals</span>
    <span class="token class-name">HashOperations</span> hashOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    hashOperations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hashOperations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> hashOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Set</span> keys <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span> values <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>

    hashOperations<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>操作列表类型数据</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 操作列表类型的数据
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//lpush lrange rpop llen</span>
    <span class="token class-name">ListOperations</span> listOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    listOperations<span class="token punctuation">.</span><span class="token function">leftPushAll</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    listOperations<span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span> mylist <span class="token operator">=</span> listOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mylist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    listOperations<span class="token punctuation">.</span><span class="token function">rightPop</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Long</span> size <span class="token operator">=</span> listOperations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>操作集合类型数据</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 操作集合类型的数据
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//sadd smembers scard sinter sunion srem</span>
  <span class="token class-name">SetOperations</span> setOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  setOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  setOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"set2"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token string">"x"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Set</span> members <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>members<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Long</span> size <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Set</span> intersect <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span> <span class="token string">"set2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>intersect<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Set</span> union <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span> <span class="token string">"set2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>union<span class="token punctuation">)</span><span class="token punctuation">;</span>

  setOperations<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>操作有序集合类型数据</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 操作有序集合类型的数据
  */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testZset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//zadd zrange zincrby zrem</span>
  <span class="token class-name">ZSetOperations</span> zSetOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  zSetOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  zSetOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  zSetOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Set</span> zset1 <span class="token operator">=</span> zSetOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zset1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  zSetOperations<span class="token punctuation">.</span><span class="token function">incrementScore</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  zSetOperations<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"zset1"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5>通用命令操作</h5>
<div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 通用命令操作
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//keys exists type del</span>
  <span class="token class-name">Set</span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Boolean</span> name <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Boolean</span> set1 <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">DataType</span> type <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
  </channel>
</rss>